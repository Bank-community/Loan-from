<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>एक्सचेंज प्लेटफॉर्म</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>

</head>
<body>
<style>
/* Basic Reset & Body */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: sans-serif; line-height: 1.6; background-color: #eef1f5; color: #333; }

/* Notification Area */
#notificationArea { position: fixed; top: 10px; right: 10px; z-index: 1050; /* Higher z-index */ }
.notification { background-color: rgba(0, 123, 255, 0.9); color: white; padding: 10px 20px; margin-bottom: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 1; transition: opacity 0.5s ease-out; }
.notification.fade-out { opacity: 0; }
.notification button { background:none; border:none; color:white; float:right; margin-left:10px; font-size:1.2em; line-height:1; cursor:pointer; padding:0; }


/* Auth Sections */
.auth-section { min-height: 80vh; display: none; justify-content: center; align-items: center; padding: 20px; }
.auth-section.active-section { display: flex; }
.auth-container { background: #fff; padding: 30px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
.auth-container h2 { margin-bottom: 25px; color: #333; }

label { display: block; margin-bottom: 8px; font-weight: bold; text-align: left; }
input[type="text"], input[type="tel"], input[type="file"], input[type="number"] { width: 100%; padding: 12px; margin-bottom: 18px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
input[type="file"] { padding: 8px; }

button { display: inline-block; background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; width: 100%; margin-top: 10px; }
button:hover:not(:disabled) { background-color: #0056b3; }
button:disabled { background-color: #ccc; cursor: not-allowed; }

.status-message { margin-top: 15px; font-weight: bold; text-align: center; min-height: 1.2em; font-size: 0.9em;}
.status-message.success { color: #28a745; }
.status-message.error { color: #dc3545; }

.auth-switch { margin-top: 20px; font-size: 0.9em; color: #555; }
.link-button { background: none; border: none; color: #007bff; text-decoration: underline; cursor: pointer; padding: 0; font-size: inherit; margin: 0; width: auto; }
.link-button:hover { color: #0056b3; }

#registrationSuccessSection .unique-id-display { font-size: 1.5em; font-weight: bold; color: #28a745; margin: 15px 0; padding: 10px; background-color: #e9f7ef; border: 1px solid #a6d9b8; border-radius: 4px; display: inline-block; }
#enterDashboardAfterRegBtn { margin-top: 20px;}


/* Dashboard Section */
#dashboardSection { display: none; }
#dashboardHeader { background-color: #343a40; color: #fff; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; /* Make header sticky */}
.profile-info { display: flex; align-items: center; }
.profile-info img { border-radius: 50%; margin-right: 12px; background-color: #eee; border: 2px solid #fff; width: 40px; height: 40px; object-fit: cover;}
.profile-info span { margin-right: 5px; font-size: 0.95em;}
.profile-info #dashboardUserUniqueId { font-weight: normal; color: #adb5bd; font-size: 0.85em; }

/* Notification Indicator (New Styling) */
.notification-indicator {
    background-color: #ffc107; /* Yellow */
    color: #333;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9em;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: background-color 0.2s ease;
}
.notification-indicator:hover {
    background-color: #e0a800;
}
.notification-indicator .icon { font-size: 1.1em; }
.notification-indicator .count { font-weight: bold; }


#logoutBtn { background-color: #dc3545; color: white; padding: 8px 15px; font-size: 0.9em; width: auto; margin: 0 0 0 15px; /* Added left margin */}
#logoutBtn:hover { background-color: #c82333; }

.dashboard-content { padding: 25px; margin-top: 60px; /* Adjust based on header height */ }
.dashboard-module { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 25px; }
.dashboard-module h2 { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; color: #007bff; }

/* Quick Actions (New Section) */
.quick-actions h2 { margin-bottom: 15px; }
.quick-actions .action-button {
    width: auto; /* Fit content */
    padding: 12px 25px;
    margin: 5px;
    font-size: 1em;
}
#openRequestCashFormBtn { background-color: #28a745; } /* Green */
#openRequestCashFormBtn:hover { background-color: #218838; }
#openRequestUpiFormBtn { background-color: #17a2b8; } /* Teal */
#openRequestUpiFormBtn:hover { background-color: #138496; }

/* Dashboard: Profile Management */
/* ... (Styling unchanged) ... */
.profile-management-content { display: grid; grid-template-columns: auto 1fr; gap: 30px; align-items: flex-start;}
.profile-pic-area { text-align: center; }
#profileMgmtPic { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; width: 100px; height: 100px; object-fit: cover; display: block; margin-left: auto; margin-right: auto;}
#newProfilePicInput { margin-top: 10px; margin-bottom: 10px; }
#uploadProfilePicBtn { width: auto; padding: 8px 15px; font-size: 0.9em; margin: 0; }
.profile-details-area p { margin-bottom: 10px; font-size: 1.05em; }
.profile-details-area strong { color: #343a40; }


/* Dashboard: Money Exchange Lists */
/* Removed form container styling from here */
.request-lists-container { margin-top: 0; } /* No top margin needed now */
.request-lists-container h3 { text-align: center; margin-bottom: 20px; }
.request-lists-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.request-list-column h4 { margin-bottom: 10px; color: #555; text-align: center; }
.request-list-column ul { list-style: none; max-height: 450px; overflow-y: auto; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #eee;}
.request-list-column li { background-color: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px; /* display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; */ font-size: 0.9em; } /* Let content flow naturally */

.request-details img { width: 30px; height: 30px; object-fit: cover; border-radius: 50%; margin-right: 8px; vertical-align: middle;}
.request-details span { display: block; margin-bottom: 5px; }
.request-details strong { font-weight: bold; color: #333; }

.request-actions { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: right; }
.request-actions button {
    padding: 5px 10px;
    font-size: 0.85em;
    width: auto;
    margin: 0 0 5px 5px; /* Spacing between buttons */
    vertical-align: middle;
}
.request-actions .accept-button { background-color: #28a745; }
.request-actions .accept-button:hover { background-color: #218838; }
.request-actions .chat-button { background-color: #17a2b8; }
.request-actions .chat-button:hover { background-color: #138496; }

.request-actions span.request-status-indicator,
.request-actions span.own-request-indicator {
    font-size:0.85em; color: #6c757d; font-weight: normal; vertical-align: middle; margin-right: 10px; display: inline-block;
}
.request-actions span.you-accepted-indicator { color: #28a745; font-weight: bold; }

/* Acceptor List Styling (New) */
.acceptors-list {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed #ccc;
    font-size: 0.9em;
}
.acceptors-list h5 {
    margin-bottom: 8px;
    font-size: 1em;
    color: #555;
}
.acceptors-list ul {
    list-style: none;
    padding-left: 0;
    max-height: 100px; /* Limit height if many acceptors */
    overflow-y: auto;
}
.acceptors-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}
.acceptors-list li:last-child { border-bottom: none; }
.acceptors-list .acceptor-info img {
    width: 25px; height: 25px; border-radius: 50%; margin-right: 5px; vertical-align: middle;
}
.acceptors-list .acceptor-info span { font-size: 0.95em; }
.acceptors-list .acceptor-actions button {
    padding: 3px 8px;
    font-size: 0.8em;
}


li.loading { justify-content: center; text-align: center; font-style: italic; color: #888; background: none; border: none; padding: 20px; }

/* Dashboard: Chat */
/* ... (Styling mostly unchanged) ... */
#chatArea h2 { margin-bottom: 15px; }
#chatInitiationFormContainer { margin-bottom: 20px; }
#startChatForm { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
#startChatForm label { margin-bottom: 0; white-space: nowrap; }
#startChatForm input { flex-grow: 1; margin-bottom: 0; min-width: 150px; }
#startChatForm button { width: auto; margin: 0; flex-shrink: 0; }
#chatInitiationStatus { margin-top: 10px; min-height: 1em; text-align: left; width: 100%; }

.chat-container { border: 1px solid #ddd; border-radius: 8px; margin-top: 15px; background: #fff; }
#chatHeader { background-color: #f8f9fa; border-radius: 8px 8px 0 0; padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; }
#chatHeader img { border-radius: 50%; margin-right: 10px; background-color: #fff; width: 40px; height: 40px; object-fit: cover; border: 1px solid #ddd; }
#chatHeader span { font-weight: bold; margin-right: 5px; }
#chatHeader #chatPartnerId { font-weight: normal; color: #555; }
#closeChatBtn { margin-left: auto; background-color: #6c757d; padding: 5px 10px; font-size: 0.9em; width: auto; }
#closeChatBtn:hover { background-color: #5a6268; }

#chatMessages { height: 350px; background-color: #fff; overflow-y: scroll; padding: 15px; border-bottom: 1px solid #eee;}
.chat-message { max-width: 75%; margin-bottom: 12px; padding: 8px 12px; border-radius: 18px; word-wrap: break-word; clear: both; display: inline-block; }
.sent { background-color: #dcf8c6; float: right; border-bottom-right-radius: 5px; text-align: right; }
.received { background-color: #f1f0f0; float: left; border-bottom-left-radius: 5px; text-align: left; }
.chat-message img.chat-image-thumbnail { max-width: 200px; max-height: 200px; display: block; margin-top: 5px; border-radius: 8px; height: auto; cursor: pointer; border: 1px solid #eee; }
.message-time { font-size: 0.75em; color: #999; display: block; margin-top: 4px; text-align: right; clear: both;}
.received .message-time { text-align: left; }

.system-message { text-align: center; font-size: 0.9em; color: #888; margin: 10px 0; font-style: italic; clear: both; }
.system-message.note { border-radius: 0 0 8px 8px; border-top: 1px solid #eee; background: #f8f9fa; margin-top: 0; padding: 10px;}

.chat-input { display: flex; padding: 10px; background-color: #f8f9fa; border-radius: 0 0 8px 8px; align-items: center; }
#chatMessageInput { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 5px; background-color: #fff;}
#sendMessageBtn, .chat-input button[title="फोटो भेजें"] { padding: 10px 15px; border: none; background-color: #007bff; color: white; cursor: pointer; border-radius: 20px; margin-left: 5px; width: auto; flex-shrink: 0; }
.chat-input button[title="फोटो भेजें"] { background-color: #6c757d; }
#sendMessageBtn:hover { background-color: #0056b3; }
.chat-input button[title="फोटो भेजें"]:hover { background-color: #5a6268; }

/* Modal Styling (Shared by Image and Form Modals) */
.modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); /* Darker overlay */ -webkit-animation-name: fadeIn; animation-name: fadeIn; -webkit-animation-duration: 0.4s; animation-duration: 0.4s; }

/* Image Modal Specific */
#imageModal .modal-content { margin: auto; display: block; width: auto; max-width: 90%; max-height: 80vh; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); -webkit-animation-name: zoom; animation-name: zoom; -webkit-animation-duration: 0.4s; animation-duration: 0.4s; }
#imageModal .modal-caption { margin: auto; display: block; width: 80%; max-width: 700px; text-align: center; color: #ccc; padding: 10px 0; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); }
#imageModal #modalBackButton { background-color: rgba(0, 123, 255, 0.8); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
#imageModal #modalBackButton:hover { background-color: rgba(0, 86, 179, 0.9); }

/* Request Form Modal Specific (New) */
#requestFormModal .modal-content-form { background-color: #fefefe; margin: 10% auto; padding: 25px 35px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); -webkit-animation-name: slideIn; animation-name: slideIn; -webkit-animation-duration: 0.4s; animation-duration: 0.4s; }
#requestFormModal .modal-content-form h3 { margin-top: 0; margin-bottom: 20px; color: #007bff; }
#requestFormModal .form-container { padding: 0; /* Remove padding from template */ }
#requestFormModal .form-container form button[type="submit"] { width: 100%; margin-top: 15px; }

/* Shared Modal Close Button */
.modal-close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; line-height: 1; }
#imageModal .modal-close-button { color: #f1f1f1; top: 15px; right: 35px; font-size: 40px; } /* Specific style for image modal close */
.modal-close-button:hover, .modal-close-button:focus { color: black; text-decoration: none; cursor: pointer; }


/* Modal Animations */
@-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
@keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
@-webkit-keyframes zoom { from {-webkit-transform: scale(0.5) translate(-50%, -50%); transform: scale(0.5) translate(-50%, -50%);} to {-webkit-transform: scale(1) translate(-50%, -50%); transform: scale(1) translate(-50%, -50%);} }
@keyframes zoom { from {transform: scale(0.5) translate(-50%, -50%); opacity: 0;} to {transform: scale(1) translate(-50%, -50%); opacity: 1;} }
@-webkit-keyframes slideIn { from {top: -100px; opacity: 0} to {top: 0; opacity: 1} } /* Use transform for better performance */
@keyframes slideIn { from {transform: translateY(-50px); opacity: 0} to {transform: translateY(0); opacity: 1} }


/* Footer */
footer { text-align: center; margin-top: 30px; padding: 15px; background-color: #e9ecef; color: #6c757d; font-size: 0.9em;}

/* Responsive */
@media (max-width: 900px) {
    .request-lists-container { grid-template-columns: 1fr; }
    .profile-management-content { grid-template-columns: 1fr; }
    .profile-pic-area { margin-bottom: 20px; }
    .quick-actions .action-button { width: 45%; /* Two buttons side-by-side */ }
}
@media (max-width: 768px) {
    #dashboardHeader { flex-wrap: wrap; /* Allow wrapping */ padding: 10px 15px; }
    .profile-info { order: 1; margin-bottom: 10px; width: 60%; } /* Adjust width */
    .notification-indicator { order: 2; margin-bottom: 10px; width: auto; }
    #logoutBtn { order: 3; margin-left: auto; /* Push to right */}
    .dashboard-content { margin-top: 90px; /* Increased margin for wrapped header */ padding: 15px;}
    #startChatForm { flex-direction: column; align-items: stretch; }
    #startChatForm input { margin-bottom: 10px; }
    .request-list-column li { flex-direction: column; align-items: stretch; }
    .request-details { margin-bottom: 10px; }
    .request-actions { text-align: left; }
    .quick-actions .action-button { width: 100%; margin: 5px 0; } /* Stack buttons */
    #requestFormModal .modal-content-form { width: 90%; margin: 15% auto; }
}
@media (max-width: 480px) {
    .auth-container { padding: 20px; }
    .dashboard-module { padding: 15px; }
    button { padding: 10px 15px; }
    #chatMessages { height: 300px; }
    #imageModal .modal-content { width: 95%; }
    .notification-indicator { font-size: 0.8em; padding: 4px 10px; }
    #dashboardHeader { padding: 10px; }
     .profile-info span { font-size: 0.9em; }
     .profile-info #dashboardUserUniqueId { font-size: 0.8em; }
}
</style>
    <div id="notificationArea"></div>

    <section id="loginSection" class="auth-section active-section">
        <div class="auth-container">
            <h2>डैशबोर्ड में एंटर करें</h2>
            <form id="loginForm">
                <label for="loginUniqueId">आपकी यूनिक ID:</label>
                <input type="text" id="loginUniqueId" required pattern="EXC[A-Za-z0-9]{3}" placeholder="जैसे: EXC123">
                <button type="submit" id="loginBtn">एंटर करें</button>
                <p id="loginStatus" class="status-message"></p>
            </form>
            <p class="auth-switch">नया अकाउंट बनाना है? <button id="showRegisterBtn" class="link-button">New Registration</button></p>
        </div>
    </section>

    <section id="registrationSection" class="auth-section">
        <div class="auth-container">
            <h2>नया अकाउंट बनाएं</h2>
            <form id="registrationForm">
                <label for="userName">नाम:</label>
                <input type="text" id="userName" required>

                <label for="userMobile">मोबाइल नंबर:</label>
                <input type="tel" id="userMobile" required pattern="[0-9]{10}" placeholder="10 अंकों का मोबाइल नंबर">

                <button type="submit" id="registerBtn">New Registration</button>
                <p id="registrationStatus" class="status-message"></p>
            </form>
             <p class="auth-switch">पहले से अकाउंट है? <button id="showLoginBtn" class="link-button">Login</button></p>
        </div>
    </section>

    <section id="registrationSuccessSection" class="auth-section">
        <div class="auth-container">
            <h2>रजिस्ट्रेशन सफल!</h2>
            <p>आपकी यूनिक ID है:</p>
            <p id="newUniqueIdDisplay" class="unique-id-display">EXCXXX</p>
            <p>कृपया इसे सुरक्षित रखें। आप इसका उपयोग करके लॉग इन कर सकते हैं।</p>
            <button id="enterDashboardAfterRegBtn">डैशबोर्ड में एंटर करें</button>
        </div>
    </section>

    <section id="dashboardSection" style="display: none;">
        <header id="dashboardHeader">
            <div class="profile-info">
                 <img src="placeholder-profile.png" alt="प्रोफ़ाइल" id="dashboardUserPic" width="40" height="40">
                 <span id="dashboardUserName">यूजर</span> (<span id="dashboardUserUniqueId">ID</span>)
            </div>
            <div id="requestNotificationIndicator" class="notification-indicator" style="display: none;" title="पेंडिंग रिक्वेस्ट्स देखने के लिए क्लिक करें">
                 <span class="icon">🔔</span>
                 <span class="count">0</span> नई रिक्वेस्ट्स
            </div>
            <button id="logoutBtn">लॉगआउट</button>
        </header>

        <main class="dashboard-content">

            <section id="quickActionsArea" class="dashboard-module quick-actions">
                <h2>त्वरित कार्रवाई</h2>
                <button id="openRequestCashFormBtn" class="action-button">💸 कैश रिक्वेस्ट बनाएँ</button>
                <button id="openRequestUpiFormBtn" class="action-button">💳 UPI रिक्वेस्ट बनाएँ</button>
            </section>

             <section id="profileManagementArea" class="dashboard-module">
                <h2>प्रोफाइल मैनेज करें</h2>
                <div class="profile-management-content">
                    <div class="profile-pic-area">
                        <p><strong>मौजूदा प्रोफाइल पिक्चर:</strong></p>
                        <img src="placeholder-profile.png" alt="Current Profile Pic" id="profileMgmtPic" width="100" height="100">
                        <label for="newProfilePicInput">नई पिक्चर अपलोड करें:</label>
                        <input type="file" id="newProfilePicInput" accept="image/*">
                        <button id="uploadProfilePicBtn">अपलोड करें</button>
                        <p id="profileUpdateStatus" class="status-message"></p>
                    </div>
                    <div class="profile-details-area">
                        <p><strong>नाम:</strong> <span id="profileMgmtName"></span></p>
                        <p><strong>मोबाइल:</strong> <span id="profileMgmtMobile"></span></p>
                        <p><strong>यूनिक ID:</strong> <span id="profileMgmtUniqueId"></span></p>
                    </div>
                </div>
             </section>

             <section id="moneyExchangeArea" class="dashboard-module">
                <h2>मनी एक्सचेंज रिक्वेस्ट्स</h2>
                 <div class="request-lists-container">
                    <h3>मौजूदा रिक्वेस्ट्स</h3>
                    <div class="request-list-column">
                        <h4>कैश चाहिए (UPI देने वाले)</h4>
                        <ul id="cashRequestsList">
                            <li class="loading">लोड हो रहा है...</li>
                        </ul>
                    </div>
                    <div class="request-list-column">
                        <h4>UPI चाहिए (कैश देने वाले)</h4>
                        <ul id="upiRequestsList">
                            <li class="loading">लोड हो रहा है...</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="chatArea" class="dashboard-module">
                <h2>डायरेक्ट चैट</h2>
                <div id="chatInitiationFormContainer">
                    <form id="startChatForm">
                        <label for="targetUserIdInput">यूजर की यूनिक ID से चैट करें:</label>
                        <input type="text" id="targetUserIdInput" required pattern="EXC[A-Za-z0-9]{3}" placeholder="जैसे: EXCXYZ">
                        <button type="submit" id="startChatBtn">चैट करें</button>
                        <p id="chatInitiationStatus" class="status-message" style="text-align: left;"></p>
                    </form>
                </div>

                 <div id="chatWindow" class="chat-container" style="display: none;">
                    <div id="chatHeader">
                         <img src="placeholder-profile.png" alt="Partner Pic" id="chatPartnerPic" width="40" height="40">
                         <span id="chatPartnerName">यूजर</span>
                        (<span id="chatPartnerId">ID</span>)
                        <button id="closeChatBtn">चैट बंद करें</button>
                    </div>
                     <div id="chatMessages">
                         <p class="system-message">चैट लोड हो रही है...</p>
                    </div>
                     <div id="chatInputArea" class="chat-input">
                         <input type="text" id="chatMessageInput" placeholder="संदेश लिखें...">
                         <input type="file" id="chatImageUpload" accept="image/*" style="display: none;">
                        <button onclick="document.getElementById('chatImageUpload').click()" title="फोटो भेजें">🖼️</button>
                         <button id="sendMessageBtn">भेजें</button>
                    </div>
                     <p class="system-message note">नोट: भेजी गई तस्वीरें and text 24 घंटे बाद डिलीट हो जायेगी।</p>
                 </div>
            </section>
        </main>
    </section>

    <footer>
        <p>&copy; 2025 एक्सचेंज प्लेटफॉर्म (ट्रायल)</p>
    </footer>

    <div id="requestFormModal" class="modal">
        <div class="modal-content-form">
            <span class="modal-close-button form-modal-close">&times;</span>
            <h3 id="requestFormModalTitle">रिक्वेस्ट बनाएँ</h3>
            <div id="requestFormModalBody">
                </div>
        </div>
    </div>

    <div id="formTemplates" style="display:none;">
        <div class="form-container" id="requestCashFormContainer">
            <h3>मुझे कैश चाहिए (मैं UPI दूँगा)</h3>
            <form id="requestCashForm">
                <label for="cashAmount">कितना कैश ($₹$)?</label>
                <input type="number" id="cashAmount" required min="1">
                <label for="cashDuration">कितनी देर दिखे (मिनट)? (डिफ़ॉल्ट: 60)</label>
                <input type="number" id="cashDuration" value="60" min="5">
                <label for="cashLocation">लोकेशन (संकेत):</label>
                <input type="text" id="cashLocation" placeholder="जैसे: नज़दीकी मेट्रो स्टेशन">
                <button type="submit">कैश रिक्वेस्ट भेजें</button>
                <p id="cashRequestStatus" class="status-message"></p>
            </form>
        </div>
        <div class="form-container" id="requestUpiFormContainer">
            <h3>मुझे UPI चाहिए (मैं कैश दूँगा)</h3>
            <form id="requestUpiForm">
                <label for="upiAmount">कितना UPI ($₹$)?</label>
                <input type="number" id="upiAmount" required min="1">
                <label for="upiDuration">कितनी देर दिखे (मिनट)? (डिफ़ॉल्ट: 60)</label>
                <input type="number" id="upiDuration" value="60" min="5">
                <label for="upiLocation">लोकेशन (संकेत):</label>
                <input type="text" id="upiLocation" placeholder="जैसे: मेरा एरिया">
                <button type="submit">UPI रिक्वेस्ट भेजें</button>
                 <p id="upiRequestStatus" class="status-message"></p>
            </form>
        </div>
    </div>

    <div id="imageModal" class="modal">
      <span class="modal-close-button">&times;</span>
      <img class="modal-content" id="modalImage">
      <div class="modal-caption">
        <button id="modalBackButton">Back</button>
      </div>
    </div>

    <script> // --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyDTHEfKs5mpc7JhUlfnWJd9ZZvyvIYvWzM", // <<< SECURITY RISK
    authDomain: "money-exchange-f4239.firebaseapp.com",
    databaseURL: "https://money-exchange-f4239-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "money-exchange-f4239",
    storageBucket: "money-exchange-f4239.firebasestorage.app",
    messagingSenderId: "850982213483",
    appId: "1:850982213483:web:0829f89ca596e2e7aa9e2e",
    measurementId: "G-22EXD4H4LN"
};
const pusherConfig = { key: "16ad334cb1a57e480dda", cluster: "ap2", useTLS: true }; // <<< SECURITY RISK
const ImgbbApiKey = "7a1be8401cccf5271ff787e57c3035bc"; // <<< SECURITY RISK
const imgbbUploadUrl = 'https://api.imgbb.com/1/upload';

// --- INITIALIZATION ---
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const database = firebase.database();
const pusher = new Pusher(pusherConfig.key, { cluster: pusherConfig.cluster, useTLS: pusherConfig.useTLS });
const usersRef = database.ref('users');
const chatsRef = database.ref('chats');
const requestsRef = database.ref('requests');

// --- GLOBAL VARIABLES ---
let currentUser = null;
let currentChatChannelId = null;
let currentChatPartnerData = null;
let activePusherChatChannel = null;
let firebaseChatListenerAttached = false;
let publicPusherChannel = null;
let firebaseRequestListenerRefs = {};
let pendingRequestCount = 0; // New: For notification count
let currentFirebaseListener = null; // For chat listener cleanup

// --- DOM ELEMENTS ---
const loginSection = document.getElementById('loginSection');
const registrationSection = document.getElementById('registrationSection');
const registrationSuccessSection = document.getElementById('registrationSuccessSection');
const loginForm = document.getElementById('loginForm');
const loginUniqueIdInput = document.getElementById('loginUniqueId');
const loginBtn = document.getElementById('loginBtn');
const loginStatus = document.getElementById('loginStatus');
const showRegisterBtn = document.getElementById('showRegisterBtn');
const registrationForm = document.getElementById('registrationForm');
const userNameInput = document.getElementById('userName');
const userMobileInput = document.getElementById('userMobile');
const registerBtn = document.getElementById('registerBtn');
const registrationStatus = document.getElementById('registrationStatus');
const showLoginBtn = document.getElementById('showLoginBtn');
const newUniqueIdDisplay = document.getElementById('newUniqueIdDisplay');
const enterDashboardAfterRegBtn = document.getElementById('enterDashboardAfterRegBtn');
const dashboardSection = document.getElementById('dashboardSection');
const dashboardHeader = document.getElementById('dashboardHeader');
const dashboardUserPic = document.getElementById('dashboardUserPic');
const dashboardUserName = document.getElementById('dashboardUserName');
const dashboardUserUniqueId = document.getElementById('dashboardUserUniqueId');
const logoutBtn = document.getElementById('logoutBtn');
const requestNotificationIndicator = document.getElementById('requestNotificationIndicator'); // New
const notificationCountSpan = requestNotificationIndicator.querySelector('.count'); // New

const profileManagementArea = document.getElementById('profileManagementArea');
const profileMgmtPic = document.getElementById('profileMgmtPic');
const newProfilePicInput = document.getElementById('newProfilePicInput');
const uploadProfilePicBtn = document.getElementById('uploadProfilePicBtn');
const profileUpdateStatus = document.getElementById('profileUpdateStatus');
const profileMgmtName = document.getElementById('profileMgmtName');
const profileMgmtMobile = document.getElementById('profileMgmtMobile');
const profileMgmtUniqueId = document.getElementById('profileMgmtUniqueId');

const moneyExchangeArea = document.getElementById('moneyExchangeArea'); // Get section reference
const cashRequestsList = document.getElementById('cashRequestsList');
const upiRequestsList = document.getElementById('upiRequestsList');

const chatArea = document.getElementById('chatArea');
const startChatForm = document.getElementById('startChatForm');
const targetUserIdInput = document.getElementById('targetUserIdInput');
const startChatBtn = document.getElementById('startChatBtn');
const chatInitiationStatus = document.getElementById('chatInitiationStatus');
const chatWindow = document.getElementById('chatWindow');
const chatHeader = document.getElementById('chatHeader');
const chatPartnerPic = document.getElementById('chatPartnerPic');
const chatPartnerName = document.getElementById('chatPartnerName');
const chatPartnerId = document.getElementById('chatPartnerId');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatMessagesDiv = document.getElementById('chatMessages');
const chatInputArea = document.getElementById('chatInputArea');
const chatMessageInput = document.getElementById('chatMessageInput');
const chatImageUploadInput = document.getElementById('chatImageUpload');
const sendMessageBtn = document.getElementById('sendMessageBtn');
const notificationArea = document.getElementById('notificationArea');

// Image Modal Elements
const imageModal = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');
const modalCloseButton = document.querySelector('#imageModal .modal-close-button'); // More specific selector
const modalBackButton = document.getElementById('modalBackButton');

// Request Form Modal Elements (New)
const requestFormModal = document.getElementById('requestFormModal');
const requestFormModalTitle = document.getElementById('requestFormModalTitle');
const requestFormModalBody = document.getElementById('requestFormModalBody');
const requestFormModalCloseBtn = document.querySelector('#requestFormModal .form-modal-close');
const openRequestCashFormBtn = document.getElementById('openRequestCashFormBtn');
const openRequestUpiFormBtn = document.getElementById('openRequestUpiFormBtn');
const formTemplates = document.getElementById('formTemplates'); // Container for hidden forms

// Get actual forms from templates (will be cloned)
const requestCashFormTemplate = document.getElementById('requestCashFormContainer');
const requestUpiFormTemplate = document.getElementById('requestUpiFormContainer');


// --- UTILITY FUNCTIONS --- (generateUniqueId, formatTimestamp, formatTimeAgo, uploadImageToImgBB, showStatus, showAuthSection - unchanged)
function generateUniqueId() { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = 'EXC'; for (let i = 0; i < 3; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); } return result; }
function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const now = new Date(); const isToday = date.toDateString() === now.toDateString(); if (isToday) { return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); } else { return date.toLocaleTimeString('en-US', { month:'numeric', day:'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); } }
function formatTimeAgo(timestamp) { if (!timestamp) return ''; const now = Date.now(); const secondsPast = (now - timestamp) / 1000; if (secondsPast < 60) return `${Math.round(secondsPast)} सेकंड पहले`; const minutesPast = secondsPast / 60; if (minutesPast < 60) return `${Math.round(minutesPast)} मिनट पहले`; const hoursPast = minutesPast / 60; if (hoursPast < 24) return `${Math.round(hoursPast)} घंटे पहले`; const daysPast = hoursPast / 24; return `${Math.round(daysPast)} दिन पहले`; }
async function uploadImageToImgBB(file, statusElement) { /* ... (unchanged) ... */ const formData = new FormData(); formData.append('key', ImgbbApiKey); formData.append('image', file); if (statusElement) showStatus(statusElement, 'इमेज अपलोड हो रही है...', false); try { const response = await fetch(imgbbUploadUrl, { method: 'POST', body: formData }); const result = await response.json(); if (result.success && result.data && result.data.url) { return result.data.url; } else { throw new Error(`Image अपलोड त्रुटि: ${result.error?.message || 'Unknown ImgBB error'}`); } } catch (error) { console.error("ImgBB Upload Error:", error); throw new Error(error.message.includes("NetworkError") || error.message.includes("Failed to fetch") ? "Image अपलोड नेटवर्क त्रुटि।" : `ImgBB Error: ${error.message}`); } }
function showStatus(element, message, isError = false, clearAfter = 0) { /* ... (unchanged) ... */ if (element) { element.textContent = message; element.className = `status-message ${isError ? 'error' : 'success'}`; element.style.display = message ? 'block' : 'none'; if (clearAfter > 0) { setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.style.display = 'none'; } }, clearAfter); } } }
function showAuthSection(sectionId) { /* ... (unchanged) ... */ loginSection.style.display = 'none'; registrationSection.style.display = 'none'; registrationSuccessSection.style.display = 'none'; dashboardSection.style.display = 'none'; const sectionToShow = document.getElementById(sectionId); if (sectionToShow) { const displayStyle = sectionToShow.id === 'dashboardSection' ? 'block' : 'flex'; sectionToShow.style.display = displayStyle; showStatus(loginStatus, '', false); showStatus(registrationStatus, '', false); } }


// --- LOGIN & REGISTRATION LOGIC ---
loginForm.addEventListener('submit', (event) => { /* ... (unchanged, ensures currentUser object has necessary fields) ... */
    event.preventDefault();
    const uniqueId = loginUniqueIdInput.value.trim().toUpperCase();
    loginBtn.disabled = true;
    showStatus(loginStatus, `ID ${uniqueId} से लॉग इन किया जा रहा है...`, false);

    if (!uniqueId || !/^EXC[A-Z0-9]{3}$/.test(uniqueId)) {
        showStatus(loginStatus, 'कृपया मान्य यूनिक ID (जैसे EXC123) डालें।', true);
        loginBtn.disabled = false; return;
    }
    usersRef.child(uniqueId).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                currentUser = snapshot.val();
                if (!currentUser.uniqueId) currentUser.uniqueId = uniqueId;
                currentUser.name = currentUser.name || 'Unknown User';
                currentUser.mobile = currentUser.mobile || 'N/A';
                currentUser.profileImageUrl = currentUser.profileImageUrl || 'placeholder-profile.png';
                showStatus(loginStatus, `स्वागत है, ${currentUser.name}!`, false);
                console.log("User logged in:", currentUser);
                showDashboard();
            } else {
                showStatus(loginStatus, `यूजर ID ${uniqueId} नहीं मिला।`, true);
                loginBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error("Login Error:", error);
            showStatus(loginStatus, `लॉगिन विफल: ${error.message}`, true);
            loginBtn.disabled = false;
        });
});

registrationForm.addEventListener('submit', async (event) => { /* ... (unchanged, includes unique ID existence check) ... */
    event.preventDefault();
    registerBtn.disabled = true;
    showStatus(registrationStatus, 'प्रोसेस किया जा रहा है...', false);
    const name = userNameInput.value.trim();
    const mobile = userMobileInput.value.trim();
    let uniqueId = null;
    try {
        if (!name || !mobile || !/^[0-9]{10}$/.test(mobile)) { throw new Error('कृपया सही नाम और 10 अंकों का मोबाइल नंबर दर्ज करें।'); }
        let idExists = true; let attempts = 0;
        while (idExists && attempts < 10) {
            uniqueId = generateUniqueId();
            const snapshot = await usersRef.child(uniqueId).once('value');
            idExists = snapshot.exists();
            if(idExists) console.warn(`ID ${uniqueId} already exists. Regenerating...`);
            attempts++;
        }
        if (idExists) { throw new Error('Unique ID बनाने में विफल। कृपया बाद में प्रयास करें।'); }
        const userData = { name, mobile, uniqueId, profileImageUrl: 'placeholder-profile.png', createdAt: firebase.database.ServerValue.TIMESTAMP };
        await usersRef.child(uniqueId).set(userData);
        currentUser = userData;
        newUniqueIdDisplay.textContent = uniqueId;
        showAuthSection('registrationSuccessSection');
        registrationForm.reset();
        showStatus(registrationStatus, '', false);
    } catch (error) {
        console.error("Registration Process Error:", error);
        showStatus(registrationStatus, `रजिस्ट्रेशन विफल: ${error.message}`, true);
        currentUser = null;
    } finally { registerBtn.disabled = false; }
});

enterDashboardAfterRegBtn.addEventListener('click', () => { /* ... (unchanged) ... */ if (currentUser) { showDashboard(); } else { console.error("Cannot enter dashboard, currentUser not set after registration."); showAuthSection('loginSection'); } });
showRegisterBtn.addEventListener('click', () => showAuthSection('registrationSection'));
showLoginBtn.addEventListener('click', () => showAuthSection('loginSection'));

// --- DASHBOARD LOGIC ---
function showDashboard() {
    if (!currentUser || !currentUser.uniqueId) { /* ... (unchanged null check) ... */ console.error("Cannot show dashboard, invalid currentUser:", currentUser); showAuthSection('loginSection'); return; }
    console.log("Showing dashboard for user:", currentUser.uniqueId);

    // Update Header & Profile
    dashboardUserPic.src = currentUser.profileImageUrl || 'placeholder-profile.png';
    dashboardUserName.textContent = currentUser.name || 'User';
    dashboardUserUniqueId.textContent = currentUser.uniqueId;
    profileMgmtPic.src = currentUser.profileImageUrl || 'placeholder-profile.png';
    profileMgmtName.textContent = currentUser.name || 'User';
    profileMgmtMobile.textContent = currentUser.mobile || 'N/A';
    profileMgmtUniqueId.textContent = currentUser.uniqueId;

    // Show dashboard, hide auth
    loginSection.style.display = 'none'; registrationSection.style.display = 'none'; registrationSuccessSection.style.display = 'none'; dashboardSection.style.display = 'block';

    // Initialize components
    initializeProfileManagement();
    initializeRequestFormsModal(); // New: Initialize modal forms
    initializeMoneyExchangeList(); // Renamed: Initialize list listening
    initializeChat();
    subscribeToPublicNotifications();

    // Reset states
    startChatForm.reset();
    showStatus(chatInitiationStatus, '', false);
    showStatus(profileUpdateStatus, '', false);
    loginBtn.disabled = false;
    updatePendingRequestCount(0); // Reset count initially
    requestNotificationIndicator.style.display = 'none'; // Hide initially
}

logoutBtn.addEventListener('click', () => {
    console.log("Logging out user:", currentUser?.uniqueId);
    currentUser = null;
    clearMoneyExchangeListListeners(); // Renamed
    unsubscribePublicNotifications();
    closeChatWindow();
    detachProfileManagementListeners();
    showAuthSection('loginSection');
    loginUniqueIdInput.value = '';
    loginBtn.disabled = false;
    showStatus(loginStatus, "आप सफलतापूर्वक लॉगआउट हो गए हैं।", false, 3000);
    dashboardUserName.textContent = 'यूजर';
    dashboardUserUniqueId.textContent = 'ID';
    dashboardUserPic.src = 'placeholder-profile.png';
    cashRequestsList.innerHTML = '<li class="loading">लॉग आउट किया गया।</li>';
    upiRequestsList.innerHTML = '<li class="loading">लॉग आउट किया गया।</li>';
    updatePendingRequestCount(0); // Reset count on logout
    requestNotificationIndicator.style.display = 'none';
});

// --- DASHBOARD: PROFILE MANAGEMENT ---
const profilePicUploadHandler = async () => { /* ... (unchanged) ... */ if (!currentUser) { showStatus(profileUpdateStatus, "त्रुटि: यूजर लॉग इन नहीं है।", true, 3000); return; } if (!newProfilePicInput.files || newProfilePicInput.files.length === 0) { showStatus(profileUpdateStatus, "कृपया अपलोड करने के लिए एक फाइल चुनें।", true, 3000); return; } const file = newProfilePicInput.files[0]; uploadProfilePicBtn.disabled = true; showStatus(profileUpdateStatus, "प्रोफाइल पिक्चर अपलोड हो रही है...", false); try { const imageUrl = await uploadImageToImgBB(file, profileUpdateStatus); const profileRef = usersRef.child(currentUser.uniqueId); await profileRef.update({ profileImageUrl: imageUrl }); currentUser.profileImageUrl = imageUrl; dashboardUserPic.src = imageUrl; profileMgmtPic.src = imageUrl; showStatus(profileUpdateStatus, "प्रोफाइल पिक्चर सफलतापूर्वक अपडेट हुई!", false, 3000); newProfilePicInput.value = ''; } catch (error) { console.error("Profile picture update failed:", error); showStatus(profileUpdateStatus, `अपडेट विफल: ${error.message}`, true, 5000); } finally { uploadProfilePicBtn.disabled = false; } };
function initializeProfileManagement() { /* ... (unchanged) ... */ if (!initializeProfileManagement.initialized) { uploadProfilePicBtn.addEventListener('click', profilePicUploadHandler); initializeProfileManagement.initialized = true; console.log("Profile management listeners initialized."); } }
initializeProfileManagement.initialized = false;
function detachProfileManagementListeners() { /* ... (unchanged) ... */ initializeProfileManagement.initialized = false; console.log("Profile management listeners conceptually detached (flag reset)."); }

// --- DASHBOARD: REQUEST FORMS MODAL (New Logic) ---

function openRequestFormModal(type) {
    requestFormModalBody.innerHTML = ''; // Clear previous form
    let formTemplate, formTitle, formContainer;

    if (type === 'cash') {
        formContainer = requestCashFormTemplate.cloneNode(true); // Clone the template
        formTitle = "कैश रिक्वेस्ट बनाएँ (आप UPI देंगे)";
    } else if (type === 'upi') {
        formContainer = requestUpiFormTemplate.cloneNode(true); // Clone the template
        formTitle = "UPI रिक्वेस्ट बनाएँ (आप कैश देंगे)";
    } else {
        console.error("Invalid form type requested:", type);
        return;
    }

    requestFormModalTitle.textContent = formTitle;
    requestFormModalBody.appendChild(formContainer); // Add the cloned form container
    requestFormModal.style.display = 'block';

    // Re-attach submit listener to the *cloned* form
    const formElement = requestFormModalBody.querySelector('form'); // Get the form inside the modal
    if (formElement) {
         // Clear any previous status message within the modal form
         const formStatus = formElement.querySelector('.status-message');
         if(formStatus) showStatus(formStatus, '', false);

        formElement.addEventListener('submit', (e) => handleMoneyRequestSubmit(e, type, true)); // Pass flag indicating it's from modal
    }
}

function closeRequestFormModal() {
    requestFormModal.style.display = 'none';
    requestFormModalBody.innerHTML = ''; // Clear form content on close
}

function initializeRequestFormsModal() {
    if (!initializeRequestFormsModal.initialized) {
        openRequestCashFormBtn.addEventListener('click', () => openRequestFormModal('cash'));
        openRequestUpiFormBtn.addEventListener('click', () => openRequestFormModal('upi'));
        requestFormModalCloseBtn.addEventListener('click', closeRequestFormModal);
        // Close modal if background is clicked
        requestFormModal.addEventListener('click', (event) => {
            if (event.target === requestFormModal) {
                closeRequestFormModal();
            }
        });
        initializeRequestFormsModal.initialized = true;
        console.log("Request form modal listeners initialized.");
    }
}
initializeRequestFormsModal.initialized = false;


// --- DASHBOARD: MONEY EXCHANGE LIST & MULTIPLE ACCEPTANCE LOGIC ---

// Renamed function
function initializeMoneyExchangeList() {
    if (Object.keys(firebaseRequestListenerRefs).length === 0) {
        cashRequestsList.innerHTML = '<li class="loading">लोड हो रहा है...</li>';
        upiRequestsList.innerHTML = '<li class="loading">लोड हो रहा है...</li>';
        listenForRequestChanges(); // Setup Firebase listeners for lists
    }
    // New: Add listener for the notification indicator click
     if (!initializeMoneyExchangeList.indicatorListenerAttached) {
        requestNotificationIndicator.addEventListener('click', () => {
             moneyExchangeArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        initializeMoneyExchangeList.indicatorListenerAttached = true;
     }
}
initializeMoneyExchangeList.indicatorListenerAttached = false;


async function handleMoneyRequestSubmit(event, type, isFromModal = false) {
    event.preventDefault();
    if (!currentUser) { alert("कृपया पहले लॉग इन करें।"); return; }

    const form = event.target; // The form element itself
    const amountInput = form.querySelector(`#${type}Amount`);
    const durationInput = form.querySelector(`#${type}Duration`);
    const locationInput = form.querySelector(`#${type}Location`);
    const submitButton = form.querySelector('button[type="submit"]');
    const statusElement = form.querySelector('.status-message'); // Get status element within the form

    const amount = amountInput.value;
    const duration = durationInput.value || 60;
    const location = locationInput.value.trim();

    if (!amount || amount <= 0) {
         showStatus(statusElement, "कृपया मान्य मात्रा दर्ज करें।", true, 3000);
         return;
    }

    const requestData = {
        type: type,
        amount: parseFloat(amount),
        durationMinutes: parseInt(duration),
        location: location || null,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        userId: currentUser.uniqueId, // Original poster
        userName: currentUser.name,
        userPic: currentUser.profileImageUrl,
        status: 'open', // New status: 'open' for available requests
        acceptors: {} // New: Initialize acceptors map (empty)
    };

    if (submitButton) submitButton.disabled = true;
    showStatus(statusElement, "रिक्वेस्ट भेजी जा रही है...", false);

    try {
        const newRequestRef = requestsRef.push();
        await newRequestRef.set(requestData);

        console.log(`${type} रिक्वेस्ट भेजी गई! ID: ${newRequestRef.key}`);
        showStatus(statusElement, "रिक्वेस्ट सफलतापूर्वक भेजी गई!", false, 3000);
        form.reset(); // Reset the specific form
        durationInput.value = '60';
        displayNotification("आपकी रिक्वेस्ट पोस्ट हो गई है!");
        console.warn("BACKEND NEEDED: Trigger Pusher for new request notification.");

        // Close modal after a short delay if submitted from modal
        if (isFromModal) {
            setTimeout(closeRequestFormModal, 1500);
        }

    } catch (error) {
        console.error(`रिक्वेस्ट भेजने में त्रुटि: ${error}`);
        showStatus(statusElement, "रिक्वेस्ट भेजने में त्रुटि हुई।", true, 5000);
    } finally {
        if (submitButton) submitButton.disabled = false;
    }
}

// Heavily Modified function for multiple acceptors
function renderMoneyRequest(requestData, requestId) {
    const listElement = requestData.type === 'cash' ? cashRequestsList : upiRequestsList;
    if (!listElement) return;

    const existingLi = document.getElementById(`req-${requestId}`);

    // --- Expiration Check ---
    const now = Date.now();
    const creationTime = requestData.timestamp || 0; // Handle missing timestamp
    const expirationTime = creationTime + (requestData.durationMinutes * 60 * 1000);
    const isExpired = expirationTime < now;

    // --- Status Check (New Logic) ---
    // Consider a request invalid/removable if expired OR explicitly closed
    const isRemovable = isExpired || requestData.status === 'closed';

    // Recalculate pending count when rendering changes occur
    recalculatePendingRequests(); // Update count based on current state

    if (isRemovable) {
        if (existingLi) removeMoneyRequestFromUI(requestId);
        return;
    }

    // --- Create or Update List Item ---
    let li = existingLi;
    if (!li) {
        li = document.createElement('li');
        li.id = `req-${requestId}`;
        li.dataset.requestId = requestId;
        li.dataset.posterId = requestData.userId; // Store poster ID

        li.innerHTML = `
            <div class="request-details"></div>
            <div class="acceptors-list" style="display: none;"></div>
            <div class="request-actions"></div>
        `; // Basic structure

        const loadingItem = listElement.querySelector('.loading');
        if (loadingItem) loadingItem.remove();
        if (listElement.firstChild) listElement.insertBefore(li, listElement.firstChild);
        else listElement.appendChild(li);
    }

    // --- Update Details ---
    const detailsDiv = li.querySelector('.request-details');
    detailsDiv.innerHTML = `
        <img src="${requestData.userPic || 'placeholder-profile.png'}" width="30" height="30" alt="${requestData.userName || 'User'} pic">
        <span><strong>${requestData.userName || 'User'}</strong> (${requestData.userId})</span>
        <span><strong>मात्रा:</strong> ₹${requestData.amount}</span>
        ${requestData.location ? `<span><strong>लोकेशन:</strong> ${requestData.location}</span>` : ''}
        <span><strong>कब:</strong> ${formatTimeAgo(requestData.timestamp)}</span>
        <span><small>(समाप्त: ${formatTimeAgo(expirationTime)})</small></span>
    `;

    // --- Update Actions and Acceptor List ---
    const actionsDiv = li.querySelector('.request-actions');
    const acceptorsListDiv = li.querySelector('.acceptors-list');
    actionsDiv.innerHTML = ''; // Clear previous actions
    acceptorsListDiv.innerHTML = ''; // Clear previous acceptors
    acceptorsListDiv.style.display = 'none'; // Hide by default

    const isOwnRequest = requestData.userId === currentUser?.uniqueId;
    const acceptorsMap = requestData.acceptors || {};
    const hasAccepted = currentUser?.uniqueId in acceptorsMap;

    if (isOwnRequest) {
        actionsDiv.innerHTML = `<span class="own-request-indicator">आपकी रिक्वेस्ट</span>`;
        // Show list of acceptors if any
        const acceptorIds = Object.keys(acceptorsMap);
        if (acceptorIds.length > 0) {
            acceptorsListDiv.style.display = 'block';
            let acceptorListHtml = '<h5>स्वीकार करने वाले:</h5><ul>';
            acceptorIds.forEach(acceptorId => {
                const acceptorData = acceptorsMap[acceptorId];
                acceptorListHtml += `
                    <li>
                        <span class="acceptor-info">
                            <img src="${acceptorData.userPic || 'placeholder-profile.png'}" alt="${acceptorData.userName || 'User'}">
                            <span>${acceptorData.userName || 'User'} (${acceptorId})</span>
                            <small>(${formatTimeAgo(acceptorData.acceptedAt)})</small>
                        </span>
                        <span class="acceptor-actions">
                            <button class="chat-button" data-chat-target-id="${acceptorId}">चैट करें</button>
                        </span>
                    </li>`;
            });
            acceptorListHtml += '</ul>';
            acceptorsListDiv.innerHTML = acceptorListHtml;
            // Add listeners to chat buttons within the acceptor list
             acceptorsListDiv.querySelectorAll('.chat-button').forEach(button => {
                 button.addEventListener('click', (e) => handleRequestChatButtonClick(e.currentTarget.dataset.chatTargetId));
             });

        } else {
             actionsDiv.innerHTML += ` <small>(अभी तक किसी ने स्वीकार नहीं किया)</small>`;
        }

    } else { // Request by someone else
        if (hasAccepted) {
            // Current user has accepted this request
            actionsDiv.innerHTML = `<span class="you-accepted-indicator">आपने स्वीकार किया</span>`;
            const chatButton = createChatButton(requestId, requestData.userId, requestData.userName); // Button to chat with POSTER
            if (chatButton) actionsDiv.appendChild(chatButton);
        } else if (requestData.status === 'open') {
            // Current user has NOT accepted, and request is open
            const acceptButton = document.createElement('button');
            acceptButton.textContent = 'स्वीकार करें';
            acceptButton.classList.add('accept-button');
            // Add necessary data attributes
            acceptButton.dataset.reqid = requestId;
            acceptButton.dataset.posterid = requestData.userId; // Need poster ID
            acceptButton.dataset.postername = requestData.userName || 'User';
            attachAcceptButtonListener(acceptButton); // Attach the modified listener
            actionsDiv.appendChild(acceptButton);
        } else {
             actionsDiv.innerHTML = `<span class="request-status-indicator">रिक्वेस्ट बंद है</span>`;
        }
    }
}

// Helper to create Chat button (modified to ensure targetId is passed)
function createChatButton(requestId, targetUserId, targetUserName) {
    if (!targetUserId || !currentUser || targetUserId === currentUser.uniqueId) return null;

    const chatButton = document.createElement('button');
    chatButton.textContent = 'चैट करें';
    chatButton.classList.add('chat-button');
    chatButton.dataset.reqid = requestId;
    chatButton.dataset.chatTargetId = targetUserId;
    chatButton.dataset.chatTargetName = targetUserName || 'User';

    chatButton.addEventListener('click', (event) => {
        handleRequestChatButtonClick(event.currentTarget.dataset.chatTargetId);
    });
    return chatButton;
}

// Modified Listener for 'Accept' Button
function attachAcceptButtonListener(button) {
    if (button.dataset.listenerAttached === 'true') return;
    button.dataset.listenerAttached = 'true';

    button.addEventListener('click', async (event) => {
        const btn = event.currentTarget;
        if (btn.disabled) return;

        const requestId = btn.dataset.reqid;
        const posterId = btn.dataset.posterid; // Poster's ID

        if (!currentUser || currentUser.uniqueId === posterId) {
            alert("आप अपनी खुद की रिक्वेस्ट स्वीकार नहीं कर सकते।");
            return;
        }

        console.log(`Attempting to accept request: ${requestId} from poster ${posterId}`);
        btn.disabled = true; // Disable button

        const requestRef = requestsRef.child(requestId);

        try {
            // Fetch current request data to check status and existing acceptors
            const snapshot = await requestRef.once('value');
            if (!snapshot.exists()) {
                throw new Error("रिक्वेस्ट अब मौजूद नहीं है।");
            }
            const requestData = snapshot.val();

            // Double-check status and if already accepted by current user
            if (requestData.status !== 'open') {
                 throw new Error("यह रिक्वेस्ट अब स्वीकार करने के लिए उपलब्ध नहीं है।");
            }
            if (requestData.acceptors && requestData.acceptors[currentUser.uniqueId]) {
                // Already accepted, maybe just initiate chat?
                console.log("आपने यह रिक्वेस्ट पहले ही स्वीकार कर ली है। चैट शुरू की जा रही है...");
                handleRequestChatButtonClick(posterId); // Initiate chat with poster
                // No need to throw error, re-enable button after chat logic? Or let render handle it.
                // btn.disabled = false; // Or keep disabled as action is done
                 return; // Exit function early
            }

            // Prepare acceptor data
            const acceptorData = {
                acceptedAt: firebase.database.ServerValue.TIMESTAMP,
                userName: currentUser.name || 'User',
                userPic: currentUser.profileImageUrl || 'placeholder-profile.png'
                // Add chatInitiated: false here if needed
            };

            // Update the request by adding the current user to the acceptors map
            // Use update for atomicity on the acceptors path
            await requestRef.child('acceptors').child(currentUser.uniqueId).update(acceptorData);

            console.log(`User ${currentUser.uniqueId} successfully accepted request ${requestId}`);
            displayNotification(`आपने ${requestData.userName} (${posterId}) की रिक्वेस्ट स्वीकार कर ली है।`);

            // Initiate chat between acceptor (currentUser) and poster (posterId)
            handleRequestChatButtonClick(posterId); // Start chat with the poster

            console.warn("BACKEND NEEDED: Notify original poster via Pusher about the new acceptance.");
            // The button will be updated by the renderMoneyRequest function on data change

        } catch (error) {
            console.error("Error accepting money request:", error);
            alert(`रिक्वेस्ट स्वीकार करने में त्रुटि हुई: ${error.message}`);
            // Re-enable button only if error wasn't "already accepted" or "request not open"
            if (!error.message.includes("पहले ही स्वीकार") && !error.message.includes("उपलब्ध नहीं")) {
                 btn.disabled = false;
                 btn.dataset.listenerAttached = 'false'; // Allow re-attaching if transient error
            } else {
                // Keep disabled if permanently unable to accept (already accepted, closed)
                 btn.disabled = true;
            }
        }
    });
}


// Modified: Handles chat initiation from various contexts
function handleRequestChatButtonClick(targetId) {
    if (!targetId) { console.error("Chat button clicked without targetId"); return; }
    if (!currentUser) { alert("कृपया पहले लॉग इन करें।"); return; }
    if (targetId === currentUser.uniqueId) { alert("आप खुद से चैट नहीं कर सकते।"); return; }

    // Scroll to chat area
    chatArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Directly start the chat process
    targetUserIdInput.value = targetId; // Set input for visual feedback (optional)
    startChatBtn.disabled = true;
    showStatus(chatInitiationStatus, `यूजर ${targetId} के साथ चैट शुरू की जा रही है...`, false);

    usersRef.child(targetId).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                currentChatPartnerData = snapshot.val();
                if (!currentChatPartnerData.uniqueId) currentChatPartnerData.uniqueId = targetId;
                currentChatPartnerData.name = currentChatPartnerData.name || 'Unknown User';
                currentChatPartnerData.profileImageUrl = currentChatPartnerData.profileImageUrl || 'placeholder-profile.png';
                showStatus(chatInitiationStatus, ``, false);
                startChatSession(targetId); // Open the chat window
            } else {
                showStatus(chatInitiationStatus, `चैट के लिए यूजर ID ${targetId} नहीं मिला।`, true);
            }
        })
        .catch(e => { console.error("Error fetching target user for request chat:", e); showStatus(chatInitiationStatus, `यूजर खोजने में त्रुटि।`, true); })
        .finally(() => { startChatBtn.disabled = false; });
}

function removeMoneyRequestFromUI(requestId) {
    const requestElement = document.getElementById(`req-${requestId}`);
    if (requestElement) {
        requestElement.remove();
        console.log(`Removed request ${requestId} from UI.`);
        // Check if lists are empty and add placeholder
        if (cashRequestsList.children.length === 0 && !cashRequestsList.querySelector('.loading')) {
            cashRequestsList.innerHTML = '<li class="loading">कोई कैश रिक्वेस्ट नहीं।</li>';
        }
        if (upiRequestsList.children.length === 0 && !upiRequestsList.querySelector('.loading')) {
            upiRequestsList.innerHTML = '<li class="loading">कोई UPI रिक्वेस्ट नहीं।</li>';
        }
         recalculatePendingRequests(); // Update count after removal
    }
}

// New function to update notification count
function updatePendingRequestCount(count) {
    pendingRequestCount = count;
    if (notificationCountSpan) {
        notificationCountSpan.textContent = count;
    }
    if (requestNotificationIndicator) {
        requestNotificationIndicator.style.display = count > 0 ? 'flex' : 'none';
    }
}

// New function to recalculate count based on current DOM lists
function recalculatePendingRequests() {
    if (!currentUser) {
        updatePendingRequestCount(0);
        return;
    }
    let count = 0;
    const allRequestItems = [...cashRequestsList.children, ...upiRequestsList.children];
    allRequestItems.forEach(item => {
        if (item.classList.contains('loading') || !item.id || !item.id.startsWith('req-')) return;

        const posterId = item.dataset.posterId;
        const acceptButton = item.querySelector('.accept-button'); // Check if accept button exists

        // Count if it's not the user's own request AND has an accept button (implies status is 'open' and not accepted by current user)
        if (posterId !== currentUser.uniqueId && acceptButton) {
            count++;
        }
    });
    updatePendingRequestCount(count);
}


// Modified to handle new status and acceptor logic for counts
function listenForRequestChanges() {
    if (Object.keys(firebaseRequestListenerRefs).length > 0) { console.warn("Attempted to attach request listeners again. Skipping."); return; }
    console.log("Attaching Firebase listeners for money requests (v8)...");

    // Listen to all requests, filter client-side for count, render handles display logic
    const requestsQuery = requestsRef.orderByChild('timestamp').limitToLast(100); // Increase limit?

    const attachListener = (eventType, callback) => {
        const handler = requestsQuery.on(eventType, callback, (error) => {
            console.error(`Firebase money request ${eventType} listener error:`, error);
        });
        const path = requestsQuery.toString();
        if (!firebaseRequestListenerRefs[path]) firebaseRequestListenerRefs[path] = {};
        firebaseRequestListenerRefs[path][eventType] = { ref: requestsQuery, handler: handler };
        console.log(`Attached ${eventType} listener to ${path}`);
    };

    // CHILD ADDED: New request appears
    attachListener('child_added', (snapshot) => {
        if (snapshot.exists()) {
            renderMoneyRequest(snapshot.val(), snapshot.key);
             // Recalculate count needed as renderMoneyRequest alone doesn't guarantee count update yet
             recalculatePendingRequests();
        }
    });

    // CHILD CHANGED: Status update, acceptor added, etc.
    attachListener('child_changed', (snapshot) => {
        if (snapshot.exists()) {
            renderMoneyRequest(snapshot.val(), snapshot.key); // Re-render handles UI update
             // Recalculate count needed as acceptors might change availability
             recalculatePendingRequests();
        }
    });

    // CHILD REMOVED: Request deleted or expired (handled in render now)
    attachListener('child_removed', (snapshot) => {
        removeMoneyRequestFromUI(snapshot.key); // Removes from UI, recalculates count
    });

     // Initial count calculation after listeners are attached (needs slight delay?)
     setTimeout(recalculatePendingRequests, 1500); // Delay to allow initial items to render
}

// Renamed function
function clearMoneyExchangeListListeners() {
    console.log("Detaching Firebase listeners for money requests.");
    for (const path in firebaseRequestListenerRefs) {
        for (const eventType in firebaseRequestListenerRefs[path]) {
             const listenerInfo = firebaseRequestListenerRefs[path][eventType];
            try { listenerInfo.ref.off(eventType, listenerInfo.handler); console.log(`Detached ${eventType} listener from ${path}`); }
            catch (e) { console.warn(`Error detaching listener for ${eventType} on ${path}:`, e); }
        }
    }
    firebaseRequestListenerRefs = {};
    // Reset form listener flag might not be needed here, only list listeners cleared
    // initializeMoneyExchangeList.listenersAttached = false; // Maybe keep separate flags
    cashRequestsList.innerHTML = '<li class="loading">लॉग आउट किया गया।</li>';
    upiRequestsList.innerHTML = '<li class="loading">लॉग आउट किया गया।</li>';
     updatePendingRequestCount(0); // Reset count
}


// --- DASHBOARD: CHAT LOGIC ---
// (initializeChat, handleStartChatSubmit, startChatSession, closeChatWindow, sendChatMessage, displayChatMessage, handleChatImageUpload, openImageModal, closeImageModal, scrollToBottom, subscribeToChatChannel, fetchChatHistory, listenForNewFirebaseMessages remain largely unchanged from previous version - ensure `handleRequestChatButtonClick` calls `startChatSession` correctly)

// Minor adjustments potentially needed in chat functions if user data structure changed, but assumed okay for now.

function initializeChat() { /* ... (Ensure modal listeners are setup) ... */
    if (!initializeChat.initialized) {
        console.log("Initializing Chat module listeners...");
        startChatForm.addEventListener('submit', handleStartChatSubmit);
        closeChatBtn.addEventListener('click', closeChatWindow);
        sendMessageBtn.addEventListener('click', () => { if(chatMessageInput.value.trim()) sendChatMessage(chatMessageInput.value.trim()); });
        chatMessageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if(chatMessageInput.value.trim()) sendChatMessage(chatMessageInput.value.trim()); } });
        chatImageUploadInput.addEventListener('change', handleChatImageUpload);
        // Image Modal Listeners
        modalCloseButton.addEventListener('click', closeImageModal);
        modalBackButton.addEventListener('click', closeImageModal);
        imageModal.addEventListener('click', (event) => { if (event.target === imageModal) closeImageModal(); });
        initializeChat.initialized = true;
    }
    closeChatWindow();
}
initializeChat.initialized = false;

function handleStartChatSubmit(event) { /* ... (Unchanged) ... */
    event.preventDefault(); const targetId = targetUserIdInput.value.trim().toUpperCase(); startChatBtn.disabled = true; showStatus(chatInitiationStatus, `यूजर ${targetId} को खोजा जा रहा है...`, false);
    if (!targetId || !/^EXC[A-Z0-9]{3}$/.test(targetId)) { showStatus(chatInitiationStatus, 'मान्य यूनिक ID डालें (जैसे EXC123)।', true, 3000); startChatBtn.disabled = false; return; } if (!currentUser) { showStatus(chatInitiationStatus, 'त्रुटि: वर्तमान यूजर सेट नहीं है।', true, 3000); startChatBtn.disabled = false; return; } if (targetId === currentUser.uniqueId) { showStatus(chatInitiationStatus, 'आप खुद से चैट नहीं कर सकते।', true, 3000); startChatBtn.disabled = false; return; }
    usersRef.child(targetId).once('value')
        .then(s => { if (s.exists()) { currentChatPartnerData = s.val(); if (!currentChatPartnerData.uniqueId) currentChatPartnerData.uniqueId = targetId; currentChatPartnerData.name = currentChatPartnerData.name || 'Unknown User'; currentChatPartnerData.profileImageUrl = currentChatPartnerData.profileImageUrl || 'placeholder-profile.png'; showStatus(chatInitiationStatus, ``, false); startChatSession(targetId); } else { showStatus(chatInitiationStatus, `यूजर ID ${targetId} नहीं मिला।`, true, 3000); } })
        .catch(e => { console.error("Error fetching target user:", e); showStatus(chatInitiationStatus, `यूजर खोजने में त्रुटि।`, true, 3000); })
        .finally(() => { startChatBtn.disabled = false; });
}

function startChatSession(targetId) { /* ... (Unchanged - ensures pairwise channel ID) ... */
    if (!currentUser || !currentChatPartnerData) { console.error("Cannot start chat session, missing user data."); return; }
    const ids = [currentUser.uniqueId, targetId].sort(); const newChannelId = `chat_${ids[0]}_${ids[1]}`;
    if (currentChatChannelId === newChannelId && chatWindow.style.display === 'block') { console.log("Already in chat with", targetId); return; }
    if (currentChatChannelId && currentChatChannelId !== newChannelId) { closeChatWindow(); }
    currentChatChannelId = newChannelId; console.log("Starting chat on channel:", currentChatChannelId);
    chatPartnerPic.src = currentChatPartnerData.profileImageUrl || 'placeholder-profile.png'; chatPartnerName.textContent = currentChatPartnerData.name || 'User'; chatPartnerId.textContent = currentChatPartnerData.uniqueId;
    document.getElementById('chatInitiationFormContainer').style.display = 'none'; chatWindow.style.display = 'block'; chatMessagesDiv.innerHTML = '<p class="system-message">चैट हिस्ट्री लोड हो रही है...</p>';
    subscribeToChatChannel(currentChatChannelId); chatMessageInput.focus();
}

function closeChatWindow() { /* ... (Unchanged - handles Pusher/Firebase listener cleanup) ... */
     if (activePusherChatChannel) { try { activePusherChatChannel.unbind_all(); pusher.unsubscribe(activePusherChatChannel.name); console.log(`Unsubscribed Pusher: ${activePusherChatChannel.name}`); } catch(e) { console.warn("Pusher unsubscribe error:", e); } activePusherChatChannel = null; }
     if (currentFirebaseListener && currentFirebaseListener.ref && currentFirebaseListener.handler) { try { currentFirebaseListener.ref.off('child_added', currentFirebaseListener.handler); console.log(`Detached Firebase listener for chat: ${currentFirebaseListener.channelId}`); } catch(e) { console.warn("Firebase chat listener detach error:", e); } currentFirebaseListener = null; } firebaseChatListenerAttached = false;
     if(chatWindow) chatWindow.style.display = 'none'; const initiationContainer = document.getElementById('chatInitiationFormContainer'); if(initiationContainer) initiationContainer.style.display = 'block'; currentChatChannelId = null; currentChatPartnerData = null; if(targetUserIdInput) targetUserIdInput.value = ''; if(chatMessageInput) chatMessageInput.value = ''; showStatus(chatInitiationStatus, "", false); console.log("Chat window closed and listeners detached.");
}

async function sendChatMessage(content) { /* ... (Unchanged) ... */
     if (!currentChatChannelId || !currentUser) return; let messageData = { senderId: currentUser.uniqueId, senderName: currentUser.name || 'User', senderPic: currentUser.profileImageUrl || 'placeholder-profile.png', timestamp: firebase.database.ServerValue.TIMESTAMP }; let isTextMessage = false;
     if (typeof content === 'string' && content.trim() !== '') { messageData.text = content.trim(); isTextMessage = true; } else if (content && content.imageUrl) { messageData.imageUrl = content.imageUrl; } else { return; }
     sendMessageBtn.disabled = true; const imageSendButton = chatInputArea.querySelector('button[title="फोटो भेजें"]'); if (imageSendButton) imageSendButton.disabled = true;
     try { await chatsRef.child(currentChatChannelId).push().set(messageData); if (isTextMessage) { chatMessageInput.value = ''; chatMessageInput.focus(); } console.log("Message sent."); console.warn("BACKEND NEEDED: Trigger Pusher for new chat message."); } catch (error) { console.error("चैट संदेश भेजने में त्रुटि:", error); alert("संदेश भेजने में त्रुटि हुई।"); } finally { sendMessageBtn.disabled = false; if (imageSendButton) imageSendButton.disabled = false; }
}

function displayChatMessage(messageData, messageId) { /* ... (Unchanged - handles text/image display) ... */
    if (!messageData || !messageData.senderId || document.getElementById(`msg-${messageId}`)) { return; } const isSent = messageData.senderId === currentUser?.uniqueId; const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message', isSent ? 'sent' : 'received'); messageDiv.id = `msg-${messageId}`;
    if (messageData.text) { const textSpan = document.createElement('span'); textSpan.innerHTML = messageData.text .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); messageDiv.appendChild(textSpan); }
    if (messageData.imageUrl) { const img = document.createElement('img'); img.src = messageData.imageUrl; img.alt = "Chat Image"; img.classList.add('chat-image-thumbnail'); img.dataset.fullImageUrl = messageData.imageUrl; img.addEventListener('click', (event) => { event.preventDefault(); openImageModal(event.currentTarget.dataset.fullImageUrl); }); img.onload = scrollToBottom; messageDiv.appendChild(img); }
    const timeSpan = document.createElement('span'); timeSpan.classList.add('message-time'); timeSpan.textContent = formatTimestamp(messageData.timestamp); messageDiv.appendChild(timeSpan);
    const systemMsg = chatMessagesDiv.querySelector('.system-message:not(.note)'); if (systemMsg) systemMsg.remove(); chatMessagesDiv.appendChild(messageDiv); scrollToBottom();
}

async function handleChatImageUpload(event) { /* ... (Unchanged) ... */
    const file = event.target.files[0]; if (!file) return; if (!currentChatChannelId) { alert("कृपया पहले चैट शुरू करें।"); event.target.value = null; return; } showStatus(chatInitiationStatus, "चैट इमेज अपलोड हो रही है...", false); const uploadButton = event.target.nextElementSibling; const sendButton = document.getElementById('sendMessageBtn'); if (uploadButton) uploadButton.disabled = true; if (sendButton) sendButton.disabled = true;
    try { const imageUrl = await uploadImageToImgBB(file, chatInitiationStatus); if (imageUrl) { await sendChatMessage({ imageUrl: imageUrl }); showStatus(chatInitiationStatus, "इमेज भेजी गई!", false, 2000); } else { showStatus(chatInitiationStatus, "इमेज अपलोड विफल (URL नहीं मिला)।", true, 3000); } } catch (error) { console.error("Chat image upload/send failed:", error); showStatus(chatInitiationStatus, `इमेज भेजने में त्रुटि: ${error.message}`, true, 5000); } finally { if (uploadButton) uploadButton.disabled = false; if (sendButton) sendButton.disabled = false; event.target.value = null; }
}

function openImageModal(imageUrl) { /* ... (Unchanged) ... */ if (!imageUrl) return; modalImage.src = imageUrl; imageModal.style.display = "block"; }
function closeImageModal() { /* ... (Unchanged) ... */ imageModal.style.display = "none"; modalImage.src = ""; }
function scrollToBottom() { /* ... (Unchanged) ... */ setTimeout(() => { if (chatMessagesDiv) { chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; } }, 150); } // Slightly increased delay

function subscribeToChatChannel(channelId) { /* ... (Unchanged - handles Pusher/Firebase subscription) ... */
    if (!activePusherChatChannel || activePusherChatChannel.name !== `presence-${channelId}`) { if (activePusherChatChannel) { try { activePusherChatChannel.unbind_all(); pusher.unsubscribe(activePusherChatChannel.name); console.log(`Unsubscribed previous Pusher: ${activePusherChatChannel.name}`); } catch(e) { console.warn("Pusher unsubscribe error:", e); } } const pusherChannelName = `presence-${channelId}`; console.log(`Subscribing Pusher: ${pusherChannelName}`); try { activePusherChatChannel = pusher.subscribe(pusherChannelName); activePusherChatChannel.bind('pusher:subscription_succeeded', () => { console.log(`Pusher subscription OK: ${pusherChannelName}`); }); activePusherChatChannel.bind('pusher:subscription_error', (status) => { console.error(`Pusher subscription error for ${pusherChannelName}:`, status); }); activePusherChatChannel.bind('new_message', (data) => { console.log("Pusher received new_message:", data); }); } catch (error) { console.error("Error subscribing to Pusher channel:", error); activePusherChatChannel = null; } }
    fetchChatHistory(channelId); listenForNewFirebaseMessages(channelId);
}

function fetchChatHistory(channelId) { /* ... (Unchanged) ... */
    const specificChatRef = chatsRef.child(channelId); console.log(`Workspaceing chat history for: ${channelId}`); specificChatRef.orderByChild('timestamp').limitToLast(50).once('value')
        .then(snapshot => { if (!chatMessagesDiv) return; chatMessagesDiv.innerHTML = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { displayChatMessage(childSnapshot.val(), childSnapshot.key); }); console.log(`Workspaceed ${snapshot.numChildren()} messages.`); } else { chatMessagesDiv.innerHTML = '<p class="system-message">यह आपकी पहली चैट है। कोई संदेश नहीं।</p>'; } scrollToBottom(); })
        .catch(error => { console.error("Error fetching chat history:", error); if (chatMessagesDiv) { chatMessagesDiv.innerHTML = '<p class="system-message error">चैट हिस्ट्री लोड करने में त्रुटि।</p>'; } });
}

function listenForNewFirebaseMessages(channelId) { /* ... (Unchanged - handles listener attachment/detachment) ... */
    if (currentFirebaseListener && currentFirebaseListener.ref && currentFirebaseListener.handler) { try { currentFirebaseListener.ref.off('child_added', currentFirebaseListener.handler); console.log("Detached previous Firebase chat listener."); } catch(e){ console.warn("Error detaching previous chat listener:", e); } currentFirebaseListener = null; } firebaseChatListenerAttached = false;
    const specificChatRef = chatsRef.child(channelId); const query = specificChatRef.orderByChild('timestamp').startAt(Date.now()); console.log(`Attaching Firebase 'child_added' listener for new messages on chat: ${channelId}`);
    const messageHandler = query.on('child_added', (snapshot) => { if (!firebaseChatListenerAttached) { console.warn("Firebase listener fired but flag is false."); try { snapshot.ref.off('child_added', messageHandler); } catch(e){} return; } console.log("Firebase listener: new message received", snapshot.key); if (snapshot.exists()) { displayChatMessage(snapshot.val(), snapshot.key); } }, (error) => { console.error(`Firebase chat listener error for ${channelId}:`, error); firebaseChatListenerAttached = false; currentFirebaseListener = null; });
    currentFirebaseListener = { ref: query, handler: messageHandler, channelId: channelId }; firebaseChatListenerAttached = true;
}

// --- NOTIFICATIONS ---
function displayNotification(message) { /* ... (Unchanged) ... */ const notification = document.createElement('div'); notification.className = 'notification'; notification.textContent = message; const closeBtn = document.createElement('button'); closeBtn.innerHTML = '&times;'; closeBtn.setAttribute('aria-label', 'Close Notification'); closeBtn.style.cssText = 'background:none;border:none;color:white;float:right;margin-left:10px;font-size:1.2em;line-height:1;cursor:pointer;padding:0;'; let timerId = null; closeBtn.onclick = () => { if (notification.parentNode) { notification.classList.add('fade-out'); setTimeout(() => { if(notification.parentNode) notification.parentNode.removeChild(notification); }, 500); } clearTimeout(timerId); }; notification.appendChild(closeBtn); notificationArea.appendChild(notification); timerId = setTimeout(() => { closeBtn.onclick(); }, 5000); }
function subscribeToPublicNotifications() { /* ... (Unchanged) ... */ if (publicPusherChannel) return; const channelName = 'public-requests'; console.log(`Subscribing Pusher: ${channelName}`); try { publicPusherChannel = pusher.subscribe(channelName); publicPusherChannel.bind('pusher:subscription_succeeded', () => console.log(`Subscribed Pusher: ${channelName}`)); publicPusherChannel.bind('pusher:subscription_error', (status) => { console.error(`Pusher sub error ${channelName}:`, status); publicPusherChannel = null; }); publicPusherChannel.bind('new-request', (data) => { console.log("Pusher: New request notification received:", data); if (currentUser && data && data.requestData && data.requestData.userId !== currentUser.uniqueId) { const typeText = data.requestData.type === 'cash' ? 'कैश' : 'UPI'; const amount = data.requestData.amount || '?'; displayNotification(`नया ${typeText} रिक्वेस्ट आया है (₹${amount})`); /* Note: This doesn't update the count indicator directly, recalculatePendingRequests handles that */ } }); } catch (error) { console.error("Error subscribing to public Pusher channel:", error); publicPusherChannel = null; } }
function unsubscribePublicNotifications() { /* ... (Unchanged) ... */ if (publicPusherChannel) { try { publicPusherChannel.unbind_all(); pusher.unsubscribe(publicPusherChannel.name); console.log(`Unsubscribed Pusher: ${publicPusherChannel.name}`); } catch(e) { console.warn("Error unsubscribing public Pusher channel:", e); } publicPusherChannel = null; } }

// --- INITIAL LOAD ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Loaded. Initializing...");
    console.warn("SECURITY WARNING: API keys exposed.");
    console.warn("BACKEND NEEDED: Pusher triggers.");

    initializeChat(); // Setup chat form/button/modal listeners
    initializeProfileManagement(); // Setup profile upload listener
    initializeRequestFormsModal(); // Setup request form modal listeners

    showAuthSection('loginSection');
    loginBtn.disabled = false;

    console.log("Initialization complete. Showing Login screen.");
});
  </script>

</body>
</html>
