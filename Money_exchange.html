// --- CONFIGURATION ---
const dataUrl = 'https://script.google.com/macros/s/AKfycbz9LCkPR8L3-i7F1KG2KUJ6It2l_p55murljRJ_4108nFysOXUOpG5WEs1sdEaGHq1L7w/exec';
const CORRECT_PASSWORD = "7536";
const defaultProfilePic = 'https://i.postimg.cc/XNpR3cN1/20241030-065157.png';

// --- GLOBAL VARIABLES ---
let allData = [];
let distributionChartInstance = null; // To hold the chart instance

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
    setupPasswordPrompt();
});

function setupPasswordPrompt() {
    const passwordContainer = document.getElementById('passwordPromptContainer');
    const passwordInput = document.getElementById('passwordInput');
    const passwordSubmit = document.getElementById('passwordSubmit');
    
    passwordContainer.classList.remove('hidden');
    passwordInput.focus();

    const checkPassword = () => {
        if (passwordInput.value === CORRECT_PASSWORD) {
            passwordContainer.classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            fetchData();
        } else {
            alert("Incorrect PIN");
            passwordInput.value = "";
            passwordInput.focus();
        }
    };

    passwordSubmit.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => e.key === 'Enter' && checkPassword());
}

// --- DATA FETCHING AND PROCESSING ---
async function fetchData() {
    try {
        const response = await fetch(dataUrl);
        const rawData = await response.json();

        allData = rawData.map(row => ({
            Date: new Date(row.Date),
            Name: String(row.Name).trim(),
            Loan: parseFloat(row.Loan) || 0,
            Payment: parseFloat(row.Payment) || 0,
            SipPayment: parseFloat(row["SIP Payment"]) || 0,
            ImageUrl: row.imageUrl || null
        })).filter(r => r.Name && !isNaN(r.Date.getTime()));

        allData.sort((a, b) => a.Date - b.Date);
        initializeDashboard();

    } catch (error) {
        console.error("Error fetching data:", error);
        document.body.innerHTML = `<div style="text-align:center; padding:50px; color:red;">Failed to load data. Please check the console and refresh.</div>`;
    } finally {
        document.getElementById('loader').classList.add('hidden');
    }
}

// --- DASHBOARD SETUP ---
function initializeDashboard() {
    const dashboard = document.getElementById('dashboardContent');
    dashboard.classList.remove('hidden');
    setTimeout(() => dashboard.classList.add('visible'), 50); // For fade-in animation

    populateMemberFilter();
    setupEventListeners();
    updateDisplay();
}

function setupEventListeners() {
    document.getElementById('memberFilter').addEventListener('change', updateDisplay);
    
    // Setup modal close events
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.querySelector('.modal-close').addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => (e.target === modal) && modal.classList.add('hidden'));
    });

    // Setup return view button
    document.getElementById('showReturnViewBtn').addEventListener('click', displayOverallReturnView);
}

function populateMemberFilter() {
    const nameFilter = document.getElementById("memberFilter");
    const memberNames = [...new Set(allData.map(row => row.Name))].sort();
    
    memberNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nameFilter.appendChild(option);
    });
}

// --- CORE DISPLAY LOGIC ---
function updateDisplay() {
    const selectedName = document.getElementById('memberFilter').value;
    updateProfileCard(selectedName);
    populateProfitLog(selectedName);
}

function updateProfileCard(name) {
    const profileImageEl = document.getElementById('profileImage');
    const profileNameEl = document.getElementById('profileName');
    const totalLoanEl = document.getElementById('profileTotalLoan');
    const totalPaymentEl = document.getElementById('profileTotalPayment');
    const balanceEl = document.getElementById('profileCurrentBalance');
    const totalProfitEl = document.getElementById('profileTotalProfit');

    let totalLoan = 0;
    let totalPayment = 0;
    let totalProfit = 0;

    if (name === 'all') {
        // Community Overview
        allData.forEach(r => {
            totalLoan += r.Loan;
            totalPayment += r.Payment + r.SipPayment;
        });
        
        // NEW: Calculate total distributed profit for the community view
        allData.filter(r => r.Payment > 0).forEach(payment => {
            const result = calculateProfitDistribution(payment);
            if (result && result.profit > 0) {
                totalProfit += result.profit;
            }
        });

        profileNameEl.textContent = 'Community Overview';
        profileImageEl.src = defaultProfilePic;
    } else {
        // Single Member View
        const dataToShow = allData.filter(r => r.Name === name);
        dataToShow.forEach(r => {
            totalLoan += r.Loan;
            totalPayment += r.Payment + r.SipPayment;
        });
        totalProfit = calculateTotalProfitForMember(name);
        
        profileNameEl.textContent = name;
        const lastUserEntryWithImage = [...dataToShow].reverse().find(r => r.ImageUrl);
        profileImageEl.src = lastUserEntryWithImage ? lastUserEntryWithImage.ImageUrl : defaultProfilePic;
    }

    const balance = totalPayment - totalLoan;
    
    totalLoanEl.textContent = `₹${totalLoan.toFixed(2)}`;
    totalPaymentEl.textContent = `₹${totalPayment.toFixed(2)}`;
    balanceEl.textContent = `₹${balance.toFixed(2)}`;
    balanceEl.className = `value ${balance >= 0 ? 'positive' : 'negative'}`;
    totalProfitEl.textContent = `₹${totalProfit.toFixed(2)}`;
    totalProfitEl.className = `value ${totalProfit > 0 ? 'positive' : ''}`;
}


// --- PROFIT CALCULATION AND DISPLAY ---
function populateProfitLog(selectedName) {
    const tableBody = document.querySelector("#profitLogTable tbody");
    tableBody.innerHTML = '';
    
    const paymentEvents = allData.filter(r => r.Payment > 0);
    let profitEventsFound = 0;

    paymentEvents.forEach(paymentRecord => {
        const result = calculateProfitDistribution(paymentRecord);

        if (result && result.profit > 0) {
            if (selectedName !== 'all' && paymentRecord.Name !== selectedName) {
                return;
            }
            
            profitEventsFound++;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(paymentRecord.Date)}</td>
                <td>${paymentRecord.Name}</td>
                <td>₹${result.loan.Loan.toFixed(2)}</td>
                <td>₹${paymentRecord.Payment.toFixed(2)}</td>
                <td class="profit-value">₹${result.profit.toFixed(2)}</td>
                <td><button class="details-btn">View</button></td>
            `;

            row.querySelector('.details-btn').addEventListener('click', () => {
                showDistributionModal(result.distribution);
            });
            tableBody.appendChild(row);
        }
    });
    
    if (profitEventsFound === 0) {
        tableBody.innerHTML = `<tr class="no-data-row"><td colspan="6">No profit events found for this selection.</td></tr>`;
    }
}

function calculateTotalProfitForMember(memberName) {
    if (memberName === 'all') return 0;
    let totalProfit = 0;
    const paymentEvents = allData.filter(r => r.Payment > 0);

    paymentEvents.forEach(payment => {
        const result = calculateProfitDistribution(payment);
        if (result && result.distribution.length > 0) {
            const memberShare = result.distribution.find(d => d.name === memberName);
            if (memberShare) {
                totalProfit += memberShare.share;
            }
        }
    });
    return totalProfit;
}

function calculateProfitDistribution(paymentRecord) {
    const correspondingLoan = allData
        .filter(r => r.Name === paymentRecord.Name && r.Loan > 0 && r.Date < paymentRecord.Date)
        .pop(); // Get the most recent loan before this payment

    if (!correspondingLoan) return null;
    
    const profit = paymentRecord.Payment - correspondingLoan.Loan;
    if (profit <= 0) return null;

    const loanDate = correspondingLoan.Date;
    const transactionsBeforeLoan = allData.filter(r => r.Date < loanDate);
    
    const memberBalancesAtLoanTime = {};
    transactionsBeforeLoan.forEach(r => {
        memberBalancesAtLoanTime[r.Name] = (memberBalancesAtLoanTime[r.Name] || 0) + (r.Payment + r.SipPayment - r.Loan);
    });
    
    const positiveBalances = Object.entries(memberBalancesAtLoanTime).filter(([name, balance]) => balance > 0);
    const totalCommunityCapital = positiveBalances.reduce((sum, [, balance]) => sum + balance, 0);

    if (totalCommunityCapital <= 0) return null;

    const distribution = [];
    positiveBalances.forEach(([name, balance]) => {
        const share = (balance / totalCommunityCapital) * profit;
        distribution.push({ name, share });
    });
    
    return {
        profit,
        loan: correspondingLoan,
        payment: paymentRecord,
        distribution: distribution.sort((a,b) => b.share - a.share)
    };
}

// --- MODAL AND UTILITY FUNCTIONS ---
function showDistributionModal(distributionData) {
    const modal = document.getElementById('detailsModal');
    const listEl = document.getElementById('distributionDetails');
    listEl.innerHTML = '';

    // NEW: Chart.js implementation
    const ctx = document.getElementById('distributionChart').getContext('2d');
    if (distributionChartInstance) {
        distributionChartInstance.destroy(); // Destroy previous chart to prevent conflicts
    }

    if (distributionData.length === 0) {
        listEl.innerHTML = '<li>No beneficiaries found.</li>';
    } else {
        // Prepare data for the chart and list
        const labels = distributionData.map(d => d.name);
        const data = distributionData.map(d => d.share.toFixed(2));
        
        distributionData.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="name">${item.name}</span> <span class="share">+ ₹${item.share.toFixed(2)}</span>`;
            listEl.appendChild(li);
        });

        // Create the new chart
        distributionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Profit Share (₹)',
                    data: data,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // Horizontal bars
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Amount (₹)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    modal.classList.remove('hidden');
}

function displayOverallReturnView() {
    const memberNames = [...new Set(allData.map(row => row.Name))];
    let memberProfits = memberNames.map(name => ({
        name: name,
        totalProfit: calculateTotalProfitForMember(name)
    })).filter(member => member.totalProfit > 0);

    memberProfits.sort((a, b) => b.totalProfit - a.totalProfit);

    const modal = document.getElementById('returnViewModal');
    const listEl = document.getElementById('returnViewList');
    listEl.innerHTML = '';

    if (memberProfits.length === 0) {
        listEl.innerHTML = '<li>No members have earned a return yet.</li>';
    } else {
        memberProfits.forEach((member, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span class="rank">${index + 1}.</span>
                <span class="name">${member.name}</span>
                <span class="share">+ ₹${member.totalProfit.toFixed(2)}</span>
            `;
            listEl.appendChild(li);
        });
    }
    
    modal.classList.remove('hidden');
}

function formatDate(date) {
    if (!(date instanceof Date) || isNaN(date)) return "N/A";
    return date.toLocaleDateString('en-GB', {
        day: '2-digit', month: 'short', year: 'numeric'
    });
}