<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§¨‡•à‡§Ç‡§ï ‡§ö‡•à‡§ü‡§¨‡•â‡§ü</title>
    <style>
        :root {
            --primary-color: #4caf50; /* Green */
            --secondary-color: #f0f2f5; /* Light grey background */
            --user-message-bg: #dcf8c6; /* Light green */
            --bot-message-bg: #ffffff; /* White */
            --text-dark: #333333;
            --text-light: #555555;
            --border-color: #dddddd;
            --suggestion-bg: #e9f5e9;
            --suggestion-hover-bg: #c8e6c9;
            --header-height: 60px;
            --input-area-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: var(--secondary-color);
            overflow: hidden; /* Prevent body scroll */
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%; /* Full height */
            width: 100%; /* Full width */
            max-width: 800px; /* Max width for larger screens */
            margin: 0 auto; /* Center on larger screens */
            background: var(--bot-message-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0; /* No radius for full screen */
        }
        @media (min-width: 801px) {
             .chat-container {
                 height: 90vh; /* Slightly less height on desktop */
                 max-height: 750px;
                 margin: 20px auto;
                 border-radius: 10px;
             }
        }

        .chat-header {
            height: var(--header-height);
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: bold;
            padding: 0 20px;
            flex-shrink: 0; /* Prevent header from shrinking */
            border-top-left-radius: inherit; /* Inherit from container */
            border-top-right-radius: inherit;
        }
        .chat-header .icon {
            margin-right: 10px;
            font-size: 1.5em; /* Adjust icon size */
        }

        .chat-messages {
            flex-grow: 1; /* Take available space */
            padding: 15px 10px;
            overflow-y: auto; /* Enable scrolling ONLY for messages */
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between messages */
        }

        .message {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 85%;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-size: 0.95em;
        }
        /* Basic link styling */
        .message a {
            color: #0066cc;
            text-decoration: underline;
        }
        .message a:hover {
             color: #004c99;
        }
        /* Paragraphs inside message */
        .message p {
            margin-bottom: 8px;
        }
        .message p:last-child {
            margin-bottom: 0;
        }
        /* Lists inside message */
        .message ul, .message ol {
            margin-left: 20px; /* Indent lists */
            margin-bottom: 8px;
            padding-left: 10px; /* Add padding for list markers */
        }
        .message ul li {
            margin-bottom: 5px; /* Space between list items */
        }
        /* Image styling */
        .message img {
            max-width: 100%; /* Ensure image fits bubble */
            height: auto; /* Maintain aspect ratio */
            max-height: 200px; /* Limit image height */
            display: block; /* Prevent extra space below image */
            margin-top: 8px; /* Space above image */
            border-radius: 8px; /* Rounded corners */
        }


        .user {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            color: var(--text-dark);
            border-bottom-right-radius: 6px;
        }

        .bot {
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            color: var(--text-dark);
            border: 1px solid #f0f0f0;
            border-bottom-left-radius: 6px;
        }
        .bot.typing {
            color: var(--text-light);
            font-style: italic;
            background-color: transparent;
            border: none;
            box-shadow: none;
        }

        /* Suggestions IN CHAT */
         .suggestion-group {
             background-color: var(--bot-message-bg);
             border: 1px solid var(--border-color);
             padding: 15px;
             margin-top: 5px;
             border-radius: 15px;
             align-self: flex-start; /* Align like bot messages */
             max-width: 85%;
         }
         .suggestion-group .group-title {
             font-weight: bold;
             margin-bottom: 12px;
             color: var(--text-light);
             font-size: 0.9em;
         }
         .chat-suggestion {
             display: block;
             background-color: var(--suggestion-bg);
             color: var(--primary-color);
             padding: 10px 14px;
             border-radius: 8px;
             cursor: pointer;
             font-size: 0.9em;
             margin-bottom: 6px;
             border: 1px solid #d0e0d0;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             text-align: left;
             font-weight: 500;
         }
         .chat-suggestion:hover {
             background-color: var(--suggestion-hover-bg);
             border-color: #b0c0b0;
         }
         .chat-suggestion:last-child {
             margin-bottom: 0;
         }

        /* Input Area */
        .chat-input-area { /* Renamed container */
            height: var(--input-area-height);
            display: flex;
            align-items: center; /* Center items vertically */
            border-top: 1px solid var(--border-color);
            background-color: #ffffff;
            padding: 8px 10px; /* Padding around input/button */
            flex-shrink: 0; /* Prevent input area from shrinking */
            position: relative; /* For suggestions box positioning */
        }
        .chat-input-area input {
            flex-grow: 1;
            height: 100%;
            padding: 0 15px; /* Padding inside input */
            border: 1px solid var(--border-color);
            border-radius: 20px; /* Rounded input */
            font-size: 1em;
            outline: none;
            margin-right: 8px; /* Space between input and button */
        }
        .chat-input-area input:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .chat-input-area button {
            height: 100%;
            padding: 0 20px;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            border-radius: 20px; /* Rounded button */
            transition: background-color 0.2s ease;
        }
        .chat-input-area button:hover {
            background: #45a049; /* Darker green */
        }

        /* Suggestions ABOVE input */
        .suggestions {
            position: absolute;
            bottom: calc(var(--input-area-height) + 5px); /* Position above input area */
            left: 10px; /* Align with input area padding */
            right: 10px; /* Align with input area padding */
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
            background: #ffffff;
            border: 1px solid var(--border-color);
            max-height: 200px; /* More height for suggestions */
            overflow-y: auto;
            z-index: 100; /* Ensure suggestions are on top */
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .suggestion {
            background: #f1f1f1;
            color: var(--text-dark);
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            text-align: left;
            border: 1px solid transparent;
            transition: background-color 0.2s ease;
        }
        .suggestion:hover {
           background: #e0e0e0;
        }

    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <span class="icon">üè¶</span>Bank community chatbot üí¨
    </div>
    <div class="chat-messages" id="chat">
        <div class="message bot">
            ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§î‡§∞ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§π‡•Ç‡§Å‡•§ ‡§Ü‡§™ ‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§®‡•Ä‡§ö‡•á ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
        </div>
    </div>
    <div class="suggestions" id="suggestions" style="display:none;"></div>
    <div class="chat-input-area">
        <input id="input" type="text" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á '‡§Ö‡§Æ‡§ø‡§§ ‡§ï‡•Å‡§Æ‡§æ‡§∞ ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏')..." oninput="showSuggestions(this.value)" onkeyup="handleKey(event)" autocomplete="off">
        <button onclick="send()" aria-label="‡§≠‡•á‡§ú‡•á‡§Ç">‡§≠‡•á‡§ú‡•á‡§Ç</button>
    </div>
</div>

<script>
    // --- API Keys and URLs ---
    // !!! ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ø‡§π ‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä API ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§π‡•à ‡§î‡§∞ ‡§Ö‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§π‡•à‡•§ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ !!!
    const API_KEY = "AIzaSyBwhJNl7Rw4Xwb8esmsIes5uVX2fWlRnSE"; // Replace with your SECURE Gemini API Key
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbz9LCkPR8L3-i7F1KG2KUJ6It2l_p55murljRJ_4108nFysOXUOpG5WEs1sdEaGHq1L7w/exec"; // Google Sheet API URL

    // 1. Hardcoded data segments (Knowledge Base for General Rules)
    const dataSegments = [
      // ... (‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ dataSegments ‡§ê‡§∞‡•á ‡§Ø‡§π‡§æ‡§Å ‡§∞‡§ñ‡•á‡§Ç) ...
      // Example structure:
      {
        "question": "bank community loan kya hai?",
        "answer": "‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§è‡§ï ‡§¨‡§ö‡§§ ‡§î‡§∞ ‡§ã‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§π‡•à, ‡§ú‡•ã ‡§õ‡•ã‡§ü‡•á ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§ï‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§î‡§∞ ‡§∏‡§π‡§Ø‡•ã‡§ó ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Æ‡§¶‡§¶ ‡§™‡§π‡•Å‡§Ç‡§ö‡§æ‡§§‡•Ä ‡§π‡•à‡•§"
      },
      {
        "question": "ye yojana kaise kaam karti hai?",
        "answer": "‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§≤‡•á‡§ï‡§∞ ‡§Ü‡§™ ‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§è‡§ï ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§∞‡§æ‡§∂‡§ø SIP (‡§™‡§π‡§≤‡•á EMI) ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ú‡§¨ ‡§Ü‡§™‡§ï‡•ã ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à, ‡§Ü‡§™ ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡•á ‡§Ö‡§®‡•Å‡§™‡§æ‡§§ ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§π‡§Ø‡•ã‡§ó ‡§∏‡•á ‡§≤‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§"
      },
       {
        "question": "sip monthly emi ki rashi aur samay seema kya hai?",
        "answer": "‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä 1 ‡§∏‡•á 10 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‚Çπ500 SIP ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§"
      },
      {
        "question": "sip bounce hone par kya hota hai?",
        "answer": "‡§Ø‡§¶‡§ø SIP 2‚Äì3 ‡§¨‡§æ‡§∞ ‡§¨‡§æ‡§â‡§Ç‡§∏ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ 1 ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§¶‡•ç‡§¶ ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§"
      },
      {
        "question": "sadasyata radd hone par kya milega?",
        "answer": "‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§≤‡•å‡§ü‡§æ‡§à ‡§ú‡§æ‡§è‡§ó‡•Ä, ‡§≤‡•á‡§ï‡§ø‡§® ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ‡•§"
      },
      {
        "question": "loan lene ke liye kya zaruri hai?",
        "answer": "‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡•ã ‡§≤‡•ã‡§® ‡§´‡•â‡§∞‡•ç‡§Æ ‡§≠‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§î‡§∞ ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§ï‡§ø ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ã‡§à ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§® ‡§π‡•ã‡•§"
      },
      {
        "question": "loan ki kist aur avadhi kaisi hogi?",
        "answer": "‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§§ 31 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§π‡•ã‡§ó‡•Ä; ‡§¶‡•á‡§∞‡•Ä ‡§∏‡•á ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§™‡§∞ ‡§Ö‡§ó‡§≤‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§§ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º ‡§ú‡§æ‡§è‡§ó‡§æ‡•§"
      },
      {
        "question": "free loan kya hai?",
        "answer": "Free Loan: ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§¨‡§æ‡§∞ ‚Çπ1000 ‡§§‡§ï 5 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§≤‡•á‡§ü ‡§´‡§æ‡§á‡§® ‚Çπ10 ‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§ø‡§®‡•§"
      },
      {
        "question": "aap kitna loan le sakte hain?",
        "answer": "‡§Ü‡§™ ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ 1.5√ó ‡§§‡§ï ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§¶‡•ã‡§ó‡•Å‡§®‡§æ ‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡§æ ‡§π‡•ã, ‡§§‡•ã 2% ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡•á‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§"
      },
      {
        "question": "late fine par byaj kaise lagu hoga?",
        "answer": "‡§Ø‡§¶‡§ø ‡§≤‡•ã‡§® 31 ‡§¶‡§ø‡§® ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§∞‡§π‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§Ö‡§ó‡§≤‡•á ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡§æ‡•§"
      },
      {
        "question": "loan kist der se hone par kya suchna deni hogi?",
        "answer": "‡§≤‡•ã‡§® ‡§ï‡§ø‡§∏‡•ç‡§§ ‡§¶‡•á‡§∞ ‡§∏‡•á ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ SMS ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à; ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã ‚Çπ10 ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä ‡§≤‡§ó‡•á‡§ó‡•Ä‡•§"
      },
      {
        "question": "kist bounce hone par kya hoga?",
        "answer": "‡§ï‡§ø‡§∏‡•ç‡§§ ‡§¨‡§æ‡§â‡§Ç‡§∏ ‡§π‡•ã‡§®‡•á ‡§î‡§∞ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á‡§®‡•á ‡§™‡§∞ 60 ‡§¶‡§ø‡§® ‡§§‡§ï ‡§≤‡•ã‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ (‡§¶‡•ã ‡§¨‡§æ‡§∞ ‡§¨‡§æ‡§â‡§Ç‡§∏ ‡§™‡§∞)‡•§"
      },
      {
        "question": "emi par loan lene par kya sharten hain?",
        "answer": "EMI ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§™‡§∞ ‡§≤‡•ã‡§® ‡§™‡§∞ 8% ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§≤‡§ó‡•á‡§ó‡§æ ‡§î‡§∞ ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§Ö‡§µ‡§ß‡§ø 3 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§π‡•ã‡§ó‡•Ä (‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§∞‡§æ‡§∂‡§ø ‚Çπ2500)‡•§"
      },
      {
        "question": "naya sadasya kaise judta hai?",
        "answer": "‡§®‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¨‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ (1‚Äì5 ‡§§‡§æ‡§∞‡•Ä‡§ñ) ‡§Æ‡•á‡§Ç ‚Çπ500 ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à; ‡§≤‡•ã‡§® ‡§ï‡•á‡§µ‡§≤ 60 ‡§¶‡§ø‡§® ‡§¨‡§æ‡§¶ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•ã‡§ó‡§æ‡•§"
      },
      {
        "question": "ek mahine ke loan par charge kya hai?",
        "answer": "1‚Äì31 ‡§¶‡§ø‡§® ‡§§‡§ï ‡§ï‡•á ‡§≤‡•ã‡§® ‡§™‡§∞ 1% ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§π‡•ã‡§ó‡§æ‡•§"
      },
      {
        "question": "do mahine ke loan par penalty kya hai?",
        "answer": "32‚Äì60 ‡§¶‡§ø‡§® ‡§§‡§ï ‡§ï‡•á ‡§≤‡•ã‡§® ‡§™‡§∞ 3% ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä ‡§≤‡§ó‡•á‡§ó‡•Ä‡•§"
      },
      {
        "question": "teen mahine ke loan par penalty kya hogi?",
        "answer": "61+ ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è 5% ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä (RED MEMBER) ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡•Ä‡•§"
      },
      {
        "question": "civil score kya hai?",
        "answer": "‚Çπ100 ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ 10 ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º‡§§‡•á ‡§π‡•à‡§Ç‡•§"
      },
      {
        "question": "loan payment aur punah loan lene ki shart?",
        "answer": "‡§ú‡§ø‡§∏ ‡§¶‡§ø‡§® ‡§Ü‡§™ ‡§≤‡•ã‡§® ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á, ‡§â‡§∏ ‡§¶‡§ø‡§® ‡§´‡§ø‡§∞ ‡§≤‡•ã‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ; ‡§Ö‡§ó‡§≤‡•á ‡§¶‡§ø‡§® ‡§Ü‡§™ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§"
      },
      {
        "question": " member exit kaise hoga?",
        "answer": "Exit ‡§ï‡•á ‡§≤‡§ø‡§è 60 ‡§¶‡§ø‡§® ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è ‡§î‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§≠‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à; 1‚Äì10 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø ‡§è‡§µ‡§Ç ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§ó‡§æ‡•§ 60 ‡§¶‡§ø‡§® ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§®‡§ø‡§ï‡§≤‡•á ‡§™‡§∞ 10% ‡§ï‡§ü‡•å‡§§‡•Ä‡•§"
      },
      {
        "question": "board member kaun-kaun hain?",
        "answer": "Prime Members: Amit Kumar, Mithilesh Sahni, Prince Kumar. ‡§á‡§®‡•ç‡§π‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§ú‡§Æ‡§æ ‡§î‡§∞ ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ö‡•Å‡§®‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§"
      },
      {
        "question": "board member ki jimmedariyan kya hain?",
        "answer": "‡§∏‡§≠‡•Ä ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§ó, ‡§≤‡•ã‡§® ‡§µ‡§ø‡§§‡§∞‡§£, ‡§´‡§Ç‡§° ‡§Æ‡•â‡§®‡§ø‡§ü‡§∞‡§ø‡§Ç‡§ó, ‡§®‡§è ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä, ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏‡•§"
      },
      {
        "question": "board member banne ke niyam kya hain?",
        "answer": "‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§ú‡§Æ‡§æ, ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ, 70% ‡§∏‡§π‡§Æ‡§§‡§ø ‡§∏‡•á ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø, ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§®‡•á‡§ó‡•á‡§ü‡§ø‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§"
      },
      {
        "question": "guarantor banne ke liye kya avashyaktaen hain?",
        "answer": "6 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§∏‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø, ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‚â•200, ‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ, ‡§§‡§Ø ‡§∂‡§∞‡•ç‡§§‡•ã‡§Ç ‡§ï‡§æ ‡§™‡§æ‡§≤‡§®‡•§"
      },
      {
        "question": "naye member jodne ki sharten kya hain?",
        "answer": "‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§ï‡•Ä ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä, 1 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Ö‡§ó‡•ç‡§∞‡§ø‡§Æ ‡§ú‡§Æ‡§æ, ‡§™‡•É‡§∑‡•ç‡§†‡§≠‡•Ç‡§Æ‡§ø ‡§ú‡§æ‡§Å‡§ö ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø‡•§"
      },
      {
        "question": "meeting aur paradarshita kaise sunishchit hoti hai?",
        "answer": "‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§ú‡§Æ‡§æ/‡§≤‡•ã‡§® ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°, ‡§Æ‡•á‡§Ç‡§¨‡§∞ ‡§è‡§µ‡§Ç ‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø, ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§™‡§∞ ‡§ö‡§∞‡•ç‡§ö‡§æ‡•§"
      },
      {
        "question": "loan website aur sthaapna ki jankari?",
        "answer": "Website: https://bank-community.github.io/Loan-from -- Estd: 23 June 2024"
      },
      {
        "question": "kya ek vyakti ek saath do loan le sakta hai?",
        "answer": "‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ 1.5 ‡§ó‡•Å‡§®‡§æ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à ‡§î‡§∞ ‚Çπ1000 ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§∞‡§æ‡§∂‡§ø ‡§∂‡•á‡§∑ ‡§π‡•à, ‡§§‡•ã ‡§µ‡§π ‚Çπ1000 ‡§§‡§ï ‡§ï‡§æ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§"
      },
      {
        "question": "loan chukane ke baad turant exit lena sambhav hai kya?",
        "answer": "‡§®‡§π‡•Ä‡§Ç, ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§™‡§π‡§≤‡•á ‡§™‡•Ç‡§∞‡§æ ‡§≤‡•ã‡§® ‡§ö‡•Å‡§ï‡§æ‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§ ‡§≤‡•ã‡§® ‡§ö‡•Å‡§ï‡§æ‡§è ‡§¨‡§ø‡§®‡§æ Exit ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§"
      },
      {
        "question": "bank community mein prime members kaun hain aur sanstha kaise chalti hai?",
        "answer": "Prime Members: Amit Kumar, Prince Kumar, Mithilesh Sahni. ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ WhatsApp Group ‡§î‡§∞ Website ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§ WhatsApp Group Link: https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ"
      },
      {
        "question": "main bank community mein kaise join kar sakta hoon?",
        "answer": "‡§Ü‡§™ ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è ‡§≤‡§ø‡§Ç‡§ï ‡§™‡§∞ ‡§ú‡§æ‡§ï‡§∞ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç: https://bank-community.github.io/Loan-from/newbank.html"
      }
    ];

    const chatBox = document.getElementById("chat");
    const inputBox = document.getElementById("input");
    const suggestionsBox = document.getElementById("suggestions");

    /**
     * Appends a message to the chat box. Handles both text and HTML.
     */
    function appendMessage(content, cls, isHtml = false) {
        const d = document.createElement("div");
        d.className = "message " + cls;
        if (isHtml) {
            // Basic sanitization attempt (replace potential script tags)
            // For robust security, use a proper sanitization library (like DOMPurify) if content isn't fully trusted
            const sanitizedContent = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
            d.innerHTML = sanitizedContent;
        } else {
            d.textContent = content; // Safer default for plain text
        }
        chatBox.appendChild(d);
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        return d;
    }

    /**
     * Finds URLs in text and converts them to clickable HTML links.
     */
    function linkify(text) {
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlRegex, function(url) {
            let fullUrl = url;
            if (!fullUrl.match(/^https?:\/\//i)) {
                 fullUrl = 'http://' + fullUrl;
            }
            const linkText = url.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
        });
    }

     /**
     * Appends a group of clickable question suggestions within the chat.
     */
     function appendSuggestionGroup(title, questions) {
        const groupDiv = document.createElement("div");
        groupDiv.className = "message bot suggestion-group";

        const titleDiv = document.createElement("div");
        titleDiv.className = "group-title";
        titleDiv.textContent = title;
        groupDiv.appendChild(titleDiv);

        questions.forEach(q_text => {
            const suggestionEl = document.createElement("div");
            suggestionEl.className = "chat-suggestion";
            suggestionEl.textContent = q_text;
            suggestionEl.onclick = () => {
                inputBox.value = q_text;
                suggestionsBox.style.display = 'none';
                send();
            };
            groupDiv.appendChild(suggestionEl);
        });

        chatBox.appendChild(groupDiv);
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    /**
     * Shows relevant question suggestions above the input field based on user typing.
     */
    function showSuggestions(text) {
        suggestionsBox.innerHTML = '';
        const lowInput = text.toLowerCase().trim();

        if (lowInput.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const matches = new Set();
         // Include suggestions for specific people if input matches partially
         const nameKeywords = ['amit', 'prince', 'mithilesh']; // Add other common names if needed
         if (nameKeywords.some(kw => lowInput.includes(kw))) {
             matches.add(lowInput.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ') + ' ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£');
         }

        dataSegments.forEach(seg => {
            if (seg.question.toLowerCase().includes(lowInput)) {
                matches.add(seg.question);
            }
        });

        if (matches.size === 0) {
            suggestionsBox.style.display = 'none';
            return;
        }

        Array.from(matches).slice(0, 5).forEach(q_text => {
            const div = document.createElement('div');
            div.className = 'suggestion';
            div.textContent = q_text;
            div.onclick = () => {
                inputBox.value = q_text;
                suggestionsBox.style.display = 'none';
                send();
            };
            suggestionsBox.appendChild(div);
        });
        suggestionsBox.style.display = 'flex';
    }

    /**
     * Handles the Enter key press in the input field.
     */
    function handleKey(event) {
        if (event.key === 'Enter') {
            send();
        }
    }

   /**
    * Displays relevant question suggestions within the chat interface.
    */
   function displayErrorSuggestions(failedQuery = "") {
        // Suggest general questions from dataSegments
        let potentialMatches = [];
        if(failedQuery){
             potentialMatches = dataSegments.filter(seg =>
                seg.question.toLowerCase().includes(failedQuery.toLowerCase()) ||
                failedQuery.toLowerCase().split(' ').some(word => word.length > 2 && seg.question.toLowerCase().includes(word))
            ).map(seg => seg.question);
        }

        const needed = 5 - potentialMatches.length;
        if (needed > 0) {
            const existing = new Set(potentialMatches);
            for (let i = 0; i < dataSegments.length && potentialMatches.length < 5; i++) {
                if (!existing.has(dataSegments[i].question)) {
                    potentialMatches.push(dataSegments[i].question);
                    existing.add(dataSegments[i].question);
                }
            }
        }
        const suggestionsToShow = potentialMatches.slice(0, 5);
        if (suggestionsToShow.length > 0) {
            setTimeout(() => {
                appendSuggestionGroup("‡§Ü‡§™ ‡§∂‡§æ‡§Ø‡§¶ ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•ã‡§à ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç:", suggestionsToShow);
            }, 200);
        }
   }

    /**
     * Extracts a potential name from the user query. Very basic implementation.
     * @param {string} query - The user's input query.
     * @returns {string|null} Extracted name or null.
     */
    function extractNameFromQuery(query) {
        // Simple logic: remove common question words/keywords and assume remaining is name
        const keywords = ['details for', 'status of', 'balance of', 'account of', 'record of', 'ka balance', 'ki details', 'ka status', 'ka record', 'ka hisab', 'ka data', 'ki photo', 'details', 'balance', 'status', 'account', 'loan', 'sip', '‡§ú‡§Æ‡§æ', '‡§≤‡•ã‡§®', '‡§¨‡§ï‡§æ‡§Ø‡§æ', '‡§π‡§ø‡§∏‡§æ‡§¨', '‡§°‡§æ‡§ü‡§æ', '‡§µ‡§ø‡§µ‡§∞‡§£', '‡§´‡•ã‡§ü‡•ã', '‡§¨‡§§‡§æ‡§ì', '‡§¶‡§ø‡§ñ‡§æ‡§ì', 'check', 'show', 'get', 'for', 'of', 'ka', 'ki', 'ke'];
        let potentialName = query.toLowerCase();
        keywords.forEach(kw => {
            // Remove whole word keywords
            const regex = new RegExp(`\\b${kw}\\b`, 'gi');
            potentialName = potentialName.replace(regex, '');
        });
        potentialName = potentialName.replace(/[?‡•§.,]/g, '').trim(); // Remove punctuation

        // Basic sanity check: return only if it's not empty and seems reasonable length
        if (potentialName && potentialName.length > 2 && potentialName.length < 35) {
             // Attempt to capitalize (Title Case) - API might need exact case match, adjust if needed
             return potentialName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        return null;
    }

    /**
     * Fetches data from Google Sheet API, processes it, and returns structured info.
     * @param {string} name - The name to query the sheet API for.
     * @returns {Promise<object>} - Promise resolving to an object {success: boolean, ...data} or {success: false, message: string}
     */
    async function fetchSheetData(name) {
        // Important: Ensure your Google Apps Script is deployed to handle the 'name' parameter in doGet(e)
        const apiUrl = `${SHEET_API_URL}?name=${encodeURIComponent(name)}`;
        console.log(`Workspaceing sheet data for: ${name} from ${apiUrl}`); // Log API call

        try {
            const response = await fetch(apiUrl);

            if (!response.ok) {
                 console.error("Sheet API Error Status:", response.status, await response.text()); // Log error response text
                 let errorMsg = `"${name}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•Ä‡§ü ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à (Status: ${response.status}). ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§®‡§æ‡§Æ ‡§∏‡§π‡•Ä ‡§π‡•à ‡§î‡§∞ API ‡§†‡•Ä‡§ï ‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`;
                  if (response.status === 404) { // Not Found likely means name doesn't exist or script error
                     errorMsg = `‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, "${name}" ‡§®‡§æ‡§Æ ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∂‡•Ä‡§ü ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ ‡§Ø‡§æ API ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à‡•§`;
                  }
                 return { success: false, message: errorMsg };
            }

            // Check content type before parsing JSON
             const contentType = response.headers.get("content-type");
             if (!contentType || !contentType.includes("application/json")) {
                const responseText = await response.text();
                console.error("Sheet API did not return JSON. Response:", responseText);
                // Check if it's the common "ScriptError" HTML page from Apps Script errors
                 if (responseText.includes("ScriptError")) {
                     return { success: false, message: `"${name}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§∂‡•Ä‡§ü API ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§` };
                 }
                return { success: false, message: "‡§∂‡•Ä‡§ü API ‡§∏‡•á ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü (JSON ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§•‡§æ)‡•§" };
            }


            const data = await response.json();
            console.log("Sheet API Raw Response:", data); // Log raw data

            // Check if the API returns an object with a 'data' array or just the array directly
            let records = [];
            if (Array.isArray(data)) {
                records = data;
            } else if (data && Array.isArray(data.data)) { // Handle cases where API wraps array in {data: [...]}
                records = data.data;
            } else {
                console.error("Sheet API JSON is not an array:", data);
                return { success: false, message: "‡§∂‡•Ä‡§ü API ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ JSON ‡§°‡•á‡§ü‡§æ ‡§è‡§ï ‡§ê‡§∞‡•á (‡§∏‡•Ç‡§ö‡•Ä) ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§" };
            }


            // Filter again client-side for safety, ensure case-insensitivity
             const relevantRecords = records.filter(record => record.Name && record.Name.toLowerCase() === name.toLowerCase());

            if (relevantRecords.length === 0) {
                 console.log(`No records found for name "${name}" after filtering.`);
                return { success: false, message: `‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, "${name}" ‡§®‡§æ‡§Æ ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∂‡•Ä‡§ü ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§` };
            }

            // Process the records for this person
            let totalSIP = 0;
            let totalLoan = 0;
            let totalPayment = 0;
            let latestImageUrl = "";
            let latestDate = ""; // Store the latest date found
             let firstDate = ""; // Store the first date found
            let displayName = relevantRecords[0].Name || name; // Use name from sheet if available

            // Sort records by date if possible to reliably get latest image/date
             // Assuming Date format is "DD Month YYYY" - needs careful parsing
             // Simple approach: iterate and overwrite if a later date/image is found.
             // For robust date comparison, use a library or parse carefully.
             // Let's just take the last entry's image/date for simplicity now.

            relevantRecords.forEach((record, index) => {
                totalSIP += Number(record["SIP Payment"] || 0);
                totalLoan += Number(record["Loan"] || 0);
                totalPayment += Number(record["Payment"] || 0);

                // Get image from the last record that has one
                if (record.imageUrl) {
                    latestImageUrl = record.imageUrl;
                }

                // Get date from the last record
                if (record.Date) {
                     latestDate = record.Date;
                 }
                 // Get date from the first record
                 if (record.Date && index === 0) {
                     firstDate = record.Date;
                 }

                // Update display name to match sheet capitalization
                displayName = record.Name || displayName;
            });

            const netLoanOutstanding = totalLoan - totalPayment;

            console.log(`Processed Data for ${displayName}: SIP=${totalSIP}, Loan=${totalLoan}, Payment=${totalPayment}, Outstanding=${netLoanOutstanding}, Image=${latestImageUrl}, Date=${latestDate}`);

            return {
                success: true,
                name: displayName,
                totalSIP: totalSIP,
                totalLoan: totalLoan,
                totalPayment: totalPayment,
                netLoanOutstanding: netLoanOutstanding,
                imageUrl: latestImageUrl,
                latestDate: latestDate,
                 firstDate: firstDate // Optionally include first transaction date
            };

        } catch (error) {
            console.error("Error fetching or processing sheet data:", error);
            // Check for network errors vs parsing errors
             if (error instanceof SyntaxError) {
                return { success: false, message: `"${name}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•Ä‡§ü API ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à (JSON ‡§™‡§æ‡§∞‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§´‡§≤)‡•§`};
             }
            return { success: false, message: `"${name}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•Ä‡§ü ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§Ø‡§æ ‡§Ö‡§®‡•ç‡§Ø ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§` };
        }
    }

    /**
     * Main function to handle user input and orchestrate responses.
     */
    async function send() {
        const q = inputBox.value.trim();
        if (!q) return;

        appendMessage(q, "user");
        const currentQuery = q;
        inputBox.value = '';
        suggestionsBox.style.display = 'none';

        // --- Check for Person Data Query Intent ---
        const personDataKeywords = ['details', 'detail', 'balance', 'status', 'account', 'record', ' ‡§ú‡§Æ‡§æ', ' ‡§≤‡•ã‡§®', ' ‡§¨‡§ï‡§æ‡§Ø‡§æ', ' ‡§π‡§ø‡§∏‡§æ‡§¨', '‡§´‡•ã‡§ü‡•ã', 'picture', 'image', '‡§°‡§æ‡§ü‡§æ', '‡§°‡§ø‡§ü‡•á‡§≤', '‡§µ‡§ø‡§µ‡§∞‡§£'];
        // Also check if the query *might* be just a name
        const isPotentialNameQuery = currentQuery.split(' ').length <= 3; // Simple check: 1-3 words could be a name
        const containsPersonKeyword = personDataKeywords.some(kw => currentQuery.toLowerCase().includes(kw));

        let potentialName = null;
        if (containsPersonKeyword || isPotentialNameQuery) {
            // Try extracting name only if keywords are present or it looks like just a name
            potentialName = extractNameFromQuery(currentQuery);
        }

        let sheetLookupAttempted = false;
        let sheetLookupSuccess = false;

        if (potentialName) {
            sheetLookupAttempted = true;
            const typingIndicator = appendMessage(`"${potentialName}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•Ä‡§ü ‡§∏‡•á ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ñ‡•ã‡§ú ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...`, "bot typing");
            try {
                const sheetResult = await fetchSheetData(potentialName);
                typingIndicator.remove(); // Remove typing indicator regardless of success/failure

                if (sheetResult.success) {
                    sheetLookupSuccess = true;
                    // --- Display Formatted Sheet Data ---
                    let htmlResponse = `
                        <p><strong>${sheetResult.name} ‡§ï‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£:</strong></p>
                        ${sheetResult.imageUrl ? `<p><img src="${sheetResult.imageUrl}" alt="${sheetResult.name}"></p>` : '<p><small>(‡§ï‡•ã‡§à ‡§´‡•ã‡§ü‡•ã ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç)</small></p>'}
                        <ul>
                            <li>‡§ï‡•Å‡§≤ ‡§ú‡§Æ‡§æ (Available Balance): ‚Çπ${sheetResult.totalSIP.toLocaleString('en-IN')}</li>
                            <li>‡§ï‡•Å‡§≤ ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ‚Çπ${sheetResult.totalLoan.toLocaleString('en-IN')}</li>
                            <li>‡§ï‡•Å‡§≤ ‡§≤‡•ã‡§® ‡§ö‡•Å‡§ï‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ‚Çπ${sheetResult.totalPayment.toLocaleString('en-IN')}</li>
                            <li><strong>‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${sheetResult.netLoanOutstanding.toLocaleString('en-IN')}</strong></li>
                            ${sheetResult.latestDate ? `<li>‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø: ${sheetResult.latestDate}</li>` : ''}
                        </ul>
                    `;
                    appendMessage(htmlResponse, "bot", true);
                    return; // Handled by Sheet API
                } else {
                    // Sheet API call failed or name not found, display the specific error message from fetchSheetData
                    appendMessage(sheetResult.message, "bot");
                    // Proceed to Gemini fallback below
                }
            } catch (error) {
                 // Catch unexpected errors during the fetch/display process itself
                 typingIndicator?.remove(); // Ensure indicator is removed
                 console.error("Unexpected error during sheet data handling:", error);
                 appendMessage(`"${potentialName}" ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡§æ‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§è‡§ï ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§`, "bot");
                 // Proceed to Gemini fallback below
            }
        }

        // --- If it wasn't a person query, or sheet lookup failed, use Gemini API ---
        if (!sheetLookupSuccess) {
             // Only show Gemini typing if we didn't already show sheet typing or if sheet failed
             let typingIndicator;
             if (!sheetLookupAttempted) {
                 typingIndicator = appendMessage("‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...", "bot typing");
             }

             // Gemini API Key Check
             if (!API_KEY || API_KEY === "YOUR_API_KEY" || API_KEY.length < 30) {
                 typingIndicator?.remove(); // Use optional chaining as indicator might not exist if sheet lookup was attempted
                 appendMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä API ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡•§", "bot");
                 console.error("Gemini API Key is missing or invalid.");
                 return;
             }

             // Prepare Context and Prompt for Gemini
             let context = "";
             let prompt = "";
             let useGeneralApiContext = false; // Flag if context comes from general knowledge

             const lowerQ = currentQuery.toLowerCase();
             const relevantSegments = dataSegments.filter(seg =>
                 seg.question.toLowerCase().includes(lowerQ) ||
                 lowerQ.split(' ').some(word => word.length > 3 && seg.question.toLowerCase().includes(word)) // More word matching
             );

             if (relevantSegments.length > 0) {
                 context = "‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§Ø‡§Æ:\n";
                 relevantSegments.slice(0, 5).forEach(seg => {
                     context += `‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${seg.question}\n‡§â‡§§‡•ç‡§§‡§∞: ${seg.answer}\n\n`;
                 });
                 prompt = `‡§Ü‡§™ '‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§ö‡•à‡§ü‡§¨‡•â‡§ü' ‡§π‡•à‡§Ç‡•§ ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è '‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§Ø‡§Æ' ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§µ‡§ø‡§®‡§Æ‡•ç‡§∞‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡§π‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§∏‡•Ä‡§ß‡•á ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§Ø‡§π ‡§® ‡§ï‡§π‡•á‡§Ç ‡§ï‡§ø '‡§Æ‡•á‡§∞‡•á ‡§™‡§æ‡§∏ ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'‡•§ ‡§Ø‡§¶‡§ø ‡§∂‡•Ä‡§ü ‡§°‡•á‡§ü‡§æ ‡§≤‡•Å‡§ï‡§Ö‡§™ ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à (‡§ú‡•à‡§∏‡•á ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ), ‡§§‡•ã ‡§â‡§∏ ‡§µ‡§ø‡§´‡§≤‡§§‡§æ ‡§ï‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§® ‡§ï‡§∞‡•á‡§Ç, ‡§¨‡§∏ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç‡•§

                    ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§Ø‡§Æ:
                    ${context}
                    ---
                    ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${currentQuery}

                    ‡§â‡§§‡•ç‡§§‡§∞ (‡§∏‡•ç‡§™‡§∑‡•ç‡§ü, ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§):`;
             } else {
                 useGeneralApiContext = true; // No specific local rule context found
                 prompt = `‡§Ü‡§™ '‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§ö‡•à‡§ü‡§¨‡•â‡§ü' ‡§π‡•à‡§Ç‡•§ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡•á ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡§æ ‡§π‡•à‡•§ ‡§Ø‡§¶‡§ø ‡§Ø‡§π ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§≤‡§ó‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§Ø‡§π ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§Ö‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§π‡•à, ‡§§‡•ã ‡§µ‡§ø‡§®‡§Æ‡•ç‡§∞‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§§‡§æ‡§è‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡§∞ ‡§π‡•à‡•§ ‡§Ø‡§¶‡§ø ‡§∂‡•Ä‡§ü ‡§°‡•á‡§ü‡§æ ‡§≤‡•Å‡§ï‡§Ö‡§™ ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à (‡§ú‡•à‡§∏‡•á ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ), ‡§§‡•ã ‡§â‡§∏ ‡§µ‡§ø‡§´‡§≤‡§§‡§æ ‡§ï‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§® ‡§ï‡§∞‡•á‡§Ç, ‡§¨‡§∏ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç‡•§

                    ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${currentQuery}

                    ‡§â‡§§‡•ç‡§§‡§∞ (‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§, ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§î‡§∞ ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡§∞ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞‡§ø‡§§):`;
             }

             // Call Gemini API
             const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
             try {
                 const response = await fetch(GEMINI_API_URL, {
                     method: "POST",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({
                         contents: [{ parts: [{ text: prompt }] }],
                         generationConfig: { temperature: 0.6, maxOutputTokens: 500 },
                         // Consider adding safety settings if needed
                     }),
                 });

                 typingIndicator?.remove();

                 if (!response.ok) {
                     const errorData = await response.json();
                     console.error("Gemini API Error:", response.status, errorData);
                     appendMessage(`‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä API ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ (Code: ${response.status})`, "bot");
                     displayErrorSuggestions(currentQuery);
                     return;
                 }

                 const js = await response.json();

                 if (js.candidates && js.candidates[0]?.content?.parts?.[0]?.text) {
                     const rawAnswer = js.candidates[0].content.parts[0].text.trim();
                     const messageElement = appendMessage("", "bot"); // Append empty div first
                      // Display suggestions only if context wasn't found OR if sheet lookup was attempted but failed
                     const showSuggestionsCallback = (useGeneralApiContext || (sheetLookupAttempted && !sheetLookupSuccess)) ? () => displayErrorSuggestions(currentQuery) : null;
                     typeEffect(rawAnswer, messageElement, showSuggestionsCallback);

                 } else {
                      let reason = "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§ï‡§æ‡§∞‡§£";
                      if(js.promptFeedback?.blockReason) { reason = `‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§¨‡•ç‡§≤‡•â‡§ï (${js.promptFeedback.blockReason})`; }
                      else if (!js.candidates || js.candidates.length === 0) { reason = "API ‡§∏‡•á ‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä"; }
                      console.warn("Gemini API Response Issue:", reason, js);
                      appendMessage(`‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§™‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å‡•§ (${reason})`, "bot");
                      displayErrorSuggestions(currentQuery);
                 }

             } catch (error) {
                 typingIndicator?.remove();
                 console.error("Gemini Network/Fetch Error:", error);
                 appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "bot");
                 displayErrorSuggestions(currentQuery);
             } // End Gemini API try-catch
        } // End Gemini fallback block
    }

    /**
     * Animates text typing effect and handles linkification.
     */
     function typeEffect(text, targetElement, callback = null) {
        let i = 0;
        targetElement.innerHTML = '&nbsp;'; // Initial placeholder
        const interval = setInterval(() => {
            if (i < text.length) {
                // Append char by char using textContent for safety during typing
                targetElement.textContent = text.substring(0, i + 1);
                chatBox.scrollTop = chatBox.scrollHeight;
                i++;
            } else {
                clearInterval(interval);
                // Finalize with HTML interpretation for links etc.
                const linkifiedHtml = linkify(text); // Apply linkify
                targetElement.innerHTML = linkifiedHtml; // Set final HTML
                 chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); // Ensure scroll is final
                // Execute callback if provided
                if (typeof callback === 'function') {
                    setTimeout(callback, 150); // Slight delay
                }
            }
        }, 20); // Typing speed
    }


    // Hide suggestions above input if user clicks outside
    document.addEventListener('click', function(event) {
        const isClickInsideInput = inputBox.contains(event.target);
        const isClickInsideSuggestions = suggestionsBox.contains(event.target);
        if (!isClickInsideInput && !isClickInsideSuggestions) {
            suggestionsBox.style.display = 'none';
        }
    });

    // Optional: Initial focus on input field
    // inputBox.focus();

</script>

</body>
</html>
