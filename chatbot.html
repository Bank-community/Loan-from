<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>बैंक चैटबॉट</title>
    <style>
        /* --- Enhanced Styles --- */
:root {
    --primary-color: #45a049; /* Slightly softer green */
    --primary-darker: #3c8e40;
    --secondary-color: #f4f6f8; /* Lighter grey background */
    --user-message-bg: #e2ffc7; /* Lighter user message */
    --bot-message-bg: #ffffff; /* White */
    --text-dark: #212529;
    --text-light: #5a6a79;
    --border-color: #e0e0e0;
    --suggestion-bg: #e9f5e9;
    --suggestion-hover-bg: #d8eed8;
    --prime-member-bg: #ffc107; /* Yellow for Prime tag BG */
    --prime-member-text: #000000; /* Black for Prime tag text */
    --loan-highlight-color: #dc3545; /* Red for loan highlight */
    --header-height: 60px;
    --input-area-height: 60px;
    --border-radius: 10px; /* Slightly larger radius */
    --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --message-shadow: 0 2px 5px rgba(0, 0, 0, 0.06);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: 'Segoe UI', 'Roboto', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--secondary-color); overflow: hidden; font-size: 16px; }
.chat-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 800px; margin: 0 auto; background: var(--bot-message-bg); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1); border-radius: 0; }
@media (min-width: 801px) { .chat-container { height: 90vh; max-height: 750px; margin: 25px auto; border-radius: var(--border-radius); overflow: hidden; /* Clip content to rounded corners */ } }

.chat-header { height: var(--header-height); background: linear-gradient(135deg, var(--primary-color), var(--primary-darker)); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.3em; font-weight: 600; padding: 0 20px; flex-shrink: 0; border-top-left-radius: inherit; border-top-right-radius: inherit; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
.chat-header .icon { margin-right: 12px; font-size: 1.6em; }

.chat-messages { flex-grow: 1; padding: 20px 15px; overflow-y: auto; background-color: var(--secondary-color); display: flex; flex-direction: column; gap: 15px; }
/* Custom Scrollbar */
.chat-messages::-webkit-scrollbar { width: 6px; }
.chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
.chat-messages::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 3px; }
.chat-messages::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

.message { padding: 14px 20px; border-radius: 18px; line-height: 1.65; word-wrap: break-word; max-width: 90%; position: relative; box-shadow: var(--message-shadow); font-size: 0.98em; }
.message a { color: #0066cc; text-decoration: underline; } .message a:hover { color: #004c99; }
.message p { margin-bottom: 10px; } .message p:last-child { margin-bottom: 0; }
.message ul, .message ol { margin-left: 20px; margin-bottom: 10px; padding-left: 15px; } .message ul li { margin-bottom: 6px; }

/* User & Bot Bubble Styles */
.user { align-self: flex-end; background-color: var(--user-message-bg); color: var(--text-dark); border-bottom-right-radius: 6px; }
.bot { align-self: flex-start; background-color: var(--bot-message-bg); color: var(--text-dark); border: 1px solid var(--border-color); border-bottom-left-radius: 6px; }
.bot.typing { color: var(--text-light); font-style: italic; background-color: transparent; border: none; box-shadow: none; padding-left: 0; }

/* --- यूजर डिटेल्स कार्ड के लिए अपडेटेड CSS --- */

.user-details-card {
    padding: 20px;                 /* मौजूदा पैडिंग */
    border: 1px solid var(--border-color); /* मौजूदा बॉर्डर */
    border-radius: var(--border-radius);   /* मौजूदा रेडियस */
    background-color: #ffffff;     /* मौजूदा पृष्ठभूमि */
    margin-top: 8px;               /* मौजूदा मार्जिन */
    box-shadow: var(--card-shadow);/* मौजूदा शैडो */
    width: 110%;                   /* <<<--- कार्ड को कंटेनर की पूरी चौड़ाई लेने दें */
    max-width: 650px;              /* <<<--- अधिकतम चौड़ाई सेट करें (समायोजित करें) */
    box-sizing: border-box;        /* <<<--- सुनिश्चित करें कि पैडिंग चौड़ाई में शामिल है */
    /* यदि आवश्यक हो तो कंटेनर के सापेक्ष मार्जिन समायोजित करें */
    margin-left: auto;
    margin-right: auto;
}

/* बाकी संबंधित स्टाइल्स (इनमें कोई बदलाव नहीं किया गया है, लेकिन कार्ड लेआउट के लिए आवश्यक हैं) */
.user-details-header {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-bottom: 18px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
}

.profile-pic-container {
    position: relative;
    flex-shrink: 0;
    width: 80px;
    height: 80px;
}

.profile-pic {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10%;
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    background-color: #eee;
}

.prime-tag-on-photo {
    position: absolute;
    top: -6px;
    right: -6px;
    background-color: var(--prime-member-bg);
    color: var(--prime-member-text);
    font-size: 0.75em;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 6px;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    z-index: 1;
}

.user-info {
    flex-grow: 1; /* जानकारी को शेष स्थान लेने दें */
}

.user-info h3 {
    margin: 0;
    font-size: 1.3em;
    color: var(--text-dark);
    font-weight: 600;
}

.user-info p {
    margin: 5px 0 0;
    font-size: 0.9em;
    color: var(--text-light);
}
.user-info .label {
    font-weight: 500;
}

.user-stats {
    padding-top: 15px;
}

.user-stats p {
    margin-bottom: 12px;
    font-size: 0.98em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* संकीर्ण कार्ड पर रैपिंग की अनुमति दें */
    gap: 5px 10px;   /* पंक्ति गैप, कॉलम गैप */
    padding-bottom: 8px; /* पैडिंग थोड़ी बढ़ा दी */
    border-bottom: 1px dashed #eee;
}
.user-stats p:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.user-stats .label {
    color: var(--text-light);
    margin-right: 8px;
    display: flex;
    align-items: center;
    gap: 6px; /* आइकन के लिए थोड़ा अधिक गैप */
    flex-shrink: 0; /* लेबल को बहुत सिकुड़ने से रोकें */
}

.user-stats .value {
    font-weight: 600;
    text-align: right;
    flex-grow: 1;        /* मान को शेष स्थान लेने दें */
    word-break: break-word; /* लंबे मानों को ओवरफ्लो होने से रोकें */
}

.user-stats .label .icon {
    font-size: 1.1em;
    opacity: 0.7;
}

.loan-highlight {
    color: var(--loan-highlight-color);
    font-weight: 700;
}

.sip-status {
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.9em;
    display: inline-block;
}
.sip-status.paid { color: #fff; background-color: #28a745; }
.sip-status.pending { color: #fff; background-color: var(--loan-highlight-color); }
.sip-status.due { color: #333; background-color: #ffc107; }


/* Clickable Member List */
.member-list-container { padding: 10px 0; max-height: 220px; overflow-y: auto; }
.clickable-member { display: block; padding: 10px 15px; margin-bottom: 5px; background-color: #f8f9fa; border-radius: 6px; cursor: pointer; color: var(--text-dark); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.98em; border: 1px solid var(--border-color); }
.clickable-member:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-darker); }

/* Suggestions IN CHAT */
.suggestion-group { background-color: var(--bot-message-bg); border: 1px solid var(--border-color); padding: 18px; margin-top: 8px; border-radius: 15px; align-self: flex-start; max-width: 85%; box-shadow: var(--message-shadow); }
.suggestion-group .group-title { font-weight: 600; margin-bottom: 14px; color: var(--text-light); font-size: 0.9em; }
.chat-suggestion { display: block; background-color: var(--suggestion-bg); color: var(--primary-color); padding: 11px 16px; border-radius: 8px; cursor: pointer; font-size: 0.92em; margin-bottom: 8px; border: 1px solid #d0e0d0; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; text-align: left; font-weight: 500; }
.chat-suggestion:hover { background-color: var(--suggestion-hover-bg); border-color: #b0c0b0; transform: translateY(-1px); }
.chat-suggestion:last-child { margin-bottom: 0; }

/* --- Input Area --- */
.chat-input-area { height: var(--input-area-height); display: flex; align-items: center; border-top: 1px solid var(--border-color); background-color: #ffffff; padding: 10px 12px; flex-shrink: 0; position: relative; border-bottom-left-radius: inherit; border-bottom-right-radius: inherit;}
.chat-input-area input { flex-grow: 1; height: 100%; padding: 0 18px; border: 1px solid var(--border-color); border-radius: 20px; font-size: 1em; outline: none; margin-right: 10px; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
.chat-input-area input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(69, 160, 73, 0.2); }
.chat-input-area button { height: 100%; padding: 0 22px; border: none; background: var(--primary-color); color: white; cursor: pointer; font-size: 1em; font-weight: 600; border-radius: 20px; transition: background-color 0.2s ease; flex-shrink: 0; }
.chat-input-area button:hover { background: var(--primary-darker); }

/* Suggestions ABOVE input */
.suggestions { position: absolute; bottom: calc(var(--input-area-height) + 8px); left: 12px; right: 12px; display: flex; flex-direction: column; gap: 6px; padding: 12px; background: #ffffff; border: 1px solid var(--border-color); max-height: 220px; overflow-y: auto; z-index: 100; box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1); border-radius: 8px; }
.suggestion { background: #f1f1f1; color: var(--text-dark); padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 0.9em; text-align: left; border: 1px solid transparent; transition: background-color 0.2s ease; }
.suggestion:hover { background: #e0e0e0; }

/* Image Modal Styles */
.modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.88); justify-content: center; align-items: center; }
.modal-content { margin: auto; display: block; max-width: 90%; max-height: 90%; border-radius: 5px; }
.modal-close { position: absolute; top: 25px; right: 40px; color: #f1f1f1; font-size: 45px; font-weight: bold; transition: 0.3s; cursor: pointer; line-height: 1; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.modal-close:hover, .modal-close:focus { color: #bbb; text-decoration: none; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <span class="icon">🏦</span>बैंक कम्युनिटी चैटबॉट 💬
    </div>
    <div class="chat-messages" id="chat">
        <div class="message bot">
            नमस्ते! मैं आपकी बैंक कम्युनिटी लोन योजना, सदस्य विवरण, पात्रता, नियमों और अन्य संबंधित प्रश्नों में सहायता कर सकता हूँ। आप किसी भी तरह से सवाल पूछें, मैं समझने और सही जानकारी देने की पूरी कोशिश करूँगा।
        </div>
        <div class="message bot suggestion-group">
             <div class="group-title">आप इस तरह पूछ सकते हैं:</div>
             <div class="chat-suggestion" onclick="inputBox.value='मेरा बैलेंस कितना है?'; send();">मेरा बैलेंस कितना है?</div>
             <div class="chat-suggestion" onclick="inputBox.value='SIP भरने की आखिरी तारीख क्या है?'; send();">SIP भरने की आखिरी तारीख क्या है?</div>
             <div class="chat-suggestion" onclick="inputBox.value='Mithlesh Sahni का विवरण दिखाओ'; send();">Mithlesh Sahni का विवरण दिखाओ</div>
             <div class="chat-suggestion" onclick="inputBox.value='सभी सदस्यों की सूची दिखाओ'; send();">सभी सदस्यों की सूची दिखाओ</div>
        </div>
    </div>
    <div class="suggestions" id="suggestions" style="display:none;"></div>
    <div class="chat-input-area">
        <input id="input" type="text" placeholder="अपना सवाल यहाँ लिखें..." oninput="showSuggestions(this.value)" onkeyup="handleKey(event)" autocomplete="off">
        <button onclick="send()" aria-label="भेजें">भेजें</button>
    </div>
</div>

<div id="imageModal" class="modal-overlay">
    <span class="modal-close" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImageContent">
</div>

<script>
// --- Configuration, Global State, dataSegments ---
const API_KEY = "AIzaSyBwhJNl7Rw4Xwb8esmsIes5uVX2fWlRnSE"; // <<<--- *** अपनी Gemini API कुंजी यहाँ डालें ***
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbz9LCkPR8L3-i7F1KG2KUJ6It2l_p55murljRJ_4108nFysOXUOpG5WEs1sdEaGHq1L7w/exec"; // <<<--- *** अपना Apps Script URL यहाँ डालें ***
const defaultProfilePic = 'https://via.placeholder.com/100/CCCCCC/FFFFFF?text=👤';
// Corrected name: Mithlesh Sahni
const primeMembers = ["Amit Kumar", "Mithlesh Sahni", "Prince Rama"]; // यदि आवश्यक हो तो अपडेट करें

let cachedSheetData = null;
let communityBalance = 0;
let isFetchingData = false;

// Rules/FAQ Data Store (dataSegments)
const dataSegments = [
  // ... (सारा dataSegments वाला JSON यहाँ पेस्ट करें जैसा पहले था) ...
  // Example:
  {
    "question": "Bank community loan kya hai?",
    "answer": "बैंक कम्युनिटी लोन एक आपसी सहयोग पर आधारित बचत और ऋण योजना है, जो समुदाय के सदस्यों को जरूरत पड़ने पर आर्थिक सहायता प्रदान करती है।"
  },
  {
    "question": "Scheme kaise work karti hai?",
    "answer": "सदस्य हर महीने एक निश्चित राशि (₹500) SIP के रूप में जमा करते हैं। जब किसी सदस्य को पैसे की जरूरत होती है, तो वह अपनी जमा राशि के आधार पर लोन ले सकता है। लोन की मंजूरी और अन्य निर्णय समुदाय के सदस्यों द्वारा मिलकर लिए जाते हैं।"
  },
  {
    "question": "Monthly SIP amount aur deadline kya hai?",
    "answer": "हर महीने की 1 से 10 तारीख के बीच ₹500 SIP जमा करना अनिवार्य है।"
  },
  {
    "question": "SIP bounce hone par kya hota hai?",
    "answer": "यदि किसी सदस्य की SIP लगातार 2-3 बार बाउंस होती है, तो उसकी सदस्यता 1 वर्ष के लिए रद्द की जा सकती है।"
  },
  {
    "question": "Cancellation par deposit refund hoga?",
    "answer": "हाँ, सदस्यता रद्द होने पर आपकी कुल जमा राशि लौटाई जाएगी, लेकिन उस पर कोई ब्याज नहीं मिलेगा।"
  },
  {
    "question": "Loan lene ke liye requirements kya hain?",
    "answer": "लोन लेने के लिए आपको पहले यह सुनिश्चित करना होगा कि आपका कोई पिछला बकाया नहीं है और फिर लोन फॉर्म भरना होगा। लोन फॉर्म का लिंक है: https://bank-community.github.io/Loan-from/loan.html"
  },
   {
    "question": "Loan form link",
    "answer": "आप लोन फॉर्म इस लिंक से प्राप्त कर सकते हैं: https://bank-community.github.io/Loan-from/loan.html"
  },
  {
    "question": "Loan installment duration kya hai?",
    "answer": "लोन की प्रत्येक किस्त की अवधि 31 दिन होती है। यदि आप समय पर भुगतान नहीं करते हैं, तो बकाया राशि अगली किस्त में जुड़ जाएगी।"
  },
  {
    "question": "Free loan kya hai?",
    "answer": "फ्री लोन एक सुविधा है जिसके तहत सदस्य महीने में एक बार ₹1000 तक का लोन अधिकतम 5 दिनों के लिए बिना किसी ब्याज के ले सकते हैं। 5 दिन के बाद भुगतान करने पर ₹10 प्रति दिन का लेट फाइन लगता है।"
  },
  {
    "question": "Maximum loan kitna le sakte hain?",
    "answer": "आप अपनी कुल जमा राशि का 1.5 गुना तक लोन ले सकते हैं। यदि आपको जमा राशि का दोगुना लोन चाहिए, तो आपको 2% अतिरिक्त ब्याज देना होगा।"
  },
  {
    "question": "Loan par late fine rules kya hain?",
    "answer": "यदि लोन 31 दिन से अधिक बकाया रहता है, तो उस पर ब्याज/पेनल्टी अगले महीने से लागू होगी। 32-60 दिनों के लिए 3% और 61+ दिनों के लिए 5% पेनल्टी (RED MEMBER) लगती है।"
  },
  {
    "question": "Late installment ka notification compulsory hai?",
    "answer": "हाँ, यदि आपकी लोन किस्त देर से होने वाली है, तो आपको SMS द्वारा सूचित करना अनिवार्य है। ऐसा न करने पर ₹10 की पेनल्टी लग सकती है।"
  },
  {
    "question": "Installment bounce ka consequence kya hai?",
    "answer": "यदि आपकी किस्त दो बार बाउंस होती है और आप सूचित नहीं करते हैं, तो आपको 60 दिनों तक कोई नया लोन नहीं मिल पाएगा।"
  },
  {
    "question": "EMI loan ki conditions kya hain?",
    "answer": "EMI विकल्प पर लोन लेने पर 8% अतिरिक्त ब्याज लगता है। लोन की न्यूनतम राशि ₹2500 होनी चाहिए और भुगतान की अधिकतम अवधि 3 महीने होगी।"
  },
  {
    "question": "New member join kaise karein?",
    "answer": "नया सदस्य बनने के लिए महीने की 1 से 5 तारीख के बीच ₹500 जमा करना होता है। नए सदस्य शामिल होने के 60 दिन बाद ही लोन लेने के पात्र होंगे।"
  },
  {
    "question": "New member joining conditions kya hain?",
    "answer": "नए सदस्य को शामिल करने के लिए एक मौजूदा सदस्य (गारंटर) की गारंटी, 1 महीने की अग्रिम SIP जमा और पृष्ठभूमि की जाँच अनिवार्य है।"
  },
  {
    "question": "Payment method aur QR code?",
    "answer": "आप SIP या लोन का भुगतान करने के लिए इस QR कोड का उपयोग कर सकते हैं: https://i.ibb.co/0yLtTKTS/20250410-080021.png (भुगतान के बाद व्यवस्थापक को सूचित करें)।"
  },
  {
    "question": "1 month loan par charge kitna hai?",
    "answer": "1 से 31 दिन तक के लोन पर 1% चार्ज लगता है।"
  },
  {
    "question": "2 month loan par penalty kitni hai?",
    "answer": "32 से 60 दिन तक के लोन पर 3% पेनल्टी लगती है।"
  },
  {
    "question": "3 month se zyada loan par penalty kitni hai?",
    "answer": "61 दिनों से अधिक लोन रखने पर 5% पेनल्टी लगती है और सदस्य को 'RED MEMBER' के रूप में चिह्नित किया जा सकता है।"
  },
   {
    "question": "Civil score kaise improve hota hai?",
    "answer": "प्रत्येक ₹100 समय पर जमा करने पर आपके सिविल स्कोर में 10 पॉइंट्स जुड़ते हैं। अच्छा सिविल स्कोर लोन पात्रता में मदद करता है।"
  },
  {
    "question": "Repayment ke baad re-loan rule kya hai?",
    "answer": "नहीं, जिस दिन आप लोन का पूरा भुगतान करते हैं, उस दिन आप दोबारा लोन नहीं ले सकते। आप अगले दिन से पुनः लोन के लिए आवेदन कर सकते हैं।"
  },
  {
    "question": "Member exit rules kya hain?",
    "answer": "योजना से बाहर निकलने (Exit) के लिए आपकी सदस्यता कम से कम 60 दिन पुरानी होनी चाहिए, कोई बकाया लोन नहीं होना चाहिए और आपको Exit फॉर्म भरना होगा। आपकी कुल जमा राशि और अर्जित ब्याज (यदि लागू हो) महीने की 1 से 10 तारीख के बीच लौटा दिया जाएगा। 60 दिन से पहले निकलने पर 10% की कटौती हो सकती है।"
  },
  {
    "question": "Prime members kaun hain?",
    "answer": `वर्तमान प्राइम सदस्य ${primeMembers.join(', ')} हैं। इन्हें उनके समय पर भुगतान और जिम्मेदार व्यवहार के आधार पर चुना गया है।`
  },
   {
    "question": "Board members kaun hain?",
    "answer": `बोर्ड सदस्य ही प्राइम सदस्य हैं: ${primeMembers.join(', ')}।`
  },
  {
    "question": "Prime member responsibilities kya hain?",
    "answer": "उनकी जिम्मेदारियों में सभी आर्थिक निर्णयों में भाग लेना, लोन वितरण की निगरानी करना, फंड की स्थिति पर नजर रखना, नए सदस्यों के लिए गारंटी देना और नियमित मीटिंग्स आयोजित करना शामिल है।"
  },
  {
    "question": "Prime member banne ke rules kya hain?",
    "answer": "इसके लिए सदस्य का समय पर भुगतान का रिकॉर्ड अच्छा होना चाहिए, गारंटी देने की क्षमता होनी चाहिए, निर्णय लेने में 70% सहमति होनी चाहिए और सिविल स्कोर नेगेटिव नहीं होना चाहिए।"
  },
  {
    "question": "Guarantor requirements kya hain?",
    "answer": "गारंटर बनने के लिए सदस्य को कम से कम 6 महीने पुराना होना चाहिए, सिविल स्कोर 200 या उससे अधिक होना चाहिए, एक लिखित समझौता करना होगा और तय शर्तों का पालन करना होगा।"
  },
  {
    "question": "Meeting aur transparency details?",
    "answer": "हर महीने मीटिंग होती है जिसमें जमा/लोन रिकॉर्ड, सदस्यों और गारंटरों की स्थिति और संस्था की प्रगति पर चर्चा की जाती है, जिससे पारदर्शिता बनी रहती है।"
  },
  {
    "question": "Bank community website link",
    "answer": "हमारी वेबसाइट है: https://bank-community.github.io/Loan-from"
  },
  {
    "question": "Scheme start date?",
    "answer": "यह योजना 23 जून 2024 को स्थापित की गई थी।"
  },
  {
    "question": "Concurrent loan rule kya hai?",
    "answer": "हाँ, यदि किसी सदस्य ने अपनी जमा राशि का 1.5 गुना लोन ले लिया है और उसके खाते में ₹1000 से अधिक की राशि शेष है, तो वह ₹1000 तक का अतिरिक्त लोन ले सकता है।"
  },
  {
    "question": "Organisation kaise operate hoti hai?",
    "answer": "संस्था मुख्य रूप से WhatsApp ग्रुप और वेबसाइट के माध्यम से संचालित होती है। WhatsApp ग्रुप लिंक: https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ"
  },
  {
    "question": "Joining link",
    "answer": "आप इस लिंक पर जाकर सदस्यता फॉर्म भर सकते हैं और प्रक्रिया शुरू कर सकते हैं: https://bank-community.github.io/Loan-from/newbank.html"
  },
  {
      "question": "Total members count?",
      "answer": "आप मुझसे पूछ सकते हैं 'कुल सदस्य कितने हैं?' या 'Total members?' और मैं आपको वर्तमान संख्या बता दूँगा।"
  },
  {
      "question": "All members ke naam?",
      "answer": "कृपया मुझसे पूछें 'सभी सदस्यों की सूची दिखाओ' ताकि मैं आपको पूरी सूची दे सकूँ।"
  },
  {
      "question": "Show all members list",
      "answer": "ज़रूर, आप मुझसे पूछें 'सभी सदस्यों की सूची दिखाओ' और मैं आपको सभी सदस्यों के नाम दिखा दूँगा, जिन पर क्लिक करके आप उनका विवरण देख सकते हैं।"
  },
   {
      "question": "Balance kaise check karein?",
      "answer": "आप अपना बैलेंस और अन्य विवरण जानने के लिए पूछ सकते हैं '[आपका नाम] का विवरण'। उदाहरण: 'अमित कुमार का विवरण'।"
  },
  {
      "question": "Loan eligibility kaise check karein?",
      "answer": "आप अपनी लोन पात्रता जानने के लिए पूछ सकते हैं '[आपका नाम] की लोन पात्रता'। उदाहरण: 'अमित कुमार की लोन पात्रता'।"
  },
   {
      "question": "Outstanding loan amount meaning?",
      "answer": "बकाया लोन राशि वह रकम है जो आपने कुल लोन लिया है उसमें से आपके द्वारा किए गए कुल *नियमित भुगतान* (SIP को छोड़कर) को घटाने के बाद बचती है।"
   },
   {
       "question": "Recent uncleared loan meaning?",
       "answer": "यदि सदस्य विवरण में 'हालिया बकाया लोन' दिखाया जा रहा है, तो इसका मतलब है कि सदस्य ने हाल ही में एक लोन लिया था और उस लोन लेने के बाद से अभी तक कोई *नियमित भुगतान* (SIP नहीं) नहीं किया है। यह उस अंतिम लोन की राशि दिखाता है।"
   }
];


// --- DOM Elements ---
const chatBox = document.getElementById("chat");
const inputBox = document.getElementById("input");
const suggestionsBox = document.getElementById("suggestions");
const imageModal = document.getElementById("imageModal");
const modalImageContent = document.getElementById("modalImageContent");

// --- Utility Functions ---
// formatDate, calculateEligibility, getSipStatus, appendMessage, linkify,
// appendSuggestionGroup, displayFallbackSuggestions, typeEffect, openImageModal, closeImageModal
// (ये सभी फ़ंक्शन पहले जैसे ही रहेंगे)
 function formatDate(date, options = {}) {
        if (!(date instanceof Date) || isNaN(date)) return "--";
        const defaultOptions = { day: '2-digit', month: 'short', year: 'numeric' };
        const mergedOptions = { ...defaultOptions, ...options };
        try { return date.toLocaleDateString('en-GB', mergedOptions); }
        catch (e) {
            try { const y = date.getFullYear(), m = String(date.getMonth() + 1).padStart(2, '0'), d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
            catch { return "--"; }
        }
    }
    function calculateEligibility(userName, userBalance, currentCommunityBalance) {
        if (!userName || userName === 'all') return { isEligible: false, approvedAmount: 0, reason: "सभी के लिए लागू नहीं" };
         // Ensure community balance calculation is up-to-date if needed
        const latestCommunityBalance = cachedSheetData ? cachedSheetData.reduce((acc, r) => acc + r.Payment + r.SipPayment - r.Loan, 0) : 0;

        const isEligible = userBalance > 0 && latestCommunityBalance > 0;
        let approvedAmount = 0, reason = "";
        if (isEligible) {
            const potentialAmount = userBalance * 1.5; // Standard eligibility 1.5x
            approvedAmount = Math.floor(Math.min(potentialAmount, latestCommunityBalance)); // Cannot approve more than available balance
            reason = approvedAmount > 0 ? "" : "(समुदाय में पर्याप्त फंड नहीं है)";
        } else {
            if (userBalance <= 0) reason = `(आपका बैलेंस शून्य या ऋणात्मक है: ₹${userBalance.toFixed(0)})`;
            else if (latestCommunityBalance <= 0) reason = "(समुदाय में फंड उपलब्ध नहीं है)";
            else reason = "(अज्ञात कारण से अपात्र)";
        }
        return { isEligible: isEligible && approvedAmount > 0, approvedAmount: approvedAmount, reason: reason };
    }
    function getSipStatus(userData) {
        if (!userData || userData.length === 0) return { statusText: "N/A", statusClass: "" };
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const currentDay = now.getDate();

        // Find if a SIP payment exists for the current month and year
        const paidThisMonth = userData.some(r =>
            r.SipPayment > 0 &&
            r.Date instanceof Date &&
            !isNaN(r.Date) &&
            r.Date.getMonth() === currentMonth &&
            r.Date.getFullYear() === currentYear
        );

        if (paidThisMonth) {
            return { statusText: "✅ Paid", statusClass: "paid" };
        } else if (currentDay > 10) { // Deadline is 10th
            return { statusText: "❌ Pending", statusClass: "pending" }; // Past due
        } else {
            return { statusText: "⚠️ Due", statusClass: "due" }; // Due within deadline
        }
    }
     function appendMessage(content, cls, isHtml = false) {
         const d = document.createElement("div"); d.className = "message " + cls;
         if (isHtml) {
              // Basic sanitation + ensure onclick safety
              const sanitizedContent = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
              d.innerHTML = sanitizedContent;
              // Add event listeners to dynamically added elements if needed, carefully
              // Example: If adding buttons with specific JS functions
              // d.querySelectorAll('.dynamic-button').forEach(button => {
              //     button.addEventListener('click', handleDynamicButtonClick);
              // });
         } else { d.textContent = content; }
         chatBox.appendChild(d);
         // Smooth scroll adjustment
         setTimeout(() => {
              chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
         }, 50); // Small delay to allow element rendering
         return d;
     }
    function linkify(text) {
        // Regex to find URLs (http, https, ftp, file) and www. links
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlRegex, function(url) {
            let fullUrl = url;
            // Prepend http:// if protocol is missing (for www. links)
            if (!fullUrl.match(/^https?:\/\//i) && fullUrl.startsWith('www.')) {
                fullUrl = 'http://' + fullUrl;
            }
            // Escape potentially harmful characters in the displayed text
            const linkText = url.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
        });
    }
     function appendSuggestionGroup(title, questions) {
         const groupDiv = document.createElement("div"); groupDiv.className = "message bot suggestion-group";
         const titleDiv = document.createElement("div"); titleDiv.className = "group-title"; titleDiv.textContent = title; groupDiv.appendChild(titleDiv);

         if (!Array.isArray(questions)) questions = [];

         // Shuffle and limit suggestions
         const shuffledQuestions = [...questions].sort(() => 0.5 - Math.random()).slice(0, 5); // Show up to 5

         shuffledQuestions.forEach(q_text => {
             if (!q_text || typeof q_text !== 'string') return; // Basic validation

             const suggestionEl = document.createElement("div");
             suggestionEl.className = "chat-suggestion";
             suggestionEl.textContent = q_text; // Use textContent for safety

             // Sanitize text before embedding in JS for onclick
             const sanitizedQText = q_text.replace(/'/g, "\\'").replace(/"/g, '\\"');
             suggestionEl.onclick = () => {
                 inputBox.value = q_text; // Set original text in input
                 suggestionsBox.style.display = 'none';
                 send();
             };
             groupDiv.appendChild(suggestionEl);
         });

         if (shuffledQuestions.length > 0) {
             chatBox.appendChild(groupDiv);
             // Scroll adjustment after adding suggestions
             setTimeout(() => {
                 chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
             }, 100);
         }
     }
    function displayFallbackSuggestions(customTitle = "आप यह भी पूछ सकते हैं:") {
        const ruleQuestions = dataSegments.map(s => s.question);
        // Add common dynamic queries
        const commonQueries = ["सभी सदस्यों की सूची दिखाओ", "कुल सदस्य कितने हैं?", "मेरा बैलेंस कितना है?", "क्या मैं लोन ले सकता हूँ?", "Loan lene ke liye requirements kya hain?"];
        let memberNames = [];
        if(cachedSheetData) {
            memberNames = [...new Set(cachedSheetData.map(r => r.Name))].slice(0, 3).map(name => `${name} का विवरण`);
        }

        const combinedSuggestions = [...new Set([...commonQueries, ...memberNames, ...ruleQuestions])]; // Combine and remove duplicates
        if (combinedSuggestions.length > 0) {
             // Display suggestions after a short delay
             setTimeout(() => { appendSuggestionGroup(customTitle, combinedSuggestions); }, 300);
        }
    }
    function typeEffect(text, targetElement, callback = null) {
        let i = 0;
        targetElement.innerHTML = '&nbsp;'; // Start with space for layout
        const interval = setInterval(() => {
            if (i < text.length) {
                // Append character by character
                targetElement.textContent = text.substring(0, i + 1);
                chatBox.scrollTop = chatBox.scrollHeight; // Keep scrolled down
                i++;
            } else {
                clearInterval(interval);
                // Apply linkify after text is fully typed
                const linkifiedHtml = linkify(targetElement.textContent); // Linkify the final text
                targetElement.innerHTML = linkifiedHtml;
                chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); // Final scroll
                // Execute callback if provided
                if (typeof callback === 'function') {
                     setTimeout(callback, 200); // Delay callback slightly
                }
            }
        }, 25); // Typing speed (adjust as needed)
    }

    function openImageModal(imageUrl) {
        if (imageUrl && imageModal && modalImageContent) {
            if (imageUrl.includes('via.placeholder.com')) return; // Don't show modal for placeholder
            modalImageContent.src = imageUrl;
            imageModal.style.display = "flex"; // Use flex for centering
        }
    }
    function closeImageModal() {
        if (imageModal) {
            imageModal.style.display = "none";
            modalImageContent.src = ""; // Clear src
        }
    }


// --- Data Fetching & Processing ---
async function fetchAndProcessSheetData() {
    // This function remains the same as before
    if (isFetchingData) {
        console.log("Already fetching data, waiting...");
        // Simple wait mechanism
        await new Promise(resolve => setTimeout(resolve, 500));
        return cachedSheetData !== null;
    }
    if (cachedSheetData) return true; // Return if already cached

    isFetchingData = true;
    console.log("Fetching fresh sheet data...");
    const loadingMsg = appendMessage("सदस्य डेटाबेस से कनेक्ट हो रहा है...", "bot typing");

    try {
        const response = await fetch(SHEET_API_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
        }
        const rawData = await response.json();

        // Process data
        cachedSheetData = rawData.map(row => {
             let parsedDate = new Date(NaN);
             if (row.Date) {
                 parsedDate = new Date(row.Date);
                 if (isNaN(parsedDate)) {
                     const dateParts = String(row.Date).match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})$/);
                     if (dateParts) {
                         parsedDate = new Date(`${dateParts[2]} ${dateParts[1]}, ${dateParts[3]}`);
                     }
                 }
             }
             if (isNaN(parsedDate)) { parsedDate = new Date(0); } // Use Epoch for invalid dates

             return {
                 Name: row.Name ? String(row.Name).trim() : 'Unknown',
                 Date: parsedDate,
                 Loan: parseFloat(row.Loan) || 0,
                 Payment: parseFloat(row.Payment) || 0,
                 SipPayment: parseFloat(row["SIP Payment"]) || 0,
                 ImageUrl: row.imageUrl || null
             };
        }).filter(r => r.Name !== 'Unknown' && r.Name.trim() !== ''); // Filter out empty/unknown names

        cachedSheetData.sort((a, b) => a.Date - b.Date); // Sort by date ascending

        // Calculate community balance
        communityBalance = cachedSheetData.reduce((acc, r) => acc + r.Payment + r.SipPayment - r.Loan, 0);

        console.log(`Sheet data processed. Members: ${new Set(cachedSheetData.map(r=>r.Name)).size}, Community Balance: ${communityBalance.toFixed(2)}`);
        loadingMsg?.remove();
        isFetchingData = false;
        return true;
    } catch (error) {
        console.error("Error fetching/processing sheet data:", error);
        cachedSheetData = null; // Reset cache on error
        communityBalance = 0;
        loadingMsg?.remove();
        isFetchingData = false;
        appendMessage(`त्रुटि: सदस्य डेटा प्राप्त करने में विफल रहा। (${error.message})`, "bot");
        return false;
    } finally {
        isFetchingData = false; // Ensure flag is reset
    }
}

function getUserDataAggregated(name) {
    // This function remains the same as before
     if (!cachedSheetData) {
         console.warn("Cannot get user data, cache is empty.");
         appendMessage("त्रुटि: सदस्य डेटा अभी लोड नहीं हुआ है। कृपया कुछ क्षण प्रतीक्षा करें।", "bot"); // Inform user
         return null;
     }
     const lowerName = name.toLowerCase().trim();
     const canonicalNameEntry = cachedSheetData.find(r => r.Name.toLowerCase() === lowerName);

     if (!canonicalNameEntry) return null; // Name not found in data

     const canonicalName = canonicalNameEntry.Name;
     const userData = cachedSheetData.filter(r => r.Name === canonicalName);

     if (userData.length === 0) return null;

     let totalSIP = 0, totalLoan = 0, totalPayment = 0, latestImageUrl = "", joinDate = null;
     let lastLoanDate = null, latestLoanAmount = 0;

     const validDates = userData.map(r => r.Date).filter(d => d.getTime() !== 0);
     joinDate = validDates.length > 0 ? new Date(Math.min(...validDates)) : new Date(NaN);

     userData.forEach((record) => {
         totalSIP += record.SipPayment;
         totalLoan += record.Loan;
         totalPayment += record.Payment;
         if (record.ImageUrl) { latestImageUrl = record.ImageUrl; }

         if (record.Loan > 0 && record.Date instanceof Date && !isNaN(record.Date) && record.Date.getTime() !== 0) {
             if (!lastLoanDate || record.Date > lastLoanDate) {
                 lastLoanDate = record.Date;
                 latestLoanAmount = record.Loan;
             }
         }
     });

      let hasUnclearedLoan = false;
      if (lastLoanDate) {
          const paymentExistsAfterLoan = userData.some(r =>
              r.Payment > 0 &&
              r.Date instanceof Date && !isNaN(r.Date) && r.Date.getTime() !== 0 &&
              r.Date > lastLoanDate
          );
          hasUnclearedLoan = !paymentExistsAfterLoan;
      }

     if (!hasUnclearedLoan) { latestLoanAmount = 0; }

     const overallBalance = (totalSIP + totalPayment) - totalLoan;
     const netLoanOutstanding = Math.max(0, totalLoan - totalPayment);
     const sipStatusInfo = getSipStatus(userData);
     const isPrime = primeMembers.some(pm => pm.toLowerCase() === canonicalName.toLowerCase());

     return {
         name: canonicalName,
         totalSIP: totalSIP,
         totalLoan: totalLoan,
         totalPayment: totalPayment,
         overallBalance: overallBalance,
         netLoanOutstanding: netLoanOutstanding,
         imageUrl: latestImageUrl || defaultProfilePic,
         joinDate: formatDate(joinDate),
         sipStatusText: sipStatusInfo.statusText,
         sipStatusClass: sipStatusInfo.statusClass,
         hasUnclearedLoan: hasUnclearedLoan,
         latestUnclearedLoanAmount: hasUnclearedLoan ? latestLoanAmount : 0,
         isPrimeMember: isPrime
     };
}


function showSuggestions(text) {
    // Suggestions logic remains similar
    suggestionsBox.innerHTML = '';
    const lowInput = text.toLowerCase().trim();

    if (lowInput.length < 2) {
        suggestionsBox.style.display = 'none';
        return;
    }

    const matches = new Set();
    const nameCheck = lowInput.split(' ')[0];

    // Suggest members (if data loaded)
    if (cachedSheetData) {
        const memberNames = [...new Set(cachedSheetData.map(r => r.Name))];
        memberNames.forEach(name => {
            if (name.toLowerCase().includes(lowInput) || name.toLowerCase().startsWith(nameCheck)) {
                matches.add(`${name} का विवरण`);
            }
        });
    } else { // Suggest prime members if data not loaded
        primeMembers.forEach(name => {
            if (name.toLowerCase().includes(lowInput) || name.toLowerCase().startsWith(nameCheck)) {
                matches.add(`${name} का विवरण`);
            }
        });
    }

    // Suggest rules/FAQs
    dataSegments.forEach(seg => {
        if (seg.question.toLowerCase().includes(lowInput)) {
            matches.add(seg.question);
        }
    });

    // Suggest common actions based on keywords
     if ("member".includes(lowInput) || "list".includes(lowInput) || "सभी".includes(lowInput)) {
         matches.add("सभी सदस्यों की सूची दिखाओ");
         matches.add("कुल सदस्य कितने हैं?");
     }
     if ("eligible".includes(lowInput) || "loan".includes(lowInput) || "लोन".includes(lowInput) || "पात्र".includes(lowInput)) {
          matches.add("क्या मैं लोन के लिए पात्र हूँ?");
          matches.add("Maximum loan kitna le sakte hain?");
          matches.add("Loan lene ke liye requirements kya hain?");
     }
      if ("balance".includes(lowInput) || "बैलेंस".includes(lowInput) ) {
          matches.add("मेरा बैलेंस कितना है?");
          if(cachedSheetData){ // Suggest specific members if data loaded
              const memberNames = [...new Set(cachedSheetData.map(r => r.Name))].slice(0, 2);
              memberNames.forEach(name => matches.add(`${name} का बैलेंस दिखाओ`));
          }
      }
      if ("sip".includes(lowInput) || "किश्त".includes(lowInput) ) {
          matches.add("Monthly SIP amount aur deadline kya hai?");
          matches.add("SIP bounce hone par kya hota hai?");
      }


    if (matches.size === 0) {
        suggestionsBox.style.display = 'none';
        return;
    }

    // Display suggestions
    Array.from(matches).slice(0, 6).forEach(q_text => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = q_text;
        const sanitizedQText = q_text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        div.onclick = () => {
            inputBox.value = q_text;
            suggestionsBox.style.display = 'none';
            send();
        };
        suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display = 'flex';
}


// --- *** Enhanced Smart Send Function *** ---
async function send() {
    const query = inputBox.value.trim();
    if (!query) return;

    appendMessage(query, "user");
    inputBox.value = '';
    suggestionsBox.style.display = 'none';
    const typingIndicator = appendMessage("समझ रहा हूँ...", "bot typing"); // Updated typing text

    // Basic checks for API Key and Sheet URL
    if (!API_KEY || API_KEY === "YOUR_GEMINI_API_KEY" || API_KEY.length < 30) {
        typingIndicator?.remove();
        appendMessage("त्रुटि: Gemini API कुंजी कॉन्फ़िगर नहीं है।", "bot"); return;
    }
    if (!SHEET_API_URL || SHEET_API_URL === "YOUR_GOOGLE_SHEET_APPS_SCRIPT_URL" || !SHEET_API_URL.startsWith("https://script.google.com/")) {
       typingIndicator?.remove();
       appendMessage("त्रुटि: Google Sheet URL कॉन्फ़िगर नहीं है।", "bot"); return;
    }

    // --- Step 1: Prepare context for API ---
    let memberNamesList = [];
    let sheetDataReady = cachedSheetData !== null;
    if (!sheetDataReady) {
        sheetDataReady = await fetchAndProcessSheetData(); // Fetch if not already cached
    }
    if (sheetDataReady) {
        memberNamesList = [...new Set(cachedSheetData.map(r => r.Name))];
    } else {
        // If sheet data failed to load, inform intents that need it later
        console.warn("Sheet data is not available.");
    }

    // Prepare rules context as a numbered list for potentially easier parsing by LLM
    const rulesContext = dataSegments.map((seg, index) => `${index + 1}. प्रश्न: ${seg.question}\n   उत्तर: ${seg.answer}`).join('\n\n');
    const knownNamesString = memberNamesList.length > 0 ? memberNamesList.join(', ') : "कोई सदस्य डेटा लोड नहीं हुआ";

    // --- Step 2: Define Intents and Refined Prompt ---
    const possibleIntents = [
        "get_rule",             // Ask about a rule/FAQ
        "get_member_details",   // Ask for full member details
        "check_balance",        // Ask for member balance
        "check_loan_eligibility",// Ask about member loan eligibility
        "list_all_members",     // Ask for member list
        "get_member_count",     // Ask for total members
        "greet",                // Simple greeting
        "thank_you",            // Simple thanks
        "general_query"         // Anything else / fallback
    ];

    // Refined prompt asking for JSON output and confidence score
    const prompt = `
आप 'बैंक कम्युनिटी चैटबॉट' हैं। आपका कार्य उपयोगकर्ता के हिंदी या अंग्रेजी प्रश्नों का विश्लेषण करना और संरचित जानकारी प्रदान करना है।

नियम/FAQ डेटा:
--- RULES START ---
${rulesContext}
--- RULES END ---

ज्ञात सदस्य: ${knownNamesString}

उपयोगकर्ता का प्रश्न: "${query}"

विश्लेषण कार्य:
1. प्रश्न का इरादा (intent) पहचानें। संभावित इरादे हैं: ${possibleIntents.join(', ')}.
2. यदि प्रश्न किसी सदस्य से संबंधित है, तो सदस्य का नाम (member_name) निकालें। यदि सदस्य सूची में नाम नहीं मिलता है या अस्पष्ट है, तो सदस्य सूची (${knownNamesString}) से सबसे मिलते-जुलते नाम का अनुमान लगाएं। यदि कोई सदस्य संदर्भित नहीं है, तो null सेट करें। यदि उपयोगकर्ता स्वयं के बारे में पूछ रहा है (जैसे 'मेरा बैलेंस'), तो member_name को "self" सेट करें।
3. यदि इरादा 'get_rule' है, तो ऊपर दिए गए RULES में से सबसे प्रासंगिक नियम का उत्तर (answer) प्रदान करें। यदि कोई नियम नहीं मिलता है, तो null सेट करें।
4. आपके विश्लेषण की विश्वसनीयता (confidence) का अनुमान लगाएं: 'high', 'medium', या 'low'।
5. निम्नलिखित संरचना के साथ एक JSON ऑब्जेक्ट लौटाएं:
   {
     "intent": "[पहचाना गया इरादा]",
     "member_name": "[निकाला गया नाम / 'self' / null]",
     "answer": "[नियम का उत्तर यदि intent='get_rule', अन्यथा null]",
     "confidence": "[high/medium/low]"
   }

उदाहरण:
- प्रश्न: "Mithlesh Sahni का बैलेंस?" -> {"intent": "check_balance", "member_name": "Mithlesh Sahni", "answer": null, "confidence": "high"}
- प्रश्न: "लोन पर पेनल्टी नियम क्या हैं?" -> {"intent": "get_rule", "member_name": null, "answer": "यदि लोन 31 दिन से अधिक बकाया रहता है, तो...5% पेनल्टी (RED MEMBER) लगती है।", "confidence": "high"}
- प्रश्न: "नमस्ते" -> {"intent": "greet", "member_name": null, "answer": null, "confidence": "high"}
- प्रश्न: "क्या मैं लोन ले सकता हूँ?" -> {"intent": "check_loan_eligibility", "member_name": "self", "answer": null, "confidence": "medium"}
- प्रश्न: "चाँद पर कौन गया?" -> {"intent": "general_query", "member_name": null, "answer": null, "confidence": "high"}

केवल JSON ऑब्जेक्ट प्रदान करें:
`;

    // --- Step 3: Call Gemini API ---
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
    let analysisResult = null;

    try {
        console.log("Sending query to Gemini for analysis (enhanced)...");
        const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.1, // Very low temperature for structured JSON
                    maxOutputTokens: 400,
                    responseMimeType: "application/json",
                },
                safetySettings: [ // Standard safety settings
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                ]
            }),
        });

        typingIndicator?.remove();

        if (!response.ok) {
            const errorBody = await response.text(); console.error("Gemini API Error Response:", errorBody);
            throw new Error(`API Error ${response.status}: ${response.statusText}`);
        }
        const js = await response.json();

        if (!js.candidates?.[0]?.content?.parts?.[0]?.text) {
            if (js.promptFeedback?.blockReason) { throw new Error(`Content Blocked (${js.promptFeedback.blockReason})`); }
            console.error("Unexpected API response structure:", js);
            throw new Error("API से कोई मान्य प्रतिक्रिया नहीं मिली।");
        }

        const rawJsonText = js.candidates[0].content.parts[0].text;
        console.log("Raw JSON from Gemini:", rawJsonText); // Log for debugging
        try {
            const cleanedJsonText = rawJsonText.replace(/^```json\s*/, '').replace(/\s*```$/, ''); // Clean markdown markers
            analysisResult = JSON.parse(cleanedJsonText);
            console.log("Parsed Analysis Result:", analysisResult);

            // Validate essential fields
            if (!analysisResult.intent || !possibleIntents.includes(analysisResult.intent)) {
                 console.warn("Invalid or missing intent in response:", analysisResult.intent);
                 analysisResult.intent = "general_query"; // Fallback if intent is bad
                 analysisResult.confidence = "low";
            }
             if (!analysisResult.confidence) {
                 analysisResult.confidence = "medium"; // Assume medium if missing
             }

        } catch (parseError) {
            console.error("Failed to parse JSON response from Gemini:", parseError, "\nRaw Text:", rawJsonText);
            // Fallback: treat as general query, use the raw text as potential answer if it's not JSON-like
             const seemsLikeJson = rawJsonText.trim().startsWith('{') && rawJsonText.trim().endsWith('}');
            analysisResult = {
                intent: "general_query", member_name: null,
                answer: seemsLikeJson ? null : rawJsonText, // Use raw text only if it's not JSON
                confidence: "low"
            };
        }

    } catch (error) {
        typingIndicator?.remove();
        console.error("Gemini Processing Error:", error);
        appendMessage(`क्षमा करें, आपके प्रश्न का विश्लेषण करने में त्रुटि हुई। (${error.message})`, "bot");
        displayFallbackSuggestions(); return;
    }

    // --- Step 4: Handle Based on Intent and Confidence ---
    if (!analysisResult || !analysisResult.intent) {
         console.error("Analysis result or intent is missing after processing:", analysisResult);
         appendMessage("क्षमा करें, मैं आपके अनुरोध को ठीक से समझ नहीं पाया।", "bot");
         displayFallbackSuggestions(); return;
    }

    const intent = analysisResult.intent;
    let memberName = analysisResult.member_name; // Can be name, "self", or null
    const confidence = analysisResult.confidence;
    const ruleAnswer = analysisResult.answer;

     // If confidence is low, perhaps ask for clarification before proceeding with complex actions
     if (confidence === 'low' && intent !== 'general_query' && intent !== 'greet' && intent !== 'thank_you') {
         console.warn(`Low confidence ('${confidence}') for intent '${intent}'. Asking for clarification.`);
         appendMessage("मैं पूरी तरह से निश्चित नहीं हूँ कि आप क्या पूछ रहे हैं। क्या आप कृपया अपना प्रश्न थोड़ा और स्पष्ट कर सकते हैं?", "bot");
         displayFallbackSuggestions();
         return; // Stop processing this query
     }

    // --- Step 5: Execute Action Based on Intent ---
    try {
         // Re-check sheet data readiness if needed for specific intents
         const needsSheetDataCheck = ["get_member_details", "check_balance", "check_loan_eligibility", "list_all_members", "get_member_count"].includes(intent);
         if (needsSheetDataCheck && !sheetDataReady) {
              appendMessage("सदस्य डेटा अभी लोड नहीं हुआ है। कृपया कुछ क्षण प्रतीक्षा करें और फिर से प्रयास करें।", "bot");
              // Optionally trigger fetch again: fetchAndProcessSheetData();
              return;
         }

        switch (intent) {
            case "greet":
                appendMessage("नमस्ते! मैं आपकी कैसे मदद कर सकता हूँ?", "bot");
                displayFallbackSuggestions("आप क्या जानना चाहेंगे?");
                break;
            case "thank_you":
                appendMessage("कोई बात नहीं! अगर आपको और कुछ चाहिए तो मुझे बताएं।", "bot");
                break;

            case "get_rule":
                if (ruleAnswer) {
                    const messageElement = appendMessage("", "bot");
                    typeEffect(ruleAnswer, messageElement, () => displayFallbackSuggestions("अन्य नियम या प्रश्न पूछें:"));
                } else {
                     appendMessage(`क्षमा करें, मुझे आपके प्रश्न "${query}" से संबंधित कोई विशिष्ट नियम नहीं मिला।`, "bot");
                     displayFallbackSuggestions();
                }
                break;

            case "get_member_details":
            case "check_balance":
            case "check_loan_eligibility":
                 if (!memberName || memberName === "self") {
                     // Needs name, but API indicated 'self' or couldn't find one clearly
                     appendMessage("कृपया सदस्य का नाम बताएं जिसके बारे में आप जानना चाहते हैं। (उदाहरण: 'अमित कुमार का विवरण')", "bot");
                     const memberNamesSuggest = memberNamesList.length > 0 ? memberNamesList : primeMembers;
                      appendSuggestionGroup("आप इनमें से किसी सदस्य के बारे में पूछ सकते हैं:", memberNamesSuggest.slice(0,5));
                 } else {
                    // Proceed with the extracted member name
                    const userData = getUserDataAggregated(memberName);
                    if (userData) {
                        if (intent === "get_member_details") {
                             // Display full card (Enhanced HTML structure)
                             const primeTagHtml = userData.isPrimeMember ? `<span class='prime-tag-on-photo'>⭐ Prime</span>` : '';
                             const unclearedLoanHtml = userData.hasUnclearedLoan ? `<p><span class="label"><span class="icon">⚠️</span>हालिया बकाया लोन:</span> <span class='value loan-highlight'>₹${userData.latestUnclearedLoanAmount.toLocaleString('en-IN')}</span></p>` : '';
                             let htmlResponse = `
                                 <div class='user-details-card'>
                                     <div class="user-details-header">
                                         <div class="profile-pic-container">
                                             <img src="${userData.imageUrl}" alt="${userData.name}" class="profile-pic" onclick="openImageModal('${userData.imageUrl}')">
                                             ${primeTagHtml}
                                         </div>
                                         <div class="user-info">
                                             <h3>${userData.name}</h3>
                                             <p><span class="label">🗓️ ज्वाइन तिथि:</span> ${userData.joinDate}</p>
                                         </div>
                                     </div>
                                     <div class="user-stats">
                                         <p><span class="label"><span class="icon">💰</span>कुल SIP जमा:</span> <span class="value">₹${userData.totalSIP.toLocaleString('en-IN')}</span></p>
                                         <p><span class="label"><span class="icon">💸</span>कुल लोन लिया:</span> <span class="value">₹${userData.totalLoan.toLocaleString('en-IN')}</span></p>
                                         <p><span class="label"><span class="icon">✅</span>कुल नियमित भुगतान:</span> <span class="value">₹${userData.totalPayment.toLocaleString('en-IN')}</span></p>
                                         <p><span class="label"><span class="icon">🏦</span>वर्तमान बैलेंस:</span> <strong class="value">₹${userData.overallBalance.toLocaleString('en-IN')}</strong></p>
                                         <p><span class="label"><span class="icon">📉</span>बकाया लोन राशि:</span> <span class="value ${userData.netLoanOutstanding > 0 ? 'loan-highlight' : ''}">₹${userData.netLoanOutstanding.toLocaleString('en-IN')}</span></p>
                                         ${unclearedLoanHtml}
                                         <p><span class="label"><span class="icon">🔔</span>मासिक SIP स्थिति:</span> <span class="value"><span class="sip-status ${userData.sipStatusClass}">${userData.sipStatusText}</span></span></p>
                                     </div>
                                 </div>`;
                             appendMessage(htmlResponse, "bot", true);
                             displayFallbackSuggestions(`और कुछ ${userData.name} के बारे में?`);
                        } else if (intent === "check_balance") {
                            appendMessage(`${userData.name} का वर्तमान बैलेंस ₹${userData.overallBalance.toLocaleString('en-IN')} है।`, 'bot');
                             appendSuggestionGroup("और क्या जानना चाहेंगे?", [`${userData.name} का पूरा विवरण देखें`, `${userData.name} की पात्रता देखें`, "सभी सदस्यों की सूची दिखाओ"]);
                        } else { // check_loan_eligibility
                             const eligibilityResult = calculateEligibility(userData.name, userData.overallBalance, communityBalance);
                             let eligibilityResponse = eligibilityResult.isEligible
                                ? `✅ हाँ, ${userData.name} लोन के लिए पात्र हैं। वे अधिकतम ₹${eligibilityResult.approvedAmount.toLocaleString('en-IN')} तक का लोन ले सकते हैं।`
                                : `❌ नहीं, ${userData.name} वर्तमान में लोन के लिए पात्र नहीं हैं। ${eligibilityResult.reason || ''}`;
                             appendMessage(eligibilityResponse, "bot");
                             appendSuggestionGroup("और क्या जानना चाहेंगे?", [`${userData.name} का बैलेंस देखें`, `${userData.name} का पूरा विवरण देखें`, "Loan lene ke liye requirements kya hain?"]);
                        }
                    } else {
                        appendMessage(`माफ़ कीजिए, "${memberName}" नाम का सदस्य रिकॉर्ड नहीं मिला। कृपया नाम की स्पेलिंग जांचें।`, "bot");
                         appendSuggestionGroup("क्या आप इनमें से किसी सदस्य के बारे में पूछ रहे थे?", memberNamesList.slice(0,5));
                    }
                }
                break;

            case "list_all_members":
                 const uniqueNamesList = memberNamesList.sort((a, b) => a.localeCompare(b));
                 if (uniqueNamesList.length > 0) {
                     let html = `<p><strong>सभी सदस्य (${uniqueNamesList.length}):</strong></p><div class='member-list-container'>`;
                     uniqueNamesList.forEach(name => {
                         const sanitizedName = name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                         html += `<div class='clickable-member' onclick="inputBox.value='${sanitizedName} का विवरण'; send();">${name}</div>`;
                     });
                     html += "</div>";
                     appendMessage(html, 'bot', true);
                 } else { appendMessage("अभी कोई सदस्य डेटा उपलब्ध नहीं है।", "bot"); }
                break;

            case "get_member_count":
                 const uniqueNamesCount = memberNamesList.length;
                 appendMessage(`वर्तमान में समुदाय में कुल ${uniqueNamesCount} सदस्य हैं।`, "bot");
                 break;

            case "general_query":
            default: // Fallback for unknown intents or general queries
                console.log("Handling as general query with Gemini:", query);
                 // If analysis provided a direct answer (e.g., from failed JSON parse but valid text)
                 if (ruleAnswer) {
                    const messageElement = appendMessage("", "bot");
                    typeEffect(ruleAnswer, messageElement, () => displayFallbackSuggestions("अन्य प्रश्न पूछें:"));
                    break; // Exit switch here
                 }

                // Otherwise, make a simpler call to Gemini for direct answer generation
                 const simplePrompt = `आप एक सहायक बैंक कम्युनिटी चैटबॉट हैं। उपयोगकर्ता ने पूछा है: "${query}". संक्षिप्त और सटीक उत्तर दें। यदि प्रश्न बैंक योजना से असंबंधित है, तो विनम्रतापूर्वक बताएं कि आपका मुख्य फोकस बैंक कम्युनिटी सहायता पर है। उत्तर:`;
                try {
                    const fallbackTyping = appendMessage("...", "bot typing");
                    const fallbackResponse = await fetch(GEMINI_API_URL, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: simplePrompt }] }],
                            generationConfig: { temperature: 0.7, maxOutputTokens: 500 },
                            safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, ]
                        }),
                    });
                    fallbackTyping?.remove();
                    if (!fallbackResponse.ok) throw new Error(`Fallback API Error ${fallbackResponse.status}`);
                    const fallbackJs = await fallbackResponse.json();
                    if (!fallbackJs.candidates?.[0]?.content?.parts?.[0]?.text) { throw new Error(fallbackJs.promptFeedback?.blockReason ? `Content Blocked (${fallbackJs.promptFeedback.blockReason})` : "Fallback API से कोई प्रतिक्रिया नहीं मिली"); }

                    const rawAnswer = fallbackJs.candidates[0].content.parts[0].text.trim();
                    const messageElement = appendMessage("", "bot");
                    typeEffect(rawAnswer, messageElement, () => displayFallbackSuggestions("संबंधित प्रश्न पूछें:"));
                } catch (fallbackError) {
                     fallbackTyping?.remove();
                     console.error("Gemini Fallback Error:", fallbackError);
                     appendMessage(`क्षमा करें, प्रतिक्रिया प्राप्त करने में त्रुटि हुई। ${fallbackError.message || ''}`, "bot");
                     displayFallbackSuggestions();
                }
                break;
        } // End Switch

    } catch (error) {
        console.error("Error handling intent:", intent, error);
        appendMessage("क्षमा करें, आपके अनुरोध को संसाधित करने में एक अप्रत्याशित त्रुटि हुई।", "bot");
        displayFallbackSuggestions();
    }
}


// --- Event Listeners & Initialization ---
// (Event listeners remain the same)
document.addEventListener('click', function(event) {
    if (inputBox && suggestionsBox && !inputBox.contains(event.target) && !suggestionsBox.contains(event.target)) {
        suggestionsBox.style.display = 'none';
    }
});
if (imageModal) {
    imageModal.addEventListener('click', function(event) {
         if (event.target === imageModal) { closeImageModal(); }
    });
}

function handleKey(event) {
    if (event.key === 'Enter') { send(); }
}

// Optional: Fetch data on page load for faster initial response for member queries
document.addEventListener('DOMContentLoaded', () => {
     fetchAndProcessSheetData();
});

</script>

</body>
</html>
