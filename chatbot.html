<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§¨‡•à‡§Ç‡§ï ‡§ö‡•à‡§ü‡§¨‡•â‡§ü</title>
    <style>
        /* --- Styles --- */
:root {
    --primary-color: #4caf50; /* Green */
    --secondary-color: #f0f2f5; /* Light grey background */
    --user-message-bg: #dcf8c6; /* Light green */
    --bot-message-bg: #ffffff; /* White */
    --text-dark: #333333;
    --text-light: #555555;
    --border-color: #dddddd;
    --suggestion-bg: #e9f5e9;
    --suggestion-hover-bg: #c8e6c9;
    --prime-member-bg: #ffc107; /* Yellow for Prime tag BG */
    --prime-member-text: #000000; /* Black for Prime tag text */
    --loan-highlight-color: #dc3545; /* Red for loan highlight */
    --header-height: 60px;
    --input-area-height: 60px; /* ** Crucial for input area height ** */
    --border-radius: 8px; /* Consistent border radius */
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--secondary-color); overflow: hidden; font-size: 16px; }
.chat-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 800px; margin: 0 auto; background: var(--bot-message-bg); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-radius: 0; }
@media (min-width: 801px) { .chat-container { height: 90vh; max-height: 750px; margin: 20px auto; border-radius: var(--border-radius); } }
.chat-header { height: var(--header-height); background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25em; font-weight: 600; padding: 0 20px; flex-shrink: 0; border-top-left-radius: inherit; border-top-right-radius: inherit; }
.chat-header .icon { margin-right: 10px; font-size: 1.5em; }
.chat-messages { flex-grow: 1; padding: 15px 10px; overflow-y: auto; background-color: var(--secondary-color); display: flex; flex-direction: column; gap: 12px; }
.message { padding: 12px 18px; border-radius: 18px; line-height: 1.6; word-wrap: break-word; max-width: 85%; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.08); font-size: 0.98em; }
.message a { color: #0066cc; text-decoration: underline; } .message a:hover { color: #004c99; }
.message p { margin-bottom: 10px; } .message p:last-child { margin-bottom: 0; }
.message ul, .message ol { margin-left: 20px; margin-bottom: 10px; padding-left: 15px; } .message ul li { margin-bottom: 6px; }

/* User & Bot Bubble Styles */
.user { align-self: flex-end; background-color: var(--user-message-bg); color: var(--text-dark); border-bottom-right-radius: 6px; }
.bot { align-self: flex-start; background-color: var(--bot-message-bg); color: var(--text-dark); border: 1px solid #f0f0f0; border-bottom-left-radius: 6px; }
.bot.typing { color: var(--text-light); font-style: italic; background-color: transparent; border: none; box-shadow: none; padding-left: 0; }

/* User Details Card Styling */
.user-details-card { padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: #f9f9f9; margin-top: 5px; } /* Added margin-top */
.user-details-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
.profile-pic-container { position: relative; flex-shrink: 0; width: 75px; height: 75px; }
.profile-pic { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-color); background-color: #eee; }
.prime-tag-on-photo {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: var(--prime-member-bg);
    color: var(--prime-member-text);
    font-size: 0.7em;
    font-weight: bold;
    padding: 3px 6px;
    border-radius: 4px;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    z-index: 1; /* Ensure tag is above image */
}
.user-info h3 { margin: 0; font-size: 1.2em; color: var(--text-dark); }
.user-info p { margin: 4px 0 0; font-size: 0.9em; color: var(--text-light); }
.user-stats { border-top: 1px solid var(--border-color); padding-top: 15px; }
.user-stats p { margin-bottom: 8px; font-size: 0.95em; display: flex; justify-content: space-between; flex-wrap: wrap; } /* Added flex-wrap */
.user-stats .label { color: var(--text-light); margin-right: 5px; }
.user-stats .value { font-weight: 600; text-align: right; }
.loan-highlight { color: var(--loan-highlight-color); }
.sip-status { font-weight: bold; padding: 2px 5px; border-radius: 4px; font-size: 0.9em; }
.sip-status.paid { color: #fff; background-color: #28a745; } /* Green */
.sip-status.pending { color: #fff; background-color: var(--loan-highlight-color); } /* Red */
.sip-status.due { color: #212529; background-color: #ffc107; } /* Yellow/Orange */

/* Clickable Member List */
.member-list-container { padding: 10px 0; max-height: 200px; overflow-y: auto; /* Add scroll if list is long */ }
.clickable-member {
     display: block; padding: 8px 12px; margin-bottom: 4px; background-color: #f1f1f1;
     border-radius: 5px; cursor: pointer; color: var(--text-dark); text-decoration: none;
     transition: background-color 0.2s ease;
     font-size: 0.95em;
}
.clickable-member:hover { background-color: #e0e0e0; }

/* Suggestions IN CHAT */
.suggestion-group { background-color: var(--bot-message-bg); border: 1px solid var(--border-color); padding: 15px; margin-top: 5px; border-radius: 15px; align-self: flex-start; max-width: 85%; }
.suggestion-group .group-title { font-weight: bold; margin-bottom: 12px; color: var(--text-light); font-size: 0.9em; }
.chat-suggestion { display: block; background-color: var(--suggestion-bg); color: var(--primary-color); padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9em; margin-bottom: 6px; border: 1px solid #d0e0d0; transition: background-color 0.2s ease, border-color 0.2s ease; text-align: left; font-weight: 500; }
.chat-suggestion:hover { background-color: var(--suggestion-hover-bg); border-color: #b0c0b0; } .chat-suggestion:last-child { margin-bottom: 0; }

/* --- Input Area --- */
.chat-input-area {
    height: var(--input-area-height); /* Use the variable */
    display: flex;
    align-items: center; /* Center items vertically */
    border-top: 1px solid var(--border-color);
    background-color: #ffffff;
    padding: 8px 10px; /* Padding around input/button */
    flex-shrink: 0; /* Prevent input area from shrinking */
    position: relative;
}
.chat-input-area input {
    flex-grow: 1;
    height: 100%; /* Make input fill the container height */
    padding: 0 15px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 1em; /* Ensure font size is appropriate */
    outline: none;
    margin-right: 8px;
}
.chat-input-area input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
.chat-input-area button {
    height: 100%; /* Make button fill the container height */
    padding: 0 20px;
    border: none;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    font-size: 1em;
    font-weight: bold;
    border-radius: 20px;
    transition: background-color 0.2s ease;
    flex-shrink: 0; /* Prevent button from shrinking */
}
.chat-input-area button:hover { background: #45a049; }

/* Suggestions ABOVE input */
.suggestions { position: absolute; bottom: calc(var(--input-area-height) + 5px); left: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; padding: 10px; background: #ffffff; border: 1px solid var(--border-color); max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; }
.suggestion { background: #f1f1f1; color: var(--text-dark); padding: 10px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; text-align: left; border: 1px solid transparent; transition: background-color 0.2s ease; }
.suggestion:hover { background: #e0e0e0; }

/* Image Modal Styles */
.modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; /* Use flex for centering */ }
.modal-content { margin: auto; display: block; max-width: 85%; max-height: 85%; }
.modal-close { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; line-height: 1; /* Better vertical alignment */ }
.modal-close:hover, .modal-close:focus { color: #bbb; text-decoration: none; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <span class="icon">üè¶</span>Bank community chatbot üí¨
    </div>
    <div class="chat-messages" id="chat">
        <div class="message bot">
            ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ, ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§î‡§∞ ‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§Ü‡§™ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§≠‡•Ä ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•Ç‡§Å‡§ó‡§æ‡•§
        </div>
    </div>
    <div class="suggestions" id="suggestions" style="display:none;"></div>
    <div class="chat-input-area">
        <input id="input" type="text" placeholder="‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á '‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏', 'SIP ‡§ï‡§¨ ‡§¶‡•á‡§®‡§æ ‡§π‡•à?')..." oninput="showSuggestions(this.value)" onkeyup="handleKey(event)" autocomplete="off">
        <button onclick="send()" aria-label="‡§≠‡•á‡§ú‡•á‡§Ç">‡§≠‡•á‡§ú‡•á‡§Ç</button>
    </div>
</div>

<div id="imageModal" class="modal-overlay">
    <span class="modal-close" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImageContent">
</div>

<script>
// --- Configuration, Global State, dataSegments ---
const API_KEY = "AIzaSyBwhJNl7Rw4Xwb8esmsIes5uVX2fWlRnSE"; // <<<--- *** ‡§Ö‡§™‡§®‡•Ä Gemini API ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç ***
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbz9LCkPR8L3-i7F1KG2KUJ6It2l_p55murljRJ_4108nFysOXUOpG5WEs1sdEaGHq1L7w/exec"; // <<<--- *** ‡§Ö‡§™‡§®‡§æ Apps Script URL ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç ***
const defaultProfilePic = 'https://via.placeholder.com/100/CCCCCC/FFFFFF?text=üë§';
const primeMembers = ["Amit Kumar", "Mithilesh Sahni", "Prince Rama"]; // ‡§Ø‡§¶‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•ã ‡§§‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç

let cachedSheetData = null;
let communityBalance = 0;
let isFetchingData = false;

// Rules/FAQ Data Store
const dataSegments = [
  // ... (‡§∏‡§æ‡§∞‡§æ dataSegments ‡§µ‡§æ‡§≤‡§æ JSON ‡§Ø‡§π‡§æ‡§Å ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§ú‡•à‡§∏‡§æ ‡§™‡§π‡§≤‡•á ‡§•‡§æ) ...
  {
    "question": "Bank community loan kya hai?",
    "answer": "‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§è‡§ï ‡§Ü‡§™‡§∏‡•Ä ‡§∏‡§π‡§Ø‡•ã‡§ó ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§¨‡§ö‡§§ ‡§î‡§∞ ‡§ã‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§π‡•à, ‡§ú‡•ã ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§ï‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§™‡•ú‡§®‡•á ‡§™‡§∞ ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "Scheme kaise work karti hai?",
    "answer": "‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§è‡§ï ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§∞‡§æ‡§∂‡§ø (‚Çπ500) SIP ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ú‡§¨ ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§™‡•à‡§∏‡•á ‡§ï‡•Ä ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§µ‡§π ‡§Ö‡§™‡§®‡•Ä ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§Æ‡§Ç‡§ú‡•Ç‡§∞‡•Ä ‡§î‡§∞ ‡§Ö‡§®‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§ï‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Æ‡§ø‡§≤‡§ï‡§∞ ‡§≤‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§"
  },
  {
    "question": "Monthly SIP amount aur deadline kya hai?",
    "answer": "‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä 1 ‡§∏‡•á 10 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‚Çπ500 SIP ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§"
  },
  {
    "question": "SIP bounce hone par kya hota hai?",
    "answer": "‡§Ø‡§¶‡§ø ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•Ä SIP ‡§≤‡§ó‡§æ‡§§‡§æ‡§∞ 2-3 ‡§¨‡§æ‡§∞ ‡§¨‡§æ‡§â‡§Ç‡§∏ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡§ï‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ 1 ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "Cancellation par deposit refund hoga?",
    "answer": "‡§π‡§æ‡§Å, ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•Å‡§≤ ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§≤‡•å‡§ü‡§æ‡§à ‡§ú‡§æ‡§è‡§ó‡•Ä, ‡§≤‡•á‡§ï‡§ø‡§® ‡§â‡§∏ ‡§™‡§∞ ‡§ï‡•ã‡§à ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ‡•§"
  },
  {
    "question": "Loan lene ke liye requirements kya hain?",
    "answer": "‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡•ã ‡§™‡§π‡§≤‡•á ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§ï‡§ø ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ã‡§à ‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§≤‡•ã‡§® ‡§´‡•â‡§∞‡•ç‡§Æ ‡§≠‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§≤‡•ã‡§® ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï ‡§π‡•à: https://bank-community.github.io/Loan-from/loan.html"
  },
   {
    "question": "Loan form link",
    "answer": "‡§Ü‡§™ ‡§≤‡•ã‡§® ‡§´‡•â‡§∞‡•ç‡§Æ ‡§á‡§∏ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç: https://bank-community.github.io/Loan-from/loan.html"
  },
  {
    "question": "Loan installment duration kya hai?",
    "answer": "‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ï‡§ø‡§∏‡•ç‡§§ ‡§ï‡•Ä ‡§Ö‡§µ‡§ß‡§ø 31 ‡§¶‡§ø‡§® ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§Ö‡§ó‡§≤‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§§ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§"
  },
  {
    "question": "Free loan kya hai?",
    "answer": "‡§´‡•ç‡§∞‡•Ä ‡§≤‡•ã‡§® ‡§è‡§ï ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§ï‡•á ‡§§‡§π‡§§ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§¨‡§æ‡§∞ ‚Çπ1000 ‡§§‡§ï ‡§ï‡§æ ‡§≤‡•ã‡§® ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 5 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§ø‡§®‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ï‡•á ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ 5 ‡§¶‡§ø‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‚Çπ10 ‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§ø‡§® ‡§ï‡§æ ‡§≤‡•á‡§ü ‡§´‡§æ‡§á‡§® ‡§≤‡§ó‡§§‡§æ ‡§π‡•à‡•§"
  },
  {
    "question": "Maximum loan kitna le sakte hain?",
    "answer": "‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä ‡§ï‡•Å‡§≤ ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ 1.5 ‡§ó‡•Å‡§®‡§æ ‡§§‡§ï ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•ã ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ ‡§¶‡•ã‡§ó‡•Å‡§®‡§æ ‡§≤‡•ã‡§® ‡§ö‡§æ‡§π‡§ø‡§è, ‡§§‡•ã ‡§Ü‡§™‡§ï‡•ã 2% ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡•á‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§"
  },
  {
    "question": "Loan par late fine rules kya hain?",
    "answer": "‡§Ø‡§¶‡§ø ‡§≤‡•ã‡§® 31 ‡§¶‡§ø‡§® ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§π‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏ ‡§™‡§∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú/‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä ‡§Ö‡§ó‡§≤‡•á ‡§Æ‡§π‡•Ä‡§®‡•á ‡§∏‡•á ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡•Ä‡•§ 32-60 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è 3% ‡§î‡§∞ 61+ ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è 5% ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä (RED MEMBER) ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "Late installment ka notification compulsory hai?",
    "answer": "‡§π‡§æ‡§Å, ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§® ‡§ï‡§ø‡§∏‡•ç‡§§ ‡§¶‡•á‡§∞ ‡§∏‡•á ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™‡§ï‡•ã SMS ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§ ‡§ê‡§∏‡§æ ‡§® ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‚Çπ10 ‡§ï‡•Ä ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä ‡§≤‡§ó ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "Installment bounce ka consequence kya hai?",
    "answer": "‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§§ ‡§¶‡•ã ‡§¨‡§æ‡§∞ ‡§¨‡§æ‡§â‡§Ç‡§∏ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§Ü‡§™ ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™‡§ï‡•ã 60 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§§‡§ï ‡§ï‡•ã‡§à ‡§®‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§™‡§æ‡§è‡§ó‡§æ‡•§"
  },
  {
    "question": "EMI loan ki conditions kya hain?",
    "answer": "EMI ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§™‡§∞ ‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡•á ‡§™‡§∞ 8% ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§≤‡§ó‡§§‡§æ ‡§π‡•à‡•§ ‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§∞‡§æ‡§∂‡§ø ‚Çπ2500 ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è ‡§î‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•Ä ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§Ö‡§µ‡§ß‡§ø 3 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§π‡•ã‡§ó‡•Ä‡•§"
  },
  {
    "question": "New member join kaise karein?",
    "answer": "‡§®‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¨‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä 1 ‡§∏‡•á 5 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‚Çπ500 ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§ ‡§®‡§è ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§®‡•á ‡§ï‡•á 60 ‡§¶‡§ø‡§® ‡§¨‡§æ‡§¶ ‡§π‡•Ä ‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§™‡§æ‡§§‡•ç‡§∞ ‡§π‡•ã‡§Ç‡§ó‡•á‡•§"
  },
  {
    "question": "New member joining conditions kya hain?",
    "answer": "‡§®‡§è ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø (‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞) ‡§ï‡•Ä ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä, 1 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§ó‡•ç‡§∞‡§ø‡§Æ SIP ‡§ú‡§Æ‡§æ ‡§î‡§∞ ‡§™‡•É‡§∑‡•ç‡§†‡§≠‡•Ç‡§Æ‡§ø ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§"
  },
  {
    "question": "Payment method aur QR code?",
    "answer": "‡§Ü‡§™ SIP ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏ QR ‡§ï‡•ã‡§° ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç: https://i.ibb.co/0yLtTKTS/20250410-080021.png (‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï ‡§ï‡•ã ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç)‡•§"
  },
  {
    "question": "1 month loan par charge kitna hai?",
    "answer": "1 ‡§∏‡•á 31 ‡§¶‡§ø‡§® ‡§§‡§ï ‡§ï‡•á ‡§≤‡•ã‡§® ‡§™‡§∞ 1% ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§≤‡§ó‡§§‡§æ ‡§π‡•à‡•§"
  },
  {
    "question": "2 month loan par penalty kitni hai?",
    "answer": "32 ‡§∏‡•á 60 ‡§¶‡§ø‡§® ‡§§‡§ï ‡§ï‡•á ‡§≤‡•ã‡§® ‡§™‡§∞ 3% ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "3 month se zyada loan par penalty kitni hai?",
    "answer": "61 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§≤‡•ã‡§® ‡§∞‡§ñ‡§®‡•á ‡§™‡§∞ 5% ‡§™‡•á‡§®‡§≤‡•ç‡§ü‡•Ä ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã 'RED MEMBER' ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§"
  },
   {
    "question": "Civil score kaise improve hota hai?",
    "answer": "‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‚Çπ100 ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§Æ‡•á‡§Ç 10 ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§ú‡•Å‡§°‡§º‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§"
  },
  {
    "question": "Repayment ke baad re-loan rule kya hai?",
    "answer": "‡§®‡§π‡•Ä‡§Ç, ‡§ú‡§ø‡§∏ ‡§¶‡§ø‡§® ‡§Ü‡§™ ‡§≤‡•ã‡§® ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§â‡§∏ ‡§¶‡§ø‡§® ‡§Ü‡§™ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§≤‡•ã‡§® ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•á ‡§∏‡§ï‡§§‡•á‡•§ ‡§Ü‡§™ ‡§Ö‡§ó‡§≤‡•á ‡§¶‡§ø‡§® ‡§∏‡•á ‡§™‡•Å‡§®‡§É ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§"
  },
  {
    "question": "Member exit rules kya hain?",
    "answer": "‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤‡§®‡•á (Exit) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 60 ‡§¶‡§ø‡§® ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è, ‡§ï‡•ã‡§à ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è ‡§î‡§∞ ‡§Ü‡§™‡§ï‡•ã Exit ‡§´‡•â‡§∞‡•ç‡§Æ ‡§≠‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•Å‡§≤ ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§î‡§∞ ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú (‡§Ø‡§¶‡§ø ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã) ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä 1 ‡§∏‡•á 10 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§≤‡•å‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§ 60 ‡§¶‡§ø‡§® ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§®‡§ø‡§ï‡§≤‡§®‡•á ‡§™‡§∞ 10% ‡§ï‡•Ä ‡§ï‡§ü‡•å‡§§‡•Ä ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "Prime members kaun hain?",
    "answer": `‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§á‡§Æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ${primeMembers.join(', ')} ‡§π‡•à‡§Ç‡•§ ‡§á‡§®‡•ç‡§π‡•á‡§Ç ‡§â‡§®‡§ï‡•á ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§î‡§∞ ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ö‡•Å‡§®‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`
  },
   {
    "question": "Board members kaun hain?",
    "answer": `‡§¨‡•ã‡§∞‡•ç‡§° ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡•Ä ‡§™‡•ç‡§∞‡§æ‡§á‡§Æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡•à‡§Ç: ${primeMembers.join(', ')}‡•§`
  },
  {
    "question": "Prime member responsibilities kya hain?",
    "answer": "‡§â‡§®‡§ï‡•Ä ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§ó ‡§≤‡•á‡§®‡§æ, ‡§≤‡•ã‡§® ‡§µ‡§ø‡§§‡§∞‡§£ ‡§ï‡•Ä ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡§∞‡§®‡§æ, ‡§´‡§Ç‡§° ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡§∞ ‡§®‡§ú‡§∞ ‡§∞‡§ñ‡§®‡§æ, ‡§®‡§è ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§¶‡•á‡§®‡§æ ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Ü‡§Ø‡•ã‡§ú‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à‡•§"
  },
  {
    "question": "Prime member banne ke rules kya hain?",
    "answer": "‡§á‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§¶‡•á‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è, ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§≤‡•á‡§®‡•á ‡§Æ‡•á‡§Ç 70% ‡§∏‡§π‡§Æ‡§§‡§ø ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è ‡§î‡§∞ ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§®‡•á‡§ó‡•á‡§ü‡§ø‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§"
  },
  {
    "question": "Guarantor requirements kya hain?",
    "answer": "‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§¨‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 6 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞ 200 ‡§Ø‡§æ ‡§â‡§∏‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§è‡§ï ‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§î‡§∞ ‡§§‡§Ø ‡§∂‡§∞‡•ç‡§§‡•ã‡§Ç ‡§ï‡§æ ‡§™‡§æ‡§≤‡§® ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§"
  },
  {
    "question": "Meeting aur transparency details?",
    "answer": "‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§ú‡§Æ‡§æ/‡§≤‡•ã‡§® ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°, ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§î‡§∞ ‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§î‡§∞ ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§™‡§∞ ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§ï‡•Ä ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§™‡§æ‡§∞‡§¶‡§∞‡•ç‡§∂‡§ø‡§§‡§æ ‡§¨‡§®‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à‡•§"
  },
  {
    "question": "Bank community website link",
    "answer": "‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§π‡•à: https://bank-community.github.io/Loan-from"
  },
  {
    "question": "Scheme start date?",
    "answer": "‡§Ø‡§π ‡§Ø‡•ã‡§ú‡§®‡§æ 23 ‡§ú‡•Ç‡§® 2024 ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§™‡§ø‡§§ ‡§ï‡•Ä ‡§ó‡§à ‡§•‡•Ä‡•§"
  },
  {
    "question": "Concurrent loan rule kya hai?",
    "answer": "‡§π‡§æ‡§Å, ‡§Ø‡§¶‡§ø ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡•á ‡§Ö‡§™‡§®‡•Ä ‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ 1.5 ‡§ó‡•Å‡§®‡§æ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à ‡§î‡§∞ ‡§â‡§∏‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‚Çπ1000 ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§∂‡•á‡§∑ ‡§π‡•à, ‡§§‡•ã ‡§µ‡§π ‚Çπ1000 ‡§§‡§ï ‡§ï‡§æ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§"
  },
  {
    "question": "Organisation kaise operate hoti hai?",
    "answer": "‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á WhatsApp ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§î‡§∞ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§ WhatsApp ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§≤‡§ø‡§Ç‡§ï: https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ"
  },
  {
    "question": "Joining link",
    "answer": "‡§Ü‡§™ ‡§á‡§∏ ‡§≤‡§ø‡§Ç‡§ï ‡§™‡§∞ ‡§ú‡§æ‡§ï‡§∞ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§≠‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç: https://bank-community.github.io/Loan-from/newbank.html"
  },
  {
      "question": "Total members count?",
      "answer": "‡§Ü‡§™ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç '‡§ï‡•Å‡§≤ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§ø‡§§‡§®‡•á ‡§π‡•à‡§Ç?' ‡§Ø‡§æ 'Total members?' ‡§î‡§∞ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¨‡§§‡§æ ‡§¶‡•Ç‡§Å‡§ó‡§æ‡•§"
  },
  {
      "question": "All members ke naam?",
      "answer": "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç '‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì' ‡§§‡§æ‡§ï‡§ø ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡•á ‡§∏‡§ï‡•Ç‡§Å‡•§" // Modified for clarity
  },
  {
      "question": "Show all members list",
      "answer": "‡§ú‡§º‡§∞‡•Ç‡§∞, ‡§Ü‡§™ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç '‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì' ‡§î‡§∞ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§®‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ ‡§¶‡•Ç‡§Å‡§ó‡§æ, ‡§ú‡§ø‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§Ü‡§™ ‡§â‡§®‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§"
  },
   {
      "question": "Balance kaise check karein?",
      "answer": "‡§Ü‡§™ ‡§Ö‡§™‡§®‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§î‡§∞ ‡§Ö‡§®‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç '[‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ] ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£'‡•§ ‡§â‡§¶‡§æ‡§π‡§∞‡§£: '‡§Ö‡§Æ‡§ø‡§§ ‡§ï‡•Å‡§Æ‡§æ‡§∞ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£'‡•§"
  },
  {
      "question": "Loan eligibility kaise check karein?",
      "answer": "‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç '[‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ] ‡§ï‡•Ä ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ'‡•§ ‡§â‡§¶‡§æ‡§π‡§∞‡§£: '‡§Ö‡§Æ‡§ø‡§§ ‡§ï‡•Å‡§Æ‡§æ‡§∞ ‡§ï‡•Ä ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ'‡•§"
  },
   {
      "question": "Outstanding loan amount meaning?",
      "answer": "‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø ‡§µ‡§π ‡§∞‡§ï‡§Æ ‡§π‡•à ‡§ú‡•ã ‡§Ü‡§™‡§®‡•á ‡§ï‡•Å‡§≤ ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à ‡§â‡§∏‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§ï‡•Å‡§≤ *‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®* (SIP ‡§ï‡•ã ‡§õ‡•ã‡§°‡§º‡§ï‡§∞) ‡§ï‡•ã ‡§ò‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¨‡§ö‡§§‡•Ä ‡§π‡•à‡•§"
   },
   {
       "question": "Recent uncleared loan meaning?",
       "answer": "‡§Ø‡§¶‡§ø ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Æ‡•á‡§Ç '‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§®' ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§§‡•ã ‡§á‡§∏‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à ‡§ï‡§ø ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡•á ‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ ‡§•‡§æ ‡§î‡§∞ ‡§â‡§∏ ‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡•á ‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à *‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®* (SIP ‡§®‡§π‡•Ä‡§Ç) ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ø‡§π ‡§â‡§∏ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à‡•§"
   }
];

// --- DOM Elements ---
const chatBox = document.getElementById("chat");
const inputBox = document.getElementById("input");
const suggestionsBox = document.getElementById("suggestions");
const imageModal = document.getElementById("imageModal");
const modalImageContent = document.getElementById("modalImageContent");

// --- Utility Functions ---
// formatDate, calculateEligibility, getSipStatus, appendMessage, linkify,
// appendSuggestionGroup, displayFallbackSuggestions, typeEffect, openImageModal, closeImageModal
// (‡§Ø‡•á ‡§∏‡§≠‡•Ä ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§™‡§π‡§≤‡•á ‡§ú‡•à‡§∏‡•á ‡§π‡•Ä ‡§∞‡§π‡•á‡§Ç‡§ó‡•á)
 function formatDate(date, options = {}) {
        if (!(date instanceof Date) || isNaN(date)) return "--";
        const defaultOptions = { day: '2-digit', month: 'short', year: 'numeric' };
        const mergedOptions = { ...defaultOptions, ...options };
        try { return date.toLocaleDateString('en-GB', mergedOptions); }
        catch (e) {
            try { const y = date.getFullYear(), m = String(date.getMonth() + 1).padStart(2, '0'), d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
            catch { return "--"; }
        }
    }
    function calculateEligibility(userName, userBalance, currentCommunityBalance) {
        if (!userName || userName === 'all') return { isEligible: false, approvedAmount: 0, reason: "‡§∏‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§æ‡§ó‡•Ç ‡§®‡§π‡•Ä‡§Ç" };
        const isEligible = userBalance > 0 && currentCommunityBalance > 0;
        let approvedAmount = 0, reason = "";
        if (isEligible) {
            const potentialAmount = userBalance * 1.5;
            approvedAmount = Math.floor(Math.min(potentialAmount, currentCommunityBalance));
            reason = approvedAmount > 0 ? "" : "(‡§´‡§Ç‡§° ‡§ï‡§Æ ‡§π‡•à)";
        } else {
            if (userBalance <= 0) reason = `(‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: ‚Çπ${userBalance.toFixed(0)})`;
            else if (currentCommunityBalance <= 0) reason = "(‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§´‡§Ç‡§° ‡§ï‡§Æ ‡§π‡•à)";
            else reason = "(‡§Ö‡§™‡§æ‡§§‡•ç‡§∞)";
        }
        return { isEligible: isEligible && approvedAmount > 0, approvedAmount: approvedAmount, reason: reason };
    }
    function getSipStatus(userData) {
        if (!userData || userData.length === 0) return { statusText: "N/A", statusClass: "" };
        const now = new Date(), currentMonth = now.getMonth(), currentYear = now.getFullYear(), currentDay = now.getDate();
        const paidThisMonth = userData.some(r => r.SipPayment > 0 && r.Date instanceof Date && !isNaN(r.Date) && r.Date.getMonth() === currentMonth && r.Date.getFullYear() === currentYear);
        if (paidThisMonth) return { statusText: "‚úÖ Paid", statusClass: "paid" };
        else if (currentDay > 10) return { statusText: "‚ùå Pending", statusClass: "pending" };
        else return { statusText: "‚ö†Ô∏è Due", statusClass: "due" };
    }
    function appendMessage(content, cls, isHtml = false) {
        const d = document.createElement("div"); d.className = "message " + cls;
        if (isHtml) {
             // Basic sanitation (remove script tags) - Consider a more robust library if needed
             const sanitizedContent = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
             // Make sure onclick handlers added dynamically are safe
             d.innerHTML = sanitizedContent;
        } else { d.textContent = content; }
        chatBox.appendChild(d); chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); return d;
    }
    function linkify(text) {
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlRegex, function(url) { let fullUrl = url; if (!fullUrl.match(/^https?:\/\//i)) fullUrl = 'http://' + fullUrl; const linkText = url.replace(/</g, "&lt;").replace(/>/g, "&gt;"); return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer">${linkText}</a>`; });
    }
    function appendSuggestionGroup(title, questions) {
        const groupDiv = document.createElement("div"); groupDiv.className = "message bot suggestion-group";
        const titleDiv = document.createElement("div"); titleDiv.className = "group-title"; titleDiv.textContent = title; groupDiv.appendChild(titleDiv);
        if (!Array.isArray(questions)) questions = [];
        const shuffledQuestions = [...questions].sort(() => 0.5 - Math.random()).slice(0, 5); // Show up to 5 random suggestions
        shuffledQuestions.forEach(q_text => {
            if (!q_text) return;
            const suggestionEl = document.createElement("div"); suggestionEl.className = "chat-suggestion"; suggestionEl.textContent = q_text;
            // Sanitize text before setting it in onclick
            const sanitizedQText = q_text.replace(/'/g, "\\'").replace(/"/g, '\\"');
            suggestionEl.onclick = () => { inputBox.value = sanitizedQText; suggestionsBox.style.display = 'none'; send(); };
            groupDiv.appendChild(suggestionEl);
        });
        if (shuffledQuestions.length > 0) { chatBox.appendChild(groupDiv); chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); }
    }
    function displayFallbackSuggestions(customTitle = "‡§Ü‡§™ ‡§Ø‡§π ‡§≠‡•Ä ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:") {
        const fallbackQuestions = dataSegments.map(s => s.question);
        if (fallbackQuestions.length > 0) {
             // Add specific actions/common queries to suggestions
             const commonQueries = ["‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì", "‡§ï‡•Å‡§≤ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§ø‡§§‡§®‡•á ‡§π‡•à‡§Ç?", "‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§ø‡§§‡§®‡§æ ‡§π‡•à?", "‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡•à‡§Ç ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?"];
             const combinedSuggestions = [...new Set([...commonQueries, ...fallbackQuestions])]; // Combine and remove duplicates
             setTimeout(() => { appendSuggestionGroup(customTitle, combinedSuggestions); }, 200);
        }
    }
    function typeEffect(text, targetElement, callback = null) {
        let i = 0; targetElement.innerHTML = '&nbsp;'; // Start with non-breaking space
        const interval = setInterval(() => {
            if (i < text.length) {
                targetElement.textContent = text.substring(0, i + 1);
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll as text types
                i++;
            } else {
                clearInterval(interval);
                // Linkify only after typing is complete
                const linkifiedHtml = linkify(text);
                targetElement.innerHTML = linkifiedHtml;
                chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); // Final scroll adjustment
                if (typeof callback === 'function') {
                     // Slight delay before triggering callback (e.g., suggestions)
                     setTimeout(callback, 150);
                }
            }
        }, 20); // Typing speed (milliseconds)
    }

    function openImageModal(imageUrl) {
        if (imageUrl && imageModal && modalImageContent) {
            // Basic check for placeholder image
            if (imageUrl.includes('via.placeholder.com')) return;
            modalImageContent.src = imageUrl;
            imageModal.style.display = "flex";
        }
    }
    function closeImageModal() {
        if (imageModal) {
            imageModal.style.display = "none";
            modalImageContent.src = ""; // Clear src
        }
    }


// --- Data Fetching & Processing ---
async function fetchAndProcessSheetData() {
    // This function remains the same as before
    if (isFetchingData) {
        console.log("Already fetching data, waiting...");
        await new Promise(resolve => {
            const interval = setInterval(() => {
                if (!isFetchingData) { clearInterval(interval); resolve(); }
            }, 300);
        });
        return cachedSheetData !== null;
    }
    if (cachedSheetData) return true;

    isFetchingData = true;
    console.log("Fetching fresh sheet data...");
    const loadingMsg = appendMessage("‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...", "bot typing");

    try {
        const response = await fetch(SHEET_API_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const rawData = await response.json();

        // Process data (same logic as before)
        cachedSheetData = rawData.map(row => {
             let parsedDate = new Date(NaN);
             if (row.Date) {
                 // Try parsing common date formats if direct parsing fails
                 parsedDate = new Date(row.Date);
                 if (isNaN(parsedDate)) {
                     // Attempt DD Mon YYYY format (e.g., "10 Apr 2024")
                     const dateParts = String(row.Date).match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})$/);
                     if (dateParts) {
                         parsedDate = new Date(`${dateParts[2]} ${dateParts[1]}, ${dateParts[3]}`);
                     }
                     // Add more specific date format parsing if needed
                 }
             }
             // If still invalid, set to a known invalid date or handle as error
             if (isNaN(parsedDate)) {
                 // console.warn(`Invalid date format encountered for row:`, row);
                 parsedDate = new Date(0); // Use Epoch as a fallback invalid date
             }

             return {
                 Name: row.Name ? String(row.Name).trim() : 'Unknown',
                 Date: parsedDate,
                 Loan: parseFloat(row.Loan) || 0,
                 Payment: parseFloat(row.Payment) || 0,
                 SipPayment: parseFloat(row["SIP Payment"]) || 0, // Check exact column name in Sheet
                 ImageUrl: row.imageUrl || null // Check exact column name
             };
        }).filter(r => r.Name !== 'Unknown' && r.Name.trim() !== ''); // Filter out rows with no name

        // Sort by date
        cachedSheetData.sort((a, b) => a.Date - b.Date);

        // Calculate community balance
        communityBalance = cachedSheetData.reduce((acc, r) => acc + r.Payment + r.SipPayment - r.Loan, 0);

        console.log(`Sheet data processed. Members: ${new Set(cachedSheetData.map(r=>r.Name)).size}, Community Balance: ${communityBalance.toFixed(2)}`);
        loadingMsg?.remove();
        isFetchingData = false;
        return true;
    } catch (error) {
        console.error("Error fetching/processing sheet data:", error);
        cachedSheetData = null; // Reset cache on error
        communityBalance = 0;
        loadingMsg?.remove();
        isFetchingData = false;
        appendMessage(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ‡•§ (${error.message})`, "bot");
        return false;
    } finally {
        isFetchingData = false; // Ensure flag is reset even if await hangs
    }
}

function getUserDataAggregated(name) {
    // This function remains the same as before
    if (!cachedSheetData) {
        console.warn("Cannot get user data, cache is empty.");
        return null;
    }
    const lowerName = name.toLowerCase().trim();
    // Find the canonical name matching case-insensitively
    const canonicalNameEntry = cachedSheetData.find(r => r.Name.toLowerCase() === lowerName);
    if (!canonicalNameEntry) return null; // No matching name found at all

    const canonicalName = canonicalNameEntry.Name; // Use the exact name from the sheet
    const userData = cachedSheetData.filter(r => r.Name === canonicalName); // Filter using the exact name

    if (userData.length === 0) return null; // Should not happen if canonicalNameEntry was found, but safety check

    let totalSIP = 0, totalLoan = 0, totalPayment = 0, latestImageUrl = "", joinDate = null;
    let lastLoanDate = null, latestLoanAmount = 0;

    // Find the earliest non-epoch date as join date
    const validDates = userData.map(r => r.Date).filter(d => d.getTime() !== 0);
    joinDate = validDates.length > 0 ? new Date(Math.min(...validDates)) : new Date(NaN);


    userData.forEach((record) => {
        totalSIP += record.SipPayment;
        totalLoan += record.Loan;
        totalPayment += record.Payment; // Regular payments towards loan
        if (record.ImageUrl) { latestImageUrl = record.ImageUrl; }

        // Track the date of the last loan taken
        if (record.Loan > 0 && record.Date instanceof Date && !isNaN(record.Date) && record.Date.getTime() !== 0) {
            if (!lastLoanDate || record.Date > lastLoanDate) {
                lastLoanDate = record.Date;
                latestLoanAmount = record.Loan; // Store the amount of the latest loan transaction
            }
        }
    });

     // Determine if the latest loan is uncleared (no regular payment *after* the last loan date)
     let hasUnclearedLoan = false;
     if (lastLoanDate) {
         // Check if there's *any* Payment > 0 record with a date *strictly after* the lastLoanDate
         const paymentExistsAfterLoan = userData.some(r =>
             r.Payment > 0 &&
             r.Date instanceof Date && !isNaN(r.Date) && r.Date.getTime() !== 0 &&
             r.Date > lastLoanDate
         );
         hasUnclearedLoan = !paymentExistsAfterLoan;
     }

    // If the latest loan is considered cleared, reset the 'latest uncleared' amount
    if (!hasUnclearedLoan) {
        latestLoanAmount = 0;
    }

    const overallBalance = (totalSIP + totalPayment) - totalLoan; // User's net balance (deposit - withdrawal)
    const netLoanOutstanding = Math.max(0, totalLoan - totalPayment); // How much loan principal is remaining

    const sipStatusInfo = getSipStatus(userData); // Check SIP status based on records
    const isPrime = primeMembers.some(pm => pm.toLowerCase() === canonicalName.toLowerCase()); // Case-insensitive prime check

    return {
        name: canonicalName,
        totalSIP: totalSIP,
        totalLoan: totalLoan,
        totalPayment: totalPayment,
        overallBalance: overallBalance,
        netLoanOutstanding: netLoanOutstanding,
        imageUrl: latestImageUrl || defaultProfilePic,
        joinDate: formatDate(joinDate),
        sipStatusText: sipStatusInfo.statusText,
        sipStatusClass: sipStatusInfo.statusClass,
        hasUnclearedLoan: hasUnclearedLoan, // Flag if the very last loan taken hasn't seen a payment yet
        latestUnclearedLoanAmount: hasUnclearedLoan ? latestLoanAmount : 0, // Show the amount only if uncleared
        isPrimeMember: isPrime
    };
}

function extractNameFromQuery(query, knownNames) {
    // Basic name extraction, can be improved or potentially replaced by API entity extraction
     const lowerQuery = query.toLowerCase();
     // Try to find a known name directly in the query
     for (const name of knownNames) {
         if (lowerQuery.includes(name.toLowerCase())) {
             return name; // Return the canonical name
         }
     }

     // Fallback: remove common keywords and see if what's left looks like a name
     // This is less reliable and might be removed if API entity extraction works well
     const keywords = ['details for', 'status of', 'balance of', 'account of', 'record of', 'ka balance', 'ki details', 'ka status', 'ka record', 'ka hisab', 'ka data', 'ki photo', 'details', 'balance', 'status', 'account', 'loan amount', 'loan', 'sip', '‡§ú‡§Æ‡§æ', '‡§≤‡•ã‡§®', '‡§¨‡§ï‡§æ‡§Ø‡§æ', '‡§π‡§ø‡§∏‡§æ‡§¨', '‡§°‡§æ‡§ü‡§æ', '‡§µ‡§ø‡§µ‡§∞‡§£', '‡§´‡•ã‡§ü‡•ã', '‡§¨‡§§‡§æ‡§ì', '‡§¶‡§ø‡§ñ‡§æ‡§ì', 'check', 'show', 'get', 'for', 'of', 'ka', 'ki', 'ke', 'eligibility', 'eligible'];
     let potentialName = lowerQuery;
     keywords.forEach(kw => {
         const regex = new RegExp(`\\b${kw}\\b`, 'gi');
         potentialName = potentialName.replace(regex, '');
     });
     potentialName = potentialName.replace(/[?‡•§.,]/g, '').trim();

     // Basic check if the remaining string could be a name (e.g., contains space or matches start of known names)
     if (potentialName && potentialName.length > 2 && potentialName.length < 35) {
         // Check against known names again after cleaning
         for (const name of knownNames) {
             if (name.toLowerCase().startsWith(potentialName)) {
                 return name;
             }
         }
         // If it contains a space, assume it's a multi-part name
         if (potentialName.includes(' ')) {
              // Capitalize each part
              return potentialName.split(' ')
                  .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                  .join(' ');
         }
     }
     return null; // No confident name found
}


function showSuggestions(text) {
    // Suggestions logic can remain similar, potentially add more dynamic suggestions based on context
    suggestionsBox.innerHTML = '';
    const lowInput = text.toLowerCase().trim();

    if (lowInput.length < 2) {
        suggestionsBox.style.display = 'none';
        return;
    }

    const matches = new Set();
    const nameCheck = lowInput.split(' ')[0]; // First word for potential name start

    // Suggest known members if input matches start
    if (cachedSheetData) {
        const memberNames = [...new Set(cachedSheetData.map(r => r.Name))];
        memberNames.forEach(name => {
            if (name.toLowerCase().includes(lowInput) || name.toLowerCase().startsWith(nameCheck)) {
                matches.add(`${name} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£`);
            }
        });
    } else {
        // Suggest prime members if data not loaded yet
        primeMembers.forEach(name => {
            if (name.toLowerCase().includes(lowInput) || name.toLowerCase().startsWith(nameCheck)) {
                matches.add(`${name} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£`);
            }
        });
    }


    // Suggest rules/FAQs
    dataSegments.forEach(seg => {
        if (seg.question.toLowerCase().includes(lowInput)) {
            matches.add(seg.question);
        }
    });

    // Suggest common actions
    if ("member".includes(lowInput) || "list".includes(lowInput) || "‡§∏‡§≠‡•Ä".includes(lowInput)) {
        matches.add("‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì");
        matches.add("‡§ï‡•Å‡§≤ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§ø‡§§‡§®‡•á ‡§π‡•à‡§Ç?");
    }
    if ("eligible".includes(lowInput) || "loan".includes(lowInput) || "‡§≤‡•ã‡§®".includes(lowInput) || "‡§™‡§æ‡§§‡•ç‡§∞".includes(lowInput)) {
         matches.add("‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡•à‡§Ç ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§§‡•ç‡§∞ ‡§π‡•Ç‡§Å?");
         matches.add("Maximum loan kitna le sakte hain?");
    }
     if ("balance".includes(lowInput) || "‡§¨‡•à‡§≤‡•á‡§Ç‡§∏".includes(lowInput) ) {
         matches.add("‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§ø‡§§‡§®‡§æ ‡§π‡•à?");
     }


    if (matches.size === 0) {
        suggestionsBox.style.display = 'none';
        return;
    }

    // Display suggestions
    Array.from(matches).slice(0, 6).forEach(q_text => { // Show up to 6 suggestions
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = q_text;
        // Sanitize text for onclick handler
        const sanitizedQText = q_text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        div.onclick = () => {
            inputBox.value = sanitizedQText;
            suggestionsBox.style.display = 'none';
            send();
        };
        suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display = 'flex';
}


// --- *** NEW Smart Send Function *** ---
async function send() {
    const query = inputBox.value.trim();
    if (!query) return;

    appendMessage(query, "user");
    inputBox.value = '';
    suggestionsBox.style.display = 'none';
    const typingIndicator = appendMessage("‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...", "bot typing");

    // Ensure API Key is set
    if (!API_KEY || API_KEY === "YOUR_GEMINI_API_KEY" || API_KEY.length < 30) {
        typingIndicator?.remove();
        appendMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: Gemini API ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§®‡•Ä ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", "bot");
        return;
    }
     // Ensure Sheet URL is set
    if (!SHEET_API_URL || SHEET_API_URL === "YOUR_GOOGLE_SHEET_APPS_SCRIPT_URL" || !SHEET_API_URL.startsWith("https://script.google.com/")) {
       typingIndicator?.remove();
       appendMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: Google Sheet URL ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§®‡§æ Apps Script URL ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", "bot");
       return;
   }

    // --- Step 1: Prepare data needed for API context ---
    let memberNamesList = [];
    let sheetDataReady = cachedSheetData !== null;
    if (!sheetDataReady) {
        sheetDataReady = await fetchAndProcessSheetData();
        // If fetching failed, we might still proceed but member-specific queries will fail
    }
    if (sheetDataReady) {
        memberNamesList = [...new Set(cachedSheetData.map(r => r.Name))];
    }

    // Prepare rules context for the API
    const rulesContext = dataSegments.map((seg, index) => `Rule ${index + 1}: Q: ${seg.question}\nA: ${seg.answer}`).join('\n\n');
    const knownNamesString = memberNamesList.length > 0 ? memberNamesList.join(', ') : "‡§Ö‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç";

    // --- Step 2: Define Intents and Prompt for Gemini ---
    // Define the possible intents your bot should recognize
    const possibleIntents = [
        "get_rule", // Asking about a specific rule/FAQ
        "get_member_details", // Asking for full details of a member
        "check_balance", // Asking for just the balance of a member
        "check_loan_eligibility", // Asking if a member is eligible for a loan
        "list_all_members", // Asking for the list of all members
        "get_member_count", // Asking for the total number of members
        "general_query" // Question not covered above, potentially general knowledge or requires basic generation
    ];

    // Construct the prompt for Gemini API
    // This prompt asks Gemini to analyze the query, determine intent, extract entities (name),
    // and potentially answer directly if it's a rule query.
    // ** IMPORTANT: This prompt needs testing and refinement! **
    const prompt = `
‡§Ü‡§™ '‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§ö‡•à‡§ü‡§¨‡•â‡§ü' ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§®‡§æ ‡§π‡•à‡•§

‡§Ø‡§π‡§æ‡§Å ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ï‡•á ‡§®‡§ø‡§Ø‡§Æ ‡§î‡§∞ ‡§Ö‡§ï‡•ç‡§∏‡§∞ ‡§™‡•Ç‡§õ‡•á ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (FAQs) ‡§π‡•à‡§Ç:
--- RULES START ---
${rulesContext}
--- RULES END ---

‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§ï‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§π‡•à: ${knownNamesString}

‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à: "${query}"

‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§∞‡•á‡§Ç:
1.  ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç‡•§
2.  ‡§®‡•Ä‡§ö‡•á ‡§¶‡•Ä ‡§ó‡§à ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§∏‡§¨‡§∏‡•á ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§á‡§∞‡§æ‡§¶‡§æ (intent) ‡§™‡§π‡§ö‡§æ‡§®‡•á‡§Ç:
    ${possibleIntents.join(', ')}
3.  ‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§ø‡§∏‡•Ä ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§π‡•à, ‡§§‡•ã ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ (member_name) ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à (‡§ú‡•à‡§∏‡•á ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§Ø‡§æ ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è), ‡§§‡•ã member_name ‡§ï‡•ã "unknown" ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã member_name ‡§ï‡•ã null ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§
4.  ‡§Ø‡§¶‡§ø ‡§á‡§∞‡§æ‡§¶‡§æ 'get_rule' ‡§π‡•à, ‡§§‡•ã ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§∏‡§¨‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§®‡§ø‡§Ø‡§Æ ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç ‡§î‡§∞ ‡§â‡§∏‡§ï‡§æ ‡§â‡§§‡•ç‡§§‡§∞ (answer) ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§®‡§ø‡§Ø‡§Æ ‡§® ‡§Æ‡§ø‡§≤‡§®‡•á ‡§™‡§∞, answer ‡§ï‡•ã null ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§
5.  ‡§è‡§ï JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§≤‡•å‡§ü‡§æ‡§è‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ï‡•Å‡§Ç‡§ú‡§ø‡§Ø‡§æ‡§Å ‡§π‡•ã‡§Ç:
    - "intent": ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ó‡§Ø‡§æ ‡§á‡§∞‡§æ‡§¶‡§æ (‡§ä‡§™‡§∞ ‡§¶‡•Ä ‡§ó‡§à ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§è‡§ï)‡•§
    - "member_name": ‡§®‡§ø‡§ï‡§æ‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ, "unknown", ‡§Ø‡§æ null‡•§
    - "answer": ‡§Ø‡§¶‡§ø ‡§á‡§∞‡§æ‡§¶‡§æ 'get_rule' ‡§π‡•à ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ ‡§Æ‡§ø‡§≤‡§æ ‡§π‡•à ‡§§‡•ã ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡§æ ‡§â‡§§‡•ç‡§§‡§∞, ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ null‡•§
    - "confidence": (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï) ‡§Ü‡§™‡§ï‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡•Ä ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø‡§§‡§æ (low, medium, high)‡•§

‡§â‡§¶‡§æ‡§π‡§∞‡§£:
- ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: "Amit Kumar ka balance kitna hai?" -> {"intent": "check_balance", "member_name": "Amit Kumar", "answer": null}
- ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: "SIP deadline kya hai?" -> {"intent": "get_rule", "member_name": null, "answer": "‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä 1 ‡§∏‡•á 10 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‚Çπ500 SIP ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§"}
- ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: "Kitne members hain?" -> {"intent": "get_member_count", "member_name": null, "answer": null}
- ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: "Kya main loan le sakta hoon?" -> {"intent": "check_loan_eligibility", "member_name": "unknown", "answer": null}
- ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: "Duniya gol kyu hai?" -> {"intent": "general_query", "member_name": null, "answer": null}

JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç:
`;

    // --- Step 3: Call Gemini API ---
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
    let analysisResult = null;

    try {
        console.log("Sending query to Gemini for analysis...");
        const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.2, // Lower temperature for more predictable JSON output
                    maxOutputTokens: 300,
                    responseMimeType: "application/json", // Request JSON output
                },
                safetySettings: [ // Standard safety settings
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                ]
            }),
        });

        typingIndicator?.remove(); // Remove typing indicator once response starts processing

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("Gemini API Error Response:", errorBody);
            throw new Error(`API Error ${response.status}: ${response.statusText}`);
        }

        const js = await response.json();

        if (!js.candidates || js.candidates.length === 0 || !js.candidates[0].content?.parts?.[0]?.text) {
             if (js.promptFeedback?.blockReason) {
                 throw new Error(`Content Blocked (${js.promptFeedback.blockReason})`);
             }
            console.error("Unexpected API response structure:", js);
            throw new Error("API ‡§∏‡•á ‡§ï‡•ã‡§à ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§");
        }

        // Attempt to parse the JSON response from Gemini
        const rawJsonText = js.candidates[0].content.parts[0].text;
         console.log("Raw JSON from Gemini:", rawJsonText); // Log raw response for debugging
        try {
             // Clean potential markdown ```json ... ``` markers if present
             const cleanedJsonText = rawJsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
            analysisResult = JSON.parse(cleanedJsonText);
            console.log("Parsed Analysis Result:", analysisResult);
        } catch (parseError) {
            console.error("Failed to parse JSON response from Gemini:", parseError, "\nRaw Text:", rawJsonText);
            // If JSON parsing fails, treat as general query and let Gemini answer directly
             analysisResult = { intent: "general_query", member_name: null, answer: rawJsonText }; // Fallback using raw text
             // Optionally, make a second simpler call to Gemini just to answer the original query
             // throw new Error("API ‡§∏‡•á JSON ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ‡•§");
        }


    } catch (error) {
        typingIndicator?.remove();
        console.error("Gemini Processing Error:", error);
        appendMessage(`‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ (${error.message})`, "bot");
        displayFallbackSuggestions(); // Show fallback suggestions on error
        return;
    }

    // --- Step 4: Handle Based on Intent ---
    if (!analysisResult || !analysisResult.intent) {
         console.error("Analysis result or intent is missing:", analysisResult);
         appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•ã ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§Ø‡§æ‡•§", "bot");
         displayFallbackSuggestions();
         return;
    }

    const intent = analysisResult.intent;
    let memberName = analysisResult.member_name; // Can be name, "unknown", or null

     // Normalize "unknown" or empty string from API to null for easier handling later
     if (memberName === "unknown" || (typeof memberName === 'string' && memberName.trim() === '')) {
         memberName = null;
     }


    try {
         // Fetch data again if needed and wasn't ready initially
         if (!sheetDataReady && (intent.startsWith("get_member") || intent.startsWith("check_") || intent === "list_all_members")) {
             sheetDataReady = await fetchAndProcessSheetData();
             if (!sheetDataReady) {
                 // If data still not available after trying, inform user for relevant intents
                 appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "bot");
                 return;
             }
              memberNamesList = [...new Set(cachedSheetData.map(r => r.Name))]; // Update names list if fetched now
         }


        switch (intent) {
            case "get_rule":
                if (analysisResult.answer) {
                    const messageElement = appendMessage("", "bot");
                    typeEffect(analysisResult.answer, messageElement, () => displayFallbackSuggestions("‡§Ö‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç:"));
                } else {
                    // If API couldn't find a rule, maybe try basic Gemini response or say rule not found
                     appendMessage(`‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•Å‡§ù‡•á ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® "${query}" ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§®‡§ø‡§Ø‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, "bot");
                     displayFallbackSuggestions(); // Suggest other things
                }
                break;

            case "get_member_details":
            case "check_balance":
            case "check_loan_eligibility":
                 if (!memberName) {
                    // If API identified intent needs a name but didn't find one
                     appendMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç ‡§ú‡§ø‡§∏‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ü‡§™ ‡§ú‡§æ‡§®‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç‡•§ (‡§â‡§¶‡§æ‡§π‡§∞‡§£: '‡§Ö‡§Æ‡§ø‡§§ ‡§ï‡•Å‡§Æ‡§æ‡§∞ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£')", "bot");
                     // Optionally show member list suggestion here
                     const memberNames = sheetDataReady ? [...new Set(cachedSheetData.map(r => r.Name))] : primeMembers;
                      appendSuggestionGroup("‡§Ü‡§™ ‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:", memberNames.slice(0,5));
                 } else if (!sheetDataReady) {
                      appendMessage("‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§Ö‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "bot");
                 }
                 else {
                    const userData = getUserDataAggregated(memberName);
                    if (userData) {
                        if (intent === "get_member_details") {
                            // Display full card (reuse existing logic/HTML structure)
                             const primeTagHtml = userData.isPrimeMember ? `<span class='prime-tag-on-photo'>‚≠ê Prime</span>` : '';
                             const unclearedLoanHtml = userData.hasUnclearedLoan ? `<p><span class="label">‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§®:</span> <span class='value loan-highlight'>‚Çπ${userData.latestUnclearedLoanAmount.toLocaleString('en-IN')}</span></p>` : '';
                             let htmlResponse = `
                                 <div class='user-details-card'>
                                     <div class="user-details-header">
                                         <div class="profile-pic-container">
                                             <img src="${userData.imageUrl}" alt="${userData.name}" class="profile-pic" onclick="openImageModal('${userData.imageUrl}')">
                                             ${primeTagHtml}
                                         </div>
                                         <div class="user-info">
                                             <h3>${userData.name}</h3>
                                             <p><span class="label">‡§ú‡•ç‡§µ‡§æ‡§á‡§® ‡§§‡§ø‡§•‡§ø:</span> ${userData.joinDate}</p>
                                         </div>
                                     </div>
                                     <div class="user-stats">
                                         <p><span class="label">‡§ï‡•Å‡§≤ SIP ‡§ú‡§Æ‡§æ:</span> <span class="value">‚Çπ${userData.totalSIP.toLocaleString('en-IN')}</span></p>
                                         <p><span class="label">‡§ï‡•Å‡§≤ ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ:</span> <span class="value">‚Çπ${userData.totalLoan.toLocaleString('en-IN')}</span></p>
                                         <p><span class="label">‡§ï‡•Å‡§≤ ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®:</span> <span class="value">‚Çπ${userData.totalPayment.toLocaleString('en-IN')}</span></p>
                                         <p><span class="label">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏:</span> <strong class="value">‚Çπ${userData.overallBalance.toLocaleString('en-IN')}</strong></p>
                                         <p><span class="label">‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø:</span> <span class="value ${userData.netLoanOutstanding > 0 ? 'loan-highlight' : ''}">‚Çπ${userData.netLoanOutstanding.toLocaleString('en-IN')}</span></p>
                                         ${unclearedLoanHtml}
                                         <p><span class="label">‡§Æ‡§æ‡§∏‡§ø‡§ï SIP ‡§∏‡•ç‡§•‡§ø‡§§‡§ø:</span> <span class="value"><span class="sip-status ${userData.sipStatusClass}">${userData.sipStatusText}</span></span></p>
                                     </div>
                                 </div>`;
                             appendMessage(htmlResponse, "bot", true);
                        } else if (intent === "check_balance") {
                            appendMessage(`${userData.name} ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‚Çπ${userData.overallBalance.toLocaleString('en-IN')} ‡§π‡•à‡•§`, 'bot');
                             const suggestions = [`${userData.name} ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç`, `${userData.name} ‡§ï‡•Ä ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç`, "‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì"];
                             appendSuggestionGroup("‡§î‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§®‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?", suggestions);
                        } else { // check_loan_eligibility
                             const eligibilityResult = calculateEligibility(userData.name, userData.overallBalance, communityBalance);
                             let eligibilityResponse = eligibilityResult.isEligible
                                ? `‚úÖ ‡§π‡§æ‡§Å, ${userData.name} ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§§‡•ç‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§µ‡•á ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‚Çπ${eligibilityResult.approvedAmount.toLocaleString('en-IN')} ‡§§‡§ï ‡§ï‡§æ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§`
                                : `‚ùå ‡§®‡§π‡•Ä‡§Ç, ${userData.name} ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ${eligibilityResult.reason || ''}`;
                             appendMessage(eligibilityResponse, "bot");
                             const suggestions = [`${userData.name} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç`, `${userData.name} ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç`, "Loan lene ke liye requirements kya hain?"];
                             appendSuggestionGroup("‡§î‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§®‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?", suggestions);
                        }
                    } else {
                        appendMessage(`‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, "${memberName}" ‡§®‡§æ‡§Æ ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, "bot");
                        // Suggest similar names or list members if available
                         if (sheetDataReady) {
                            const memberNames = [...new Set(cachedSheetData.map(r => r.Name))];
                             appendSuggestionGroup("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ ‡§∞‡§π‡•á ‡§•‡•á?", memberNames.slice(0,5));
                         } else { displayFallbackSuggestions();}
                    }
                }
                break;

            case "list_all_members":
                 if (!sheetDataReady) { appendMessage("‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§Ö‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "bot"); }
                 else {
                     const uniqueNamesList = [...new Set(cachedSheetData.map(r => r.Name))].sort((a, b) => a.localeCompare(b));
                     if (uniqueNamesList.length > 0) {
                         let html = `<p><strong>‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø (${uniqueNamesList.length}):</strong></p><div class='member-list-container'>`;
                         uniqueNamesList.forEach(name => {
                             const sanitizedName = name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                             // Update onclick to use the new send() logic which understands context
                             html += `<div class='clickable-member' onclick="inputBox.value='${sanitizedName} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£'; send();">${name}</div>`;
                         });
                         html += "</div>";
                         appendMessage(html, 'bot', true);
                     } else { appendMessage("‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "bot"); }
                 }
                break;

            case "get_member_count":
                 if (!sheetDataReady) { appendMessage("‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§Ö‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "bot"); }
                 else {
                     const uniqueNamesCount = new Set(cachedSheetData.map(r => r.Name)).size;
                     appendMessage(`‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§≤ ${uniqueNamesCount} ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§`, "bot");
                 }
                break;

            case "general_query":
            default: // Fallback for unknown intents or general queries
                console.log("Handling as general query with Gemini:", query);
                // Use Gemini for a direct answer to the original query, without the complex analysis prompt
                 const simplePrompt = `‡§Ü‡§™ '‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§ö‡•à‡§ü‡§¨‡•â‡§ü' ‡§π‡•à‡§Ç‡•§ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡•á ‡§™‡•Ç‡§õ‡§æ ‡§π‡•à: "${query}".
                 ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§î‡§∞ ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∏‡•á ‡§Ö‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§π‡•à, ‡§§‡•ã ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¨‡§§‡§æ‡§è‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§´‡•ã‡§ï‡§∏ ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§™‡§∞ ‡§π‡•à‡•§
                 ‡§â‡§§‡•ç‡§§‡§∞:`;
                try {
                    const fallbackTyping = appendMessage("...", "bot typing"); // New typing indicator for this call
                    const fallbackResponse = await fetch(GEMINI_API_URL, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: simplePrompt }] }],
                            generationConfig: { temperature: 0.7, maxOutputTokens: 500 }, // Standard generation config
                            safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, ]
                        }),
                    });
                    fallbackTyping?.remove();
                    if (!fallbackResponse.ok) throw new Error(`Fallback API Error ${fallbackResponse.status}`);
                    const fallbackJs = await fallbackResponse.json();
                    if (!fallbackJs.candidates || fallbackJs.candidates.length === 0) { throw new Error(fallbackJs.promptFeedback?.blockReason ? `Content Blocked (${fallbackJs.promptFeedback.blockReason})` : "Fallback API ‡§∏‡•á ‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä"); }

                    if (fallbackJs.candidates[0]?.content?.parts?.[0]?.text) {
                        const rawAnswer = fallbackJs.candidates[0].content.parts[0].text.trim();
                        const messageElement = appendMessage("", "bot");
                        typeEffect(rawAnswer, messageElement, () => displayFallbackSuggestions("‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç:"));
                    } else { throw new Error("Fallback API ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§π‡•à"); }
                } catch (fallbackError) {
                     fallbackTyping?.remove();
                     console.error("Gemini Fallback Error:", fallbackError);
                     appendMessage(`‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ${fallbackError.message || ''}`, "bot");
                     displayFallbackSuggestions();
                }
                break;
        } // End Switch

    } catch (error) {
        console.error("Error handling intent:", intent, error);
        appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•ã ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§", "bot");
        displayFallbackSuggestions();
    }
}


// --- Event Listeners & Initialization ---
// (Event listeners remain the same)
document.addEventListener('click', function(event) { // Hide suggestions on outside click
    if (inputBox && suggestionsBox && !inputBox.contains(event.target) && !suggestionsBox.contains(event.target)) {
        suggestionsBox.style.display = 'none';
    }
});
if (imageModal) { // Ensure modal exists before adding listener
    imageModal.addEventListener('click', function(event) { // Close modal on overlay click
         if (event.target === imageModal) { closeImageModal(); }
    });
}

// Initial data fetch on load (optional, can fetch on first query needing it)
// fetchAndProcessSheetData(); // ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§™‡§∞ ‡§ï‡•â‡§≤ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡§∞


// --- Helper function to handle Enter key in input ---
function handleKey(event) {
    if (event.key === 'Enter') {
        send();
    }
}

// Initialize - maybe fetch data on load
document.addEventListener('DOMContentLoaded', () => {
     // fetchAndProcessSheetData(); // Fetch data when the page is ready
     // OR: Let the send function fetch when needed
});

</script>

</body>
</html>
