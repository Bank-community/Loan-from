<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§î‡§∞ ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 15px;
            color: #333;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        select, button, input {
            padding: 12px 15px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 25px;
            font-size: 18px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .chart-container {
    position: relative;
    height: 450px; /* ‡§Æ‡•à‡§Ç‡§®‡•á ‡§ä‡§Ç‡§ö‡§æ‡§à ‡§¨‡§¢‡§º‡§æ ‡§¶‡•Ä */
    margin: 20px 0;
}

@media (max-width: 600px) {
    .chart-container {
        height: 350px; /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≠‡•Ä ‡§¨‡§¢‡§º‡§æ‡§à */
    }
}
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-gold {
            background-color: gold;
            color: #333;
        }
        .badge-silver {
            background-color: silver;
            color: #333;
        }
        .badge-bronze {
            background-color: #cd7f32;
            color: white;
        }
        .top-members {
            margin-top: 30px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 8px;
        }
        .all-members {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
        }
        .member-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #d1e7f7;
        }
        .member-rank {
            font-weight: bold;
            margin-right: 10px;
            width: 30px;
            display: inline-block;
        }
        .top-member {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #d1e7f7;
        }
        .score-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 8px;
        }
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .score-table th, .score-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .score-table th {
            background-color: #3498db;
            color: white;
        }
        .score-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .score-card {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .score-level {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        .score-good {
            background-color: #ffcc00;
            color: #333;
        }
        .score-better {
            background-color: #ff9900;
            color: white;
        }
        .score-best {
            background-color: #00cc66;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .highlight {
            background-color: #fffacd;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            select, button, input {
                font-size: 14px;
                padding: 10px 12px;
            }
            .result {
                font-size: 16px;
            }
            .chart-container {
                height: 250px;
            }
            .score-card {
                flex-direction: column;
            }
            .score-level {
                margin: 5px 0;
            }
            .modal-content {
                width: 90%;
                margin: 20% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§î‡§∞ ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ</h2>
        <label>‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç:</label>
        <select id="personSelect"></select>
        <button onclick="calculateCreditScore()">‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
        <button onclick="showScoreDetails()" id="scoreDetailsBtn" style="display: none; background-color: #2ecc71;">‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
        <div class="result" id="result"></div>
        
<div class="chart-container">
    <canvas id="historyChart"></canvas>
</div>
        
        
        <div class="score-info" id="scoreInfo"></div>
        <div class="top-members" id="topMembers"></div>
        <div class="all-members" id="allMembers"></div>
    </div>

    <!-- Score Details Modal -->
    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const apiUrl = "https://script.google.com/macros/s/AKfycbyzs5UbjLWv9U-JBiT87iTd8Pbgy2yxYUI8vsiiiQ7zkFNF7L5t49aBZOnsFgvK4GZc2A/exec";
        let allData = [];
        let historyChart = null;
        let currentMemberData = null;

        async function fetchData() {
            try {
                document.getElementById("result").innerHTML = "<p>‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>";
                const response = await fetch(apiUrl);
                const data = await response.json();
                allData = data;

                let uniqueNames = [...new Set(data.map(item => item.Name))];

                let selectBox = document.getElementById("personSelect");
                selectBox.innerHTML = "";
                uniqueNames.forEach(name => {
                    let option = document.createElement("option");
                    option.value = name;
                    option.innerText = name;
                    selectBox.appendChild(option);
                });

                displayTopMembers();
            } catch (error) {
                document.getElementById("result").innerHTML = `<p style="color: red;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</p>`;
            }
        }

        function displayTopMembers() {
            let individualBalances = calculateIndividualBalances();
            
            // Convert to array and calculate scores for all members
            let allMembers = Object.entries(individualBalances)
                .map(([name, data]) => {
                    let scoreData = calculateCreditScoreForMember(data);
                    return {
                        name,
                        balance: data.currentBalance,
                        loan: data.totalLoan,
                        timelyPayments: data.timelyPayments,
                        creditScore: scoreData.totalScore,
                        scoreData: scoreData
                    };
                })
                .sort((a, b) => b.creditScore - a.creditScore);
            
            // Get top 3 members
            let topMembers = allMembers.slice(0, 3);
            
            // Display top members with medals
            let topMembersDiv = document.getElementById("topMembers");
            if (topMembers.length > 0) {
                topMembersDiv.innerHTML = "<h3>‡§∂‡•Ä‡§∞‡•ç‡§∑ 3 ‡§∏‡§¶‡§∏‡•ç‡§Ø (‡§á‡§∏ ‡§Æ‡§æ‡§π)</h3>";
                
                topMembers.forEach((member, index) => {
                    let badgeClass = "";
                    let badgeText = "";
                    if (index === 0) {
                        badgeClass = "badge-gold";
                        badgeText = "üèÜ ‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§†";
                    } else if (index === 1) {
                        badgeClass = "badge-silver";
                        badgeText = "ü•à ‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø";
                    } else if (index === 2) {
                        badgeClass = "badge-bronze";
                        badgeText = "ü•â ‡§§‡•É‡§§‡•Ä‡§Ø";
                    }
                    
                    topMembersDiv.innerHTML += `
                        <div class="top-member">
                            <span>${member.name} <span class="badge ${badgeClass}">${badgeText}</span></span>
                            <span>‡§∏‡•ç‡§ï‡•ã‡§∞: ${member.creditScore >= 900 ? '900+' : member.creditScore}</span>
                        </div>
                    `;
                });
            } else {
                topMembersDiv.innerHTML = "<p>‡§ï‡•ã‡§à ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>";
            }
            
            // Display all members with their scores
            displayAllMembers(allMembers);
        }

        function displayAllMembers(allMembers) {
            let allMembersDiv = document.getElementById("allMembers");
            allMembersDiv.innerHTML = "<h3>‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞</h3>";
            
            if (allMembers.length === 0) {
                allMembersDiv.innerHTML += "<p>‡§ï‡•ã‡§à ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>";
                return;
            }
            
            allMembers.forEach((member, index) => {
                let isTop3 = index < 3;
                let highlightClass = isTop3 ? "highlight" : "";
                let rankBadge = "";
                
                if (index === 0) {
                    rankBadge = '<span class="badge badge-gold">ü•á</span>';
                } else if (index === 1) {
                    rankBadge = '<span class="badge badge-silver">ü•à</span>';
                } else if (index === 2) {
                    rankBadge = '<span class="badge badge-bronze">ü•â</span>';
                }
                
                allMembersDiv.innerHTML += `
                    <div class="member-item ${highlightClass}">
                        <div>
                            <span class="member-rank">${index + 1}.</span>
                            ${member.name} ${rankBadge}
                        </div>
                        <span>‡§∏‡•ç‡§ï‡•ã‡§∞: ${member.creditScore >= 900 ? '900+' : member.creditScore}</span>
                    </div>
                `;
            });
        }

        function calculateCreditScoreForMember(memberData) {
            // Calculate score components
            const balancePoints = Math.min(300, Math.floor(memberData.currentBalance / 1000) * 10);
            const paymentPoints = Math.min(300, memberData.timelyPayments * 15);
            const loanUtilization = memberData.totalLoan > 0 ? 
                (memberData.currentBalance / memberData.totalLoan) : 1;
            const utilizationPoints = Math.min(300, Math.floor(loanUtilization * 100));
            
            // Calculate total score (300-900)
            const totalScore = Math.min(900, Math.max(300, 
                300 + balancePoints + paymentPoints + utilizationPoints));
            
            return {
                totalScore: Math.floor(totalScore),
                components: {
                    balance: Math.floor(balancePoints),
                    payments: Math.floor(paymentPoints),
                    utilization: Math.floor(utilizationPoints)
                }
            };
        }

        function calculateIndividualBalances() {
            let individualBalances = {};

            allData.forEach(entry => {
                let name = entry.Name;
                let emi = parseInt(entry[" EMI payment"]) || 0;
                let loan = parseInt(entry["Loan"]) || 0;
                let payment = parseInt(entry["Payment"]) || 0;
                let date = entry.Date || "";

                if (!individualBalances[name]) {
                    individualBalances[name] = {
                        totalEMI: 0,
                        totalPayment: 0,
                        totalLoan: 0,
                        timelyPayments: 0,
                        history: [],
                        currentBalance: 0
                    };
                }

                individualBalances[name].totalEMI += emi;
                individualBalances[name].totalPayment += payment;
                individualBalances[name].totalLoan += loan;
                
                if (payment > 0) {
                    individualBalances[name].timelyPayments++;
                }
                
                individualBalances[name].currentBalance = 
                    individualBalances[name].totalEMI + 
                    individualBalances[name].totalPayment - 
                    individualBalances[name].totalLoan;
                
                if (date) {
                    individualBalances[name].history.push({
                        date,
                        balance: individualBalances[name].currentBalance
                    });
                }
            });

            return individualBalances;
        }

        function calculateCreditScore() {
            let selectedName = document.getElementById("personSelect").value;
            if (!selectedName) {
                alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ö‡•Å‡§®‡•á‡§Ç");
                return;
            }

            let individualBalances = calculateIndividualBalances();
            let personData = individualBalances[selectedName];
            
            if (!personData) {
                document.getElementById("result").innerHTML = "<p style='color: red;'>‡§á‡§∏ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>";
                document.getElementById("scoreDetailsBtn").style.display = "none";
                return;
            }

            currentMemberData = personData;
            currentMemberData.name = selectedName;

            let totalBankBalance = Object.values(individualBalances)
                .reduce((sum, person) => sum + person.currentBalance, 0);
            
            let currentBalance = personData.currentBalance;
            let approvedLoan = currentBalance > 0 && totalBankBalance > 0 ? currentBalance * 1.5 : 0;

            // Calculate credit score with components
            let creditScore = calculateCreditScoreForMember(personData);
            let displayScore = creditScore.totalScore >= 900 ? "900+" : creditScore.totalScore;
            
            let color = creditScore.totalScore >= 750 ? "green" : 
                       creditScore.totalScore >= 600 ? "orange" : "red";
            
            let loanMessage = approvedLoan > 0
                ? `<p style="color: green;">‡§Ü‡§™ ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‚Çπ${approvedLoan.toLocaleString()} ‡§§‡§ï ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>`
                : `<p style="color: red;">‡§Ü‡§™‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§Æ ‡§π‡•à, ‡§≤‡•ã‡§® ‡§Ö‡§™‡•ç‡§∞‡•Ç‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ‡•§</p>`;

            // Check if member is in top 3
            let isTopMember = false;
            let memberRank = 0;
            let topMembersDiv = document.getElementById("topMembers");
            if (topMembersDiv.innerHTML.includes(selectedName)) {
                isTopMember = true;
                if (topMembersDiv.innerHTML.indexOf(selectedName) < topMembersDiv.innerHTML.indexOf("‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø")) {
                    memberRank = 1;
                } else if (topMembersDiv.innerHTML.indexOf(selectedName) < topMembersDiv.innerHTML.indexOf("‡§§‡•É‡§§‡•Ä‡§Ø")) {
                    memberRank = 2;
                } else {
                    memberRank = 3;
                }
            }

            let topMemberTag = isTopMember 
                ? `<p style="color: ${memberRank === 1 ? 'gold' : memberRank === 2 ? 'silver' : '#cd7f32'}; 
                    font-weight: bold;">${memberRank === 1 ? 'üèÜ ‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§† ‡§∏‡§¶‡§∏‡•ç‡§Ø' : memberRank === 2 ? 'ü•à ‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø ‡§∏‡•ç‡§•‡§æ‡§®' : 'ü•â ‡§§‡•É‡§§‡•Ä‡§Ø ‡§∏‡•ç‡§•‡§æ‡§®'}</p>`
                : "";

            // Display result
            let resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `
                <p style="font-size: 22px; font-weight: bold; color: ${color};">‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞: ${displayScore}</p>
                ${topMemberTag}
                <p>‡§Ü‡§™‡§ï‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: ‚Çπ${currentBalance.toLocaleString()}</p>
                <p>‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®: ‚Çπ${personData.totalPayment.toLocaleString()}</p>
                <p>‡§ï‡•Å‡§≤ ‡§ã‡§£: ‚Çπ${personData.totalLoan.toLocaleString()}</p>
                <p>‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®: ${personData.timelyPayments}</p>
                ${loanMessage}
            `;

            // Show score details button
            document.getElementById("scoreDetailsBtn").style.display = "block";

            // Display score info and rating
            displayScoreInfo(creditScore);
            
            // Display history chart
            displayHistoryChart(selectedName, personData.history);
        }

        function displayScoreInfo(creditScore) {
            let scoreInfoDiv = document.getElementById("scoreInfo");
            
            // Score level rating
            let scoreLevel = "";
            let scoreClass = "";
            if (creditScore.totalScore >= 800) {
                scoreLevel = "‡§¨‡•á‡§∏‡•ç‡§ü";
                scoreClass = "score-best";
            } else if (creditScore.totalScore >= 650) {
                scoreLevel = "‡§¨‡•á‡§ü‡§∞";
                scoreClass = "score-better";
            } else {
                scoreLevel = "‡§ó‡•Å‡§°";
                scoreClass = "score-good";
            }
            
            // Score card visualization
            scoreInfoDiv.innerHTML = `
                <h3>‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó: <span class="${scoreClass}">${scoreLevel}</span></h3>
                <div class="score-card">
                    <div class="score-level ${creditScore.totalScore >= 300 ? 'score-good' : ''}">300-599</div>
                    <div class="score-level ${creditScore.totalScore >= 600 ? 'score-better' : ''}">600-799</div>
                    <div class="score-level ${creditScore.totalScore >= 800 ? 'score-best' : ''}">800-900+</div>
                </div>
                
                <h4>‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡•à‡§∏‡•á ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç:</h4>
                <ul>
                    <li>‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç (15 ‡§™‡•â‡§á‡§Ç‡§ü ‡§™‡•ç‡§∞‡§§‡§ø ‡§≠‡•Å‡§ó‡§§‡§æ‡§®)</li>
                    <li>‡§Ö‡§™‡§®‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç (‚Çπ1000 ‡§™‡§∞ 10 ‡§™‡•â‡§á‡§Ç‡§ü)</li>
                    <li>‡§ã‡§£ ‡§ï‡§æ ‡§ï‡§Æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç (‡§ï‡§Æ ‡§ã‡§£ = ‡§Ö‡§ß‡§ø‡§ï ‡§™‡•â‡§á‡§Ç‡§ü)</li>
                </ul>
                
                <table class="score-table">
                    <tr>
                        <th>‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§∞‡•á‡§Ç‡§ú</th>
                        <th>‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó</th>
                        <th>‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ</th>
                    </tr>
                    <tr>
                        <td>800-900+</td>
                        <td>‡§¨‡•á‡§∏‡•ç‡§ü</td>
                        <td>‡§â‡§ö‡•ç‡§ö‡§§‡§Æ ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ</td>
                    </tr>
                    <tr>
                        <td>650-799</td>
                        <td>‡§¨‡•á‡§ü‡§∞</td>
                        <td>‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ</td>
                    </tr>
                    <tr>
                        <td>300-649</td>
                        <td>‡§ó‡•Å‡§°</td>
                        <td>‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ</td>
                    </tr>
                </table>
            `;
        }

        function displayHistoryChart(name, historyData) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            historyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = historyData.map(item => {
                const date = new Date(item.date);
                return `${date.getDate()}/${date.getMonth()+1}`;
            });
            
            const data = historyData.map(item => item.balance);
            
            const minValue = Math.max(100, Math.min(...data) - 100);
            const maxValue = Math.max(...data) + 100;
            
            if (historyChart) {
                historyChart.destroy();
            }
            
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${name} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ (‚Çπ)`,
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: ‚Çπ${context.raw.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    if (index > 0) {
                                        const change = data[index] - data[index-1];
                                        const changeText = change >= 0 ? 
                                            `‚Üë ‚Çπ${Math.abs(change).toLocaleString()}` : 
                                            `‚Üì ‚Çπ${Math.abs(change).toLocaleString()}`;
                                        return `‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®: ${changeText}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: minValue,
                            max: maxValue,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toLocaleString();
                                },
                                stepSize: Math.ceil((maxValue - minValue) / 5)
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '‡§Æ‡§π‡•Ä‡§®‡§æ'
                            }
                        }
                    }
                }
            });
        }

        function showScoreDetails() {
            if (!currentMemberData) return;
            
            let creditScore = calculateCreditScoreForMember(currentMemberData);
            
            document.getElementById("modalTitle").textContent = `${currentMemberData.name} ‡§ï‡•á ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏`;
            
            document.getElementById("modalContent").innerHTML = `
                <h4>‡§ï‡•Å‡§≤ ‡§∏‡•ç‡§ï‡•ã‡§∞: ${creditScore.totalScore >= 900 ? '900+' : creditScore.totalScore}</h4>
                <table class="score-table">
                    <tr>
                        <th>‡§™‡•à‡§∞‡§æ‡§Æ‡•Ä‡§ü‡§∞</th>
                        <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                        <th>‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏</th>
                    </tr>
                    <tr>
                        <td>‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</td>
                        <td>‚Çπ${currentMemberData.currentBalance.toLocaleString()} (‚Çπ1000 ‡§™‡§∞ 10 ‡§™‡•â‡§á‡§Ç‡§ü)</td>
                        <td>${creditScore.components.balance}</td>
                    </tr>
                    <tr>
                        <td>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§á‡§§‡§ø‡§π‡§æ‡§∏</td>
                        <td>${currentMemberData.timelyPayments} ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (‡§™‡•ç‡§∞‡§§‡§ø ‡§≠‡•Å‡§ó‡§§‡§æ‡§® 15 ‡§™‡•â‡§á‡§Ç‡§ü)</td>
                        <td>${creditScore.components.payments}</td>
                    </tr>
                    <tr>
                        <td>‡§ã‡§£ ‡§â‡§™‡§Ø‡•ã‡§ó</td>
                        <td>‡§ã‡§£: ‚Çπ${currentMemberData.totalLoan.toLocaleString()}, ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏: ‚Çπ${currentMemberData.currentBalance.toLocaleString()}</td>
                        <td>${creditScore.components.utilization}</td>
                    </tr>
                </table>
                
                <h4 style="margin-top: 20px;">‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§¨‡§¢‡§º‡§æ‡§®‡•á ‡§ï‡•á ‡§ü‡§ø‡§™‡•ç‡§∏:</h4>
                <ul>
                    <li>‡§Ö‡§ó‡§≤‡•á ‚Çπ${Math.ceil((300 - creditScore.components.balance) * 100)} ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§ï‡•á ${300 - creditScore.components.balance} ‡§î‡§∞ ‡§™‡•â‡§á‡§Ç‡§ü ‡§ï‡§Æ‡§æ‡§è‡§Ç</li>
                    <li>${Math.ceil((300 - creditScore.components.payments) / 15)} ‡§î‡§∞ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§ï‡•á ${300 - creditScore.components.payments} ‡§™‡•â‡§á‡§Ç‡§ü ‡§ï‡§Æ‡§æ‡§è‡§Ç</li>
                    <li>‡§ã‡§£ ‡§ï‡§Æ ‡§ï‡§∞‡§ï‡•á ${300 - creditScore.components.utilization} ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§™‡•â‡§á‡§Ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</li>
                </ul>
            `;
            
            document.getElementById("scoreModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("scoreModal").style.display = "none";
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById("scoreModal")) {
                closeModal();
            }
        }
    
        // Initialize the app
        fetchData();
    </script>
</body>
</html>