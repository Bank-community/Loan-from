<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Community Loan Dashboard</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* All CSS styles remain the same as before */
        :root {
             --primary-color: #007BFF; --secondary-color: #056fff; --light-bg: #f8f9fa;
             --text-light: #fff; --text-dark: #555; --positive-color: #04c800;
             --negative-color: #ff1f02; --warning-color: #ffc107; --neutral-color: #808080;
             --profile-bg: linear-gradient(135deg, #0d6efd, #0a58ca); --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
             --profile-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
             --loader-color: var(--primary-color); --modal-bg: rgba(0, 0, 0, 0.88);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: var(--light-bg);
            padding-top: 230px;
            transition: padding-top 0.3s ease; color: var(--text-dark); line-height: 1.5;
        }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--light-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; font-size: 18px; color: var(--text-dark); transition: opacity 0.5s ease; padding: 20px; text-align: center; box-sizing: border-box; }
        #loader .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--loader-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #passwordPromptContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; opacity: 1; transition: opacity 0.3s ease; }
        #passwordPromptContainer.hidden { opacity: 0; pointer-events: none; }
        #passwordPromptMessage { padding: 25px 30px; background-color: #fff; border-radius: 10px; box-shadow: var(--card-shadow); text-align: center; max-width: 320px; width: 85%; }
        #passwordPromptMessage p { margin: 0 0 15px 0; font-size: 16px; }
        #passwordInput { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; text-align: center; letter-spacing: 5px; }
        #passwordSubmit { padding: 10px 20px; font-size: 16px; background-color: var(--primary-color); color: var(--text-light); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; }
        #passwordSubmit:hover { background-color: #0056b3; }
        #passwordError { color: var(--negative-color); font-weight: bold; margin-top: 10px; font-size: 14px; min-height: 1em; }
        #dashboardContent { display: none; } #dashboardContent.visible { display: block; }
        #dataTable tbody tr.highlight-recent-loan td { font-weight: bold; color: red; }
        .header { text-align: center; background-color: var(--primary-color); color: var(--text-light); padding: 10px 0; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header img { width: 40px; height: 40px; margin-right: 10px; } .header h1 { font-size: 1.2em; margin: 0; font-weight: 500; }
        .profile-section { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--profile-bg); color: var(--text-light); border-radius: 12px; box-shadow: var(--profile-shadow); width: 94%; max-width: 520px; z-index: 1000; padding: 15px; display: grid; grid-template-areas: "pic header buttons" "stats stats stats"; grid-template-columns: auto 1fr auto; grid-template-rows: auto 1fr; gap: 10px 15px; align-items: start; transition: top 0.3s ease; }
        .profile-picture { grid-area: pic; width: 75px; height: 75px; border-radius: 50%; background-color: #fff; display: flex; align-items: center; justify-content: center; font-size: 35px; font-weight: bold; color: var(--text-dark); text-transform: uppercase; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); flex-shrink: 0; border: 4px solid rgba(255, 255, 255, 0.8); overflow: hidden; margin-top: 5px; padding: 5px; box-sizing: border-box;}
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .profile-header-area { grid-area: header; display: flex; flex-direction: column; justify-content: center; min-width: 0; align-items: start; margin-top: 5px; }
        .profile-header-area h3 { margin: 0; font-size: 20px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .profile-buttons-area { grid-area: buttons; display: flex; flex-direction: column; align-items: end; gap: 5px; margin-top: 5px; }
        .profile-buttons-area button { background-color: rgba(255, 255, 255, 0.2); color: var(--text-light); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 5px; padding: 4px 8px; font-size: 11px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; white-space: nowrap; }
        .profile-buttons-area button:hover { background-color: rgba(255, 255, 255, 0.3); }
        .profile-stats-grid { grid-area: stats; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; align-self: stretch; }
        .metric-card { background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 70px; cursor: default; box-sizing: border-box; }
        .metric-card .label { font-size: 11px; opacity: 0.9; margin-bottom: 3px; white-space: nowrap; color: #e0e0e0; }
        .metric-card .value { font-weight: bold; font-size: 15px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-light); }
        #netAmountCard .value.positive { color: #b2f0b2; } 
        #netAmountCard .value.negative { color: #f7c8c8; }
        #loanAmountCard .value { color: #f7c8c8; }
        #sipAmountCard .value, #paymentAmountCard .value, #returnAmountCard .value { color: #b2f0b2; }
        .filters { display: flex; justify-content: center; margin: 15px 10px; gap: 15px; flex-wrap: wrap; padding-top: 180px; }
        label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 14px; }
        select { padding: 8px 10px; font-size: 14px; min-width: 160px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; }
        .table-container { width: 100%; overflow-x: auto; margin: 0 auto 20px auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: var(--card-shadow); }
        th, td { padding: 8px 10px; border: 1px solid #e0e0e0; text-align: center; }
        th { background-color: var(--primary-color); color: var(--text-light); font-size: 13px; font-weight: 500; white-space: nowrap; }
        td { font-size: 12px; vertical-align: middle; }
        .loan { color: var(--negative-color); font-weight: 500; } .payment { color: var(--positive-color); font-weight: 500;}
        tfoot td { font-weight: bold; background-color: #fff8e1; font-size: 13px; }
        .positive { color: var(--positive-color); font-weight: bold; } .negative { color: var(--negative-color); font-weight: bold; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; align-items: center; justify-content: center; z-index: 2500; opacity: 1; transition: opacity 0.3s ease; padding: 10px; box-sizing: border-box; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { background-color: #fff; padding: 20px 25px; border-radius: 8px; box-shadow: var(--card-shadow); max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; box-sizing: border-box; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; z-index: 10; padding: 0; }
        .modal h2 { margin-top: 0; margin-bottom: 15px; font-size: 18px; color: var(--primary-color); text-align: center; }
        #imageModal .modal-content { background: none; box-shadow: none; padding: 5px; width: auto; height: auto; max-width: 95%; max-height: 95%; overflow: hidden; }
        #modalImage { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; border-radius: 10px; border: 4px solid white; object-fit: contain; box-sizing: border-box; }
        #sipStatusModal .status-list { max-height: 60vh; overflow-y: auto; margin-top: 10px; padding-right: 5px;}
        #sipStatusModal .status-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
        #sipStatusModal .status-item span:last-child { font-weight: bold; display: flex; align-items: center; gap: 5px;}
        #sipStatusModal .status-paid { color: var(--positive-color); }
        #sipStatusModal .status-pending { color: var(--negative-color); }
        #sipStatusModal .status-due { color: var(--neutral-color); }
        @media only screen and (max-width: 1024px) { body { padding-top: 195px; } .filters { padding-top: 150px; } .profile-section { max-width: 95%; } }
        @media only screen and (max-width: 600px) { body { padding-top: 205px; } .header { height: 55px; } .header h1 { font-size: 1em; } .profile-section { top: 65px; width: 95%; padding: 10px 12px; grid-template-columns: 55px 1fr auto; gap: 8px 10px; } .profile-picture { width: 50px; height: 50px; font-size: 22px; border-width: 2px; margin-top: 0;} .profile-header-area h3 { font-size: 16px; } .profile-buttons-area { flex-direction: row; gap: 6px; grid-column: 3; grid-row: 1; align-self: center; margin-top: 0;} .profile-stats-grid{ grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 8px; } .metric-card{ min-height: 55px; padding: 5px 6px; border-radius: 4px; } .metric-card .label{ font-size: 9px; } .metric-card .value{ font-size: 12px; } .filters { padding-top: 165px; gap: 10px; margin-top: 15px; } label, select { font-size: 12px; min-width: 110px;} select { padding: 5px 6px; } .table-container { margin-top: 10px; } th { font-size: 11px; padding: 6px 8px; } td { font-size: 10px; padding: 5px 6px; } tfoot td { font-size: 11px; } .modal-content{ width: 95%; padding: 15px 20px; } .modal h2{ font-size: 16px; } #sipStatusModal .status-item{font-size: 13px;} }
        @media only screen and (max-width: 420px) { body { padding-top: 220px; } .profile-section { grid-template-columns: 50px 1fr auto; gap: 5px 8px; padding: 8px 10px; } .profile-picture { width: 45px; height: 45px; font-size: 20px; } .profile-header-area h3 { font-size: 15px; } .profile-stats-grid { grid-template-columns: repeat(2, 1fr); } .filters { padding-top: 180px; } }
    </style>
</head>
<body>
    <div id="loader"> <div class="spinner"></div> Loading... </div>

    <div id="passwordPromptContainer" class="hidden">
        <div id="passwordPromptMessage">
            <p>Enter Access PIN:</p>
            <input type="password" id="passwordInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off">
            <div id="passwordError"></div>
            <button id="passwordSubmit">Enter</button>
        </div>
    </div>

    <div id="dashboardContent" class="hidden">
        <div class="header">
            <img src="https://i.postimg.cc/XNpR3cN1/20241030-065157.png" alt="Logo">
            <h1>Community Loan Dashboard</h1>
        </div>

        <div id="profileSection" class="profile-section">
            <div class="profile-picture" id="profilePictureContainer"></div>
            <div class="profile-header-area">
                 <h3 id="profileName">Loading...</h3>
            </div>
            <div class="profile-buttons-area">
                <button id="sipStatusButton">SIP Status</button>
            </div>
            
            <div class="profile-stats-grid">
                 <div class="metric-card" id="sipAmountCard"><span class="label">Total SIP</span><span id="totalSipValue" class="value">0</span></div>
                 <div class="metric-card" id="paymentAmountCard"><span class="label">Total Payment</span><span id="totalPaymentValue" class="value">0</span></div>
                 <div class="metric-card" id="returnAmountCard"><span class="label">Total Return</span><span id="totalReturnValue" class="value">0</span></div>
                 <div class="metric-card" id="loanAmountCard"><span class="label">Total Loan</span><span id="totalLoanValue" class="value">0</span></div>
                 <div class="metric-card" id="netAmountCard"><span class="label">Net Amount</span><span id="netAmountValue" class="value">0</span></div>
                 <div class="metric-card" id="daysCard"><span class="label">Total Days</span><span id="totalDaysValue" class="value">0</span></div>
            </div>
        </div>

        <div class="filters">
             <div><label for="nameFilter">Select Name:</label><select id="nameFilter"><option value="all">All Members</option></select></div>
             <div><label for="typeFilter">Filter Data By:</label><select id="typeFilter"><option value="all_transactions">All Transactions</option><option value="members_invest">Loan Repayments</option><option value="loan_history">Loan History</option><option value="sip_payment">SIP Payments</option><option value="total_return">Total Return</option></select></div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead></thead>
                <tbody></tbody>
                <tfoot><tr><td id="totalLabelCell" colspan="2">Total</td><td id="totalValue1Cell">0</td><td id="totalValue2Cell">0</td><td id="totalValue3Cell">0</td></tr></tfoot>
            </table>
        </div>
    </div>

    <div id="imageModal" class="modal hidden"><div class="modal-content"><button class="modal-close" onclick="closeModal('imageModal')">×</button><img id="modalImage" src="" alt="Profile Image Fullscreen"></div></div>
    <div id="sipStatusModal" class="modal hidden"><div class="modal-content"><button class="modal-close" onclick="closeModal('sipStatusModal')">×</button><h2>Current Month SIP Status</h2><div id="sipStatusList" class="status-list">Loading status...</div></div></div>

<script>
    // --- Global variables ---
    let allData = [];
    let allMembers = {};
    const defaultProfilePic = 'https://i.postimg.cc/XNpR3cN1/20241030-065157.png';

    // --- Initialization & Authentication Flow ---
    document.addEventListener("DOMContentLoaded", () => {
        initializeApp();
    });

    async function initializeApp() {
        const loader = document.getElementById('loader');
        try {
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('Configuration API se fetch nahi ho saki.');
            const config = await response.json();
            if (!firebase.apps.length) firebase.initializeApp(config.firebase);
            setupPasswordPrompt();
        } catch (error) {
            console.error("Initialization Error:", error);
            loader.innerHTML = `<b>Initialization Error:</b> ${error.message}`;
        }
    }

    function setupPasswordPrompt() {
        const passwordInput = document.getElementById('passwordInput');
        const passwordSubmit = document.getElementById('passwordSubmit');
        const passwordError = document.getElementById('passwordError');
        const passwordContainer = document.getElementById('passwordPromptContainer');
        const loader = document.getElementById('loader');

        loader.classList.add('hidden');
        passwordContainer.classList.remove('hidden');
        passwordInput.focus();

        const checkPassword = async () => {
            const enteredPassword = passwordInput.value;
            if (!enteredPassword) return;

            passwordError.textContent = "";
            passwordSubmit.disabled = true;
            passwordSubmit.textContent = "Checking...";

            try {
                const membersSnapshot = await firebase.database().ref('members').once('value');
                allMembers = membersSnapshot.val() || {};
                const isValidPin = Object.values(allMembers).some(member => member.password === enteredPassword);

                if (isValidPin) {
                    passwordContainer.classList.add('hidden');
                    loader.classList.remove('hidden');
                    await processFirebaseData();
                } else {
                    passwordError.textContent = "Incorrect PIN";
                    passwordInput.value = "";
                    passwordInput.focus();
                    passwordInput.style.animation = 'shake 0.5s';
                    setTimeout(() => passwordInput.style.animation = '', 500);
                }
            } catch (error) {
                console.error("Error during PIN verification:", error);
                passwordError.textContent = "Error connecting to database.";
            } finally {
                passwordSubmit.disabled = false;
                passwordSubmit.textContent = "Enter";
            }
        };

        passwordSubmit.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') checkPassword();
        });
    }
    
    // --- MUKHYA UPDATE: Data Fetching & Processing from new structure (Corrected) ---
    async function processFirebaseData() {
        const loader = document.getElementById('loader');
        try {
            const transactionsSnapshot = await firebase.database().ref('transactions').once('value');
            const rawTransactions = transactionsSnapshot.val() || {};

            // Step 1: Member ID se Full Name ka map banayein
            const memberIdToNameMap = {};
            if (allMembers) {
                Object.values(allMembers).forEach(member => {
                    if (member && member.memberId && member.fullName) {
                        memberIdToNameMap[member.memberId] = member.fullName;
                    }
                });
            }

            if (Object.keys(memberIdToNameMap).length === 0) {
                console.error("MAPPING ERROR: Koi bhi member 'memberId' ke saath nahi mila. '/members' data structure check karein.");
            }

            // Step 2: Loan ID se Loan Type ka map banayein
            const loanIdToTypeMap = {};
            Object.values(rawTransactions).forEach(tx => {
                if (tx.type === 'Loan Taken' && tx.linkedLoanId && tx.loanType) {
                    loanIdToTypeMap[tx.linkedLoanId] = tx.loanType;
                }
            });

            // Step 3: Sabhi transactions ko process karke ek flat list banayein
            let flatTransactionList = [];
            let unmappedCount = 0;
            Object.values(rawTransactions).forEach(tx => {
                const memberName = memberIdToNameMap[tx.memberId];
                if (!memberName) {
                    unmappedCount++;
                    return; // Member nahi mila, is transaction ko skip karein
                }

                const parsedDate = new Date(tx.date || tx.timestamp || 0);
                if (isNaN(parsedDate.getTime())) return;

                let processedTx = {
                    Name: memberName, Date: parsedDate,
                    Loan: 0, Payment: 0, SipPayment: 0, ReturnAmount: 0,
                    Category: tx.type || 'Unknown'
                };

                const amount = parseFloat(tx.amount) || 0;
                
                switch (tx.type) {
                    case 'Loan Taken':
                        processedTx.Loan = amount;
                        processedTx.Category = `Loan (${tx.loanType || 'General'})`;
                        break;
                    case 'Loan Payment':
                        processedTx.Payment = parseFloat(tx.principalPaid) || 0;
                        const loanType = loanIdToTypeMap[tx.paidForLoanId] || 'General';
                        processedTx.Category = `Payment (${loanType})`;
                        break;
                    case 'SIP Payment':
                        processedTx.SipPayment = amount;
                        processedTx.Category = 'SIP';
                        break;
                    default:
                        // Agar type nahi hai, par amount hai, to use SIP maanein
                        if (amount > 0 && !tx.type) {
                            processedTx.SipPayment = amount;
                            processedTx.Category = 'SIP';
                        }
                        break;
                }

                if (processedTx.Loan > 0 || processedTx.Payment > 0 || processedTx.SipPayment > 0) {
                    flatTransactionList.push(processedTx);
                }
            });

            if (unmappedCount > 0) {
                console.warn(`WARNING: ${unmappedCount} transactions skip kiye gaye kyunki unka 'memberId' match nahi hua.`);
            }
            
            flatTransactionList.sort((a, b) => a.Date - b.Date);
            allData = flatTransactionList;
            
            initializeDashboard();

        } catch (error) {
            console.error("Error processing Firebase data:", error);
            loader.innerHTML = `Error: ${error.message}`;
        } finally {
            loader.classList.add('hidden');
        }
    }

    // --- Dashboard Initialization & Event Listeners ---
    function initializeDashboard() {
        document.getElementById('dashboardContent').classList.add('visible');
        populateNameFilter();
        setupEventListeners();
        document.getElementById('nameFilter').value = 'all';
        document.getElementById('typeFilter').value = 'all_transactions';
        updateDisplay();
    }

    function setupEventListeners() {
        document.getElementById('nameFilter').addEventListener('change', updateDisplay);
        document.getElementById('typeFilter').addEventListener('change', updateDisplay);
        document.getElementById('imageModal').addEventListener('click', () => closeModal('imageModal'));
        document.getElementById('profilePictureContainer').addEventListener('click', (event) => {
            const img = event.target;
            if (img.tagName === 'IMG' && img.src && img.src !== defaultProfilePic) {
                 event.stopPropagation();
                openModal('imageModal', img.src);
            }
        });
        document.getElementById('sipStatusButton').addEventListener('click', () => {
            populateSipStatusModal();
            openModal('sipStatusModal');
        });
    }

    // --- Modal, Filter, and other utility functions ---
    function openModal(modalId, imageSrc = null) {
        const modal = document.getElementById(modalId);
        if(modal) {
            if (modalId === 'imageModal' && imageSrc) modal.querySelector('#modalImage').src = imageSrc;
            modal.classList.remove('hidden');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) {
            modal.classList.add('hidden');
            if (modalId === 'imageModal') modal.querySelector('#modalImage').src = "";
        }
    }
    
    function populateNameFilter() {
        const nameFilter = document.getElementById("nameFilter");
        const memberNames = Object.values(allMembers).map(m => m.fullName).filter(Boolean);
        const uniqueNames = [...new Set(memberNames)];
        uniqueNames.sort((a, b) => a.localeCompare(b));
        nameFilter.innerHTML = '<option value="all">All Members</option>';
        uniqueNames.forEach(name => {
            nameFilter.innerHTML += `<option value="${name}">${name}</option>`;
        });
    }

    function updateDisplay() {
        const selectedName = document.getElementById('nameFilter').value;
        const selectedType = document.getElementById('typeFilter').value;
        updateProfileSection(selectedName);
        updateTopCards(selectedName);
        const filteredData = getFilteredTransactionData(selectedName, selectedType);
        updateTableHeader(selectedType === 'total_return' ? 'total_return' : 'all_transactions');
        if (selectedType === 'total_return') {
            calculateAndDisplayTotalReturn(filteredData);
        } else {
            displayTransactionData(filteredData, selectedType === 'all_transactions');
        }
    }
    
    function updateTopCards(selectedName) {
        const dataForCards = selectedName === 'all' ? allData : allData.filter(row => row.Name === selectedName);
        let totalSip = 0, totalReturn = 0, totalLoan = 0, totalPayment = 0;

        dataForCards.forEach(row => {
            totalSip += row.SipPayment;
            totalReturn += row.ReturnAmount;
            totalLoan += row.Loan;
            totalPayment += row.Payment + row.SipPayment;
        });

        const netAmount = (totalPayment + totalReturn) - totalLoan;
        let totalDays = 0;
        if (dataForCards.length > 0) {
            const firstDate = dataForCards[0].Date;
            totalDays = Math.round((new Date() - firstDate) / (1000 * 60 * 60 * 24));
        }

        document.getElementById('totalSipValue').textContent = totalSip.toFixed(2);
        document.getElementById('totalPaymentValue').textContent = totalPayment.toFixed(2);
        document.getElementById('totalReturnValue').textContent = totalReturn.toFixed(2);
        document.getElementById('totalLoanValue').textContent = totalLoan.toFixed(2);
        const netAmountEl = document.getElementById('netAmountValue');
        netAmountEl.textContent = netAmount.toFixed(2);
        netAmountEl.parentElement.classList.toggle('positive', netAmount >= 0);
        netAmountEl.parentElement.classList.toggle('negative', netAmount < 0);
        document.getElementById('totalDaysValue').textContent = totalDays;
    }

    function updateTableHeader(type) {
        const tableHead = document.querySelector('#dataTable thead');
        const footLabel = document.getElementById('totalLabelCell');
        const [footVal1, footVal2, footVal3] = [document.getElementById('totalValue1Cell'), document.getElementById('totalValue2Cell'), document.getElementById('totalValue3Cell')];
        
        footVal1.style.display = ''; footVal2.style.display = ''; footVal3.style.display = '';
        
        if (type === 'total_return') {
            tableHead.innerHTML = `<tr><th>Member</th><th>Total Return</th></tr>`;
            footLabel.textContent = "Total:"; footLabel.colSpan = 1;
            footVal1.className = 'positive';
            footVal2.style.display = 'none'; footVal3.style.display = 'none';
        } else {
            tableHead.innerHTML = `<tr><th>Date</th><th>Member</th><th>Amount</th><th>Category</th><th>Net Balance</th></tr>`;
            footLabel.textContent = "Total:"; footLabel.colSpan = 2;
        }
    }

    function getFilteredTransactionData(name, type) {
        const data = name === 'all' ? allData : allData.filter(r => r.Name === name);
        switch (type) {
            case 'loan_history': return data.filter(r => r.Loan > 0);
            case 'members_invest': return data.filter(r => r.Payment > 0);
            case 'sip_payment': return data.filter(r => r.SipPayment > 0);
            case 'total_return': return data.filter(r => r.ReturnAmount > 0);
            default: return data;
        }
    }

    function displayTransactionData(data, isCumulative) {
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = "";
        let loanSum = 0, paymentSum = 0, runningBalance = 0;

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5">No transactions found for this filter.</td></tr>`;
            updateTransactionTotals(0, 0, 0); return;
        }

        data.forEach(row => {
            const totalPayment = row.Payment + row.SipPayment + row.ReturnAmount;
            loanSum += row.Loan;
            paymentSum += totalPayment;
            runningBalance += (totalPayment - row.Loan);
            
            const displayAmount = row.Loan > 0 ? row.Loan : totalPayment;
            const amountClass = row.Loan > 0 ? 'loan' : 'payment';
            const netToShow = isCumulative ? runningBalance : (totalPayment - row.Loan);

            tbody.innerHTML += `<tr>
                <td>${formatDate(row.Date)}</td><td>${row.Name}</td>
                <td class="${amountClass}">${displayAmount.toFixed(2)}</td>
                <td>${row.Category}</td>
                <td class="${netToShow < 0 ? 'negative' : 'positive'}">${netToShow.toFixed(2)}</td>
            </tr>`;
        });
        updateTransactionTotals(loanSum, paymentSum, runningBalance);
    }
    
    function calculateAndDisplayTotalReturn(returnData) {
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = "";
        let totalReturn = 0;
        if (returnData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="2">No return data available.</td></tr>`;
            document.getElementById("totalValue1Cell").textContent = "0.00"; return;
        }
        const returnByMember = returnData.reduce((acc, row) => {
            acc[row.Name] = (acc[row.Name] || 0) + row.ReturnAmount;
            return acc;
        }, {});
        Object.entries(returnByMember).sort(([,a], [,b]) => b - a).forEach(([name, amount]) => {
            tbody.innerHTML += `<tr><td>${name}</td><td class="positive">${amount.toFixed(2)}</td></tr>`;
            totalReturn += amount;
        });
        document.getElementById("totalValue1Cell").textContent = totalReturn.toFixed(2);
    }

    function updateTransactionTotals(loanSum, paymentSum, finalBalance) {
        const [footVal1, footVal2, footVal3] = [document.getElementById('totalValue1Cell'), document.getElementById('totalValue2Cell'), document.getElementById('totalValue3Cell')];
        footVal1.textContent = loanSum.toFixed(2); footVal1.className = 'loan';
        footVal2.textContent = paymentSum.toFixed(2); footVal2.className = 'payment';
        footVal3.textContent = finalBalance.toFixed(2); footVal3.className = finalBalance < 0 ? "negative" : "positive";
    }

    function updateProfileSection(name) {
        const profileNameEl = document.getElementById("profileName");
        const profilePicContainer = document.getElementById("profilePictureContainer");
        let displayName = "Community Overview", profileImageUrl = defaultProfilePic;

        if (name !== 'all') {
            const memberInfo = Object.values(allMembers).find(m => m.fullName === name);
            displayName = name;
            if (memberInfo && memberInfo.profilePicUrl) profileImageUrl = memberInfo.profilePicUrl;
        }
        
        profileNameEl.textContent = displayName;
        profilePicContainer.innerHTML = `<img src="${profileImageUrl}" alt="Profile of ${name}" onerror="this.onerror=null; this.src='${defaultProfilePic}';" style="cursor: ${profileImageUrl !== defaultProfilePic ? 'pointer' : 'default'}; object-fit: ${profileImageUrl === defaultProfilePic ? 'contain' : 'cover'};">`;
    }
    
    function populateSipStatusModal() {
        const listContainer = document.getElementById('sipStatusList');
        listContainer.innerHTML = "";
        const memberNames = [...new Set(Object.values(allMembers).map(m => m.fullName).filter(Boolean))].sort();
        const now = new Date(), currentMonth = now.getMonth(), currentYear = now.getFullYear(), currentDay = now.getDate();

        if (memberNames.length === 0) { listContainer.innerHTML = "No members found."; return; }

        memberNames.forEach(name => {
            const paidThisMonth = allData.some(r => r.Name === name && r.SipPayment > 0 && r.Date.getMonth() === currentMonth && r.Date.getFullYear() === currentYear);
            let statusText, statusClass, statusIcon;
            if (paidThisMonth) { [statusText, statusClass, statusIcon] = ["Paid", "status-paid", "✅"]; } 
            else if (currentDay > 10) { [statusText, statusClass, statusIcon] = ["Pending", "status-pending", "❌"]; } 
            else { [statusText, statusClass, statusIcon] = ["Due", "status-due", "🔴"]; }
            listContainer.innerHTML += `<div class="status-item"><span>${name}</span><span class="${statusClass}">${statusIcon} ${statusText}</span></div>`;
        });
    }

    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return "Invalid Date";
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = `@keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }`;
    document.head.appendChild(styleSheet);
</script>
</body>
</html>


