<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Community Loan Dashboard</title>
    <style>
        /* Basic Reset & Body Style */
        :root {
             --primary-color: #007BFF; --secondary-color: #056fff; --light-bg: #f8f9fa;
             --text-light: #fff; --text-dark: #343a40; --positive-color: #04c800;
             --negative-color: #ff1f02; --warning-color: #ffc107; --neutral-color: #000; /* Gray for Due */
             --profile-bg: linear-gradient(135deg, #0d6efd, #0a58ca); --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
             --profile-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
             --rating-good: #dc3545; --rating-better: #ffc107; --rating-best: #198754;
             --loader-color: var(--primary-color); --modal-bg: rgba(0, 0, 0, 0.88); /* Slightly less opaque */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: var(--light-bg);
            padding-top: 230px; /* Increased padding for taller profile */
            transition: padding-top 0.3s ease; color: var(--text-dark); line-height: 1.5;
        }

        /* Loader Styles */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--light-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; font-size: 18px; color: var(--text-dark); transition: opacity 0.5s ease; }
        #loader .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--loader-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Password Prompt Styles (Unchanged) */
        #passwordPromptContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; opacity: 1; transition: opacity 0.3s ease; }
        #passwordPromptContainer.hidden { opacity: 0; pointer-events: none; }
        #passwordPromptMessage { padding: 25px 30px; background-color: #fff; border-radius: 10px; box-shadow: var(--card-shadow); text-align: center; max-width: 320px; width: 85%; }
        #passwordPromptMessage p { margin: 0 0 15px 0; font-size: 16px; }
        #passwordInput { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; text-align: center; letter-spacing: 5px; }
        #passwordSubmit { padding: 10px 20px; font-size: 16px; background-color: var(--primary-color); color: var(--text-light); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; }
        #passwordSubmit:hover { background-color: #0056b3; }
        #passwordError { color: var(--negative-color); font-weight: bold; margin-top: 10px; font-size: 14px; min-height: 1em; }

        /* Dashboard Content Container */
        #dashboardContent { display: none; } #dashboardContent.visible { display: block; }

        /* Header (Unchanged) */
        .header { text-align: center; background-color: var(--primary-color); color: var(--text-light); padding: 10px 0; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header img { width: 40px; height: 40px; margin-right: 10px; } .header h1 { font-size: 1.2em; margin: 0; font-weight: 500; }

        /* --- Profile Section Redesigned --- */
        .profile-section { /* Main outer card */
            position: fixed; top: 70px; /* Lowered slightly */ left: 50%; transform: translateX(-50%);
            background: var(--profile-bg); color: var(--text-light); border-radius: 12px; /* More rounded */
            box-shadow: var(--profile-shadow); width: 94%; max-width: 520px; /* Wider */
            z-index: 1000; padding: 15px; display: grid;
            /* Grid Layout: Pic | Header (Name/Tags) | Buttons */
            /* Pic | Stats Grid        | Stats Grid */
            /* Bar | Bar               | Bar        */
            grid-template-areas:
                "pic header buttons"
                "pic stats  stats"
                "bar bar    bar";
            grid-template-columns: auto 1fr auto; /* Pic | Main Area | Buttons */
            grid-template-rows: auto 1fr auto; /* Header | Stats | Bar */
            gap: 10px 15px; /* Row gap, Column gap */
            align-items: start; transition: top 0.3s ease;
        }

        .profile-picture { /* Picture style */
            grid-area: pic; width: 75px; height: 75px; /* Size */ border-radius: 50%;
            background-color: #eee; display: flex; align-items: center; justify-content: center;
            font-size: 35px; font-weight: bold; color: var(--text-dark); text-transform: uppercase;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); flex-shrink: 0;
            border: 4px solid rgba(255, 255, 255, 0.8); overflow: hidden; margin-top: 5px;
        }
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }

        .profile-header-area { /* Contains Name, Rank, Best Tag */
            grid-area: header; display: flex; flex-direction: column;
            justify-content: center; min-width: 0; align-items: start; margin-top: 5px;
        }
        .profile-header-area h3 { margin: 0; font-size: 20px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .profile-sub-tags { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 4px; }
        .profile-rank { background-color: rgba(255, 255, 255, 0.2); color: var(--text-light); padding: 2px 7px; border-radius: 10px; font-size: 11px; font-weight: bold; line-height: 1; display: inline-block; }
        .best-member-tag { font-size: 11px; font-weight: bold; color: #ffd700; background-color: rgba(0, 0, 0, 0.3); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .profile-rank.hidden, .best-member-tag.hidden { display: none; }

        .profile-buttons-area { /* Container for Tips & SIP Status buttons */
            grid-area: buttons; display: flex; flex-direction: column; align-items: end; gap: 5px; margin-top: 5px;
        }
        .profile-buttons-area button {
             background-color: rgba(255, 255, 255, 0.2); color: var(--text-light);
             border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 5px; padding: 4px 8px;
             font-size: 11px; font-weight: 500; cursor: pointer;
             transition: background-color 0.2s ease; white-space: nowrap;
        }
        .profile-buttons-area button:hover { background-color: rgba(255, 255, 255, 0.3); }

        .profile-stats-grid { /* Grid for all metric cards */
            grid-area: stats; display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Columns */
            gap: 8px; width: 100%; align-self: stretch; /* Stretch to fill height */
        }
        /* Common style for all metric cards */
        .metric-card {
            background-color: rgba(0,0,0,0.3); /* Darker background for better contrast */ padding: 10px; border-radius: 8px; /* More rounded */
            text-align: center; display: flex; flex-direction: column; justify-content: center;
            min-height: 70px; /* Consistent height */ cursor: default; box-sizing: border-box;
        }
        .metric-card .label { font-size: 11px; opacity: 0.9; /* Less transparent */ margin-bottom: 3px; white-space: nowrap; color: #e0e0e0; /* Lighter gray label */ }
        .metric-card .value { font-weight: bold; /* Bolder value */ font-size: 15px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-light); }
        /* Specific card adjustments */
        #profileCibilCard { /* Distinct CIBIL card style */
             background-color: rgba(255, 255, 255, 0.15); /* Lighter background */
             border: 1px solid rgba(255, 255, 255, 0.3);
             cursor: pointer; transition: background-color 0.2s ease;
        }
        #profileCibilCard:hover { background-color: rgba(255, 255, 255, 0.25); }
        #profileCibilCard .value { font-size: 16px; } /* Slightly larger CIBIL score */
        #profileCibilCard .rating { font-size: 10px; font-weight: bold; margin-left: 5px; padding: 1px 4px; border-radius: 4px; display: inline-block; vertical-align: middle;}
        #profileCibilCard .rating.good { background-color: var(--rating-good); color: white; }
        #profileCibilCard .rating.better { background-color: var(--rating-better); color: #333; }
        #profileCibilCard .rating.best { background-color: var(--rating-best); color: white; }
        #profileEligibilityCard .value.eligible { color: var(--positive-color); font-weight: bold; }
        #profileEligibilityCard .value.not-eligible { color: var(--negative-color); font-weight: bold; }
        #profileEligibilityCard .sub-value { font-size: 10px; opacity: 0.9; color: #e0e0e0; } /* Lighter sub-value */
        #profileAmountCard .value.positive { color: #b2f0b2; } #profileAmountCard .value.negative { color: #f7c8c8; } /* Adjusted contrast */
        #profileCurrentLoanCard .value.positive { color: #b2f0b2; } #profileCurrentLoanCard .value.negative { color: #f7c8c8; }
        #profileSipStatusCard .value.pending { color: var(--warning-color); } #profileSipStatusCard .value.paid { color: #b2f0b2; }
        #profileSipStatusCard .value.due { color: var(--neutral-color); } /* Style for Due status */

        .progress-bar-container { grid-area: bar; width: 100%; height: 6px; background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-bar { height: 100%; width: 0; transition: width 1s ease-in-out, background-color 0.5s ease-in-out; }
        .progress-bar.positive { background-color: #39ff14; } .progress-bar.negative { background-color: #ff3d3d; }
        .profile-section .footnote { grid-column: 1 / -1; font-size: 9px; opacity: 0.7; margin: 0 0 -5px 0; text-align: center; line-height: 1.1; }
        /* --- End Profile Section --- */


        /* Filters (Adjust padding) */
        .filters { display: flex; justify-content: center; margin: 15px 10px; gap: 15px; flex-wrap: wrap; padding-top: 180px; /* Adjusted for profile height */ }
        label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 14px; }
        select { padding: 8px 10px; font-size: 14px; min-width: 160px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; }

        /* Table Styles (Unchanged) */
        .table-container { width: 100%; overflow-x: auto; margin: 0 auto 20px auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: var(--card-shadow); }
        th, td { padding: 8px 10px; border: 1px solid #e0e0e0; text-align: center; }
        th { background-color: var(--primary-color); color: var(--text-light); font-size: 13px; font-weight: 500; white-space: nowrap; }
        td { font-size: 12px; vertical-align: middle; }
        .loan { color: var(--negative-color); font-weight: 500; } .payment { color: var(--positive-color); font-weight: 500;}
        tfoot td { font-weight: bold; background-color: #fff8e1; font-size: 13px; }
        .positive { color: var(--positive-color); font-weight: bold; } .negative { color: var(--negative-color); font-weight: bold; }
        .sip-tag { background-color: #6f42c1; color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px; margin-left: 4px; vertical-align: middle; font-weight: normal;}
        .highlight-recent-loan { background-color: rgba(220, 53, 69, 0.1) !important; }

        /* Modal Styles (Image Modal Update) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; align-items: center; justify-content: center; z-index: 2500; opacity: 1; transition: opacity 0.3s ease; padding: 10px; box-sizing: border-box; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { background-color: #fff; padding: 20px 25px; border-radius: 8px; box-shadow: var(--card-shadow); max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; box-sizing: border-box; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; z-index: 10; padding: 0; }
        .modal-close:hover { color: #777; }
        .modal h2 { margin-top: 0; margin-bottom: 15px; font-size: 18px; color: var(--primary-color); text-align: center; }
        /* Image Modal Specifics */
        #imageModal .modal-content { background: none; box-shadow: none; padding: 5px; /* Add padding for border */ width: auto; height: auto; max-width: 95%; max-height: 95%; overflow: hidden; }
        #modalImage { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; border-radius: 10px; border: 4px solid white; /* Thicker border */ object-fit: contain; box-sizing: border-box; }

        /* Tips Modal Specifics */
        #tipsModal .tip-section { margin-bottom: 15px; } #tipsModal h3 { font-size: 16px; margin-bottom: 8px; color: var(--text-dark); border-bottom: 1px solid #eee; padding-bottom: 4px;} #tipsModal ul { margin: 0; padding-left: 20px; font-size: 14px; color: #555; } #tipsModal li { margin-bottom: 6px; }
        /* History Modal Specifics */
        #cibilHistoryModal .history-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dotted #eee; font-size: 14px;} #cibilHistoryModal .history-item:last-child { border-bottom: none; } #cibilHistoryModal .history-item span:first-child { color: #555; } #cibilHistoryModal .history-item span:last-child { font-weight: bold; } #cibilHistoryModal .total-score { margin-top: 15px; text-align: right; font-size: 16px; font-weight: bold; }
        /* SIP Status Modal Specifics */
        #sipStatusModal .status-list { max-height: 60vh; overflow-y: auto; margin-top: 10px; padding-right: 5px;} /* Scrollable list */
        #sipStatusModal .status-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
        #sipStatusModal .status-item:last-child { border-bottom: none; }
        #sipStatusModal .status-item span:first-child { font-weight: 500; } /* Name */
        #sipStatusModal .status-item span:last-child { font-weight: bold; display: flex; align-items: center; gap: 5px;}
        #sipStatusModal .status-paid { color: var(--positive-color); }
        #sipStatusModal .status-pending { color: var(--negative-color); }
        #sipStatusModal .status-due { color: var(--neutral-color); }


        /* --- Responsive adjustments --- */
        @media only screen and (max-width: 1024px) { body { padding-top: 195px; } .filters { padding-top: 150px; } .profile-section { max-width: 95%; } }
        @media only screen and (max-width: 600px) {
            body { padding-top: 205px; } .header { height: 55px; } .header h1 { font-size: 1em; }
            .profile-section { top: 65px; width: 95%; padding: 10px 12px; grid-template-areas: "pic header buttons" "stats stats stats" "bar bar bar"; grid-template-columns: 55px 1fr auto; gap: 8px 10px; }
            .profile-picture { width: 50px; height: 50px; font-size: 22px; border-width: 2px; margin-top: 0;}
            .profile-header-area h3 { font-size: 16px; } .profile-sub-tags{ margin-top: 2px; gap: 5px; } .profile-rank{font-size: 10px; padding: 1px 5px;} .best-member-tag{font-size: 9px; padding: 1px 4px;}
            .profile-buttons-area { flex-direction: row; gap: 6px; grid-column: 3; grid-row: 1; align-self: center; margin-top: 0;} /* Buttons side-by-side */
            #tipsButton, #sipStatusButton { font-size: 10px; padding: 3px 5px;}
            .profile-stats-grid{ grid-area: stats; grid-template-columns: 1fr 1fr; /* 2 columns for cards */ gap: 6px; margin-top: 8px; }
            .metric-card{ min-height: 55px; padding: 5px 6px; border-radius: 4px; }
            .metric-card .label{ font-size: 9px; } .metric-card .value{ font-size: 12px; }
            #profileCibilCard .score { font-size: 13px; } #profileCibilCard .rating { font-size: 9px; }
            #profileEligibilityCard .sub-value { font-size: 9px; }
            .progress-bar-container{ margin-top: 8px; }
            .filters { padding-top: 165px; gap: 10px; margin-top: 15px; } label, select { font-size: 12px; min-width: 110px;} select { padding: 5px 6px; }
            .table-container { margin-top: 10px; } th { font-size: 11px; padding: 6px 8px; } td { font-size: 10px; padding: 5px 6px; white-space: normal; overflow-wrap: break-word; word-break: break-word; vertical-align: middle; } tfoot td { font-size: 11px; }
            .modal-content{ width: 95%; padding: 15px 20px; } .modal h2{ font-size: 16px; } #tipsModal ul{ font-size: 13px; } #cibilHistoryModal .history-item{ font-size: 13px; } #sipStatusModal .status-item{font-size: 13px;}
        }
        @media only screen and (max-width: 420px) { body { padding-top: 220px; } .profile-section { grid-template-columns: 50px 1fr auto; gap: 5px 8px; padding: 8px 10px; } .profile-picture { width: 45px; height: 45px; font-size: 20px; } .profile-header-area h3 { font-size: 15px; } .profile-stats-grid { grid-template-columns: 1fr 1fr; } /* Keep 2 columns */ .filters { padding-top: 180px; } }

    </style>
</head>
<body>
    <div id="loader"> <div class="spinner"></div> Loading... </div>

    <div id="passwordPromptContainer" class="hidden"> <div id="passwordPromptMessage"> <p>Enter Access PIN:</p> <input type="password" id="passwordInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off"> <div id="passwordError"></div> <button id="passwordSubmit">Enter</button> </div> </div>

    <div id="dashboardContent" class="hidden">
        <div class="header"> <img src="https://i.postimg.cc/XNpR3cN1/20241030-065157.png" alt="Logo"> <h1>Community Loan Dashboard</h1> </div>

        <div id="profileSection" class="profile-section">
            <div class="profile-picture" id="profilePictureContainer"></div>
            <div class="profile-header-area">
                 <h3 id="profileName">Loading...</h3>
                 <div class="profile-sub-tags">
                     <span id="profileRank" class="profile-rank hidden">#?</span>
                     <span id="bestMemberTag" class="best-member-tag hidden">✨ Best Member</span>
                 </div>
            </div>
            <div class="profile-buttons-area">
                <button id="tipsButton">Tips Score</button>
                <button id="sipStatusButton">SIP Status</button> </div>

            <div class="profile-stats-grid"> <div class="metric-card" id="profileCibilCard"> <span class="label">CIBIL Score*</span><span class="value"><span id="profileCibilScore">---</span><span class="rating" id="profileCibilRating">---</span></span>
                 </div>
                  <div class="metric-card" id="profileEligibilityCard"> <span class="label">Loan Eligibility</span><span id="profileEligibilityStatus" class="value not-eligible">Not Eligible</span><span id="profileEligibilityAmount" class="sub-value"></span>
                 </div>
                 <div class="metric-card" id="profileAmountCard"> <span class="label">Balance</span><span id="profileAmount" class="value positive">0</span>
                 </div>
                 <div class="metric-card" id="profileCurrentLoanCard"> <span class="label">Current Loan*</span><span id="profileCurrentLoan" class="value negative">0</span>
                 </div>
                 <div class="metric-card" id="profileSipStatusCard"> <span class="label">SIP Status</span><span id="profileSipStatus" class="value">--</span>
                 </div>
                 <div class="metric-card" id="profileJoinDateCard"> <span class="label">Join Date</span><span id="profileJoinDate" class="value">--</span>
                 </div>
            </div>

            <div class="progress-bar-container"> <div class="progress-bar" id="progressBar"></div> </div>
            <p class="footnote">*CIBIL Score & Current Loan calculated via specific rules.</p>
        </div>

        <div class="filters">
             <div><label for="nameFilter">Select Name:</label><select id="nameFilter"><option value="all">All Members</option></select></div>
             <div><label for="typeFilter">Filter Data By:</label><select id="typeFilter">
                    <option value="Civil Score">Performance Score</option> {/* Renamed Label */}
                    <option value="all_transactions">All Transactions</option> <option value="members_invest">Loan Repayments</option>
                    <option value="loan_history">Loan History</option> <option value="sip_payment">SIP Payments</option>
                    <option value="total_return">Total Return</option>
             </select></div>
        </div>

        <div class="table-container"> <table id="dataTable"><thead></thead><tbody></tbody><tfoot><tr><td id="totalLabel" colspan="1">Total</td><td id="totalValue1">0</td><td id="totalValue2">0</td><td id="totalValue3" class="positive">0</td></tr></tfoot></table> </div>
    </div> <div id="imageModal" class="modal hidden"> <div class="modal-content"><button class="modal-close" onclick="closeModal('imageModal')">&times;</button><img id="modalImage" src="" alt="Profile Image Fullscreen"></div></div>

    <div id="tipsModal" class="modal hidden"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('tipsModal')">&times;</button> <h2>स्कोर सुधारने के टिप्स</h2> <div class="tip-section"> <h3>स्कोर कैसे सुधारें:</h3> <ul> <li>सभी लोन और SIP का भुगतान समय पर (हर महीने 1-10 तारीख के बीच) करें।</li> <li>अपना बैलेंस सकारात्मक (positive) बनाए रखें।</li> <li>लिए गए लोन की तुलना में अधिक भुगतान करने का प्रयास करें (Loan Utilization सुधारें)।</li> <li>नियमित रूप से अपनी वित्तीय स्थिति की समीक्षा करें।</li> </ul> </div> <div class="tip-section"> <h3>क्या न करें (जिससे स्कोर घट सकता है):</h3> <ul> <li>SIP या लोन की किश्तों का भुगतान करने में देरी (31 दिन से अधिक)।</li> <li>लंबे समय तक (50, 80, या 100+ दिन) भुगतान न करना।</li> <li>अपना खाता बैलेंस नकारात्मक (negative) रखना।</li> <li>जितना चुका सकते हैं उससे अधिक लोन लेना।</li> </ul> </div> <p style="font-size: 12px; color: #666; margin-top: 15px;">*यह स्कोर बैंक द्वारा उपयोग किए जाने वाले आधिकारिक CIBIL स्कोर से भिन्न है और केवल इस समूह के आंतरिक मूल्यांकन के लिए है।</p> </div> </div>

    <div id="cibilHistoryModal" class="modal hidden"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('cibilHistoryModal')">&times;</button> <h2>CIBIL Score Breakdown</h2> <div id="cibilBreakdownContent"> <div class="history-item"><span>Base Score</span><span>+300</span></div> <div class="history-item"><span>Balance Component</span><span id="histBalanceScore">0</span></div> <div class="history-item"><span>Timely SIPs Component</span><span id="histHistoryScore">0</span></div> <div class="history-item"><span>Loan Utilization Component</span><span id="histUtilizationScore">0</span></div> <div class="history-item"><span>Overdue Loan Penalty</span><span id="histPenalty" style="color: var(--negative-color);">0</span></div> <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;"> <div class="total-score"><span>Final Score</span> <span id="histFinalScore">300</span></div> </div> <p style="font-size: 12px; color: #666; margin-top: 15px;">*यह ब्रेकडाउन अनुमानित है और केवल सूचना के लिए है। पेनल्टी रूल: >31 दिन: -50, >50 दिन: -100, >80 दिन: -200, >100 दिन: -600.</p> </div> </div>

     <div id="sipStatusModal" class="modal hidden">
         <div class="modal-content">
             <button class="modal-close" onclick="closeModal('sipStatusModal')">&times;</button>
             <h2>Current Month SIP Status</h2>
             <div id="sipStatusList" class="status-list">
                 Loading status...
             </div>
         </div>
     </div>


    <script>
    let allData = [];
    const CORRECT_PASSWORD = "7536";
    let userRankMap = new Map();
    let communityBalance = 0;
    let latestCivilScoreBreakdown = {};

    // URLs & Defaults
    const dataUrl = 'https://script.google.com/macros/s/AKfycbx0yaFBlNlpBJec0HygQbRQcp9uzq2YEvSqKS3s93uaOe2GjMMxMM9rOaZ-N-Ui8lrlLQ/exec';
    const defaultProfilePic = 'https://via.placeholder.com/70/CCCCCC/FFFFFF?text=M';

    // --- Initialization, Password, Loader ---
    document.addEventListener("DOMContentLoaded", () => { const loader=document.getElementById('loader'); loader.classList.remove('hidden'); document.getElementById('passwordPromptContainer').classList.add('hidden'); document.getElementById('dashboardContent').classList.add('hidden'); setTimeout(setupPasswordPrompt, 100); });
    function setupPasswordPrompt() { const passwordInput=document.getElementById('passwordInput'); const passwordSubmit=document.getElementById('passwordSubmit'); const passwordError=document.getElementById('passwordError'); const passwordContainer=document.getElementById('passwordPromptContainer'); const loader=document.getElementById('loader'); loader.classList.add('hidden'); passwordContainer.classList.remove('hidden'); passwordInput.focus(); passwordSubmit.addEventListener('click', checkPassword); passwordInput.addEventListener('keydown', (event)=>{if(event.key==='Enter'){checkPassword();}}); function checkPassword(){const enteredPassword=passwordInput.value; if(enteredPassword===CORRECT_PASSWORD){passwordContainer.classList.add('hidden'); loader.classList.remove('hidden'); fetchData();}else{passwordError.textContent="Incorrect PIN"; passwordInput.value=""; passwordInput.focus(); passwordInput.style.animation='shake 0.5s'; setTimeout(()=>passwordInput.style.animation='',500);}} }
    const styleSheet=document.createElement("style"); styleSheet.type="text/css"; styleSheet.innerText=`@keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }`; document.head.appendChild(styleSheet);

    // --- Data Fetching & Processing ---
    async function fetchData() { const loader=document.getElementById('loader'); try { const response=await fetch(dataUrl); if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`); const rawData=await response.json(); allData=rawData.map(row=>({ Name:row.name?String(row.name).trim():'Unknown', Date:row.date?new Date(row.date):new Date(0), Loan:parseFloat(row.loan)||0, Payment:parseFloat(row.payment)||0, SipPayment:parseFloat(row.emi)||0, ImageUrl:row.imageUrl||null })); communityBalance=allData.reduce((acc,r)=>acc+r.Payment+r.SipPayment-r.Loan,0); initializeDashboard(); } catch(error){ console.error("Error fetching/processing data:", error); const dashboardContent=document.getElementById('dashboardContent'); dashboardContent.innerHTML=`<p style='color: red; text-align: center; padding: 50px;'>Error loading data: ${error.message}. Please check the source URL or data format.</p>`; dashboardContent.classList.add('visible'); } finally { loader.classList.add('hidden'); } }
    // initializeDashboard, setupEventListeners (Added SIP Status Button Listener)
    function initializeDashboard() { document.getElementById('dashboardContent').classList.add('visible'); populateNameFilter(); setupEventListeners(); document.getElementById('nameFilter').value='all'; document.getElementById('typeFilter').value='Civil Score'; updateDisplay(); }
    function setupEventListeners() { document.getElementById('nameFilter').addEventListener('change', updateDisplay); document.getElementById('typeFilter').addEventListener('change', updateDisplay); document.getElementById('imageModal').addEventListener('click', ()=>{closeModal('imageModal')}); document.getElementById('profilePictureContainer').addEventListener('click',(event)=>{ if(event.target.tagName==='IMG'){ openModal('imageModal', event.target.src); } }); document.getElementById('tipsButton').addEventListener('click', () => { openModal('tipsModal'); });
        // Add listener for SIP Status button
        document.getElementById('sipStatusButton').addEventListener('click', () => {
             populateSipStatusModal(); // Populate before opening
             openModal('sipStatusModal');
        });
        /* CIBIL history listener added dynamically in updateProfileSection */
    }

    // --- Modal Functions --- (Unchanged)
    function openModal(modalId, imageSrc = null) { const modal=document.getElementById(modalId); if(modal){if(modalId==='imageModal'&&imageSrc){modal.querySelector('#modalImage').src=imageSrc;} if(modalId==='cibilHistoryModal'){populateCibilHistoryModal();} modal.classList.remove('hidden');}}
    function closeModal(modalId) { const modal=document.getElementById(modalId); if(modal){modal.classList.add('hidden');}}
    // --- Populate CIBIL History Modal --- (Unchanged)
    function populateCibilHistoryModal() { document.getElementById('histBalanceScore').textContent=latestCivilScoreBreakdown.balanceScore?.toFixed(0)??'0'; document.getElementById('histHistoryScore').textContent=latestCivilScoreBreakdown.historyScore?.toFixed(0)??'0'; document.getElementById('histUtilizationScore').textContent=latestCivilScoreBreakdown.utilizationScore?.toFixed(0)??'0'; document.getElementById('histPenalty').textContent=latestCivilScoreBreakdown.penalty?.toFixed(0)??'0'; document.getElementById('histFinalScore').textContent=latestCivilScoreBreakdown.scoreDisplay??'---'; document.getElementById('histPenalty').style.color=(latestCivilScoreBreakdown.penalty??0)<0?'var(--negative-color)':'var(--positive-color)'; }

    // --- Populate SIP Status Modal --- (NEW FUNCTION)
    function populateSipStatusModal() {
        const listContainer = document.getElementById('sipStatusList');
        if (!listContainer) return;

        listContainer.innerHTML = ""; // Clear previous list
        const members = [...new Set(allData.map(r => r.Name))].filter(name => name !== 'Unknown').sort(); // Get sorted unique member names
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const currentDay = now.getDate();

        if (members.length === 0) {
            listContainer.innerHTML = "No member data found.";
            return;
        }

        members.forEach(name => {
            const userData = allData.filter(r => r.Name === name);
            const paidThisMonth = userData.some(r => r.SipPayment > 0 && r.Date.getMonth() === currentMonth && r.Date.getFullYear() === currentYear);

            let statusText = "";
            let statusClass = "";
            let statusIcon = "";

            if (paidThisMonth) {
                statusText = "Paid";
                statusClass = "status-paid";
                statusIcon = "✅";
            } else if (currentDay > 10) {
                statusText = "Pending";
                statusClass = "status-pending";
                statusIcon = "❌";
            } else {
                statusText = "Due";
                statusClass = "status-due";
                statusIcon = "🔴";
            }

            const itemDiv = document.createElement('div');
            itemDiv.className = 'status-item';
            itemDiv.innerHTML = `<span>${name}</span><span class="${statusClass}">${statusIcon} ${statusText}</span>`;
            listContainer.appendChild(itemDiv);
        });
    }


    // --- Filter Population --- (Unchanged)
    function populateNameFilter() { const nameFilter=document.getElementById("nameFilter"); const memberData={}; allData.forEach(row=>{const name=row.Name; if(name==='Unknown')return; if(!memberData[name])memberData[name]=0; memberData[name]+=row.Payment+row.SipPayment-row.Loan;}); const sortedMembers=Object.entries(memberData).sort(([,balA],[,balB])=>balB-balA); nameFilter.innerHTML='<option value="all">All Members</option>'; sortedMembers.forEach(([name])=>{nameFilter.innerHTML+=`<option value="${name}">${name}</option>`;}); }

     // --- Rank Calculation (Performance Score Rank) --- (Unchanged)
     function calculateAllUserRanks() { userRankMap.clear(); const userData={}; allData.forEach(row=>{const name=row.Name; if(name==='Unknown')return; if(!userData[name])userData[name]={amount:0}; userData[name].amount+=row.Payment+row.SipPayment-row.Loan;}); const sortedData=Object.entries(userData).map(([name,{amount}])=>({name, score:calculatePerformanceScore(amount)})).sort((a,b)=>b.score-a.score); sortedData.forEach((user,index)=>{let rankDisplay; if(index===0)rankDisplay="🥇"; else if(index===1)rankDisplay="🥈"; else if(index===2)rankDisplay="🥉"; else rankDisplay=`#${index + 1}`; userRankMap.set(user.name,rankDisplay);}); }

          // --- CIBIL Score Calculation (With Penalty & Updated Rating) ---
     function calculateCivilScore(userName) {
         // Handle "All Members" case
         if (userName === 'all') {
             return { scoreValue: 0, scoreDisplay: "N/A", rating: "", balanceScore: 0, historyScore: 0, utilizationScore: 0, penalty: 0 };
         }

         const userData = allData.filter(r => r.Name === userName);

         // Handle case where user exists but has no data entries yet
         if (userData.length === 0) {
              // Return minimum possible score and "Poor" rating
             return { scoreValue: 100, scoreDisplay: "100", rating: "Poor", balanceScore: 0, historyScore: 0, utilizationScore: 0, penalty: 0 };
         }

         // Calculate components based on user data
         const totalLoanTaken = userData.reduce((acc, r) => acc + r.Loan, 0);
         const totalPayment = userData.reduce((acc, r) => acc + r.Payment, 0);
         const totalSipPayment = userData.reduce((acc, r) => acc + r.SipPayment, 0);
         const currentBalance = totalPayment + totalSipPayment - totalLoanTaken;

         // 1. Balance Component (Max 100 as per user's provided code)
         const balanceScore = Math.min(100, Math.max(0, Math.floor(currentBalance / 1000) * 10));

         // 2. Payment History Component (Max 300) - Timely SIPs
         let timelySipCount = 0;
         userData.filter(r => r.SipPayment > 0).forEach(sip => {
             // Ensure Date is valid before calling getDate
             if (sip.Date instanceof Date && !isNaN(sip.Date)) {
                 const paymentDay = sip.Date.getDate();
                 if (paymentDay >= 1 && paymentDay <= 10) {
                     timelySipCount++;
                 }
             }
         });
         const historyScore = Math.min(300, timelySipCount * 15);

         // 3. Loan Utilization Component (Max 300) - % Repaid
         const totalRepaid = totalPayment + totalSipPayment;
         const utilizationRatio = (totalLoanTaken === 0) ? 1 : Math.max(0, Math.min(1, totalRepaid / totalLoanTaken));
         const utilizationScore = Math.round(utilizationRatio * 300);

         // 4. Overdue Loan Penalty
         let penalty = 0;
         const outstandingLoan = Math.max(0, totalLoanTaken - totalRepaid);
         if (outstandingLoan > 0) {
             // Find the most recent loan to check for overdue status
             const lastLoan = userData.filter(r => r.Loan > 0).sort((a, b) => b.Date - a.Date)[0];
             if (lastLoan && lastLoan.Date instanceof Date && !isNaN(lastLoan.Date)) {
                 const today = new Date();
                 const dueDate = new Date(lastLoan.Date);
                 dueDate.setDate(dueDate.getDate() + 31); // Due 31 days after loan date
                 // Ensure dates are valid before comparison
                 if (!isNaN(dueDate)) {
                    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));

                    if (daysOverdue > 100) penalty = -600;
                    else if (daysOverdue > 80) penalty = -200;
                    else if (daysOverdue > 50) penalty = -100;
                    else if (daysOverdue > 0) penalty = -50; // Overdue by 1-50 days (after 31 day grace)
                 }
             }
         }

         // Calculate Final Score (Sum components + penalty)
         const calculatedScore = balanceScore + historyScore + utilizationScore + penalty;

         // Clamp Final Score between 100 and 900 (as per user's provided code minimum)
         const finalScore = Math.max(100, Math.min(900, calculatedScore));

         // Determine Rating (UPDATED with "Poor")
         let rating = "";
         if (finalScore <= 499) rating = "Poor";    // Scores 100-499
         else if (finalScore <= 649) rating = "Good";   // Scores 500-649
         else if (finalScore <= 799) rating = "Better"; // Scores 650-799
         else rating = "Best";                          // Scores 800-900+

         // Format Display Score
         const scoreDisplay = finalScore >= 900 ? "900+" : String(finalScore);

         // Return full breakdown
         return {
             scoreValue: finalScore,
             scoreDisplay: scoreDisplay,
             rating: rating,
             balanceScore: balanceScore,
             historyScore: historyScore,
             utilizationScore: utilizationScore,
             penalty: penalty
         };
     }

     // --- Loan Eligibility Calculation --- (Unchanged)
     function calculateEligibility(userName) { if(userName==='all'){return{isEligible:false,approvedAmount:0};} const userData=allData.filter(r=>r.Name===userName); if(userData.length===0){return{isEligible:false,approvedAmount:0};} const totalLoanTaken=userData.reduce((acc,r)=>acc+r.Loan,0); const totalPayment=userData.reduce((acc,r)=>acc+r.Payment,0); const totalSipPayment=userData.reduce((acc,r)=>acc+r.SipPayment,0); const userCurrentBalance=totalPayment+totalSipPayment-totalLoanTaken; const isEligible=userCurrentBalance>0&&communityBalance>0; const approvedAmount=isEligible?userCurrentBalance*1.5:0; return{isEligible:isEligible,approvedAmount:approvedAmount}; }

    // --- Central Display Logic --- (Unchanged)
    function updateDisplay() { const selectedName=document.getElementById('nameFilter').value; const selectedType=document.getElementById('typeFilter').value; calculateAllUserRanks(); const currentUserRank=selectedName==='all'?null:userRankMap.get(selectedName); const civilScoreResult=calculateCivilScore(selectedName); const eligibilityResult=calculateEligibility(selectedName); updateProfileSection(selectedName,currentUserRank,civilScoreResult,eligibilityResult); switch(selectedType){case'Civil Score':updateTableHeader('civil_score'); displayPerformanceScoreTable(selectedName); break; case'total_return':updateTableHeader('total_return'); calculateAndDisplayTotalReturn(selectedName); break; case'loan_history':case'members_invest':case'sip_payment':case'all_transactions':updateTableHeader(selectedType); const transactionData=getFilteredTransactionData(selectedName,selectedType); displayTransactionData(transactionData); checkRecentStatus(selectedName); break; default:console.error("Unknown filter type:",selectedType); document.querySelector("#dataTable tbody").innerHTML=`<tr><td colspan="5">Invalid filter selected.</td></tr>`;} }

    // --- Table Header Management --- (Unchanged)
    function updateTableHeader(type) { /* ... no change ... */ const tableHead=document.querySelector('#dataTable thead'); let headers=[]; const footCells=document.querySelectorAll('#dataTable tfoot td'); footCells.forEach(cell=>cell.removeAttribute('id')); footCells[0].colSpan=1; footCells[1].textContent='0'; footCells[2].textContent='0'; footCells[3].textContent='0'; switch(type){case'civil_score':headers=["Rank","Name","Perf. Score","Balance"]; footCells[0].textContent="Total Members:"; footCells[0].colSpan=1; footCells[1].id="totalMembers"; footCells[2].id="totalScore"; footCells[3].id="totalBalance"; break; case'total_return':headers=["Member","Loan*","Payment*","Return*"]; footCells[0].textContent="Overall Total:"; footCells[0].colSpan=1; footCells[1].id="totalLoanReturn"; footCells[2].id="totalPaymentReturn"; footCells[3].id="totalNetReturn"; break; case'loan_history':case'members_invest':case'sip_payment':case'all_transactions':headers=["Date","Loan","Payment","Member","Net"]; footCells[0].textContent="Total:"; footCells[0].colSpan=2; footCells[1].id="totalLoan"; footCells[2].id="totalPayment"; footCells[3].id="totalNetBalance"; if(type==='sip_payment')headers[2]="SIP Paid"; if(type==='members_invest')headers[1]=""; break; default:headers=["Date","Loan","Payment","Member","Net"]; footCells[0].textContent="Total:"; footCells[0].colSpan=2; footCells[1].id="totalLoan"; footCells[2].id="totalPayment"; footCells[3].id="totalNetBalance";} tableHead.innerHTML=`<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`; if(footCells[3])footCells[3].className='positive'; }

    // --- Data Filtering & Display --- (Unchanged)
    function getFilteredTransactionData(nameFilter, typeFilter) { /* ... no change ... */ let filtered=[]; const isAllNames=nameFilter==='all'; const nameFilteredData=isAllNames?allData:allData.filter(row=>row.Name===nameFilter); switch(typeFilter){case'loan_history':filtered=nameFilteredData.filter(r=>r.Loan>0).map(r=>({...r,Payment:0,SipPayment:0,IsSip:false})); break; case'members_invest':filtered=nameFilteredData.filter(r=>r.Payment>0).map(r=>({...r,Loan:0,SipPayment:0,IsSip:false})); break; case'sip_payment':filtered=nameFilteredData.filter(r=>r.SipPayment>0).map(r=>({...r,Payment:r.SipPayment,Loan:0,IsSip:true})); break; case'all_transactions':const l=nameFilteredData.filter(r=>r.Loan>0).map(r=>({...r,Payment:0,SipPayment:0,IsSip:false})); const p=nameFilteredData.filter(r=>r.Payment>0).map(r=>({...r,Loan:0,SipPayment:0,IsSip:false})); const s=nameFilteredData.filter(r=>r.SipPayment>0).map(r=>({...r,Payment:r.SipPayment,Loan:0,IsSip:true})); filtered=[...l,...p,...s]; break; default:filtered=nameFilteredData;} return filtered.sort((a,b)=>a.Date-b.Date); }
    function displayTransactionData(filteredData) { /* ... no change ... */ const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML=""; let loanSum=0, paymentSum=0; if(filteredData.length===0){tbody.innerHTML=`<tr><td colspan="5">No transactions found.</td></tr>`; updateTransactionTotals(0,0); return;} filteredData.forEach(row=>{const loan=row.Loan; const payment=row.Payment; const net=payment-loan; loanSum+=loan; paymentSum+=payment; const sipTag=row.IsSip?`<span class="sip-tag">SIP</span>`:''; tbody.innerHTML+=`<tr data-name="${row.Name}" data-date="${row.Date.toISOString()}"><td>${formatDate(row.Date)}</td><td class="loan">${loan>0?loan.toFixed(2):""}</td><td class="payment">${payment>0?payment.toFixed(2):""} ${sipTag}</td><td>${row.Name}</td><td class="${net<0?'negative':'positive'}">${net.toFixed(2)}</td></tr>`;}); updateTransactionTotals(loanSum,paymentSum); }
    function displayPerformanceScoreTable(selectedName) { /* ... no change ... */ const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML=""; const isAllNames=selectedName==='all'; const userData={}; let totalMembers=0; allData.forEach(row=>{const name=row.Name; if(name==='Unknown')return; if(!userData[name]){userData[name]={amount:0}; totalMembers++;} userData[name].amount+=row.Payment+row.SipPayment-row.Loan;}); let totalScoreSum=0; let totalAmountSum=0; const sortedData=Object.entries(userData).map(([name,{amount}])=>{const score=calculatePerformanceScore(amount); totalScoreSum+=score; totalAmountSum+=amount; return{name,score,amount};}).sort((a,b)=>b.score-a.score); if(sortedData.length===0){tbody.innerHTML=`<tr><td colspan="4">No score data available.</td></tr>`; updateScoreTotals(0,0,0); return;} sortedData.forEach((user,index)=>{const isSelectedUser=!isAllNames&&user.name===selectedName; const rankDisplay=userRankMap.get(user.name)||`#${index+1}`; const scoreTag=user.score>1000?' <span style="color: green;">⬆️</span>':''; const rowStyle=`background-color:${user.amount<0?'rgba(220,53,69,0.05)':'rgba(40,167,69,0.05)'}; ${isSelectedUser?'font-weight: bold;':''}`; tbody.innerHTML+=`<tr style="${rowStyle}"><td>${rankDisplay}</td><td>${user.name}</td><td style="color:${user.score<0?'var(--negative-color)':'var(--positive-color)'}; font-weight: bold;">${user.score}${scoreTag}</td><td class="${user.amount<0?'negative':'positive'}">${user.amount.toFixed(2)}</td></tr>`;}); updateScoreTotals(totalMembers,totalScoreSum,totalAmountSum); }
    function calculateAndDisplayTotalReturn(selectedName) { /* ... no change ... */ const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML=""; let overallLoanSum=0, overallPaymentSum=0, overallReturnSum=0; const isAllNames=selectedName==='all'; const members=[...new Set(allData.map(r=>r.Name.trim()))].filter(name=>name!=='Unknown'&&(isAllNames||name===selectedName)); const memberResults=members.map(member=>{const memberData=allData.filter(r=>r.Name===member); const lastPaymentDate=memberData.filter(r=>r.Payment>0).reduce((latest,r)=>(r.Date>latest?r.Date:latest),new Date(0)); const totalLoan=memberData.filter(r=>r.Date<=lastPaymentDate&&r.Loan>0).reduce((sum,r)=>sum+r.Loan,0); const totalPayment=memberData.filter(r=>r.Payment>0).reduce((sum,r)=>sum+r.Payment,0); const totalReturn=totalPayment-totalLoan; overallLoanSum+=totalLoan; overallPaymentSum+=totalPayment; overallReturnSum+=totalReturn; return{member,totalLoan,totalPayment,totalReturn};}).sort((a,b)=>b.totalReturn-a.totalReturn); if(memberResults.length===0){tbody.innerHTML=`<tr><td colspan="4">No return data available.</td></tr>`; updateReturnTotals(0,0,0); return;} memberResults.forEach(({member,totalLoan,totalPayment,totalReturn})=>{tbody.innerHTML+=`<tr><td>${member}</td><td class="loan">${totalLoan.toFixed(2)}</td><td class="payment">${totalPayment.toFixed(2)}</td><td class="${totalReturn>=0?'positive':'negative'}" style="font-weight:bold;">${totalReturn.toFixed(2)}</td></tr>`;}); updateReturnTotals(overallLoanSum,overallPaymentSum,overallReturnSum); }

    // --- Footer Total Updates --- (Unchanged)
    function updateTransactionTotals(loanSum, paymentSum) { const netSum=paymentSum-loanSum; const elLoan=document.getElementById("totalLoan"), elPay=document.getElementById("totalPayment"), elNet=document.getElementById("totalNetBalance"); if(elLoan)elLoan.textContent=loanSum.toFixed(2); if(elPay)elPay.textContent=paymentSum.toFixed(2); if(elNet){elNet.textContent=netSum.toFixed(2); elNet.className=netSum<0?"negative":"positive";} }
    function updateScoreTotals(count, scoreSum, balanceSum) { const elMem=document.getElementById("totalMembers"), elScore=document.getElementById("totalScore"), elBal=document.getElementById("totalBalance"); if(elMem)elMem.textContent=`${count}`; if(elScore)elScore.textContent=scoreSum.toFixed(0); if(elBal){elBal.textContent=balanceSum.toFixed(2); elBal.className=balanceSum<0?"negative":"positive";} }
    function updateReturnTotals(loanSum, paymentSum, returnSum) { const elLoan=document.getElementById("totalLoanReturn"), elPay=document.getElementById("totalPaymentReturn"), elRet=document.getElementById("totalNetReturn"); if(elLoan)elLoan.textContent=loanSum.toFixed(2); if(elPay)elPay.textContent=paymentSum.toFixed(2); if(elRet){elRet.textContent=returnSum.toFixed(2); elRet.className=returnSum<0?"negative":"positive";} }

    // --- Profile Section Update (Handles new Layout, CIBIL, Eligibility, Join Date etc.) ---
    function updateProfileSection(name, rank, civilScoreResult, eligibilityResult) {
        // Get DOM Elements
        const profileNameEl = document.getElementById("profileName");
        const profileAmountEl = document.getElementById("profileAmount");
        const profileCurrentLoanEl = document.getElementById("profileCurrentLoan");
        const profileSipStatusEl = document.getElementById("profileSipStatus");
        const profileJoinDateEl = document.getElementById("profileJoinDate");
        const profileRankEl = document.getElementById("profileRank");
        const bestMemberTagEl = document.getElementById("bestMemberTag");
        const progressBar = document.getElementById("progressBar");
        const profilePicContainer = document.getElementById("profilePictureContainer");
        const profileCibilScoreEl = document.getElementById("profileCibilScore");
        const profileCibilRatingEl = document.getElementById("profileCibilRating");
        const eligibilityCardEl = document.getElementById("profileEligibilityCard");
        const eligibilityStatusEl = document.getElementById("profileEligibilityStatus");
        const eligibilityAmountEl = document.getElementById("profileEligibilityAmount");
        const cibilCardEl = document.getElementById("profileCibilCard");
        const sipStatusCardEl = document.getElementById("profileSipStatusCard"); // Get SIP card element for class

        // Reset CIBIL history click listener
        cibilCardEl.onclick = null;
        cibilCardEl.style.cursor = 'default';

        // Initialize variables
        let amount = 0, currentLoan = 0, joinDate = "--", sipStatus = "--", sipStatusClass = "", profileImageUrl = defaultProfilePic, displayName = "All Members";
        let performanceScore = 0;
        const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear(); const currentDay = now.getDate();

        if (name === 'all') {
            amount = communityBalance; performanceScore = calculatePerformanceScore(amount);
            currentLoan = 0; sipStatus = "N/A"; joinDate = "N/A";
            profileRankEl.classList.add('hidden'); bestMemberTagEl.classList.add('hidden');
            eligibilityCardEl.style.display = 'none'; // Hide eligibility card
            profileCibilScoreEl.textContent = "N/A"; profileCibilRatingEl.textContent = ""; profileCibilRatingEl.className = "rating";
            profilePicContainer.innerHTML = `<div style="width:100%; height:100%; background-color:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:30px;">👥</div>`;
            latestCivilScoreBreakdown = {};
            sipStatusCardEl.className = 'metric-card'; // Reset SIP card class
        } else {
            const userData = allData.filter(r => r.Name === name);
            displayName = name;
            eligibilityCardEl.style.display = 'flex'; // Show eligibility card

            if (userData.length > 0) {
                 // Balance & Performance Score
                 const totalLoanTaken=userData.reduce((acc,r)=>acc+r.Loan,0); const totalPayment=userData.reduce((acc,r)=>acc+r.Payment,0); const totalSipPayment=userData.reduce((acc,r)=>acc+r.SipPayment,0);
                 amount=(totalPayment + totalSipPayment) - totalLoanTaken; performanceScore = calculatePerformanceScore(amount);
                 // Current Loan
                 const lastPaymentDate = userData.filter(r => r.Payment > 0).reduce((latest, r) => (r.Date > latest ? r.Date : latest), new Date(0));
                 currentLoan = userData.filter(r => r.Loan > 0 && r.Date > lastPaymentDate).reduce((sum, r) => sum + r.Loan, 0);
                 // Join Date
                 const firstSipPayment = userData.filter(r => r.SipPayment > 0).sort((a, b) => a.Date - b.Date)[0];
                 joinDate = firstSipPayment ? formatDate(firstSipPayment.Date, { month: 'long' }) : "--";
                 // SIP Status
                 const paidThisMonth = userData.some(r => r.SipPayment > 0 && r.Date.getMonth() === currentMonth && r.Date.getFullYear() === currentYear);
                 if(paidThisMonth){sipStatus="✅ Paid"; sipStatusClass="paid";}else if(currentDay>10){sipStatus="❌ Pending"; sipStatusClass="pending";}else{sipStatus="🔴 Due"; sipStatusClass="due";}
                 // Rank & Best Member
                 if(rank){profileRankEl.textContent=rank; profileRankEl.classList.remove('hidden');}else{profileRankEl.classList.add('hidden');}
                 if(performanceScore > 1000){bestMemberTagEl.classList.remove('hidden');}else{bestMemberTagEl.classList.add('hidden');}
                 // Image URL
                 const userRecordWithImage = userData.slice().reverse().find(row => row.ImageUrl); profileImageUrl = userRecordWithImage ? userRecordWithImage.ImageUrl : defaultProfilePic;
            } else {
                 amount = 0; performanceScore = 0; currentLoan = 0; joinDate = "--"; sipStatus = "--"; sipStatusClass = "";
                 profileRankEl.classList.add('hidden'); bestMemberTagEl.classList.add('hidden');
            }
            profilePicContainer.innerHTML = `<img src="${profileImageUrl}" alt="Profile image of ${name}" onerror="this.src='${defaultProfilePic}'">`;

            // Update CIBIL Score Display & Store Breakdown
            profileCibilScoreEl.textContent = civilScoreResult.scoreDisplay; profileCibilRatingEl.textContent = civilScoreResult.rating; profileCibilRatingEl.className = `rating ${civilScoreResult.rating.toLowerCase()}`;
            latestCivilScoreBreakdown = civilScoreResult;
            cibilCardEl.onclick = ()=>{openModal('cibilHistoryModal');}; cibilCardEl.style.cursor = 'pointer';

             // Update Eligibility Display
             if(eligibilityResult.isEligible){eligibilityStatusEl.textContent="Eligible"; eligibilityStatusEl.className='value eligible'; eligibilityAmountEl.textContent=`Amt: ₹${eligibilityResult.approvedAmount.toFixed(0)}`;}else{eligibilityStatusEl.textContent="Not Eligible"; eligibilityStatusEl.className='value not-eligible'; eligibilityAmountEl.textContent=` `; }
        }

        // Update Common DOM Elements
        profileNameEl.textContent=displayName;
        profileAmountEl.textContent=amount.toFixed(2); profileAmountEl.parentElement.className=`metric-card ${amount>=0?'positive':'negative'}`; // Add class to card
        profileCurrentLoanEl.textContent=currentLoan.toFixed(2); profileCurrentLoanEl.parentElement.className=`metric-card ${currentLoan>0?'negative':'positive'}`; // Add class to card
        profileSipStatusEl.textContent=sipStatus; sipStatusCardEl.className=`metric-card ${sipStatusClass}`; // Set class on SIP card
        profileJoinDateEl.textContent=joinDate;

        // Update progress bar (using Performance Score)
        const maxPerfScoreAbs=2000; const progressPercent=Math.min(100,(Math.abs(performanceScore)/maxPerfScoreAbs)*100); progressBar.style.width=`${progressPercent}%`; progressBar.className=`progress-bar ${performanceScore<0?'negative':'positive'}`;
    }

    // --- Utility Functions ---
     function calculatePerformanceScore(amount) { return Math.max(-2000, Math.min(2000, Math.round(amount / 10))); } // Performance Score calculation
     function formatDate(date, options = {}) { if(!(date instanceof Date)||isNaN(date))return"Invalid Date"; const defaultOptions={day:'2-digit',month:'short',year:'numeric'}; const mergedOptions={...defaultOptions,...options}; return date.toLocaleDateString('en-GB',mergedOptions); }
     function checkRecentStatus(selectedName) { document.querySelectorAll("#dataTable tbody tr").forEach(r=>r.classList.remove('highlight-recent-loan')); const nameToProcess=selectedName==='all'?[...new Set(allData.map(d=>d.Name))]:[selectedName]; nameToProcess.forEach(name=>{if(name==='Unknown')return; const records=allData.filter(r=>r.Name===name).sort((a,b)=>b.Date-a.Date); let recentLoanDate=null; for(const record of records){if(record.Payment>0)break; if(record.Loan>0){recentLoanDate=record.Date.toISOString(); break;}} if(recentLoanDate){const rowToHighlight=document.querySelector(`#dataTable tbody tr[data-name="${name}"][data-date="${recentLoanDate}"]`); if(rowToHighlight)rowToHighlight.classList.add('highlight-recent-loan');}}); }

</script>
</body>
</html>
