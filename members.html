<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Community Loan Dashboard</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* General Styling */
        :root {
             --primary-color: #007BFF; --secondary-color: #056fff; --light-bg: #f8f9fa;
             --text-light: #fff; --text-dark: #555; --positive-color: #04c800;
             --negative-color: #ff1f02; --warning-color: #ffc107; --neutral-color: #808080;
             --profile-bg: linear-gradient(135deg, #0d6efd, #0a58ca); --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
             --profile-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
             --loader-color: var(--primary-color); --modal-bg: rgba(0, 0, 0, 0.88);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: var(--light-bg);
            padding-top: 230px; /* Initial padding, JS will adjust */
            transition: padding-top 0.3s ease; color: var(--text-dark); line-height: 1.5;
        }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--light-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; font-size: 18px; color: var(--text-dark); transition: opacity 0.5s ease; padding: 20px; text-align: center; box-sizing: border-box; }
        #loader .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--loader-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #passwordPromptContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; opacity: 1; transition: opacity 0.3s ease; }
        #passwordPromptContainer.hidden { opacity: 0; pointer-events: none; }
        #passwordPromptMessage { padding: 25px 30px; background-color: #fff; border-radius: 10px; box-shadow: var(--card-shadow); text-align: center; max-width: 320px; width: 85%; }
        #passwordPromptMessage p { margin: 0 0 15px 0; font-size: 16px; }
        #passwordInput { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; text-align: center; letter-spacing: 5px; }
        #passwordSubmit { padding: 10px 20px; font-size: 16px; background-color: var(--primary-color); color: var(--text-light); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; }
        #passwordSubmit:hover { background-color: #0056b3; }
        #passwordError { color: var(--negative-color); font-weight: bold; margin-top: 10px; font-size: 14px; min-height: 1em; }
        #dashboardContent { display: none; } #dashboardContent.visible { display: block; }
        .header { text-align: center; background-color: var(--primary-color); color: var(--text-light); padding: 10px 0; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header img { width: 40px; height: 40px; margin-right: 10px; border-radius: 50%; } .header h1 { font-size: 1.2em; margin: 0; font-weight: 500; }
        .profile-section { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--profile-bg); color: var(--text-light); border-radius: 12px; box-shadow: var(--profile-shadow); width: 94%; max-width: 520px; z-index: 1000; padding: 15px; display: grid; grid-template-areas: "pic header buttons" "stats stats stats"; grid-template-columns: auto 1fr auto; grid-template-rows: auto 1fr; gap: 10px 15px; align-items: start; transition: top 0.3s ease; }
        .profile-picture { grid-area: pic; width: 75px; height: 75px; border-radius: 50%; background-color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 4px solid rgba(255, 255, 255, 0.8); overflow: hidden; margin-top: 5px; }
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .profile-header-area { grid-area: header; display: flex; flex-direction: column; justify-content: center; min-width: 0; align-items: start; margin-top: 5px; }
        .profile-header-area h3 { margin: 0; font-size: 20px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .profile-buttons-area { grid-area: buttons; display: flex; flex-direction: column; align-items: end; gap: 5px; margin-top: 5px; }
        .profile-buttons-area button { background-color: rgba(255, 255, 255, 0.2); color: var(--text-light); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 5px; padding: 4px 8px; font-size: 11px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; white-space: nowrap; }
        .profile-buttons-area button:hover { background-color: rgba(255, 255, 255, 0.3); }
        .profile-stats-grid { grid-area: stats; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; align-self: stretch; }
        .metric-card { background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 70px; cursor: default; box-sizing: border-box; }
        .metric-card .label { font-size: 11px; opacity: 0.9; margin-bottom: 3px; white-space: nowrap; color: #e0e0e0; }
        .metric-card .value { font-weight: bold; font-size: 15px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-light); }
        #accountBalanceCard .value.positive { color: #b2f0b2; } 
        #accountBalanceCard .value.negative { color: #f7c8c8; }
        #loanDueCard .value { color: #f7c8c8; }
        
        /* BADLAV: Filter layout ab mobile ke liye bhi behtar hai */
        .filters { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin: 15px; 
            gap: 10px; /* Gap kam kiya gaya hai */
            flex-wrap: nowrap; /* Wrap nahi hoga */
        }
        .filter-item {
            flex: 1; /* Dono items barabar space lenge */
        }

        label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 14px; }
        select { width: 100%; padding: 8px 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; }
        .table-container { width: 95%; max-width: 800px; margin: 0 auto 20px auto; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: var(--card-shadow); border-radius: 8px; overflow: hidden;}
        th, td { padding: 10px 12px; border-bottom: 1px solid #e0e0e0; text-align: left; }
        th { background-color: var(--primary-color); color: var(--text-light); font-size: 13px; font-weight: 500; white-space: nowrap; }
        td { font-size: 12px; vertical-align: middle; }
        td.debit { color: var(--negative-color); } td.credit { color: var(--positive-color); }
        tfoot td { font-weight: bold; background-color: #f5f5f5; font-size: 13px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; align-items: center; justify-content: center; z-index: 2500; opacity: 1; transition: opacity 0.3s ease; padding: 10px; box-sizing: border-box; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { background-color: #fff; padding: 20px 25px; border-radius: 8px; box-shadow: var(--card-shadow); max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; box-sizing: border-box; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; z-index: 10; padding: 0; }
        .modal h2 { margin-top: 0; margin-bottom: 15px; font-size: 18px; color: var(--primary-color); text-align: center; }
        #imageModal .modal-content { background: none; box-shadow: none; padding: 5px; width: auto; height: auto; max-width: 95%; max-height: 95%; overflow: hidden; }
        #modalImage { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; border-radius: 10px; border: 4px solid white; object-fit: contain; box-sizing: border-box; }
        #sipStatusModal .status-list { max-height: 60vh; overflow-y: auto; margin-top: 10px; padding-right: 5px;}
        #sipStatusModal .status-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
        #sipStatusModal .status-item span:last-child { font-weight: bold; display: flex; align-items: center; gap: 5px;}
        #sipStatusModal .status-paid { color: var(--positive-color); }
        #sipStatusModal .status-pending { color: var(--negative-color); }
        #sipStatusModal .status-due { color: var(--neutral-color); }
        
        @media only screen and (max-width: 600px) { 
            body { padding-top: 250px; } 
            .header { height: 55px; } .header h1 { font-size: 1em; } 
            .profile-section { top: 65px; width: 95%; padding: 10px 12px; grid-template-columns: 55px 1fr auto; gap: 8px 10px; } 
            .profile-picture { width: 50px; height: 50px; font-size: 22px; border-width: 2px; margin-top: 0;} 
            .profile-header-area h3 { font-size: 16px; } 
            .profile-buttons-area { flex-direction: row; gap: 6px; grid-column: 3; grid-row: 1; align-self: center; margin-top: 0;} 
            .profile-stats-grid{ grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 8px; } 
            .metric-card{ min-height: 55px; padding: 5px 6px; border-radius: 4px; } 
            .metric-card .label{ font-size: 9px; } .metric-card .value{ font-size: 12px; } 
            .filters { margin: 15px 10px; } 
            th,td { padding: 8px 10px; } 
        }
        @media only screen and (max-width: 420px) {
            label { font-size: 12px; }
            select { font-size: 12px; padding: 6px 8px; }
        }
    </style>
</head>
<body>
    <div id="loader"> <div class="spinner"></div> Loading... </div>

    <div id="passwordPromptContainer" class="hidden">
        <div id="passwordPromptMessage">
            <p>Enter Access PIN:</p>
            <input type="password" id="passwordInput" inputmode="numeric" pattern="[0-9]*" maxlength="10" autocomplete="off">
            <div id="passwordError"></div>
            <button id="passwordSubmit">Enter</button>
        </div>
    </div>

    <div id="dashboardContent" class="hidden">
        <div class="header">
            <img src="https://i.ibb.co/xSNPXDc8/1753150042002.jpg" alt="Logo">
            <h1>Community Loan Dashboard</h1>
        </div>

        <div id="profileSection" class="profile-section">
            <div class="profile-picture" id="profilePictureContainer"></div>
            <div class="profile-header-area">
                 <h3 id="profileName">Loading...</h3>
            </div>
            <div class="profile-buttons-area">
                <button id="sipStatusButton">SIP Status</button>
            </div>
            
            <div class="profile-stats-grid">
                 <div class="metric-card" id="totalSipCard">
                     <span class="label">Total SIP</span>
                     <span id="totalSipValue" class="value">0</span>
                 </div>
                 <div class="metric-card" id="interestPaidCard">
                     <span class="label">Interest Paid</span>
                     <span id="interestPaidValue" class="value">0</span>
                 </div>
                 <div class="metric-card" id="accountBalanceCard">
                     <span class="label">Account Balance</span>
                     <span id="accountBalanceValue" class="value">0</span>
                 </div>
                 <div class="metric-card" id="loanDueCard">
                     <span class="label">Loan Due</span>
                     <span id="loanDueValue" class="value">0</span>
                 </div>
                 <div class="metric-card" id="totalLoanCard">
                     <span class="label">Total Loan Taken</span>
                     <span id="totalLoanValue" class="value">0</span>
                 </div>
                 <div class="metric-card" id="joiningDateCard">
                     <span class="label">Joining Date</span>
                     <span id="joiningDateValue" class="value">-</span>
                 </div>
            </div>
        </div>

        <div class="filters">
             <div class="filter-item">
                <label for="memberFilter">Select Member:</label>
                <select id="memberFilter">
                    <option value="all">All Members</option>
                </select>
            </div>
             <div class="filter-item">
                <label for="typeFilter">Filter Data By:</label>
                <select id="typeFilter">
                    <option value="all">All Transactions</option>
                    <option value="active_loans">Active Loans</option>
                    <option value="loan">Loan History</option>
                    <option value="payment">Payment History</option>
                    <option value="sip">SIP History</option>
             </select>
            </div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead></thead>
                <tbody></tbody>
                <tfoot></tfoot>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="imageModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('imageModal')">×</button>
            <img id="modalImage" src="" alt="Profile Image Fullscreen">
        </div>
    </div>
    <div id="sipStatusModal" class="modal hidden">
         <div class="modal-content">
             <button class="modal-close" onclick="closeModal('sipStatusModal')">×</button>
             <h2>Current Month SIP Status</h2>
             <div id="sipStatusList" class="status-list">Loading...</div>
         </div>
     </div>

<script>
    // === GLOBAL VARIABLES ===
    let allMembers = {};
    let allTransactions = [];
    let allActiveLoans = [];
    let loggedInUserPassword = null; 
    const defaultProfilePic = 'https://i.ibb.co/xSNPXDc8/1753150042002.jpg';

    // === INITIALIZATION & AUTHENTICATION ===
    document.addEventListener("DOMContentLoaded", () => {
        initializeApp();
    });

    async function initializeApp() {
        const loader = document.getElementById('loader');
        try {
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('Configuration API could not be fetched.');
            const config = await response.json();

            if (!firebase.apps.length) {
                firebase.initializeApp(config.firebase);
            }
            
            setupPasswordPrompt();

        } catch (error) {
            console.error("Initialization Error:", error);
            loader.innerHTML = `<b>Initialization Error:</b> ${error.message}`;
        }
    }

    function setupPasswordPrompt() {
        const passwordInput = document.getElementById('passwordInput');
        const passwordSubmit = document.getElementById('passwordSubmit');
        const passwordError = document.getElementById('passwordError');
        const passwordContainer = document.getElementById('passwordPromptContainer');
        const loader = document.getElementById('loader');

        loader.classList.add('hidden');
        passwordContainer.classList.remove('hidden');
        passwordInput.focus();

        passwordSubmit.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') checkPassword();
        });

        async function checkPassword() {
            const enteredPassword = passwordInput.value;
            if (!enteredPassword) return;

            passwordError.textContent = "";
            passwordSubmit.disabled = true;
            passwordSubmit.textContent = "Checking...";

            try {
                const membersSnapshot = await firebase.database().ref('members').once('value');
                const allMembersData = membersSnapshot.val() || {};
                
                const isValidUser = Object.values(allMembersData).some(member => member.password === enteredPassword);

                if (isValidUser) {
                    loggedInUserPassword = enteredPassword;
                    passwordContainer.classList.add('hidden');
                    loader.classList.remove('hidden');
                    await processFirebaseData();
                } else {
                    passwordError.textContent = "Incorrect PIN";
                    passwordInput.value = "";
                    passwordInput.focus();
                }
            } catch (error) {
                console.error("Error during PIN verification:", error);
                passwordError.textContent = "Error connecting to database.";
            } finally {
                passwordSubmit.disabled = false;
                passwordSubmit.textContent = "Enter";
            }
        }
    }
    
    // === DATA FETCH & PROCESSING ===
    async function processFirebaseData() {
        try {
            const membersSnapshot = await firebase.database().ref('members').once('value');
            const transactionsSnapshot = await firebase.database().ref('transactions').once('value');
            const activeLoansSnapshot = await firebase.database().ref('activeLoans').once('value');

            allMembers = membersSnapshot.val() || {};
            
            allTransactions = Object.values(transactionsSnapshot.val() || {})
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            allActiveLoans = Object.values(activeLoansSnapshot.val() || {});

            initializeDashboard();

        } catch (error) {
            console.error("Error processing Firebase data:", error);
            document.getElementById('loader').innerHTML = `Error: ${error.message}`;
        }
    }

    // === DASHBOARD INITIALIZATION ===
    function initializeDashboard() {
        document.getElementById('dashboardContent').classList.add('visible');
        populateMemberFilter(); 
        setupEventListeners();
        updateDisplay(); 
        document.getElementById('loader').classList.add('hidden');
    }

    function populateMemberFilter() {
        const memberFilter = document.getElementById('memberFilter');
        memberFilter.innerHTML = '<option value="all">All Members</option>';

        const approvedMembers = Object.values(allMembers)
            .filter(member => member.status === 'Approved')
            .sort((a, b) => a.fullName.localeCompare(b.fullName));

        approvedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.membershipId; 
            option.textContent = member.fullName;
            memberFilter.appendChild(option);
        });
    }

    function setupEventListeners() {
        document.getElementById('memberFilter').addEventListener('change', updateDisplay);
        document.getElementById('typeFilter').addEventListener('change', updateDisplay);
        
        document.getElementById('imageModal').addEventListener('click', () => closeModal('imageModal'));
        document.getElementById('profilePictureContainer').addEventListener('click', (event) => {
            if (event.target.tagName === 'IMG' && event.target.src !== defaultProfilePic && event.target.src) {
                event.stopPropagation();
                openModal('imageModal', event.target.src);
            }
        });
        document.getElementById('sipStatusButton').addEventListener('click', () => {
            populateSipStatusModal();
            openModal('sipStatusModal');
        });

        const profileSection = document.getElementById('profileSection');
        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                const height = entry.contentRect.height;
                document.body.style.paddingTop = `${height + 95}px`;
            }
        });
        resizeObserver.observe(profileSection);
    }

    // === CENTRAL DISPLAY LOGIC ===
    function updateDisplay() {
        const selectedMemberId = document.getElementById('memberFilter').value;
        const selectedType = document.getElementById('typeFilter').value;
        
        updateProfileSection(selectedMemberId);
        updateTopCards(selectedMemberId);
        
        if (selectedType === 'active_loans') {
            displayActiveLoansData(selectedMemberId);
        } else {
            displayTransactionData(selectedMemberId, selectedType);
        }
    }
    
    function updateProfileSection(selectedMemberId) {
        const profileNameEl = document.getElementById("profileName");
        const profilePicContainer = document.getElementById("profilePictureContainer");

        if (selectedMemberId === 'all') {
            profileNameEl.textContent = "Community Overview";
            profilePicContainer.innerHTML = `<img src="${defaultProfilePic}" alt="Community Logo">`;
        } else {
            const member = allMembers[selectedMemberId];
            if (member) {
                profileNameEl.textContent = member.fullName;
                const profileImageUrl = member.profilePicUrl || defaultProfilePic;
                profilePicContainer.innerHTML = `<img src="${profileImageUrl}" alt="Profile image" onerror="this.onerror=null; this.src='${defaultProfilePic}';">`;
            }
        }
    }

    function updateTopCards(selectedMemberId) {
        const memberTransactions = (selectedMemberId === 'all') 
            ? allTransactions 
            : allTransactions.filter(tx => tx.memberId === selectedMemberId);
        
        const memberActiveLoans = (selectedMemberId === 'all')
            ? allActiveLoans
            : allActiveLoans.filter(loan => loan.memberId === selectedMemberId);

        let totalSip = 0, interestPaid = 0, accountBalance = 0, totalLoanTaken = 0;
        
        memberTransactions.forEach(tx => {
            if (tx.type === 'SIP') totalSip += tx.amount || 0;
            if (tx.type === 'Loan Payment') interestPaid += tx.interestPaid || 0;
            if (tx.type === 'Extra Payment') accountBalance += tx.amount || 0;
            if (tx.type === 'Extra Withdraw') accountBalance -= tx.amount || 0;
            if (tx.type === 'Loan Taken') totalLoanTaken += tx.amount || 0;
        });

        const loanDue = memberActiveLoans.reduce((sum, loan) => sum + loan.outstandingAmount, 0);

        let joiningDate = '-';
        if (selectedMemberId !== 'all') {
            const sipTransactions = memberTransactions.filter(tx => tx.type === 'SIP');
            if (sipTransactions.length > 0) {
                joiningDate = formatDate(new Date(sipTransactions[0].date));
            }
        }

        document.getElementById('totalSipValue').textContent = `₹${totalSip.toLocaleString('en-IN')}`;
        document.getElementById('interestPaidValue').textContent = `₹${interestPaid.toLocaleString('en-IN')}`;
        document.getElementById('accountBalanceValue').textContent = `₹${accountBalance.toLocaleString('en-IN')}`;
        document.getElementById('loanDueValue').textContent = `₹${loanDue.toLocaleString('en-IN')}`;
        document.getElementById('totalLoanValue').textContent = `₹${totalLoanTaken.toLocaleString('en-IN')}`;
        document.getElementById('joiningDateValue').textContent = joiningDate;
    }

    // === DATA DISPLAY FUNCTIONS ===
    function displayTransactionData(selectedMemberId, typeFilter) {
        const table = document.getElementById('dataTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        const tfoot = table.querySelector('tfoot');
        tbody.innerHTML = "";

        // BADLAV: Transaction table ka header ab 6 column ka hoga
        thead.innerHTML = `
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th style="text-align: right;">Debit (₹)</th>
                <th style="text-align: right;">Principal (₹)</th>
                <th style="text-align: right;">Interest (₹)</th>
                <th style="text-align: right;">Balance (₹)</th>
            </tr>`;
        
        tfoot.innerHTML = `
            <tr>
                <td colspan="2" style="text-align: right; font-weight: bold;">Total</td>
                <td id="totalDebitCell" style="text-align: right;">0.00</td>
                <td id="totalPrincipalCell" style="text-align: right;">0.00</td>
                <td id="totalInterestCell" style="text-align: right;">0.00</td>
                <td></td>
            </tr>`;
        
        const memberTransactions = (selectedMemberId === 'all')
            ? allTransactions
            : allTransactions.filter(tx => tx.memberId === selectedMemberId);

        let runningBalance = 0;
        let totalDebit = 0, totalPrincipal = 0, totalInterest = 0;

        const statementLines = [];
        memberTransactions.forEach(tx => {
            let line = { date: new Date(tx.date), description: '', debit: 0, principal: 0, interest: 0, type: tx.type };
            
            // BADLAV: Loan Payment ko alag alag handle kiya jayega
            switch (tx.type) {
                case 'SIP': line.description = 'SIP Payment'; line.principal = tx.amount || 0; break;
                case 'Loan Taken': line.description = `${tx.loanType || 'Loan'} Taken`; line.debit = tx.amount || 0; break;
                case 'Loan Payment': line.description = `Loan Payment`; line.principal = tx.principalPaid || 0; line.interest = tx.interestPaid || 0; break;
                case 'Extra Payment': line.description = 'Extra Amount Deposited'; line.principal = tx.amount || 0; break;
                case 'Extra Withdraw': line.description = 'Extra Amount Withdrawn'; line.debit = tx.amount || 0; break;
            }
            const credit = line.principal + line.interest;
            runningBalance += credit - line.debit;
            line.balance = runningBalance;
            statementLines.push(line);
        });

        const filteredLines = statementLines.filter(line => {
            if (typeFilter === 'all') return true;
            if (typeFilter === 'loan' && line.type === 'Loan Taken') return true;
            if (typeFilter === 'payment' && line.type === 'Loan Payment') return true;
            if (typeFilter === 'sip' && line.type === 'SIP') return true;
            return false;
        });

        if (filteredLines.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No matching transactions found.</td></tr>`;
            tfoot.style.display = 'none';
            return;
        }

        tfoot.style.display = '';
        filteredLines.forEach(line => {
            totalDebit += line.debit;
            totalPrincipal += line.principal;
            totalInterest += line.interest;
            tbody.innerHTML += `
                <tr>
                    <td>${formatDate(line.date)}</td>
                    <td>${line.description}</td>
                    <td class="debit" style="text-align: right;">${line.debit > 0 ? f(line.debit) : '-'}</td>
                    <td class="credit" style="text-align: right;">${line.principal > 0 ? f(line.principal) : '-'}</td>
                    <td class="credit" style="text-align: right;">${line.interest > 0 ? f(line.interest) : '-'}</td>
                    <td style="text-align: right; font-weight: 500;">${f(line.balance)}</td>
                </tr>
            `;
        });
        
        document.getElementById('totalDebitCell').textContent = f(totalDebit);
        document.getElementById('totalPrincipalCell').textContent = f(totalPrincipal);
        document.getElementById('totalInterestCell').textContent = f(totalInterest);
    }

    function displayActiveLoansData(selectedMemberId) {
        const table = document.getElementById('dataTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        const tfoot = table.querySelector('tfoot');
        tbody.innerHTML = "";
        
        // BADLAV: Active Loans ke header me "Member Name" joda gaya
        thead.innerHTML = `
            <tr>
                <th>Member Name</th>
                <th>Loan Date</th>
                <th>Loan Type</th>
                <th style="text-align: right;">Original (₹)</th>
                <th style="text-align: right;">Outstanding (₹)</th>
            </tr>`;

        tfoot.innerHTML = '';

        const memberActiveLoans = (selectedMemberId === 'all')
            ? allActiveLoans.filter(loan => loan.status === 'Active')
            : allActiveLoans.filter(loan => loan.memberId === selectedMemberId && loan.status === 'Active');

        if (memberActiveLoans.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No active loans found.</td></tr>`;
            return;
        }

        memberActiveLoans.forEach(loan => {
            // Member ka naam `allMembers` se prapt karein
            const memberName = allMembers[loan.memberId] ? allMembers[loan.memberId].fullName : 'Unknown';
            tbody.innerHTML += `
                <tr>
                    <td>${memberName}</td>
                    <td>${formatDate(new Date(loan.loanDate))}</td>
                    <td>${loan.loanType}</td>
                    <td style="text-align: right;">${f(loan.originalAmount)}</td>
                    <td class="debit" style="text-align: right; font-weight: bold;">${f(loan.outstandingAmount)}</td>
                </tr>
            `;
        });
    }

    // === UTILITY FUNCTIONS ===
    function populateSipStatusModal() {
        const listContainer = document.getElementById('sipStatusList');
        listContainer.innerHTML = "";
        
        const approvedMembers = Object.values(allMembers)
            .filter(member => member.status === 'Approved')
            .sort((a, b) => a.fullName.localeCompare(b.fullName));
            
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const currentDay = now.getDate();

        if (approvedMembers.length === 0) { listContainer.innerHTML = "No approved members found."; return; }

        approvedMembers.forEach(member => {
            const paidThisMonth = allTransactions.some(tx => 
                tx.memberId === member.membershipId && 
                tx.type === 'SIP' && 
                new Date(tx.date).getMonth() === currentMonth && 
                new Date(tx.date).getFullYear() === currentYear
            );
            
            let statusText, statusClass, statusIcon;
            if (paidThisMonth) { [statusText, statusClass, statusIcon] = ["Paid", "status-paid", "✅"]; } 
            else if (currentDay > 10) { [statusText, statusClass, statusIcon] = ["Pending", "status-pending", "❌"]; } 
            else { [statusText, statusClass, statusIcon] = ["Due", "status-due", "🔴"]; }

            const itemDiv = document.createElement('div');
            itemDiv.className = 'status-item';
            itemDiv.innerHTML = `<span>${member.fullName}</span><span class="${statusClass}">${statusIcon} ${statusText}</span>`;
            listContainer.appendChild(itemDiv);
        });
    }

    function openModal(modalId, imageSrc = null) {
        const modal = document.getElementById(modalId);
        if (modal) {
            if (modalId === 'imageModal' && imageSrc) {
                modal.querySelector('#modalImage').src = imageSrc;
            }
            modal.classList.remove('hidden');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
             if (modalId === 'imageModal') {
                 modal.querySelector('#modalImage').src = "";
             }
        }
    }

    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return "N/A";
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    
    // Currency format karne ke liye ek chhota helper function
    function f(num) {
        return (num || 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
    }

</script>
</body>
</html>

