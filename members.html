<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Community Loan Dashboard</title>
    <style>
        /* Basic Reset & Body Style */
        :root {
             --primary-color: #007BFF; --secondary-color: #056fff; --light-bg: #f9f9f9;
             --text-light: #fff; --text-dark: #333; --positive-color: #28a745; /* Green */
             --negative-color: #dc3545; /* Red */ --warning-color: #ffc107; /* Yellow for Pending */
             --profile-bg: linear-gradient(135deg, #0d6efd, #0a58ca); --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
             --profile-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: var(--light-bg);
            padding-top: 185px; /* Adjusted for compact profile */
            transition: padding-top 0.3s ease; color: var(--text-dark); line-height: 1.5;
        }

        /* Password Prompt Styles (Unchanged) */
        #passwordPromptContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; opacity: 1; transition: opacity 0.3s ease; }
        #passwordPromptContainer.hidden { opacity: 0; pointer-events: none; }
        #passwordPromptMessage { padding: 25px 30px; background-color: #fff; border-radius: 10px; box-shadow: var(--card-shadow); text-align: center; max-width: 320px; width: 85%; }
        #passwordPromptMessage p { margin: 0 0 15px 0; font-size: 16px; }
        #passwordInput { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; text-align: center; letter-spacing: 5px; }
        #passwordSubmit { padding: 10px 20px; font-size: 16px; background-color: var(--primary-color); color: var(--text-light); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; }
        #passwordSubmit:hover { background-color: #0056b3; }
        #passwordError { color: var(--negative-color); font-weight: bold; margin-top: 10px; font-size: 14px; min-height: 1em; }

        /* Dashboard Content Container */
        #dashboardContent { display: none; } #dashboardContent.visible { display: block; }

        /* Header (Unchanged) */
        .header { text-align: center; background-color: var(--primary-color); color: var(--text-light); padding: 10px 0; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header img { width: 40px; height: 40px; margin-right: 10px; } .header h1 { font-size: 1.2em; margin: 0; font-weight: 500; }

        /* --- Compact Profile Section --- */
        .profile-section {
            position: fixed; top: 70px; /* Slightly higher */ left: 50%; transform: translateX(-50%);
            background: var(--profile-bg); color: var(--text-light); border-radius: 10px; /* Less rounded */
            box-shadow: var(--profile-shadow); width: 92%; max-width: 430px; /* Adjusted */
            z-index: 1000; padding: 12px 15px; /* Reduced padding */
            display: grid;
            grid-template-areas: /* Adjusted grid areas */
                "pic name rank"
                "pic details details"
                "bar bar bar";
            grid-template-columns: auto 1fr auto; /* Pic | Name/Details | Rank */
            gap: 4px 12px; /* Reduced gaps */
            align-items: center; transition: top 0.3s ease;
        }

        .profile-picture {
            grid-area: pic; width: 70px; height: 70px; /* Slightly smaller */ border-radius: 50%;
            background-color: #eee; display: flex; align-items: center; justify-content: center;
            font-size: 32px; /* Adjusted */ font-weight: bold; color: var(--text-dark); text-transform: uppercase;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2); flex-shrink: 0;
            border: 3px solid rgba(255, 255, 255, 0.7); /* Thinner border */ overflow: hidden;
        }
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }

        .profile-name-rank { grid-area: name; display: flex; flex-direction: column; justify-content: center; min-width: 0; align-items: start; }
        .profile-name-rank h3 { margin: 0; font-size: 18px; /* Smaller */ font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .best-member-tag { font-size: 10px; /* Smaller */ font-weight: bold; color: #ffd700; background-color: rgba(0, 0, 0, 0.2); padding: 1px 5px; /* Adjusted */ border-radius: 4px; margin-top: 3px; display: inline-block; }
        .best-member-tag.hidden { display: none; }

        .profile-rank {
             grid-area: rank; justify-self: end; align-self: start; /* Align top right */
             background-color: rgba(255, 255, 255, 0.2); color: var(--text-light);
             padding: 2px 7px; /* Smaller */ border-radius: 12px; /* More rounded badge */
             font-size: 12px; /* Smaller */ font-weight: bold; line-height: 1; margin-top: 2px;
        }
        .profile-rank.hidden { display: none; }

        .profile-details { /* Holds Balance, Score, Loan, SIP, Join Date */
            grid-area: details; display: grid;
            /* Flexible columns, aiming for 3 on wider screens within profile */
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 5px; /* Reduced gap */ margin-top: 5px; width: 100%;
        }
        .profile-details p { /* Style for each metric box */
            margin: 0; background-color: rgba(0,0,0,0.1); padding: 4px 6px; /* Reduced padding */
            border-radius: 4px; /* Less rounded */ text-align: center; display: flex; flex-direction: column;
        }
         .profile-details p .label { /* Label (Balance, Score...) */
            font-size: 10px; /* Smaller */ opacity: 0.8; margin-bottom: 1px; white-space: nowrap;
         }
        .profile-details p .value { /* Value (Amount, Date...) */
            font-weight: 600; /* Slightly less bold */ font-size: 13px; /* Smaller */ line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* Specific value styling (unchanged) */
        .profile-details .positive .value { color: #aaffaa; } .profile-details .negative .value { color: #ffbaba; }
        .profile-details .pending .value { color: var(--warning-color); } .profile-details .paid .value { color: #aaffaa; }


        .progress-bar-container { grid-area: bar; width: 100%; height: 6px; /* Thinner */ background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; overflow: hidden; margin-top: 8px; /* Reduced margin */ }
        .progress-bar { height: 100%; width: 0; transition: width 1s ease-in-out, background-color 0.5s ease-in-out; }
        .progress-bar.positive { background-color: #39ff14; } .progress-bar.negative { background-color: #ff3d3d; }
        /* --- End Compact Profile Section --- */

        /* Filters */
        .filters { display: flex; justify-content: center; margin: 15px 10px; /* Reduced margin */ gap: 15px; flex-wrap: wrap; padding-top: 125px; /* Adjusted for compact profile height */ }
        label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 14px; }
        select { padding: 8px 10px; font-size: 14px; min-width: 160px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; }

        /* Table Styles */
        .table-container { /* Add a container for better control */
             width: 100%;
             overflow-x: auto; /* Keep horizontal scroll on container */
             margin: 0 auto 20px auto;
             -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        table {
            width: 100%; /* Table takes full width of container */
            border-collapse: collapse; background-color: white; box-shadow: var(--card-shadow);
            /* Remove display:block and overflow-x:auto from table itself */
        }
        th, td { padding: 8px 10px; /* Adjusted padding */ border: 1px solid #e0e0e0; text-align: center; }
        th { background-color: var(--primary-color); color: var(--text-light); font-size: 13px; /* Slightly smaller */ font-weight: 500; white-space: nowrap; /* Keep headers nowrap */ }
        td { font-size: 12px; /* Smaller */ vertical-align: middle; } /* Align vertically */
        .loan { color: var(--negative-color); font-weight: 500; }
        .payment { color: var(--positive-color); font-weight: 500;}
        tfoot td { font-weight: bold; background-color: #fff8e1; font-size: 13px; }
        .positive { color: var(--positive-color); font-weight: bold; } .negative { color: var(--negative-color); font-weight: bold; }
        .sip-tag { background-color: #6f42c1; color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px; margin-left: 4px; vertical-align: middle; font-weight: normal;}
        .highlight-recent-loan { background-color: rgba(220, 53, 69, 0.1) !important; }

        /* Modal Styles (Unchanged) */
        #imageModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; }
        #modalImage { max-width: 90%; max-height: 90%; border-radius: 10px; border: 3px solid white; }

        /* --- Responsive adjustments --- */
        @media only screen and (max-width: 1024px) {
             body { padding-top: 180px; }
             .filters { padding-top: 120px; }
             .profile-section { max-width: 95%; }
        }
        @media only screen and (max-width: 600px) {
            body { padding-top: 190px; } /* Adjusted */
            .header { height: 55px; } .header h1 { font-size: 1em; }
            .profile-section {
                 top: 65px; width: 95%; padding: 10px 12px; /* Adjusted padding */
                 grid-template-areas: /* Adjust grid */
                    "pic name name" /* Name takes more space */
                    "pic rank details" /* Rank moves down slightly */
                    "bar bar bar";
                 grid-template-columns: 65px 1fr auto; /* Adjust pic size */
                 gap: 5px 8px; /* Reduced gaps */
            }
            .profile-picture { width: 60px; height: 60px; font-size: 28px; border-width: 3px; }
            .profile-name-rank h3 { font-size: 16px; } /* Adjusted */
            .best-member-tag { font-size: 9px; padding: 1px 4px; }
            .profile-rank { grid-row: 2; grid-column: 2; justify-self: start; /* Align left below name */ align-self: center; margin: 0; } /* Reposition Rank */
            .profile-details { grid-area: details; grid-row: 2; grid-column: 3; grid-template-columns: 1fr; gap: 4px; margin-top: 0; } /* Metrics stack on right */
            .profile-details p { font-size: 10px; padding: 3px 5px; }
            .profile-details p .label { font-size: 9px; }
            .profile-details p .value { font-size: 11px; }

            .filters { padding-top: 135px; /* Adjusted */ gap: 10px; margin-top: 15px; }
            label, select { font-size: 12px; min-width: 110px;} select { padding: 5px 6px; }

            /* Table mobile adjustments */
            .table-container { margin-top: 10px; }
            th { font-size: 11px; padding: 6px 8px; } /* Smaller header */
            td {
                font-size: 10px; /* Smaller text */
                padding: 5px 6px; /* Less padding */
                white-space: normal; /* Allow text wrapping */
                overflow-wrap: break-word; /* Break long words */
                word-break: break-word; /* Ensure breaking */
                vertical-align: middle;
            }
            tfoot td { font-size: 11px; }
        }
         @media only screen and (max-width: 420px) { /* Further adjustments for very small screens */
             body { padding-top: 200px; } /* May need more if profile wraps badly */
             .profile-section { grid-template-columns: 55px 1fr auto; gap: 4px 6px; } /* Smaller pic */
             .profile-picture { width: 50px; height: 50px; font-size: 22px; border-width: 2px; }
             .profile-name-rank h3 { font-size: 15px; }
             .profile-details { grid-area: details; grid-row: 3; grid-column: 1 / -1; grid-template-columns: 1fr 1fr; margin-top: 5px; } /* Span full width, 2 columns */
             .progress-bar-container { grid-row: 4; grid-column: 1 / -1; }
             .filters { padding-top: 155px; }
         }

    </style>
</head>
<body>
    <div id="passwordPromptContainer"> <div id="passwordPromptMessage"> <p>Enter Access PIN:</p> <input type="password" id="passwordInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off"> <div id="passwordError"></div> <button id="passwordSubmit">Enter</button> </div> </div>

    <div id="dashboardContent">
        <div class="header"> <img src="https://i.postimg.cc/XNpR3cN1/20241030-065157.png" alt="Logo"> <h1>Community Loan Dashboard</h1> </div>

        <div id="profileSection" class="profile-section">
            <div class="profile-picture" id="profilePictureContainer"></div>
            <div class="profile-name-rank">
                 <h3 id="profileName">Loading...</h3>
                 <span id="bestMemberTag" class="best-member-tag hidden">✨ Best Performance Member</span>
            </div>
             <div class="profile-rank hidden" id="profileRank">#?</div>
            <div class="profile-details">
                 <p><span class="label">Balance</span><span id="profileAmount" class="value positive">0</span></p>
                 <p><span class="label">Score</span><span id="profileScore" class="value positive">0</span></p>
                 <p><span class="label">Current Loan*</span><span id="profileCurrentLoan" class="value negative">0</span></p>
                 <p><span class="label">SIP Status</span><span id="profileSipStatus" class="value">--</span></p>
                 <p><span class="label">Join Date</span><span id="profileJoinDate" class="value">--</span></p> </div>
            <div class="progress-bar-container"> <div class="progress-bar" id="progressBar"></div> </div>
             <p style="grid-column: 1 / -1; font-size: 9px; opacity: 0.7; margin: 3px 0 -5px 0; text-align: center; line-height: 1.1;">*Current Loan = Loans after last non-SIP payment.</p>
        </div>

        <div class="filters">
             <div><label for="nameFilter">Select Name:</label><select id="nameFilter"><option value="all">All Members</option></select></div>
             <div><label for="typeFilter">Filter Data By:</label><select id="typeFilter">
                    <option value="Civil Score">Performance Score</option>
                    <option value="all_transactions">All Transactions</option>
                    <option value="members_invest">Loan Repayments</option>
                    <option value="loan_history">Loan History</option>
                    <option value="sip_payment">SIP Payments</option> <option value="total_return">Total Return</option>
             </select></div>
        </div>

        <div class="table-container">  <table id="dataTable"><thead></thead><tbody></tbody><tfoot><tr><td id="totalLabel" colspan="1">Total</td><td id="totalValue1">0</td><td id="totalValue2">0</td><td id="totalValue3" class="positive">0</td></tr></tfoot></table>
        </div>
    </div> <div id="imageModal"><img id="modalImage" src="" alt="Profile Image Fullscreen"></div>

    <script>
    let allData = [];
    const profileDataMap = new Map();
    const CORRECT_PASSWORD = "7536";
    let userRankMap = new Map();

    // URLs & Defaults (Unchanged)
    const dataUrl = 'https://script.google.com/macros/s/AKfycbyzs5UbjLWv9U-JBiT87iTd8Pbgy2yxYUI8vsiiiQ7zkFNF7L5t49aBZOnsFgvK4GZc2A/exec';
    const defaultProfilePic = 'https://via.placeholder.com/80/CCCCCC/FFFFFF?text=M';
    const profileEntries = [ { name: "Prince Rama", image: "https://bit.ly/49GvZh4" }, { name: "Amit Kumar", image: "https://bit.ly/4gzlMFs" }, { name: "Mithlesh Sahni", image: "https://bit.ly/3ZCGptv" }, { name: "Raja Sahni", image: "https://bit.ly/3ZEnwGK" }, { name: "Dilkhush Kumar", image: "https://bit.ly/4iTxRrh" }, { name: "Nitish Sahni", image: "https://bit.ly/3BxVjcw" }, { name: "Kunal kumar", image: "https://bit.ly/49H7tMO" }, { name: "Dr Santosh", image: "https://bit.ly/3BBiGC3" } ];
    profileEntries.forEach(p => profileDataMap.set(p.name.trim().toLowerCase(), p.image));

    // --- Initialization & Password --- (Unchanged)
    document.addEventListener("DOMContentLoaded", setupPasswordPrompt);
    function setupPasswordPrompt() { const passwordInput=document.getElementById('passwordInput'); const passwordSubmit=document.getElementById('passwordSubmit'); const passwordError=document.getElementById('passwordError'); const passwordContainer=document.getElementById('passwordPromptContainer'); passwordSubmit.addEventListener('click', checkPassword); passwordInput.addEventListener('keydown', (event)=>{if(event.key==='Enter'){checkPassword();}}); passwordInput.focus(); function checkPassword(){const enteredPassword=passwordInput.value; if(enteredPassword===CORRECT_PASSWORD){passwordContainer.classList.add('hidden'); fetchData();}else{passwordError.textContent="Incorrect PIN"; passwordInput.value=""; passwordInput.focus(); passwordInput.style.animation='shake 0.5s'; setTimeout(()=>passwordInput.style.animation='',500);}} }
    const styleSheet=document.createElement("style"); styleSheet.type="text/css"; styleSheet.innerText=`@keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }`; document.head.appendChild(styleSheet);

    // --- Data Fetching & Processing --- (Unchanged)
    async function fetchData() { try { const response=await fetch(dataUrl); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); allData = await response.json(); allData=allData.map(row=>({ Name:row.Name?String(row.Name).trim():'Unknown', Date:row.Date?new Date(row.Date):new Date(0), Loan:parseFloat(row.Loan)||0, Payment:parseFloat(row.Payment)||0, SipPayment:parseFloat(row[" EMI payment"])||0 })); initializeDashboard(); } catch (error) { console.error("Error fetching/processing data:", error); const dashboardContent=document.getElementById('dashboardContent'); dashboardContent.innerHTML=`<p style='color: red; text-align: center; padding: 50px;'>Error loading data. Please try again later.</p>`; dashboardContent.classList.add('visible'); } }
    function initializeDashboard() { document.getElementById('dashboardContent').classList.add('visible'); populateNameFilter(); setupEventListeners(); document.getElementById('nameFilter').value='all'; document.getElementById('typeFilter').value='Civil Score'; updateDisplay(); }
    function setupEventListeners() { document.getElementById('nameFilter').addEventListener('change', updateDisplay); document.getElementById('typeFilter').addEventListener('change', updateDisplay); document.getElementById('imageModal').addEventListener('click', ()=>{document.getElementById('imageModal').style.display='none';}); document.getElementById('profilePictureContainer').addEventListener('click',(event)=>{if(event.target.tagName==='IMG'){const modal=document.getElementById('imageModal'); const modalImage=document.getElementById('modalImage'); modalImage.src=event.target.src; modal.style.display='flex';}}); }

    // --- Filter Population --- (Unchanged)
    function populateNameFilter() { const nameFilter=document.getElementById("nameFilter"); const memberData={}; allData.forEach(row=>{const name=row.Name; if(name==='Unknown')return; if(!memberData[name])memberData[name]=0; memberData[name]+=row.Payment+row.SipPayment-row.Loan;}); const sortedMembers=Object.entries(memberData).sort(([,balA],[,balB])=>balB-balA); nameFilter.innerHTML='<option value="all">All Members</option>'; sortedMembers.forEach(([name])=>{nameFilter.innerHTML+=`<option value="${name}">${name}</option>`;}); }

     // --- Rank Calculation --- (Unchanged)
     function calculateAllUserRanks() { userRankMap.clear(); const userData={}; allData.forEach(row=>{const name=row.Name; if(name==='Unknown')return; if(!userData[name])userData[name]={amount:0}; userData[name].amount+=row.Payment+row.SipPayment-row.Loan;}); const sortedData=Object.entries(userData).map(([name,{amount}])=>({name, score:calculateScore(amount)})).sort((a,b)=>b.score-a.score); sortedData.forEach((user,index)=>{let rankDisplay; if(index===0)rankDisplay="🥇"; else if(index===1)rankDisplay="🥈"; else if(index===2)rankDisplay="🥉"; else rankDisplay=`#${index + 1}`; userRankMap.set(user.name,rankDisplay);}); }

    // --- Central Display Logic --- (Unchanged)
    function updateDisplay() { const selectedName=document.getElementById('nameFilter').value; const selectedType=document.getElementById('typeFilter').value; calculateAllUserRanks(); const currentUserRank=selectedName==='all'?null:userRankMap.get(selectedName); updateProfileSection(selectedName,currentUserRank); switch(selectedType){case'Civil Score':updateTableHeader('civil_score'); displayCivilScoreData(selectedName); break; case'total_return':updateTableHeader('total_return'); calculateAndDisplayTotalReturn(selectedName); break; case'loan_history':case'members_invest':case'sip_payment':case'all_transactions':updateTableHeader(selectedType); const transactionData=getFilteredTransactionData(selectedName,selectedType); displayTransactionData(transactionData); checkRecentStatus(selectedName); break; default:console.error("Unknown filter type:",selectedType); document.querySelector("#dataTable tbody").innerHTML=`<tr><td colspan="4">Invalid filter selected.</td></tr>`;} }

    // --- Table Header Management --- (Unchanged)
    function updateTableHeader(type) { const tableHead=document.querySelector('#dataTable thead'); let headers=[]; const footCells=document.querySelectorAll('#dataTable tfoot td'); footCells.forEach(cell=>cell.removeAttribute('id')); footCells[0].colSpan=1; footCells[1].textContent='0'; footCells[2].textContent='0'; footCells[3].textContent='0'; switch(type){case'civil_score':headers=["Rank","Name","Score","Balance"]; footCells[0].textContent="Total Members:"; footCells[0].colSpan=1; footCells[1].id="totalMembers"; footCells[2].id="totalScore"; footCells[3].id="totalBalance"; break; case'total_return':headers=["Member","Loan*","Payment*","Return*"]; footCells[0].textContent="Overall Total:"; footCells[0].colSpan=1; footCells[1].id="totalLoanReturn"; footCells[2].id="totalPaymentReturn"; footCells[3].id="totalNetReturn"; break; case'loan_history':case'members_invest':case'sip_payment':case'all_transactions':headers=["Date","Loan","Payment","Member","Net"]; footCells[0].textContent="Total:"; footCells[0].colSpan=2; footCells[1].id="totalLoan"; footCells[2].id="totalPayment"; footCells[3].id="totalNetBalance"; if(type==='sip_payment')headers[2]="SIP Paid"; if(type==='members_invest')headers[1]=""; break; default:headers=["Date","Loan","Payment","Member","Net"]; footCells[0].textContent="Total:"; footCells[0].colSpan=2; footCells[1].id="totalLoan"; footCells[2].id="totalPayment"; footCells[3].id="totalNetBalance";} tableHead.innerHTML=`<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`; if(footCells[3])footCells[3].className='positive'; }

    // --- Data Filtering & Display ---
    // getFilteredTransactionData (Unchanged)
    function getFilteredTransactionData(nameFilter, typeFilter) { let filtered=[]; const isAllNames=nameFilter==='all'; const nameFilteredData=isAllNames?allData:allData.filter(row=>row.Name===nameFilter); switch(typeFilter){case'loan_history':filtered=nameFilteredData.filter(r=>r.Loan>0).map(r=>({...r,Payment:0,SipPayment:0,IsSip:false})); break; case'members_invest':filtered=nameFilteredData.filter(r=>r.Payment>0).map(r=>({...r,Loan:0,SipPayment:0,IsSip:false})); break; case'sip_payment':filtered=nameFilteredData.filter(r=>r.SipPayment>0).map(r=>({...r,Payment:r.SipPayment,Loan:0,IsSip:true})); break; case'all_transactions':const l=nameFilteredData.filter(r=>r.Loan>0).map(r=>({...r,Payment:0,SipPayment:0,IsSip:false})); const p=nameFilteredData.filter(r=>r.Payment>0).map(r=>({...r,Loan:0,SipPayment:0,IsSip:false})); const s=nameFilteredData.filter(r=>r.SipPayment>0).map(r=>({...r,Payment:r.SipPayment,Loan:0,IsSip:true})); filtered=[...l,...p,...s]; break; default:filtered=nameFilteredData;} return filtered.sort((a,b)=>a.Date-b.Date); }
    // displayTransactionData (Unchanged)
    function displayTransactionData(filteredData) { const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML=""; let loanSum=0, paymentSum=0; if(filteredData.length===0){tbody.innerHTML=`<tr><td colspan="5">No transactions found.</td></tr>`; updateTransactionTotals(0,0); return;} filteredData.forEach(row=>{const loan=row.Loan; const payment=row.Payment; const net=payment-loan; loanSum+=loan; paymentSum+=payment; const sipTag=row.IsSip?`<span class="sip-tag">SIP</span>`:''; tbody.innerHTML+=`<tr data-name="${row.Name}" data-date="${row.Date.toISOString()}"><td>${formatDate(row.Date)}</td><td class="loan">${loan>0?loan.toFixed(2):""}</td><td class="payment">${payment>0?payment.toFixed(2):""} ${sipTag}</td><td>${row.Name}</td><td class="${net<0?'negative':'positive'}">${net.toFixed(2)}</td></tr>`;}); updateTransactionTotals(loanSum,paymentSum); }
    // displayCivilScoreData (Unchanged)
    function displayCivilScoreData(selectedName) { const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML=""; const isAllNames=selectedName==='all'; const userData={}; let totalMembers=0; allData.forEach(row=>{const name=row.Name; if(name==='Unknown')return; if(!userData[name]){userData[name]={amount:0}; totalMembers++;} userData[name].amount+=row.Payment+row.SipPayment-row.Loan;}); let totalScoreSum=0; let totalAmountSum=0; const sortedData=Object.entries(userData).map(([name,{amount}])=>{const score=calculateScore(amount); totalScoreSum+=score; totalAmountSum+=amount; return{name,score,amount};}).sort((a,b)=>b.score-a.score); if(sortedData.length===0){tbody.innerHTML=`<tr><td colspan="4">No score data available.</td></tr>`; updateScoreTotals(0,0,0); return;} sortedData.forEach((user,index)=>{const isSelectedUser=!isAllNames&&user.name===selectedName; const rankDisplay=userRankMap.get(user.name)||`#${index+1}`; const scoreTag=user.score>1000?' <span style="color: green;">⬆️</span>':''; const rowStyle=`background-color:${user.amount<0?'rgba(220,53,69,0.05)':'rgba(40,167,69,0.05)'}; ${isSelectedUser?'font-weight: bold;':''}`; tbody.innerHTML+=`<tr style="${rowStyle}"><td>${rankDisplay}</td><td>${user.name}</td><td style="color:${user.score<0?'var(--negative-color)':'var(--positive-color)'}; font-weight: bold;">${user.score}${scoreTag}</td><td class="${user.amount<0?'negative':'positive'}">${user.amount.toFixed(2)}</td></tr>`;}); updateScoreTotals(totalMembers,totalScoreSum,totalAmountSum); }
    // calculateAndDisplayTotalReturn (Unchanged)
    function calculateAndDisplayTotalReturn(selectedName) { const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML=""; let overallLoanSum=0, overallPaymentSum=0, overallReturnSum=0; const isAllNames=selectedName==='all'; const members=[...new Set(allData.map(r=>r.Name.trim()))].filter(name=>name!=='Unknown'&&(isAllNames||name===selectedName)); const memberResults=members.map(member=>{const memberData=allData.filter(r=>r.Name===member); const lastPaymentDate=memberData.filter(r=>r.Payment>0).reduce((latest,r)=>(r.Date>latest?r.Date:latest),new Date(0)); const totalLoan=memberData.filter(r=>r.Date<=lastPaymentDate&&r.Loan>0).reduce((sum,r)=>sum+r.Loan,0); const totalPayment=memberData.filter(r=>r.Payment>0).reduce((sum,r)=>sum+r.Payment,0); const totalReturn=totalPayment-totalLoan; overallLoanSum+=totalLoan; overallPaymentSum+=totalPayment; overallReturnSum+=totalReturn; return{member,totalLoan,totalPayment,totalReturn};}).sort((a,b)=>b.totalReturn-a.totalReturn); if(memberResults.length===0){tbody.innerHTML=`<tr><td colspan="4">No return data available.</td></tr>`; updateReturnTotals(0,0,0); return;} memberResults.forEach(({member,totalLoan,totalPayment,totalReturn})=>{tbody.innerHTML+=`<tr><td>${member}</td><td class="loan">${totalLoan.toFixed(2)}</td><td class="payment">${totalPayment.toFixed(2)}</td><td class="${totalReturn>=0?'positive':'negative'}" style="font-weight:bold;">${totalReturn.toFixed(2)}</td></tr>`;}); updateReturnTotals(overallLoanSum,overallPaymentSum,overallReturnSum); }

    // --- Footer Total Updates --- (Unchanged)
    function updateTransactionTotals(loanSum, paymentSum) { const netSum=paymentSum-loanSum; const elLoan=document.getElementById("totalLoan"), elPay=document.getElementById("totalPayment"), elNet=document.getElementById("totalNetBalance"); if(elLoan)elLoan.textContent=loanSum.toFixed(2); if(elPay)elPay.textContent=paymentSum.toFixed(2); if(elNet){elNet.textContent=netSum.toFixed(2); elNet.className=netSum<0?"negative":"positive";} }
    function updateScoreTotals(count, scoreSum, balanceSum) { const elMem=document.getElementById("totalMembers"), elScore=document.getElementById("totalScore"), elBal=document.getElementById("totalBalance"); if(elMem)elMem.textContent=`${count}`; if(elScore)elScore.textContent=scoreSum.toFixed(0); if(elBal){elBal.textContent=balanceSum.toFixed(2); elBal.className=balanceSum<0?"negative":"positive";} }
    function updateReturnTotals(loanSum, paymentSum, returnSum) { const elLoan=document.getElementById("totalLoanReturn"), elPay=document.getElementById("totalPaymentReturn"), elRet=document.getElementById("totalNetReturn"); if(elLoan)elLoan.textContent=loanSum.toFixed(2); if(elPay)elPay.textContent=paymentSum.toFixed(2); if(elRet){elRet.textContent=returnSum.toFixed(2); elRet.className=returnSum<0?"negative":"positive";} }

    // --- Profile Section Update (Added Join Date) ---
    function updateProfileSection(name, rank) {
        const profileNameEl=document.getElementById("profileName"); const profileAmountEl=document.getElementById("profileAmount"); const profileScoreEl=document.getElementById("profileScore"); const profileCurrentLoanEl=document.getElementById("profileCurrentLoan"); const profileSipStatusEl=document.getElementById("profileSipStatus"); const profileJoinDateEl = document.getElementById("profileJoinDate"); // Get Join Date Element
        const profileRankEl=document.getElementById("profileRank"); const bestMemberTagEl=document.getElementById("bestMemberTag"); const progressBar=document.getElementById("progressBar"); const profilePicContainer=document.getElementById("profilePictureContainer"); const maxScoreAbs=2000;

        let amount = 0, score = 0, currentLoan = 0, joinDate = "--", sipStatus = "--", sipStatusClass = "", profileImageUrl = defaultProfilePic, displayName = "All Members";
        const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear(); const currentDay = now.getDate();

        if (name === 'all') {
            amount=allData.reduce((acc,r)=>acc+r.Payment+r.SipPayment-r.Loan,0); score=calculateScore(amount); currentLoan=0; sipStatus="N/A"; joinDate="N/A";
            profileRankEl.classList.add('hidden'); bestMemberTagEl.classList.add('hidden');
            profilePicContainer.innerHTML=`<div style="width:100%; height:100%; background-color:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:30px;">👥</div>`;
        } else {
            const userData=allData.filter(r=>r.Name===name);
            // Balance & Score
            const totalLoanTaken=userData.reduce((acc,r)=>acc+r.Loan,0); const totalPayment=userData.reduce((acc,r)=>acc+r.Payment,0); const totalSipPayment=userData.reduce((acc,r)=>acc+r.SipPayment,0);
            amount=(totalPayment + totalSipPayment) - totalLoanTaken; score = calculateScore(amount);
            // Current Loan
            const lastPaymentDate = userData.filter(r => r.Payment > 0).reduce((latest, r) => (r.Date > latest ? r.Date : latest), new Date(0));
            currentLoan = userData.filter(r => r.Loan > 0 && r.Date > lastPaymentDate).reduce((sum, r) => sum + r.Loan, 0);
            // Join Date (First SIP Payment)
            const firstSipPayment = userData.filter(r => r.SipPayment > 0).sort((a, b) => a.Date - b.Date)[0];
            joinDate = firstSipPayment ? formatDate(firstSipPayment.Date, { month: 'long' }) : "--"; // Use long month format

            // SIP Status
            const paidThisMonth = userData.some(r => r.SipPayment > 0 && r.Date.getMonth() === currentMonth && r.Date.getFullYear() === currentYear);
            if(paidThisMonth){sipStatus="Paid this month"; sipStatusClass="paid";}else if(currentDay>10){sipStatus="Pending"; sipStatusClass="pending";}else{sipStatus="Due"; sipStatusClass="";}

            displayName = name;
            // Rank & Best Member
            if(rank){profileRankEl.textContent=rank; profileRankEl.classList.remove('hidden');}else{profileRankEl.classList.add('hidden');}
            if(score > 1000){bestMemberTagEl.classList.remove('hidden');}else{bestMemberTagEl.classList.add('hidden');}
            // Profile Picture
            profileImageUrl=profileDataMap.get(name.toLowerCase())||defaultProfilePic; profilePicContainer.innerHTML=`<img src="${profileImageUrl}" alt="Profile image of ${name}">`;
        }

        // Update DOM
        profileNameEl.textContent=displayName;
        profileAmountEl.textContent=amount.toFixed(2); profileAmountEl.parentElement.className=amount>=0?'positive':'negative';
        profileScoreEl.textContent=score; profileScoreEl.parentElement.className=score>=0?'positive':'negative';
        profileCurrentLoanEl.textContent=currentLoan.toFixed(2); profileCurrentLoanEl.parentElement.className=currentLoan>0?'negative':'positive';
        profileSipStatusEl.textContent=sipStatus; profileSipStatusEl.parentElement.className=sipStatusClass;
        profileJoinDateEl.textContent = joinDate; // Update Join Date

        // Update progress bar
        const progressPercent=Math.min(100,(Math.abs(score)/maxScoreAbs)*100); progressBar.style.width=`${progressPercent}%`; progressBar.className=`progress-bar ${score<0?'negative':'positive'}`;
    }

    // --- Utility Functions ---
     function calculateScore(amount) { return Math.max(-2000, Math.min(2000, Math.round(amount / 10))); }
     // Updated formatDate to accept options
     function formatDate(date, options = {}) {
         if (!(date instanceof Date) || isNaN(date)) return "Invalid Date";
         const defaultOptions = { day: '2-digit', month: 'short', year: 'numeric' };
         const mergedOptions = { ...defaultOptions, ...options };
         // Handle potential locale issues for month names if needed, 'en-GB' is generally good
         return date.toLocaleDateString('en-GB', mergedOptions);
     }
     function checkRecentStatus(selectedName) { document.querySelectorAll("#dataTable tbody tr").forEach(r=>r.classList.remove('highlight-recent-loan')); const nameToProcess=selectedName==='all'?[...new Set(allData.map(d=>d.Name))]:[selectedName]; nameToProcess.forEach(name=>{if(name==='Unknown')return; const records=allData.filter(r=>r.Name===name).sort((a,b)=>b.Date-a.Date); let recentLoanDate=null; for(const record of records){if(record.Payment>0)break; if(record.Loan>0){recentLoanDate=record.Date.toISOString(); break;}} if(recentLoanDate){const rowToHighlight=document.querySelector(`#dataTable tbody tr[data-name="${name}"][data-date="${recentLoanDate}"]`); if(rowToHighlight)rowToHighlight.classList.add('highlight-recent-loan');}}); }

</script>
</body>
</html>
