<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Community Loan</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      margin: 0;
    }
    .form-container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 450px;
      margin-bottom: 30px;
    }
    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }
    label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px; /* Increased margin */
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, select:focus {
      border-color: #4cc9f0;
      outline: none;
      box-shadow: 0 0 8px rgba(76, 201, 240, 0.4);
    }
    input[type="file"] {
        padding: 5px; /* Adjust padding for file input */
    }
    .btn {
      padding: 1.1em 2em;
      background: #ecd448; /* Yellow */
      border: none; /* Removed border */
      font-size: 16px; /* Slightly larger font */
      color: #131313;
      cursor: pointer;
      border-radius: 8px; /* Slightly less rounded */
      font-weight: bolder;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Softer shadow */
      width: 100%;
      margin-top: 20px;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    }
    .btn:hover {
      background-color: #4cc9f0; /* Blue on hover */
      color: #fff;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); /* Enhanced shadow on hover */
      transform: translateY(-2px); /* Slight lift effect */
    }
     #downloadBtn {
        background-color: #5cb85c; /* Green for download */
        color: white;
     }
     #downloadBtn:hover {
        background-color: #4cae4c;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        transform: translateY(-2px);
     }

    /* Styles for the capture section (A4 layout) */
    #capture {
      display: none; /* Hidden initially */
      width: 210mm; /* A4 width */
      /* height: 297mm; A4 height - Let content define height */
      min-height: 280mm; /* Minimum height */
      padding: 15mm; /* Padding in mm */
      background: white;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid #ccc; /* Simple border */
      box-sizing: border-box; /* Include padding and border in width/height */
      margin: 20px auto; /* Center it */
      position: relative; /* Needed for absolute positioning inside if any */
       /* Flex column layout */
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      border-bottom: 4px solid #056fff; /* Thicker border */
      padding-bottom: 15px;
      margin-bottom: 20px;
      position: relative; /* For absolute positioning of date */
    }
    .header-info {
      position: absolute;
      right: 0; /* Align to the right of the header */
      top: 0; /* Align to the top of the header */
      text-align: right;
      font-size: 14px; /* Slightly smaller date font */
      color: #555;
    }
    .header .logo {
      width: 100px; /* Slightly smaller logo */
      margin-bottom: 5px;
    }
     .header h1 {
        font-size: 24px; /* Adjust heading size */
        margin: 10px 0 5px 0;
        color: #056fff;
     }
     .header h2 {
        font-size: 18px;
        margin: 0;
        color: #333;
     }
    .registration-number {
      color: #ff0000;
      font-weight: bold;
      margin-top: 15px; /* Space above reg number */
      font-size: 16px;
    }

    .loan-details-container {
        display: flex; /* Enable flexbox */
        justify-content: space-between; /* Space between details and photo */
        align-items: flex-start; /* Align items to the top */
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        background-color: #fafafa; /* Light background for details section */
    }

    .details-text {
        flex-grow: 1; /* Allow text details to take available space */
        padding-right: 20px; /* Space between text and photo */
    }
    .details-text p {
        margin: 10px 0; /* Spacing between detail lines */
        font-size: 15px; /* Standard font size */
        color: #333;
        display: flex; /* Use flex for icon alignment */
        align-items: center; /* Center icon vertically */
    }
     .details-text p i {
        margin-right: 10px; /* Space between icon and text */
        color: #056fff; /* Icon color */
        width: 20px; /* Fixed width for alignment */
        text-align: center;
     }

    .applicant-photo-container {
        flex-shrink: 0; /* Prevent photo container from shrinking */
        width: 130px; /* Fixed width for the photo container */
        text-align: center; /* Center photo within its container */
    }

    #applicantPhoto {
      max-width: 100%; /* Make image responsive within its container */
      height: auto; /* Maintain aspect ratio */
      max-height: 150px; /* Maximum height */
      border: 1px solid #ddd;
      border-radius: 5px;
      object-fit: contain; /* Ensure image fits without distortion */
      margin-top: 5px; /* Space above photo */
    }
    .highlight {
      color: #056fff;
      font-weight: bold;
    }
    .request-text {
        margin-top: 20px;
        text-align: center;
        font-style: italic;
        color: #555;
    }

    /* Footer section for Stamp and Signature */
    .footer-section {
        margin-top: auto; /* Push footer to the bottom */
        padding-top: 30px; /* Space above the footer items */
        display: flex;
        justify-content: space-between; /* Space out stamp and signature */
        align-items: flex-end; /* Align items to the bottom */
        border-top: 1px dashed #ccc; /* Separator line */
    }

    .stamp-section {
        text-align: center;
    }
    .stamp-img {
      width: 150px; /* Adjusted size */
      opacity: 0.8;
    }

    .signature-section {
      text-align: center;
    }
    .signature-img {
      width: 200px; /* Adjusted size */
      margin-top: 5px;
    }
     .signature-section p {
        margin: 0;
        font-size: 14px;
        color: #333;
     }

  </style>
</head>
<body>
  <div class="form-container">
    <h1>Loan Application Form</h1>
    <form id="loanForm">
      <label for="nameSelect">Applicant Name:</label>
      <select id="nameSelect" required></select>

      <label for="mobile">Mobile Number:</label>
      <input type="tel" id="mobile" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" required>

      <label for="amount">Loan Amount (₹):</label>
      <input type="number" id="amount" placeholder="Enter loan amount" min="1" required>

      <label for="monthlyRate">Interest Rate & Duration:</label>
      <select id="monthlyRate" required>
        <option value="" disabled selected>Select Rate and Duration</option>
        <option value="1">1% for 1 month</option>
        <option value="2">3% for 2 months</option>
        <option value="3">5% for 3 months</option>
        <option value="1_2x">2% for 1 month (2× loan)</option> <option value="emi">8% (Flat) for 3 Months (EMI)</option>
      </select>

      <label for="imageUpload">Upload Aadhaar Photo:</label>
      <input type="file" id="imageUpload" accept="image/*">

      <button type="submit" class="btn">Generate Loan Letter</button>
    </form>
  </div>

  <div id="capture">
    <div class="header">
      <div class="header-info">Date: <span id="currentDate"></span></div>
      <img src="https://i.imgur.com/JLyQvpv.png" class="logo" alt="Bank Logo">
      <h1>BANK COMMUNITY LOAN FORM</h1>
      <h2>बैंक कम्युनिटी लोन</h2>
      <div class="registration-number">Reg. No: <span id="regNumber"></span></div>
    </div>

    <div class="loan-details-container">
        <div class="details-text">
          <p><i class="fas fa-user"></i>Applicant Name: <span class="highlight" id="displayName"></span></p>
          <p><i class="fas fa-mobile-alt"></i>Mobile Number: <span id="displayMobile"></span></p>
          <p><i class="fas fa-rupee-sign"></i>Loan Amount: ₹<span id="displayAmount"></span></p>
          <p><i class="fas fa-percent"></i>Interest Rate: <span id="displayRate"></span></p>
          <p><i class="fas fa-file-invoice-dollar"></i>Total Payable: ₹<span id="displayTotalAmount"></span></p>
          <p><i class="fas fa-calendar-alt"></i>Repayment Period Ends: <span id="repaymentDate"></span></p>
          <p id="emiRow" style="display: none;"><i class="fas fa-chart-pie"></i>Monthly EMI: ₹<span id="displayEMI"></span>/month</p>
        </div>
        <div class="applicant-photo-container">
            <p style="margin-bottom: 5px; font-weight: bold; color: #555;">Applicant Photo:</p>
            <img id="applicantPhoto" src="" alt="Applicant Photo"> </div>
    </div>

     <p class="request-text highlight">I request the bank community members to please approve this loan application.</p>

    <div class="footer-section">
        <div class="stamp-section">
             <img src="https://i.imgur.com/w9J5t2N.png" class="stamp-img" alt="Bank Stamp">
             <p>Bank Seal</p>
        </div>
        <div class="signature-section">
          <p>Authorized Signature</p>
          <img src="https://i.imgur.com/kkg2glD.png" class="signature-img" alt="Signature">
          <p>Prime Members</p>
        </div>
    </div>
  </div>

  <button id="downloadBtn" class="btn" style="display: none; max-width: 450px; margin: 0 auto;">Download Letter</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz9LCkPR8L3-i7F1KG2KUJ6It2l_p55murljRJ_4108nFysOXUOpG5WEs1sdEaGHq1L7w/exec';
    let membersData = [];

    const nameSelect = document.getElementById('nameSelect');
    const mobileInput = document.getElementById('mobile');
    const amountInput = document.getElementById('amount');
    const rateSelect = document.getElementById('monthlyRate');
    const imageUploadInput = document.getElementById('imageUpload');
    const loanForm = document.getElementById('loanForm');
    const captureDiv = document.getElementById('capture');
    const downloadBtn = document.getElementById('downloadBtn');

    // Elements inside captureDiv
    const currentDateEl = document.getElementById('currentDate');
    const displayNameEl = document.getElementById('displayName');
    const displayMobileEl = document.getElementById('displayMobile');
    const displayAmountEl = document.getElementById('displayAmount');
    const displayRateEl = document.getElementById('displayRate');
    const displayTotalAmountEl = document.getElementById('displayTotalAmount');
    const displayEMIEl = document.getElementById('displayEMI');
    const repaymentDateEl = document.getElementById('repaymentDate');
    const regNumberEl = document.getElementById('regNumber');
    const applicantPhotoEl = document.getElementById('applicantPhoto');
    const emiRowEl = document.getElementById('emiRow');


    async function fetchMemberData() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        membersData = Array.isArray(data) ? data : [data]; // Ensure it's an array

        // Filter out potential empty rows or invalid entries before creating unique names
        const validMembers = membersData.filter(d => d && d.Name && d.Name.trim() !== '');
        const uniqueNames = [...new Set(validMembers.map(d => d.Name.trim()))].sort(); // Sort names alphabetically

        nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant Name</option>'; // Placeholder
        uniqueNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          nameSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching member data:', error);
        alert('Failed to load member data. Please check the API or refresh the page.');
      }
    }

    function formatDate(date) {
      const day = date.getDate();
      const month = date.toLocaleString('default', { month: 'long' }); // Get full month name
      const year = date.getFullYear();
      return `${day} ${month} ${year}`;
    }

    function generateRegistrationNumber() {
      const timestamp = Date.now().toString(); // Use full timestamp for more uniqueness
      const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase(); // Add random chars
      return `BCL-${timestamp.slice(-6)}-${randomPart}`;
    }

    loanForm.addEventListener('submit', function(e) {
      e.preventDefault(); // Prevent default form submission

      const selectedName = nameSelect.value;
      const member = membersData.find(m => m.Name === selectedName);
      const mobile = mobileInput.value;
      const amount = parseFloat(amountInput.value);
      const rateValue = rateSelect.value;
      const uploadedFile = imageUploadInput.files[0];

      if (!selectedName || !mobile || isNaN(amount) || !rateValue) {
          alert('Please fill in all required fields.');
          return;
      }

      let interest = 0;
      let months = 1;
      let rateText = '';

      // Determine interest, months, and descriptive text based on selection
      if (rateValue === 'emi') {
        interest = 8; // Assuming 8% flat rate for the entire period
        months = 3;
        rateText = `8% Flat for 3 Months (EMI)`;
      } else if (rateValue === '1_2x') {
        interest = 2;
        months = 1;
        rateText = `2% for 1 Month`; // Removed (2x loan) as it's unclear
      } else if (rateValue === '1') {
        interest = 1;
        months = 1;
        rateText = `1% for 1 Month`;
      } else if (rateValue === '2') {
        interest = 3;
        months = 2;
         rateText = `3% for 2 Months`;
      } else if (rateValue === '3') {
        interest = 5;
        months = 3;
         rateText = `5% for 3 Months`;
      }

      // Calculate total amount and EMI
      // Note: This assumes flat interest, not reducing balance for EMI. Adjust if needed.
      const totalInterestAmount = amount * (interest / 100);
      const totalAmount = amount + totalInterestAmount;
      let emi = '-';

      if (rateValue === 'emi') {
          emi = (totalAmount / months).toFixed(2);
          emiRowEl.style.display = 'flex'; // Show EMI row
      } else {
          emiRowEl.style.display = 'none'; // Hide EMI row
      }

      // Calculate repayment date
      const today = new Date();
      const repaymentDate = new Date(today);
      repaymentDate.setMonth(repaymentDate.getMonth() + months);

      // Populate the capture div
      currentDateEl.textContent = formatDate(today);
      displayNameEl.textContent = selectedName;
      displayMobileEl.textContent = mobile;
      displayAmountEl.textContent = amount.toFixed(2);
      displayRateEl.textContent = rateText; // Display full rate description
      displayTotalAmountEl.textContent = totalAmount.toFixed(2);
      displayEMIEl.textContent = emi;
      repaymentDateEl.textContent = formatDate(repaymentDate);
      regNumberEl.textContent = generateRegistrationNumber();

      // --- Handle Image ---
      applicantPhotoEl.src = ""; // Clear previous image
      applicantPhotoEl.alt = "Applicant Photo"; // Reset alt text

      if (uploadedFile) {
          // If a file is uploaded, read and display it
          const reader = new FileReader();
          reader.onload = function(event) {
              applicantPhotoEl.src = event.target.result;
              // Make capture div visible AFTER image is loaded
              captureDiv.style.display = 'flex'; // Use flex display
              downloadBtn.style.display = 'block'; // Show download button
          }
          reader.onerror = function(event) {
              console.error("File could not be read: " + event.target.error.code);
              alert('Error reading uploaded file.');
              // Optionally fallback to API image or placeholder here
              setApiOrDefaultImage(member);
              captureDiv.style.display = 'flex';
              downloadBtn.style.display = 'block';
          }
          reader.readAsDataURL(uploadedFile);
      } else {
          // If no file uploaded, use API image or a default/placeholder
          setApiOrDefaultImage(member);
          // Make capture div visible immediately
          captureDiv.style.display = 'flex'; // Use flex display
          downloadBtn.style.display = 'block'; // Show download button
      }
    });

    function setApiOrDefaultImage(member) {
        if (member && member.imageUrl) {
            applicantPhotoEl.src = member.imageUrl;
            // Optional: Add crossOrigin attribute if images are on a different domain and CORS is configured
            // applicantPhotoEl.crossOrigin = "anonymous";
        } else {
            // Optional: Set a placeholder image if no API image and no upload
            // applicantPhotoEl.src = 'path/to/placeholder.png';
            applicantPhotoEl.alt = "No Photo Available";
        }
    }


    downloadBtn.addEventListener('click', function() {
      // Ensure the capture element is visible
      if (captureDiv.style.display === 'none') {
        alert('Please generate the loan form first by filling the details and clicking "Generate Loan Letter".');
        return;
      }

      // Hide the download button itself during capture if it overlaps or looks bad
      // downloadBtn.style.display = 'none';

      html2canvas(captureDiv, {
        scale: 2, // Higher scale for better resolution
        logging: false, // Disable logging in console
        useCORS: true, // Attempt to load cross-origin images (like from imgur or API)
        allowTaint: false, // Set to false when useCORS is true
        scrollX: 0, // Ensure capture starts from top-left
        scrollY: 0,
        windowWidth: captureDiv.scrollWidth, // Use element's dimensions
        windowHeight: captureDiv.scrollHeight
      }).then(canvas => {
        const link = document.createElement('a');
        const fileName = `Bank_Community_Loan_${displayNameEl.textContent.replace(/\s+/g, '_') || 'Form'}_${Date.now()}.png`;
        link.download = fileName;
        link.href = canvas.toDataURL('image/png'); // Get image data as PNG
        document.body.appendChild(link); // Required for Firefox
        link.click();
        document.body.removeChild(link); // Clean up

        // Show the download button again if it was hidden
        // downloadBtn.style.display = 'block';

      }).catch(error => {
        console.error('Error generating image with html2canvas:', error);
        alert('Error downloading the form image. Please ensure all images loaded correctly and try again. Check console for details.');
         // Show the download button again if it was hidden
        // downloadBtn.style.display = 'block';
      });
    });

    // Initialize the form by fetching member data when the page loads
    fetchMemberData();
  </script>
</body>
</html>
